<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EscoMind ‚Äî Learn Your Lines</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<!-- PWA / App Icon ‚Äî fully embedded, no extra files needed -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="EscoMind">
<meta name="theme-color" content="#C1614F">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAP3UlEQVR4nO3W0ZHjhhVE0Y1BUTj/KBSE09C3XbIlUdod7jSHIBt477yq888CMNP32zd36fvll1/+A9DS/h/o3OWv/UcM8E7t/7nOvfXaf3AAV9D+X+3c09f+IwKYoP2/3LlPr/1HArBB+3+9cwYf4ATaW+CWXPtDB+C+9ka4gdf+qAHItTfDXfzaHzAAz2tvibvQtT9WAI7X3hZ30mt/mAC8T3tz3Amu/REC0NPeIFe49kcHwHm0N8m94dofGQDn1d4o94Jrf1QAXEd7s9xB1/6QALie9na5J6798QBwfe0tcw9c+2MBYJ72trlPrv2BADBXe+PcB9f+KADYo7157o9rfwgA7NPevtXXfvkA0N7Cddd+4QDwp/Ymrrn2iwaA77W3cfS1Xy4AfKa9leOu/UIBINXezDHXfpEA8Kj2dl7+2i8QAL6qvaGXvPZLA4CjtDf1Mtd+UQBwtPa2nv7aLwgAXqW9sae99osBgFdrb+3prv1CAOBd2pt7mmu/CAB4t/b21q/9AgCgpb3BtWs/eABoa2/x26/9wAHgLNqb/LZrP2gAOJv2Nr/82g8YAM6qvdEvvfbDBYCzam/0y679YAHg7Npbffi1HygAXEV7sw+79oMEgKtpb/fT136AAHBV7Q1/6toPDwCuqr3hX772gwOAq2tv+cPXfmAAMEV70+NrPygAmKa97dG1HxIATNPe9k+v/YAAYKr2xt+99oMBgOnaW//htR8KAEzX3vofrv1AAGCL9ub/de0HAQDbtLf/f9d+CACwTXv7jT8AlAgAAFjI+APAUsYfAJYSAACwkPEHgKUEAAAsZPwBYCkBAAALGX8AWEoAAMBCxh8AlhIAALCQAACAhYw/ACwlAABgIeMPAEsJAABYSAAAwELGHwCWEgAAsJDxB4ClBAAALCQAAGAh4w8ASwkAAFhIAADAQgIAABYy/gCwlAAAgIUEAAAsJAAAYCHjDwBLCQAAWEgAAMBCAgAAFjL+ALCUAACAhQQAACwkAABgIQEAAAsJAABYSAAAwELGHwCWEgAAsJAAAICFBAAALCQAAGAhAQAACwkAAFhIAADAQgIAABYSAACwkAAAgIUEAAAsJAAAYCEBAAALGX8AWEgAAMBCAgAAFhIAALCQAACAhQQAACwkAABgIQEAAAsJAABYSAAAwEICAAAWEgAAsJAAAICFBAAALCQAAGAhAQAACwkAAFhIAADAQgIAABYSAACwkAAAgIUEAAAsJACI/fbbb/CU9jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+ur/0NAzcCgFh7PLi+9jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+u7+hv8t//+lf97wKuSgAQa48H1/eV7+73kf+q9t8MnJkAINYeD64v/daeGX0xABkBQKw9HlzfZ9/YK4ZfCMDHBACx9nhwffe+rXcMvxCAfxIAxI76Zw9/1xh/EQACgAcIAI7UHH4hAAKABwgAjtIefBEAAoAHCACO0B56EQD/JwCICQCe1R54EQA3AoCYAOAZ7WEXAfBPAoCYAOCr2oMuAuBHAoCYAOCr2mMuAOBHAoCYAOAr2kMuAuBjAoCYAOBR7QEXAXCfACAmAHhUe7wFANwnAIgJAB7RHm4RAD8nAIgJAB7RHm0BAD8nAIgJAFLtwRYB8DkBQEwAkGqPtQCAzwkAYgKAVHusBQB8TgAQEwAk2kMtAiAjAIgJABLtkRYAkBEAxAQAifZICwDICABiAoBEe6QFAGQEADEBQKI90gIAMgKAmAAg0R5pAQAZAUBMAJBoj7QAgIwAICYA+Ex7oEUA5AQAMQFAoj3Qxh8yAoCYACDRHmkBABkBQEwAkGiPtACAjAAgJgBItEdaAEBGABATACTaIy0AICMAiAkAEu2RFgCQEQDEBACJ9kgLAMgIAGICgFR7qI0/fE4AEBMApNpjLQDgcwKAmAAg1R5rAQCfEwDEBACPaA+28YefEwDEBACPaI+2AICfEwDEBACPag+38Yf7BAAxAcCj2uMtAOA+AUBMAPAV7QE3/vAxAUBMAPBV7SE3/vAjAUBMAPBV7TEXAPAjAUBMAPCM9qAbf/gnAUBMAPCs9rAbf7gRAMQEAEdoD7zxh/8TAMQEAEdpD73xBwHAAwQAR2oPvvFnOwFATADwCoYfOgQAMQHAqxh/eD8BQEwA8GqGH95HABATALyL4YfXEwDEBAANRh9eQwAQEwCcjZGHrxMAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFA7NEA4Nza3xPQJQCItQcLAQAcRwAQaw8WAgA4jgAg1h4sBABwHAFArD1YCADgOAKAWHuwEADAcQQAsfZgIQCA4wgAYu3BQgAAxxEAxNqDhQAAjiMAiLUHCwEAHEcAEGsPFgIAOI4AINYeLAQAcBwBQMzAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiD0aAPC99jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+ur/0NAzcCgFh7PLi+9jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+ur/0NAzcCgFh7PLi+9jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+ur/0NAzcCAAAWEgAAsJAAAICFBAAALCQAAGAhAQAACwkAAFhIAADAQgIAABYSAACwkAAAgIUEALzZr7/+Wv8NfgsgAODFfh+2z/gt3d8CGwkAeKFk5N41dn4L8HcCAF7kkZF79dj5LcD3BAC8wFdG7lVj57cAHxEAcLBnRu7osfNbgHsEABzsTEPntwD3CAA42JmGzm8B7hEAcLAzDZ3fAtwjAOBAR4zcUWPntwA/IwDgYGcaOb8FuOfb79f+ETDJmYbObwHuEQBwsDMNnd8C3CMA4GBnGjq/BbhHAMALnGnk/BbgIwIAXuRMI+e3AN8TAPBCZxo5vwX4OwEAL3amkfNbgD8JAHizMw2b3wJ7CQAAWEgAAMBCAgAAFhIAALCQAACAhQQAACz07c9r/xAA4D2+/f3aPwYAeA8BAAALCQAAWEgAAMBCAgAAFhIAALDQt++v/YMAgNf6YfwFAADMJwAAYCEBAAALfRgAIgAA5ro7/gIAAOYSAACwkAAAgIV+GgAiAADm+XT8BQAAzCMAAGAhAQAAC0UBIAIAYI54/AUAAMwhAABgoYcCQAQAwPU9PP4CAACu70sBIAIA4Lq+PP4CAACuSwAAwEJPBYAIAIDreXr8BQAAXM8hASACAOA6Dht/AQAA1yEAAGChQwNABADA+R0+/gIAAM7vJQEgAgDgvF42/gIAAM7rpQEgAgDgfF4+/gIAAM7nLQEgAgDgPN42/gIAAM7jrQEgAgCg7+3jLwIAoKs2/gIAAHqqASACAOD92tv/v2s/BADYpr39f137QQDAFu3N/+HaDwQApmtv/YfXfigAMF176+9e+8EAwFTtjf/02g8IAKZpb3t07YcEANO0tz2+9oMCgCnam/7wtR8YAFxde8u/fO0HBwBX1d7wp6798ADgqtob/vS1HyAAXE17uw+79oMEgKtob/bh136gAHB27a1+2bUfLACcVXujX3rthwsAZ9Xe6Jdf+wEDwNm0t/lt137QAHAW7U1++7UfOAC0tbe4du0HDwAt7Q2uX/sFAMC7tbf3NNd+EQDwLu3NPd21XwgAvFp7a0977RcDAK/S3tjTX/sFAcDR2tt6mWu/KAA4SntTL3ntlwYAX9Xe0Mtf+wUCwKPa2znm2i8SAFLtzRx37RcKAJ9pb+Xoa79cAPheexvXXPtFA8Cf2pu47tovHADaW7j62i8fgH3a2+f+uPaHAMAe7c1zH1z7owBgrvbGuU+u/YEAME9729wD1/5YALi+9pa5J6798QBwPe3tcgdd+0MC4Dram+VecO2PCoDzam+Ue8O1PzIAzqO9Sa5w7Y8OgJ72BrkTXPsjBOB92pvjTnrtDxOA47W3xV3o2h8rAM9rb4m7+LU/YABy7c1wA6/9UQNwX3sj3JJrf+gAGH13gmv/EQBs0P5f79yn1/4jAZig/b/cuaev/UcEcAXt/9XOvfXaf3AA79T+n+u+ffsvvceaczFgqLsAAAAASUVORK5CYII=">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%23C1614F'/><text y='72' x='50' text-anchor='middle' font-size='62' font-family='serif'>üé≠</text></svg>">
<style>
@font-face {
  font-family: 'OpenDyslexic';
  src: url('https://cdn.jsdelivr.net/npm/open-dyslexic@1.0.3/fonts/OpenDyslexic-Regular.otf') format('opentype');
}

:root {
  --sand: #F5ECD7;
  --sand-dark: #E8D9BC;
  --cream: #FAF4E8;
  --terra: #C1614F;
  --terra-light: #D4826F;
  --terra-dark: #A04F3E;
  --sage: #7A9E7E;
  --sage-light: #A3C4A8;
  --sage-dark: #5A7E5E;
  --brown: #4A3728;
  --brown-light: #6B5445;
  --amber: #E8A838;
  --amber-light: #F2C46A;
  --rose: #C4897A;
  --font: 'OpenDyslexic', 'Nunito', sans-serif;
  --display: 'Nunito', sans-serif;
  --r: 18px;
  --rs: 10px;
  --shadow: 0 4px 20px rgba(74,55,40,0.12);
  --shadow-lg: 0 8px 40px rgba(74,55,40,0.2);
}

*{margin:0;padding:0;box-sizing:border-box;}

body {
  font-family: var(--font);
  background: var(--sand);
  color: var(--brown);
  min-height: 100vh;
  overflow-x: hidden;
  font-size: 15px;
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display:none; min-height:100vh; flex-direction:column; animation: fadeIn 0.25s ease; }
.screen.active { display:flex; }
.game-screen { display:none; min-height:100vh; flex-direction:column; background:var(--sand); }
.game-screen.active { display:flex; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* ‚îÄ‚îÄ SCROLLABLE BODY ‚îÄ‚îÄ */
.scroll-content { flex:1; overflow-y:auto; padding:20px 20px 110px; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.app-header {
  background: var(--cream);
  padding: 50px 20px 14px;
  border-bottom: 2px solid var(--sand-dark);
  display: flex; align-items:center; justify-content:space-between;
  position: sticky; top:0; z-index:50;
  box-shadow: 0 2px 12px rgba(74,55,40,0.06);
}
.logo { font-family:var(--display); font-size:26px; font-weight:900; color:var(--terra); letter-spacing:-1px; }
.logo span { color:var(--sage); }

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav {
  position:fixed; bottom:0; left:0; right:0;
  background:var(--cream); border-top:2px solid var(--sand-dark);
  display:flex; justify-content:space-around; align-items:center;
  padding:8px 0 18px; z-index:100;
  box-shadow: 0 -4px 20px rgba(74,55,40,0.08);
}
.nav-btn {
  display:flex; flex-direction:column; align-items:center; gap:2px;
  background:none; border:none; cursor:pointer; padding:4px 6px;
  color:var(--brown-light); font-family:var(--font); font-size:9px; font-weight:700;
  border-radius:var(--rs); transition:all 0.2s;
}
.nav-btn.active { color:var(--terra); }
.nav-btn .ni { font-size:18px; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background:var(--cream); border-radius:var(--r); padding:20px;
  box-shadow:var(--shadow); margin-bottom:16px;
}
.section-title { font-size:17px; font-weight:900; margin-bottom:14px; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  border:none; border-radius:var(--rs); padding:14px 20px;
  font-family:var(--font); font-weight:900; font-size:14px;
  cursor:pointer; transition:all 0.2s; width:100%;
}
.btn-terra { background:var(--terra); color:white; }
.btn-terra:hover { background:var(--terra-dark); }
.btn-sage { background:var(--sage); color:white; }
.btn-sage:hover { background:var(--sage-dark); }
.btn-ghost { background:var(--sand); color:var(--brown); border:2px solid var(--sand-dark); }
.btn-ghost:hover { border-color:var(--terra); }
.btn-sm { padding:8px 16px; font-size:12px; width:auto; }

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero {
  border-radius:var(--r); padding:26px 22px; margin-bottom:20px;
  color:white; position:relative; overflow:hidden;
}
.hero-terra { background: linear-gradient(135deg, var(--terra), var(--rose)); }
.hero-brown { background: linear-gradient(135deg, var(--brown), var(--brown-light)); }
.hero-sage  { background: linear-gradient(135deg, var(--sage-dark), var(--sage)); }
.hero::before { content:attr(data-emoji); font-size:90px; position:absolute; right:-12px; top:-12px; opacity:0.15; pointer-events:none; }
.hero h2 { font-size:22px; font-weight:900; margin-bottom:6px; }
.hero p { font-size:13px; opacity:0.9; line-height:1.6; }
.hero-stats { display:flex; gap:12px; margin-top:16px; flex-wrap:wrap; }
.hstat { background:rgba(255,255,255,0.18); border-radius:var(--rs); padding:10px 14px; text-align:center; }
.hstat .n { font-size:20px; font-weight:900; }
.hstat .l { font-size:10px; opacity:0.85; }

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.prog-wrap { background:var(--sand-dark); border-radius:99px; height:8px; }
.prog-fill { height:8px; border-radius:99px; background:linear-gradient(90deg,var(--terra),var(--amber)); transition:width 0.4s; }
.prog-label { font-size:11px; color:var(--brown-light); margin-top:4px; }

/* ‚îÄ‚îÄ PRODUCTION CARDS ‚îÄ‚îÄ */
.prod-card {
  background:var(--cream); border-radius:var(--r); padding:16px 18px;
  box-shadow:var(--shadow); cursor:pointer; transition:transform 0.2s;
  display:flex; align-items:center; gap:14px; margin-bottom:12px;
  border-left:5px solid var(--terra);
}
.prod-card:nth-child(2){border-left-color:var(--sage);}
.prod-card:nth-child(3){border-left-color:var(--amber);}
.prod-card:hover{transform:translateY(-2px);}
.prod-icon{font-size:30px;}
.prod-info{flex:1;}
.prod-name{font-weight:900;font-size:15px;margin-bottom:2px;}
.prod-sub{font-size:11px;color:var(--brown-light);}

/* ‚îÄ‚îÄ QUICK ACTIONS ‚îÄ‚îÄ */
.qa-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px; }
.qa-btn {
  background:var(--cream); border-radius:var(--r); padding:18px 14px;
  box-shadow:var(--shadow); cursor:pointer; text-align:center;
  transition:transform 0.2s; border:none; font-family:var(--font);
}
.qa-btn:hover{transform:translateY(-2px);}
.qa-icon{font-size:28px;margin-bottom:8px;}
.qa-label{font-size:12px;font-weight:800;color:var(--brown);}

/* ‚îÄ‚îÄ TIMER WIDGET ‚îÄ‚îÄ */
.timer-widget {
  background:linear-gradient(135deg,var(--sage),var(--sage-dark));
  border-radius:var(--r); padding:18px 22px; margin-bottom:20px;
  color:white; display:flex; align-items:center; justify-content:space-between; cursor:pointer;
}
.tw-left h3{font-size:15px;font-weight:900;margin-bottom:3px;}
.tw-left p{font-size:12px;opacity:0.85;}
.tw-time{font-size:32px;font-weight:900;font-family:var(--display);letter-spacing:-1px;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SCRIPT IMPORT ‚Äî THE NEW SECTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* drag zone */
.import-zone {
  border:3px dashed var(--sand-dark); border-radius:var(--r);
  padding:36px 20px; text-align:center; cursor:pointer;
  transition:all 0.25s; background:var(--cream); margin-bottom:16px;
  position:relative;
}
.import-zone:hover, .import-zone.drag-over {
  border-color:var(--terra); background:rgba(193,97,79,0.05);
}
.import-zone input[type=file] {
  position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%;
}
.iz-icon{font-size:48px;margin-bottom:10px;}
.iz-title{font-size:17px;font-weight:900;margin-bottom:6px;}
.iz-sub{font-size:13px;color:var(--brown-light);line-height:1.5;}

/* import method tabs */
.import-tabs { display:flex; gap:8px; margin-bottom:16px; }
.itab {
  flex:1; padding:10px; border-radius:var(--rs); border:2px solid var(--sand-dark);
  background:var(--sand); font-family:var(--font); font-size:12px; font-weight:800;
  cursor:pointer; color:var(--brown); text-align:center; transition:all 0.2s;
}
.itab.active{background:var(--terra);color:white;border-color:var(--terra);}

.import-panel { display:none; }
.import-panel.active { display:block; }

/* paste area */
.paste-area {
  width:100%; min-height:180px; padding:16px; border-radius:var(--rs);
  border:2px solid var(--sand-dark); background:var(--sand);
  font-family:var(--font); font-size:14px; color:var(--brown);
  resize:vertical; outline:none; line-height:1.8; transition:border-color 0.2s;
}
.paste-area:focus{border-color:var(--terra);}
.paste-area::placeholder{color:var(--brown-light);}

/* character setup */
.char-setup {
  background:var(--cream); border-radius:var(--r); padding:20px;
  box-shadow:var(--shadow); margin-bottom:16px; display:none;
}
.char-setup.show{display:block; animation:fadeIn 0.3s ease;}
.char-setup h3{font-size:16px;font-weight:900;margin-bottom:12px;}
.char-input {
  width:100%; padding:14px 16px; border-radius:var(--rs);
  border:2px solid var(--sand-dark); background:var(--sand);
  font-family:var(--font); font-size:15px; color:var(--brown);
  outline:none; transition:border-color 0.2s; margin-bottom:12px;
}
.char-input:focus{border-color:var(--terra);}

/* detected characters */
.detected-chars { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:14px; }
.char-pill {
  padding:6px 14px; border-radius:99px; border:2px solid var(--sand-dark);
  background:var(--sand); font-family:var(--font); font-size:13px;
  font-weight:800; cursor:pointer; color:var(--brown); transition:all 0.2s;
}
.char-pill.selected{background:var(--terra);color:white;border-color:var(--terra);}

/* script reader */
.reader-toolbar {
  display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px;
}
.tool-btn {
  padding:7px 14px; border-radius:99px; border:2px solid var(--sand-dark);
  background:var(--sand); font-family:var(--font); font-size:11px;
  font-weight:800; cursor:pointer; color:var(--brown); transition:all 0.2s;
}
.tool-btn.active{background:var(--terra);color:white;border-color:var(--terra);}

.script-reader {
  background:var(--cream); border-radius:var(--r); padding:22px 18px;
  box-shadow:var(--shadow); line-height:2; display:none;
}
.script-reader.show{display:block;}
.script-block{margin-bottom:18px;}
.s-charname{font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1.5px;color:var(--brown-light);margin-bottom:4px;}
.s-myline{background:rgba(193,97,79,0.1);border-left:4px solid var(--terra);padding:10px 14px;border-radius:0 var(--rs) var(--rs) 0;font-size:var(--script-fs,16px);}
.s-otherline{padding:4px 0;color:var(--brown-light);font-size:calc(var(--script-fs,16px) - 1px);}
.clickword{cursor:pointer;border-radius:3px;transition:background 0.15s;display:inline;}
.clickword:hover{background:var(--amber-light);}

/* empty state */
.empty-state{text-align:center;padding:40px 20px;color:var(--brown-light);}
.empty-state .es-icon{font-size:52px;margin-bottom:12px;}
.empty-state p{font-size:14px;line-height:1.6;}

/* ‚îÄ‚îÄ PRACTICE ‚îÄ‚îÄ */
.pm-card {
  background:var(--cream); border-radius:var(--r); padding:16px 18px;
  box-shadow:var(--shadow); cursor:pointer; transition:transform 0.2s;
  display:flex; align-items:center; gap:14px; margin-bottom:12px;
}
.pm-card:hover{transform:translateY(-2px);}
.pm-icon{font-size:32px;}
.pm-info{flex:1;}
.pm-name{font-weight:900;font-size:15px;margin-bottom:2px;}
.pm-desc{font-size:11px;color:var(--brown-light);line-height:1.4;}
.pm-arrow{font-size:20px;color:var(--brown-light);}

/* ‚îÄ‚îÄ CUE CARDS ‚îÄ‚îÄ */
.cue-header{background:var(--cream);padding:50px 20px 14px;border-bottom:2px solid var(--sand-dark);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:50;}
.back-btn{background:none;border:none;font-size:26px;cursor:pointer;color:var(--brown);line-height:1;}
.cue-body{flex:1;padding:20px 20px 110px;display:flex;flex-direction:column;gap:14px;}

.cue-box{background:var(--cream);border-radius:var(--r);padding:22px;box-shadow:var(--shadow);}
.cue-lbl{font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:1.5px;color:var(--brown-light);margin-bottom:8px;}
.cue-txt{font-size:16px;line-height:1.8;}

.myline-reveal {
  background:var(--cream); border-radius:var(--r); padding:22px;
  box-shadow:var(--shadow); border:2px solid var(--sand-dark);
  min-height:90px; cursor:pointer; transition:all 0.2s;
  display:flex; align-items:center; justify-content:center; text-align:center;
}
.myline-reveal.shown{background:rgba(122,158,126,0.08);border-color:var(--sage);}
.reveal-hint{color:var(--brown-light);font-size:14px;}
.reveal-txt{font-size:16px;line-height:1.8;display:none;}

.voice-btn{
  background:var(--terra); color:white; border:none;
  border-radius:var(--rs); padding:15px; font-family:var(--font);
  font-weight:900; font-size:14px; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px;
  width:100%; transition:all 0.2s;
}
.voice-btn.listening{background:var(--sage);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}

.feedback-row{display:flex;gap:10px;}
.fb-btn{
  flex:1; padding:13px; border-radius:var(--rs); border:none;
  font-family:var(--font); font-weight:900; font-size:13px; cursor:pointer;
}
.fb-wrong{background:#F5D0CA;color:var(--terra-dark);}
.fb-close{background:var(--amber-light);color:#7A5500;}
.fb-right{background:rgba(122,158,126,0.25);color:var(--sage-dark);}

.result-banner{border-radius:var(--rs);padding:14px 18px;font-weight:900;font-size:14px;text-align:center;display:none;line-height:1.5;}
.res-good{background:rgba(122,158,126,0.2);color:var(--sage-dark);display:block;}
.res-bad{background:rgba(193,97,79,0.12);color:var(--terra-dark);display:block;}

.next-btn{background:var(--terra);color:white;border:none;border-radius:var(--rs);padding:15px;font-family:var(--font);font-weight:900;font-size:15px;cursor:pointer;width:100%;display:none;transition:background 0.2s;}
.next-btn.show{display:block;}
.next-btn:hover{background:var(--terra-dark);}

/* word analysis */
.word-analysis{background:var(--cream);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);display:none;font-size:13px;line-height:1.8;}
.word-analysis.show{display:block;}
.w-correct{color:var(--sage-dark);font-weight:800;}
.w-wrong{color:var(--terra-dark);font-weight:800;text-decoration:underline wavy var(--terra);}
.w-missing{background:rgba(193,97,79,0.15);border-radius:3px;padding:1px 4px;color:var(--terra-dark);font-weight:800;}

/* ‚îÄ‚îÄ GAME CENTER ‚îÄ‚îÄ */
.gc-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
.gc-card{
  border-radius:var(--r); padding:18px 14px; cursor:pointer;
  transition:transform 0.2s; box-shadow:var(--shadow); position:relative; overflow:hidden;
}
.gc-card:hover{transform:translateY(-3px);}
.gc-1{background:linear-gradient(135deg,#E8C4A0,#D4A070);}
.gc-2{background:linear-gradient(135deg,var(--sage-light),var(--sage));}
.gc-3{background:linear-gradient(135deg,#D4A4B4,#B87090);}
.gc-4{background:linear-gradient(135deg,#A0C4D4,#6090B0);}
.gc-icon{font-size:32px;margin-bottom:8px;}
.gc-name{font-size:13px;font-weight:900;color:var(--brown);margin-bottom:3px;}
.gc-desc{font-size:10px;color:var(--brown-light);line-height:1.4;}
.gc-best{position:absolute;top:10px;right:10px;font-size:9px;font-weight:900;color:var(--brown-light);}

.daily-chal {
  background:linear-gradient(135deg,var(--amber),var(--terra));
  border-radius:var(--r); padding:18px 22px; margin-bottom:20px;
  color:white; display:flex; align-items:center; justify-content:space-between;
  cursor:pointer; transition:transform 0.2s;
}
.daily-chal:hover{transform:translateY(-2px);}
.dc-info h3{font-size:15px;font-weight:900;margin-bottom:3px;}
.dc-info p{font-size:12px;opacity:0.9;}

.xp-card{background:var(--cream);border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow);margin-bottom:20px;}
.xp-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.xp-ttl{font-size:15px;font-weight:900;}
.xp-lvl{background:var(--terra);color:white;border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;}
.xp-bar{background:var(--sand);border-radius:99px;height:10px;margin-bottom:6px;}
.xp-fill{height:10px;border-radius:99px;background:linear-gradient(90deg,var(--terra),var(--amber));width:65%;}
.badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
.badge{background:var(--sand);border-radius:var(--rs);padding:8px 12px;text-align:center;}
.badge-lbl{font-size:9px;color:var(--brown-light);font-weight:700;margin-top:2px;}

/* source selector */
.src-tabs{display:flex;gap:10px;margin-bottom:16px;}
.src-tab{flex:1;padding:10px;border-radius:var(--rs);border:2px solid var(--sand-dark);background:var(--sand);font-family:var(--font);font-size:12px;font-weight:800;cursor:pointer;color:var(--brown);text-align:center;transition:all 0.2s;}
.src-tab.active{background:var(--terra);color:white;border-color:var(--terra);}

/* ‚îÄ‚îÄ FILL IN BLANK GAME ‚îÄ‚îÄ */
.game-header{background:var(--cream);padding:50px 20px 14px;border-bottom:2px solid var(--sand-dark);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:50;}
.game-body{flex:1;padding:20px 20px 110px;display:flex;flex-direction:column;gap:14px;}
.score-strip{display:flex;gap:8px;flex-wrap:wrap;}
.pill{border-radius:99px;padding:6px 14px;font-size:12px;font-weight:900;}
.pill-terra{background:var(--terra);color:white;}
.pill-amber{background:var(--amber);color:var(--brown);}
.pill-sage{background:var(--sage);color:white;}

.game-line-card{background:var(--cream);border-radius:var(--r);padding:22px;box-shadow:var(--shadow);font-size:18px;line-height:2;}
.blank{display:inline-block;min-width:80px;border-bottom:3px solid var(--terra);margin:0 3px;text-align:center;font-weight:900;color:var(--terra);padding:0 6px;}
.blank.filled-ok{color:var(--sage-dark);border-color:var(--sage);}
.blank.filled-bad{color:var(--terra-dark);animation:shake 0.3s;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

.word-opts{display:flex;flex-wrap:wrap;gap:10px;}
.wopt{
  background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;
  padding:8px 18px;font-family:var(--font);font-size:13px;font-weight:700;
  cursor:pointer;color:var(--brown);transition:all 0.2s;
}
.wopt:hover{background:var(--terra);color:white;border-color:var(--terra);}
.wopt:disabled{opacity:0.45;pointer-events:none;}

/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
.set-sec{background:var(--cream);border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow);margin-bottom:14px;}
.set-sec h3{font-size:15px;font-weight:900;margin-bottom:14px;}
.set-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--sand);}
.set-row:last-child{border-bottom:none;}
.set-name{font-size:13px;font-weight:800;}
.set-desc{font-size:10px;color:var(--brown-light);margin-top:2px;}
.toggle{width:46px;height:24px;border-radius:99px;background:var(--sand-dark);position:relative;cursor:pointer;transition:background 0.2s;border:none;flex-shrink:0;}
.toggle.on{background:var(--sage);}
.toggle::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:white;top:3px;left:3px;transition:left 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.2);}
.toggle.on::after{left:25px;}
.fs-ctrl{display:flex;align-items:center;gap:10px;}
.fs-btn{background:var(--sand);border:2px solid var(--sand-dark);width:32px;height:32px;border-radius:99px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:var(--font);color:var(--brown);font-weight:900;}
.swatches{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.swatch{width:34px;height:34px;border-radius:99px;cursor:pointer;border:3px solid transparent;transition:border-color 0.2s;}
.swatch.active{border-color:var(--brown);}
.theme-card{background:var(--sand);border:3px solid var(--sand-dark);border-radius:var(--rs);padding:12px;cursor:pointer;transition:all 0.2s;}
.theme-card.active{border-color:var(--terra);background:rgba(193,97,79,0.08);}
.theme-card:hover{border-color:var(--terra-light);}

/* ‚îÄ‚îÄ HANDS-FREE / SCENE PARTNER / SPEED DRILL SCREENS ‚îÄ‚îÄ */
.hf-screen{background:var(--sand);min-height:100vh;display:none;flex-direction:column;}
.hf-screen.active{display:flex;}
.hf-header{background:var(--cream);padding:50px 20px 14px;border-bottom:2px solid var(--sand-dark);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:50;}
.hf-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;gap:20px;text-align:center;}
.hf-cue-card{background:var(--cream);border-radius:var(--r);padding:24px;box-shadow:var(--shadow-lg);width:100%;max-width:500px;}
.hf-cue-label{font-size:11px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.hf-cue-text{font-size:18px;font-weight:700;line-height:1.6;color:var(--brown);}
.hf-status{font-size:14px;font-weight:900;color:var(--brown-light);min-height:28px;}
.hf-big-btn{width:88px;height:88px;border-radius:50%;border:none;font-size:32px;cursor:pointer;box-shadow:var(--shadow-lg);transition:transform 0.1s;}
.hf-big-btn:active{transform:scale(0.94);}
.hf-big-btn.listening{background:var(--terra);animation:pulse 1s infinite;}
.hf-big-btn.idle{background:var(--sage);}
.hf-big-btn.speaking{background:var(--amber);}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(193,97,79,0.4)}50%{box-shadow:0 0 0 20px rgba(193,97,79,0)}}
.hf-result{border-radius:var(--rs);padding:12px 16px;font-size:14px;font-weight:800;width:100%;max-width:500px;}
.hf-result.good{background:rgba(39,174,96,0.15);color:#1a7a40;}
.hf-result.close{background:rgba(232,168,56,0.15);color:#a07010;}
.hf-result.wrong{background:rgba(193,97,79,0.12);color:var(--terra-dark);}
.hf-controls{display:flex;gap:12px;width:100%;max-width:500px;}
.sp-other-line{background:var(--sand-dark);border-radius:var(--rs);padding:14px 18px;font-size:15px;font-weight:700;line-height:1.6;color:var(--brown-light);font-style:italic;width:100%;max-width:500px;text-align:left;}
.sp-char-name{font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:1px;color:var(--brown-light);margin-bottom:4px;}

/* ‚îÄ‚îÄ SPEED DRILL ‚îÄ‚îÄ */
.sd-timer{font-size:72px;font-weight:900;color:var(--terra);font-family:monospace;line-height:1;}
.sd-best{font-size:12px;font-weight:800;color:var(--brown-light);}
.sd-line-card{background:var(--cream);border-radius:var(--r);padding:20px 22px;box-shadow:var(--shadow-lg);width:100%;max-width:500px;}
.sd-scene-tag{font-size:10px;font-weight:900;color:var(--sage-dark);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}

/* ‚îÄ‚îÄ PROGRESS DASHBOARD ‚îÄ‚îÄ */
.prog-dash{background:var(--sand);min-height:100vh;display:none;flex-direction:column;}
.prog-dash.active{display:flex;}
.scene-progress-bar{height:10px;background:var(--sand-dark);border-radius:99px;overflow:hidden;margin-top:6px;}
.scene-progress-fill{height:100%;border-radius:99px;background:var(--sage);transition:width 0.6s;}
.conf-pill{display:inline-block;border-radius:99px;padding:3px 10px;font-size:10px;font-weight:900;cursor:pointer;border:none;font-family:var(--font);}
.conf-shaky{background:rgba(193,97,79,0.15);color:var(--terra-dark);}
.conf-getting{background:rgba(232,168,56,0.15);color:#a07010;}
.conf-solid{background:rgba(122,158,126,0.15);color:var(--sage-dark);}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(74,55,40,0.55);z-index:300;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-sheet{background:var(--cream);border-radius:var(--r) var(--r) 0 0;padding:28px 22px 44px;width:100%;max-width:580px;animation:slideUp 0.3s ease;}
@keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-size:20px;font-weight:900;margin-bottom:20px;text-align:center;}
.timer-big{font-size:68px;font-weight:900;font-family:var(--display);text-align:center;color:var(--terra);margin:16px 0;letter-spacing:-2px;}
.timer-mode{text-align:center;font-size:13px;color:var(--brown-light);font-weight:700;margin-bottom:16px;}
.break-opts{display:flex;gap:10px;margin-bottom:18px;}
.break-opt{flex:1;padding:12px;border-radius:var(--rs);border:2px solid var(--sand-dark);background:var(--sand);font-family:var(--font);font-weight:900;font-size:13px;cursor:pointer;color:var(--brown);text-align:center;transition:all 0.2s;}
.break-opt.active{border-color:var(--sage);background:rgba(122,158,126,0.15);color:var(--sage-dark);}
.timer-ctrl-row{display:flex;gap:10px;}
.tcbtn{flex:1;padding:14px;border-radius:var(--rs);border:none;font-family:var(--font);font-weight:900;font-size:14px;cursor:pointer;}
.tcbtn-go{background:var(--terra);color:white;}
.tcbtn-stop{background:var(--sand);color:var(--brown);}

/* ‚îÄ‚îÄ DICT POPUP ‚îÄ‚îÄ */
.dict-pop{display:none;position:fixed;bottom:88px;left:16px;right:16px;background:var(--brown);color:white;border-radius:var(--r);padding:20px 22px;z-index:200;box-shadow:var(--shadow-lg);animation:slideUp 0.25s ease;}
.dict-pop.show{display:block;}
.dict-word{font-size:20px;font-weight:900;margin-bottom:3px;}
.dict-pron{font-size:12px;color:var(--amber-light);margin-bottom:8px;}
.dict-def{font-size:13px;line-height:1.6;}
.dict-close{position:absolute;top:10px;right:14px;background:none;border:none;color:white;font-size:22px;cursor:pointer;line-height:1;}
.dict-speak-btn{background:var(--terra);border:none;color:white;border-radius:99px;padding:6px 16px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;margin-top:10px;}

/* ‚îÄ‚îÄ TOAST & STREAK ‚îÄ‚îÄ */
.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-16px);background:var(--brown);color:white;padding:10px 22px;border-radius:99px;font-weight:900;font-size:13px;z-index:400;opacity:0;transition:all 0.3s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.streak-fx{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:80px;z-index:500;pointer-events:none;opacity:0;transition:all 0.4s;}
.streak-fx.pop{opacity:1;transform:translate(-50%,-65%);}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(min-width:600px){
  body{max-width:480px;margin:0 auto;}
  .bottom-nav,.modal-overlay{max-width:480px;left:50%;right:auto;width:480px;transform:translateX(-50%);}
  .dict-pop{left:calc(50% - 224px);right:auto;width:448px;}
  .toast{max-width:440px;}
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>

<div class="toast" id="toast"></div>
<div class="streak-fx" id="streakFx">üî•</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="homeScreen">
  <div class="app-header">
    <div class="logo">Esco<span>Mind</span></div>
    <button onclick="openTimer()" style="background:var(--sage);border:none;color:white;border-radius:99px;padding:8px 16px;font-family:var(--font);font-weight:800;font-size:12px;cursor:pointer;">‚è± Timer</button>
  </div>
  <div class="scroll-content">

    <div class="hero hero-terra" data-emoji="üé≠">
      <h2 id="heroGreeting">Welcome to EscoMind! üé≠</h2>
      <p id="heroSubtitle">Upload your first script to get started.</p>
      <div class="hero-stats">
        <div class="hstat"><div class="n" id="heroStreak">0üî•</div><div class="l">Day Streak</div></div>
        <div class="hstat"><div class="n" id="heroXP">0</div><div class="l">XP Total</div></div>
        <div class="hstat"><div class="n" id="homeLinesLearned">0</div><div class="l">Lines Learned</div></div>
      </div>
    </div>

    <div class="section-title">My Productions</div>
    <div id="homeProductions">
      <div class="empty-state">
        <div class="es-icon">üé≠</div>
        <p>No productions yet.<br>Upload your first script to get started!</p>
        <br>
        <button class="btn btn-terra btn-sm" onclick="navTo('scriptScreen',1)" style="width:auto;padding:10px 24px;">Upload Script</button>
      </div>
    </div>

    <div class="section-title">Quick Actions</div>
    <div class="qa-grid">
      <button class="qa-btn" onclick="navTo('practiceScreen',2)"><div class="qa-icon">üìö</div><div class="qa-label">Practice Lines</div></button>
      <button class="qa-btn" onclick="navTo('gameScreen',3)"><div class="qa-icon">üéÆ</div><div class="qa-label">Game Center</div></button>
      <button class="qa-btn" onclick="navTo('scriptScreen',1)"><div class="qa-icon">üìÑ</div><div class="qa-label">Scripts</div></button>
      <button class="qa-btn" onclick="openTimer()"><div class="qa-icon">‚è±</div><div class="qa-label">Study Timer</div></button>
    </div>

    <div class="xp-card">
      <div class="xp-hdr"><div class="xp-ttl" id="xpLevelLabel">Level 1 ‚Äî Just Starting üå±</div><div class="xp-lvl" id="xpTotal">0 XP</div></div>
      <div class="xp-bar"><div class="xp-fill" id="xpBar" style="width:0%"></div></div>
      <div style="font-size:11px;color:var(--brown-light);" id="xpNext">100 XP to Level 2</div>
      <div class="badges" id="homeBadges">
        <div style="font-size:12px;color:var(--brown-light);padding:8px 0;">Earn badges by practising and playing games! üèÖ</div>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scriptScreen">

  <!-- LIBRARY VIEW -->
  <div id="scriptHome">
    <div class="app-header">
      <div class="logo">Esco<span>Mind</span></div>
      <button onclick="showScriptUpload()" style="background:var(--terra);border:none;color:white;border-radius:99px;padding:8px 16px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">+ Upload</button>
    </div>
    <div class="scroll-content">
      <div class="section-title">My Scripts üìÑ</div>
      <div id="scriptLibrary">
        <div class="empty-state"><div class="es-icon">üìÑ</div><p>No scripts yet.<br>Upload your first script!</p><br>
        <button class="btn btn-terra btn-sm" onclick="showScriptUpload()" style="width:auto;padding:10px 24px;">+ Upload Script</button></div>
      </div>
    </div>
  </div>

  <!-- UPLOAD VIEW -->
  <div id="scriptUploadView" style="display:none;">
    <div class="app-header">
      <button class="back-btn" onclick="showScriptHome()">‚Äπ</button>
      <div style="font-size:17px;font-weight:900;">Add Script</div>
    </div>
    <div class="scroll-content">
      <div class="import-tabs">
        <button class="itab active" onclick="switchImportTab('upload',this)">üìÇ Upload</button>
        <button class="itab" onclick="switchImportTab('paste',this)">üìã Paste</button>
        <button class="itab" onclick="switchImportTab('manual',this)">‚úèÔ∏è Manual</button>
      </div>

      <!-- UPLOAD PANEL -->
      <div class="import-panel active" id="uploadPanel">
        <div class="import-zone" id="dropZone">
          <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.rtf" onchange="handleFileUpload(this)">
          <div class="iz-icon">üìÇ</div>
          <div class="iz-title">Upload Your Script</div>
          <div class="iz-sub">Tap to choose a file ‚Äî or drag and drop here<br><strong>PDF ¬∑ TXT ¬∑ Word Doc ¬∑ RTF</strong><br><br>üì± From your phone:<br>Files app ¬∑ Google Drive ¬∑ AirDrop ¬∑ iCloud</div>
        </div>
      </div>

      <!-- PASTE PANEL -->
      <div class="import-panel" id="pastePanel">
        <div class="card">
          <div style="font-size:13px;font-weight:800;margin-bottom:10px;">Paste your script below:</div>
          <textarea class="paste-area" id="pasteArea" placeholder="Copy your script from Google Docs, Notes, or email and paste here.&#10;&#10;EscoMind will detect all characters automatically.&#10;&#10;Format:&#10;ELI&#10;Take out your phones.&#10;&#10;BROTHER 1&#10;Yo the fuck, Eli..."></textarea>
          <button class="btn btn-terra" style="margin-top:12px;" onclick="processScript('paste')">üîç Analyse Script</button>
        </div>
      </div>

      <!-- MANUAL ENTRY PANEL -->
      <div class="import-panel" id="manualPanel">
        <div class="card" id="manualStep1">
          <div style="font-size:16px;font-weight:900;margin-bottom:6px;">‚úèÔ∏è Enter Lines Manually</div>
          <div style="font-size:13px;color:var(--brown-light);margin-bottom:16px;line-height:1.6;">Perfect for watermarked or locked PDFs. Add one cue and one line at a time.</div>
          <div style="font-size:13px;font-weight:800;margin-bottom:8px;">What's your character name?</div>
          <input class="char-input" id="manualCharName" type="text" placeholder="e.g. ELI">
          <button class="btn btn-terra" style="margin-top:10px;" onclick="startManualEntry()">Let's go ‚Üí</button>
        </div>
        <div id="manualStep2" style="display:none;">
          <div class="card" style="background:linear-gradient(135deg,var(--terra),var(--rose));color:white;margin-bottom:14px;">
            <div style="font-size:14px;font-weight:900;margin-bottom:4px;">Adding lines for: <span id="manualCharDisplay"></span></div>
            <div style="font-size:12px;opacity:0.9;"><span id="manualLineCount">0</span> lines ¬∑ Scene: <span id="manualCurrentSceneName">Scene 1</span></div>
          </div>
          <div id="manualSceneBanner" style="background:var(--sage);color:white;border-radius:var(--rs);padding:10px 16px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;">
            <div><div style="font-size:11px;font-weight:900;opacity:0.85;text-transform:uppercase;letter-spacing:1px;">Currently entering:</div><div style="font-size:15px;font-weight:900;" id="manualSceneBannerName">Scene 1</div></div>
            <button onclick="newScene()" style="background:rgba(255,255,255,0.25);border:none;color:white;border-radius:99px;padding:8px 16px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">+ New Scene</button>
          </div>
          <div class="card" style="margin-bottom:14px;">
            <div style="font-size:13px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">üì£ Cue ‚Äî line just before yours:</div>
            <textarea class="paste-area" id="manualCueInput" style="min-height:70px;" placeholder="What does the other character say just before you speak?"></textarea>
            <div style="font-size:13px;font-weight:900;color:var(--terra);text-transform:uppercase;letter-spacing:1px;margin:14px 0 8px;">üé≠ Your line:</div>
            <textarea class="paste-area" id="manualLineInput" style="min-height:70px;border-color:var(--terra);" placeholder="Type your line exactly as it appears in the script."></textarea>
            <div style="display:flex;gap:10px;margin-top:12px;">
              <button class="btn btn-terra" style="flex:2;" onclick="addManualLine()">‚ûï Add Line</button>
              <button class="btn btn-ghost" style="flex:1;" onclick="finishManualEntry()">‚úÖ Done</button>
            </div>
          </div>
          <div id="manualLinesList" style="display:none;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
              <div class="section-title" style="font-size:14px;margin-bottom:0;">Lines Added üìã</div>
              <button class="btn btn-sage btn-sm" onclick="finishManualEntry()">‚úÖ Save</button>
            </div>
            <div id="manualSceneTabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;"></div>
            <div id="manualLinesListInner"></div>
          </div>
        </div>
      </div>

      <!-- PDF PAGE TOOLS -->
      <div id="pdfToolsSection" style="display:none;">
        <div class="card" style="margin-bottom:14px;background:linear-gradient(135deg,#1a1a2e,#16213e);color:white;">
          <div style="font-size:15px;font-weight:900;margin-bottom:4px;">üìÑ PDF Page Tools</div>
          <div style="font-size:12px;opacity:0.85;line-height:1.5;">Fix scanned or photographed scripts before importing ‚Äî rotate sideways pages, crop borders, tint for easier reading, or reorder pages.</div>
        </div>

        <!-- Page thumbnails grid -->
        <div style="font-size:12px;font-weight:900;color:var(--brown);margin-bottom:8px;">Pages ‚Äî tap to select, then apply a tool:</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;" id="pdfPageGrid"></div>

        <!-- Selection controls -->
        <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" onclick="pdfSelectAll()" style="flex:1;min-width:80px;">Select All</button>
          <button class="btn btn-ghost btn-sm" onclick="pdfSelectNone()" style="flex:1;min-width:80px;">Deselect All</button>
          <span id="pdfSelCount" style="font-size:12px;font-weight:900;color:var(--brown-light);align-self:center;min-width:80px;text-align:center;">0 selected</span>
        </div>

        <!-- Tool buttons -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
          <!-- ROTATE -->
          <div class="card" style="padding:12px;">
            <div style="font-size:13px;font-weight:900;margin-bottom:8px;">‚Ü© Rotating Pages</div>
            <div style="display:flex;gap:6px;">
              <button class="btn btn-sage btn-sm" style="flex:1;" onclick="pdfRotate(-90)">‚Ü∫ 90¬∞ L</button>
              <button class="btn btn-sage btn-sm" style="flex:1;" onclick="pdfRotate(90)">‚Üª 90¬∞ R</button>
              <button class="btn btn-sage btn-sm" style="flex:1;" onclick="pdfRotate(180)">‚Üï 180¬∞</button>
            </div>
          </div>

          <!-- CROP -->
          <div class="card" style="padding:12px;">
            <div style="font-size:13px;font-weight:900;margin-bottom:8px;">‚úÇ Cropping Pages</div>
            <div style="font-size:11px;color:var(--brown-light);margin-bottom:6px;">Remove border (% each side):</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">
              <input type="number" id="cropTop" placeholder="Top %" min="0" max="40" value="5" style="padding:4px 6px;border:1px solid var(--sand-dark);border-radius:var(--rs);font-family:var(--font);font-size:11px;width:100%;">
              <input type="number" id="cropBottom" placeholder="Bottom %" min="0" max="40" value="5" style="padding:4px 6px;border:1px solid var(--sand-dark);border-radius:var(--rs);font-family:var(--font);font-size:11px;width:100%;">
              <input type="number" id="cropLeft" placeholder="Left %" min="0" max="40" value="5" style="padding:4px 6px;border:1px solid var(--sand-dark);border-radius:var(--rs);font-family:var(--font);font-size:11px;width:100%;">
              <input type="number" id="cropRight" placeholder="Right %" min="0" max="40" value="5" style="padding:4px 6px;border:1px solid var(--sand-dark);border-radius:var(--rs);font-family:var(--font);font-size:11px;width:100%;">
            </div>
            <button class="btn btn-terra btn-sm" style="width:100%;margin-top:6px;" onclick="pdfCrop()">‚úÇ Apply Crop</button>
          </div>

          <!-- TINT -->
          <div class="card" style="padding:12px;">
            <div style="font-size:13px;font-weight:900;margin-bottom:8px;">üé® Tinting Pages</div>
            <div style="font-size:11px;color:var(--brown-light);margin-bottom:6px;">Overlay colour for easier reading:</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;">
              <button onclick="pdfTint('#FFF9C4',0.25,this)" style="background:#FFF9C4;border:2px solid #ccc;border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;cursor:pointer;color:#333;">Yellow</button>
              <button onclick="pdfTint('#E8F5E9',0.25,this)" style="background:#E8F5E9;border:2px solid #ccc;border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;cursor:pointer;color:#333;">Green</button>
              <button onclick="pdfTint('#E3F2FD',0.25,this)" style="background:#E3F2FD;border:2px solid #ccc;border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;cursor:pointer;color:#333;">Blue</button>
              <button onclick="pdfTint('#FCE4EC',0.25,this)" style="background:#FCE4EC;border:2px solid #ccc;border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;cursor:pointer;color:#333;">Pink</button>
              <button onclick="pdfTint(null,0,this)" style="background:white;border:2px solid #ccc;border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;cursor:pointer;color:#333;">None</button>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:10px;color:var(--brown-light);">Strength:</span>
              <input type="range" id="tintStrength" min="0.05" max="0.5" step="0.05" value="0.25" style="flex:1;" oninput="document.getElementById('tintStrengthVal').textContent=Math.round(this.value*100)+'%'">
              <span id="tintStrengthVal" style="font-size:10px;font-weight:900;min-width:30px;">25%</span>
            </div>
          </div>

          <!-- COLLATE / REORDER -->
          <div class="card" style="padding:12px;">
            <div style="font-size:13px;font-weight:900;margin-bottom:8px;">üìã Collating Pages</div>
            <div style="font-size:11px;color:var(--brown-light);margin-bottom:6px;">Drag thumbnails above to reorder, or:</div>
            <button class="btn btn-ghost btn-sm" style="width:100%;margin-bottom:6px;" onclick="pdfMoveUp()">‚Üë Move selected up</button>
            <button class="btn btn-ghost btn-sm" style="width:100%;margin-bottom:6px;" onclick="pdfMoveDown()">‚Üì Move selected down</button>
            <button class="btn btn-terra btn-sm" style="width:100%;" onclick="pdfDeletePages()">üóë Delete selected</button>
          </div>
        </div>

        <!-- Preview selected page -->
        <div id="pdfPreviewArea" style="display:none;margin-bottom:14px;">
          <div style="font-size:12px;font-weight:900;color:var(--brown);margin-bottom:8px;">Preview:</div>
          <canvas id="pdfPreviewCanvas" style="width:100%;border-radius:var(--rs);box-shadow:var(--shadow);max-height:400px;object-fit:contain;"></canvas>
        </div>

        <!-- Action buttons -->
        <div style="display:flex;gap:10px;margin-bottom:8px;">
          <button class="btn btn-ghost" style="flex:1;" onclick="pdfPreviewSelected()">üëÅ Preview</button>
          <button class="btn btn-terra" style="flex:2;" onclick="pdfDoneEditing()">‚úÖ Done ‚Äî Import Script</button>
        </div>
        <button onclick="hidePdfTools()" style="background:none;border:2px solid var(--sand-dark);border-radius:99px;padding:8px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;color:var(--brown-light);width:100%;">‚úï Cancel</button>
      </div>

      <!-- CHARACTER SETUP -->
      <div class="char-setup" id="charSetup">
        <h3>üé≠ Who are you playing?</h3>
        <div style="font-size:13px;color:var(--brown-light);margin-bottom:12px;">Characters found in your script ‚Äî tap yours, or type below:</div>
        <div class="detected-chars" id="detectedChars"></div>
        <input class="char-input" id="myCharInput" type="text" placeholder="Or type your character name..." oninput="highlightTypedChar(this.value)">
        <button class="btn btn-terra" onclick="confirmCharacter()">‚úÖ That's me ‚Äî Show My Lines</button>
      </div>

      <!-- SCENE SPLITTER -->
      <div id="sceneSplitterSection" style="display:none;">
        <div class="card" style="margin-bottom:14px;background:linear-gradient(135deg,var(--sage),var(--sage-dark));color:white;">
          <div style="font-size:15px;font-weight:900;margin-bottom:6px;">üìç Split into Scenes</div>
          <div style="font-size:12px;opacity:0.9;line-height:1.6;">Tap anywhere to add a scene divider. Name each scene. When done, tap Save Scenes.</div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
          <button class="btn btn-sage" style="flex:1;" onclick="saveSplitScenes()">‚úÖ Save Scenes</button>
          <button class="btn btn-ghost" style="flex:1;" onclick="skipSceneSplit()">Skip ‚Äî No Scenes</button>
        </div>
        <div id="splitterScript" style="background:var(--cream);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);"></div>
      </div>

      <!-- READER -->
      <div id="readerSection" style="display:none;">
        <div class="reader-toolbar">
          <button class="tool-btn active" id="fontToggle" onclick="toggleFont(this)">OpenDyslexic</button>
          <button class="tool-btn" onclick="changeFontSize(1,this)">A+</button>
          <button class="tool-btn" onclick="changeFontSize(-1,this)">A‚àí</button>
          <button class="tool-btn" id="ttsToggle" onclick="readAloud()">üîä Read</button>
          <button class="tool-btn" id="myLinesOnly" onclick="toggleMyLinesOnly(this)">My Lines Only</button>
        </div>
        <!-- TTS speed control -->
        <div style="display:flex;align-items:center;gap:10px;background:var(--sand);border-radius:var(--rs);padding:10px 14px;margin-bottom:10px;">
          <span style="font-size:12px;font-weight:900;color:var(--brown-light);">Speed:</span>
          <input type="range" id="ttsSpeedSlider" min="0.5" max="2" step="0.1" value="0.85" style="flex:1;" oninput="updateTTSSpeed(this.value)">
          <span id="ttsSpeedLabel" style="font-size:12px;font-weight:900;color:var(--brown);min-width:32px;">0.9x</span>
          <button onclick="stopReading()" style="background:var(--terra);color:white;border:none;border-radius:99px;padding:5px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);">‚èπ Stop</button>
        </div>
        <div class="script-reader show" id="scriptReader"></div>
      </div>

    </div><!-- scroll-content -->
  </div><!-- scriptUploadView -->

  <!-- SCRIPT DETAIL VIEW -->
  <div id="scriptDetailView" style="display:none;">
    <div class="app-header">
      <button class="back-btn" onclick="showScriptHome()">‚Äπ</button>
      <div style="flex:1;">
        <div style="font-size:17px;font-weight:900;" id="detailTitle">Script</div>
        <div style="font-size:11px;color:var(--brown-light);" id="detailSub">Loading...</div>
      </div>
      <button onclick="deleteCurrentScript()" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;" title="Delete script">üóë</button>
    </div>
    <div class="scroll-content">
      <!-- Action buttons -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;">
        <button onclick="practiceCurrentScript()" style="background:var(--sage);color:white;border:none;border-radius:var(--r);padding:16px 8px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;text-align:center;"><div style="font-size:24px;margin-bottom:4px;">üìö</div>Practice</button>
        <button onclick="editCurrentScript()" style="background:var(--amber);color:var(--brown);border:none;border-radius:var(--r);padding:16px 8px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;text-align:center;"><div style="font-size:24px;margin-bottom:4px;">‚úèÔ∏è</div>Edit</button>
        <button onclick="gameCurrentScript()" style="background:var(--terra);color:white;border:none;border-radius:var(--r);padding:16px 8px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;text-align:center;"><div style="font-size:24px;margin-bottom:4px;">üéÆ</div>Games</button>
      </div>

      <!-- Character label -->
      <div id="detailCharBadge" style="margin-bottom:16px;"></div>

      <!-- Script reader with highlighting -->
      <div id="detailReaderToolbar" style="margin-bottom:10px;">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
          <button class="tool-btn active" onclick="toggleFont(this)">OpenDyslexic</button>
          <button class="tool-btn" onclick="changeFontSize(1,this)">A+</button>
          <button class="tool-btn" onclick="changeFontSize(-1,this)">A‚àí</button>
          <button class="tool-btn" id="detailTtsBtn" onclick="readAloud()">üîä Read</button>
          <button class="tool-btn" id="detailMyLinesOnly" onclick="toggleMyLinesOnly(this)">My Lines Only</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;background:var(--sand);border-radius:var(--rs);padding:8px 12px;margin-bottom:8px;">
          <span style="font-size:11px;font-weight:900;color:var(--brown-light);">Speed:</span>
          <input type="range" id="ttsSpeedSlider2" min="0.5" max="2" step="0.1" value="0.85" style="flex:1;" oninput="updateTTSSpeed(this.value)">
          <span id="ttsSpeedLabel2" style="font-size:11px;font-weight:900;color:var(--brown);min-width:32px;">0.9x</span>
          <button onclick="stopReading()" style="background:var(--terra);color:white;border:none;border-radius:99px;padding:4px 10px;font-size:10px;font-weight:900;cursor:pointer;font-family:var(--font);">‚èπ Stop</button>
        </div>
        <!-- Character assignment bar -->
        <div style="background:var(--sand);border-radius:var(--rs);padding:10px 12px;margin-bottom:8px;" id="charAssignBar">
          <div id="charAssignPills"></div>
        </div>
      </div>
      <div class="script-reader show" id="detailScriptReader"></div>
    </div>
  </div>

  <!-- SCRIPT EDITOR VIEW -->
  <div id="scriptEditorView" style="display:none;">
    <div class="app-header">
      <button class="back-btn" onclick="exitEditor()">‚Äπ</button>
      <div style="flex:1;font-size:17px;font-weight:900;">Edit Script</div>
      <button onclick="saveEditorChanges()" style="background:var(--sage);border:none;color:white;border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">Save ‚úÖ</button>
    </div>
    <div class="scroll-content">
      <div class="card" style="margin-bottom:14px;">
        <div style="font-size:12px;font-weight:900;color:var(--brown-light);margin-bottom:8px;">Script name:</div>
        <input class="char-input" id="editorScriptName" placeholder="Script name...">
      </div>
      <div style="font-size:12px;font-weight:900;color:var(--brown);margin-bottom:8px;">Edit lines ‚Äî tap any line to edit its text or reassign its character:</div>
      <div id="editorLinesList"></div>
      <div class="card" style="margin-top:12px;">
        <div style="font-size:13px;font-weight:900;margin-bottom:10px;">+ Add new line:</div>
        <select id="editorNewChar" style="width:100%;padding:10px;border-radius:var(--rs);border:2px solid var(--sand-dark);font-family:var(--font);font-weight:700;margin-bottom:8px;"></select>
        <textarea class="paste-area" id="editorNewText" style="min-height:60px;" placeholder="Line text..."></textarea>
        <button class="btn btn-terra" style="margin-top:8px;" onclick="editorAddLine()">+ Add Line</button>
      </div>
      <!-- Upload additional pages -->
      <div class="card" style="margin-top:12px;">
        <div style="font-size:13px;font-weight:900;margin-bottom:6px;">üìÑ Upload additional pages:</div>
        <div style="font-size:12px;color:var(--brown-light);margin-bottom:10px);">Upload a new page to insert into this script. You can choose where it goes.</div>
        <input type="file" id="editorPageUpload" accept=".txt,.pdf" style="display:none;" onchange="handleEditorPageUpload(this)">
        <button class="btn btn-sage" onclick="document.getElementById('editorPageUpload').click()">üìÇ Upload Page / Pages</button>
        <div id="editorInsertArea" style="display:none;margin-top:10px;">
          <div style="font-size:12px;font-weight:900;margin-bottom:6px;">Insert after which line?</div>
          <select id="editorInsertAfter" style="width:100%;padding:10px;border-radius:var(--rs);border:2px solid var(--sand-dark);font-family:var(--font);"></select>
          <button class="btn btn-terra" style="margin-top:8px;" onclick="confirmEditorInsert()">Insert Here ‚úÖ</button>
        </div>
      </div>
    </div>
  </div>

</div><!-- scriptScreen -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRACTICE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="practiceScreen">
  <div id="practiceHome">
    <div class="app-header">
      <div class="logo">Esco<span>Mind</span></div>
      <div style="font-size:13px;font-weight:800;color:var(--brown-light);">Practice</div>
    </div>
    <div class="scroll-content">
      <div class="section-title">Choose Script</div>
      <div id="practiceScriptPicker" style="margin-bottom:16px;"></div>
      <div id="practiceContent">
        <div class="empty-state"><div class="es-icon">üìö</div><p>Upload a script first to start practising!</p><br>
        <button class="btn btn-terra btn-sm" onclick="navTo('scriptScreen',1)" style="width:auto;padding:10px 24px;">Upload Script</button></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CUE CARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="cueScreen">
  <div class="cue-header">
    <button class="back-btn" onclick="exitToGameChooser()">‚Äπ</button>
    <div>
      <div style="font-size:17px;font-weight:900;" id="cueScreenTitle">Cue Cards</div>
      <div style="font-size:11px;color:var(--brown-light);" id="cueScreenSub">Loading...</div>
    </div>
    <button onclick="pauseCueCards()" id="cuePauseBtn" style="margin-left:auto;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">‚è∏ Pause</button>
  </div>
  <div class="cue-body">
    <div class="prog-wrap"><div class="prog-fill" id="cueProgBar" style="width:0%"></div></div>
    <div class="prog-label" id="cueProgLabel">Line 1 of 0</div>
    <div class="cue-box">
      <div class="cue-lbl">üé§ Cue line:
        <button onclick="speakCue()" style="float:right;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:3px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--brown);">üîä Hear it</button>
      </div>
      <div class="cue-txt" id="cueTxt">Loading...</div>
    </div>
    <div class="myline-reveal" id="myLineReveal" onclick="revealMyLine()">
      <div class="reveal-hint" id="revealHint">üëÜ Tap to reveal your line ‚Äî or speak it below</div>
      <div class="reveal-txt" id="revealTxt"></div>
    </div>
    <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üéô Speak Your Line</button>
    <div class="word-analysis" id="wordAnalysis"></div>
    <div class="result-banner" id="cueBanner"></div>
    <div class="feedback-row" id="feedbackRow" style="display:none;">
      <button class="fb-btn fb-wrong" onclick="nextCue('wrong')">‚úó Wrong</button>
      <button class="fb-btn fb-close" onclick="nextCue('close')">~ Close</button>
      <button class="fb-btn fb-right" onclick="nextCue('correct')">‚úì Got it!</button>
    </div>
    <button class="next-btn" id="nextCueBtn" onclick="nextCue('correct')">Next Line ‚Üí</button>
    <button onclick="exitToGameChooser()" style="background:none;border:2px solid var(--sand-dark);border-radius:99px;padding:8px 20px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;color:var(--brown-light);margin-top:8px;width:100%;">‚úï Quit Game</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAMES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="gameScreen">

  <!-- GAME HOME -->
  <div id="gameHome">
    <div class="app-header">
      <div class="logo">Esco<span>Mind</span></div>
      <div style="font-size:13px;font-weight:800;color:var(--brown-light);">Game Center üéÆ</div>
    </div>
    <div class="scroll-content">

      <!-- Script picker -->
      <div class="section-title">Choose Script</div>
      <div id="gameScriptPicker" style="margin-bottom:4px;"></div>
      <!-- Scene picker -->
      <div id="gameScenePicker" style="margin-bottom:16px;display:none;">
        <div style="font-size:12px;font-weight:900;color:var(--brown-light);margin-bottom:8px;">Practice which section?</div>
        <div id="gameScenePills" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
      </div>

      <!-- Daily challenge -->
      <div class="daily-chal" onclick="startGameById('fillblank')">
        <div class="dc-info"><h3>‚ö° Daily Challenge</h3><p id="dailyChalDesc">Today: Fill in the Blank</p></div>
        <div style="font-size:40px;">üèÜ</div>
      </div>

      <!-- Game grid -->
      <div class="section-title">Games</div>
      <div class="section-title" style="margin-top:0;">Core Games</div>
      <div class="gc-grid">
        <div class="gc-card gc-1" onclick="startGameById('cue')">
          <div class="gc-best" id="gcBest-cue">Best: --</div>
          <div class="gc-icon">üÉè</div>
          <div class="gc-name">Cue Cards</div>
          <div class="gc-desc">See the cue, recall your line</div>
        </div>
        <div class="gc-card gc-2" onclick="startGameById('fillblank')">
          <div class="gc-best" id="gcBest-fillblank">Best: --</div>
          <div class="gc-icon">üìù</div>
          <div class="gc-name">Fill in the Blank</div>
          <div class="gc-desc">Complete the missing word</div>
        </div>
        <div class="gc-card gc-3" onclick="startGameById('speed')">
          <div class="gc-best" id="gcBest-speed">Best: --</div>
          <div class="gc-icon">‚ö°</div>
          <div class="gc-name">Speed Drill</div>
          <div class="gc-desc">Race through all your lines</div>
        </div>
        <div class="gc-card gc-4" onclick="startGameById('partner')">
          <div class="gc-best" id="gcBest-partner">Best: --</div>
          <div class="gc-icon">üé≠</div>
          <div class="gc-name">Scene Partner</div>
          <div class="gc-desc">App reads others, you speak yours</div>
        </div>
      </div>
      <div class="section-title">New ‚Äî Rehearsal Pro + Line Learner Methods ‚ú®</div>
      <div class="gc-grid">
        <div class="gc-card gc-5" onclick="startGameById('blackout')">
          <div class="gc-best" id="gcBest-blackout">Best: --</div>
          <div class="gc-icon">‚¨õ</div>
          <div class="gc-name">Blackout</div>
          <div class="gc-desc">Lines hidden ‚Äî tap to peek</div>
        </div>
        <div class="gc-card gc-1" onclick="startGameById('audiogap')">
          <div class="gc-best" id="gcBest-audiogap">Best: --</div>
          <div class="gc-icon">üéß</div>
          <div class="gc-name">Audio Run-Through</div>
          <div class="gc-desc">Scene plays ‚Äî gap left for you</div>
        </div>
        <div class="gc-card gc-2" onclick="startGameById('teleprompter')">
          <div class="gc-best" id="gcBest-teleprompter">Best: --</div>
          <div class="gc-icon">üìú</div>
          <div class="gc-name">Teleprompter</div>
          <div class="gc-desc">Auto-scroll full script</div>
        </div>
      </div>

      <!-- XP -->
      <div class="xp-card">
        <div class="xp-hdr"><div class="xp-ttl" id="gameXpLabel">Level 1 ‚Äî Just Starting üå±</div><div class="xp-lvl" id="gameXpTotal">0 XP</div></div>
        <div class="xp-bar"><div class="xp-fill" id="gameXpBar" style="width:0%"></div></div>
        <div style="font-size:11px;color:var(--brown-light);" id="gameXpNext">100 XP to Level 2</div>
        <div class="badges" id="gameBadges"><div style="font-size:12px;color:var(--brown-light);padding:8px 0;">Play games to earn badges! üèÖ</div></div>
      </div>
    </div>
  </div>

  <!-- GAME CHOOSER (after script is picked, before game starts) -->
  <div id="gameChooser" style="display:none;">
    <div class="app-header">
      <button class="back-btn" onclick="showGameHome()">‚Äπ</button>
      <div>
        <div style="font-size:17px;font-weight:900;" id="chooserTitle">Choose Game</div>
        <div style="font-size:11px;color:var(--brown-light);" id="chooserSub"></div>
      </div>
    </div>
    <div class="scroll-content">
      <div class="gc-grid">
        <div class="gc-card gc-1" onclick="launchGame('cue')"><div class="gc-icon">üÉè</div><div class="gc-name">Cue Cards</div></div>
        <div class="gc-card gc-2" onclick="launchGame('fillblank')"><div class="gc-icon">üìù</div><div class="gc-name">Fill in the Blank</div></div>
        <div class="gc-card gc-3" onclick="launchGame('speed')"><div class="gc-icon">‚ö°</div><div class="gc-name">Speed Drill</div></div>
        <div class="gc-card gc-4" onclick="launchGame('partner')"><div class="gc-icon">üé≠</div><div class="gc-name">Scene Partner</div></div>
        <div class="gc-card gc-5" onclick="launchGame('blackout')"><div class="gc-icon">‚¨õ</div><div class="gc-name">Blackout</div><div class="gc-desc" style="font-size:9px;color:rgba(255,255,255,0.7);">Rehearsal Pro style</div></div>
        <div class="gc-card gc-1" onclick="launchGame('teleprompter')"><div class="gc-icon">üìú</div><div class="gc-name">Teleprompter</div><div class="gc-desc" style="font-size:9px;color:rgba(255,255,255,0.7);">Auto-scroll script</div></div>
        <div class="gc-card gc-2" onclick="launchGame('audiogap')"><div class="gc-icon">üéß</div><div class="gc-name">Audio Run-Through</div><div class="gc-desc" style="font-size:9px;color:rgba(255,255,255,0.7);">Line Learner style</div></div>
      </div>
    </div>
  </div>

</div><!-- gameScreen -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILL IN BLANK GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="game-screen" id="fillBlankScreen">
  <div class="game-header">
    <button class="back-btn" onclick="exitToGameChooser()">‚Äπ</button>
    <div style="flex:1;font-size:17px;font-weight:900;">Fill in the Blank üìù</div>
    <select id="diffSel" onchange="setDiff(this.value)" style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 12px;font-family:var(--font);font-weight:700;color:var(--brown);font-size:11px;cursor:pointer;">
      <option value="easy">Easy</option>
      <option value="medium" selected>Medium</option>
      <option value="hard">Hard</option>
    </select>
  </div>
  <div class="game-body">
    <div class="game-stats">
      <div class="gstat"><div id="gScore">0</div><div>Score</div></div>
      <div class="gstat"><div id="gStreak">0</div><div>Streak üî•</div></div>
      <div class="gstat"><div id="gTimer">60</div><div>Secs</div></div>
    </div>
    <div class="prog-wrap"><div class="prog-fill" id="gameProgBar" style="width:0%"></div></div>
    <div class="game-line-card" id="gameLineCard">Loading...</div>
    <div class="word-opts" id="wordOpts"></div>
    <div class="result-banner" id="gameBanner"></div>
    <button class="next-btn" id="gameNextBtn" onclick="nextGameQ()" style="display:none;">Next ‚Üí</button>
    <button onclick="exitToGameChooser()" style="background:none;border:2px solid var(--sand-dark);border-radius:99px;padding:8px 20px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;color:var(--brown-light);margin-top:8px;width:100%;">‚úï Quit Game</button>
  </div>
</div>


<div class="screen" id="settingsScreen">
  <div class="app-header">
    <div class="logo">Esco<span>Mind</span></div>
    <div style="font-size:13px;font-weight:800;color:var(--brown-light);">Settings</div>
  </div>
  <div class="scroll-content">
    <div class="set-sec">
      <h3>üî§ Text & Display</h3>
      <div class="set-row">
        <div><div class="set-name">OpenDyslexic Font</div><div class="set-desc">Dyslexia-friendly font everywhere</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="set-row">
        <div class="set-name">Font Size</div>
        <div class="fs-ctrl">
          <button class="fs-btn" onclick="globalFontSize(-1)">‚àí</button>
          <div style="font-weight:900;min-width:28px;text-align:center;" id="globalFsDisplay">16</div>
          <button class="fs-btn" onclick="globalFontSize(1)">+</button>
        </div>
      </div>
      <div class="set-row">
        <div><div class="set-name">Extra Line Spacing</div><div class="set-desc">More breathing room between lines</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="set-row">
        <div><div class="set-name">Text-to-Speech</div><div class="set-desc">Read lines aloud as you study</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
    </div>

    <div class="set-sec">
      <h3>üé® Creative Themes</h3>
      <div style="font-size:12px;color:var(--brown-light);margin-bottom:12px;">Pick a full theme ‚Äî changes background, buttons and accent colours:</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;" id="themeGrid">
        <div class="theme-card active" onclick="applyTheme('sand',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#F5ECD7;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#C1614F;"></div><div style="width:18px;height:18px;border-radius:50%;background:#7A9E7E;"></div></div>
          <div style="font-size:12px;font-weight:900;">Warm Sand</div><div style="font-size:10px;color:var(--brown-light);">Original ‚Äî easy on the eyes</div>
        </div>
        <div class="theme-card" onclick="applyTheme('night',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#1A1A2E;border:2px solid #444;"></div><div style="width:18px;height:18px;border-radius:50%;background:#E94560;"></div><div style="width:18px;height:18px;border-radius:50%;background:#0F3460;"></div></div>
          <div style="font-size:12px;font-weight:900;">Night Mode üåô</div><div style="font-size:10px;color:var(--brown-light);">Dark ‚Äî late night rehearsals</div>
        </div>
        <div class="theme-card" onclick="applyTheme('ocean',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#E8F4FD;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#2980B9;"></div><div style="width:18px;height:18px;border-radius:50%;background:#1ABC9C;"></div></div>
          <div style="font-size:12px;font-weight:900;">Ocean üåä</div><div style="font-size:10px;color:var(--brown-light);">Cool blue and teal</div>
        </div>
        <div class="theme-card" onclick="applyTheme('sunset',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#FFF0E6;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#E67E22;"></div><div style="width:18px;height:18px;border-radius:50%;background:#C0392B;"></div></div>
          <div style="font-size:12px;font-weight:900;">Sunset üåÖ</div><div style="font-size:10px;color:var(--brown-light);">Warm orange and red</div>
        </div>
        <div class="theme-card" onclick="applyTheme('lavender',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#F5F0FF;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#8E44AD;"></div><div style="width:18px;height:18px;border-radius:50%;background:#3498DB;"></div></div>
          <div style="font-size:12px;font-weight:900;">Lavender üíú</div><div style="font-size:10px;color:var(--brown-light);">Purple and blue calm</div>
        </div>
        <div class="theme-card" onclick="applyTheme('forest',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#EAF5EA;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#27AE60;"></div><div style="width:18px;height:18px;border-radius:50%;background:#F39C12;"></div></div>
          <div style="font-size:12px;font-weight:900;">Forest üåø</div><div style="font-size:10px;color:var(--brown-light);">Green and gold nature</div>
        </div>
        <div class="theme-card" onclick="applyTheme('rose',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#FFF0F5;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#E91E8C;"></div><div style="width:18px;height:18px;border-radius:50%;background:#9B59B6;"></div></div>
          <div style="font-size:12px;font-weight:900;">Rose Gold üå∏</div><div style="font-size:10px;color:var(--brown-light);">Pink and purple glam</div>
        </div>
        <div class="theme-card" onclick="applyTheme('slate',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#ECF0F1;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#2C3E50;"></div><div style="width:18px;height:18px;border-radius:50%;background:#E74C3C;"></div></div>
          <div style="font-size:12px;font-weight:900;">Slate ‚ö°</div><div style="font-size:10px;color:var(--brown-light);">Clean monochrome</div>
        </div>
      </div>
    </div>

    <div class="set-sec">
      <h3>‚è± Study Timer</h3>
      <div class="set-row">
        <div><div class="set-name">Session Length</div><div class="set-desc">How long each focus block lasts</div></div>
        <button onclick="openTimer()" style="background:var(--terra);color:white;border:none;border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">Set Timer</button>
      </div>
      <div class="set-row">
        <div><div class="set-name">Day of Week Reminder</div><div class="set-desc">Which days to practice</div></div>
        <div style="display:flex;gap:4px;flex-wrap:wrap;">
          <button class="tool-btn active" onclick="this.classList.toggle('active')">M</button>
          <button class="tool-btn active" onclick="this.classList.toggle('active')">T</button>
          <button class="tool-btn active" onclick="this.classList.toggle('active')">W</button>
          <button class="tool-btn active" onclick="this.classList.toggle('active')">Th</button>
          <button class="tool-btn active" onclick="this.classList.toggle('active')">F</button>
          <button class="tool-btn" onclick="this.classList.toggle('active')">Sa</button>
          <button class="tool-btn" onclick="this.classList.toggle('active')">Su</button>
        </div>
      </div>
    </div>

    <div class="set-sec">
      <h3>üéô Line Checking</h3>
      <div class="set-row">
        <div><div class="set-name">Word-Perfect Mode</div><div class="set-desc">Every word must match exactly</div></div>
        <button class="toggle on" id="wordPerfectToggle" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="set-row">
        <div><div class="set-name">Voice Input</div><div class="set-desc">Speak your lines for checking</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
    </div>

    <div class="set-sec">
      <h3>üîî Notifications</h3>
      <div class="set-row">
        <div><div class="set-name">Daily Reminder</div><div class="set-desc">Remind me to practise each day</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="set-row">
        <div><div class="set-name">Streak Alerts</div><div class="set-desc">Don't let me break my streak!</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
    </div>

    <div class="set-sec">
      <h3>‚òÅÔ∏è Sync Across Devices</h3>
      <p style="font-size:12px;color:var(--brown-light);margin-bottom:14px;line-height:1.6;">
        Set this up once and your lines, scenes and progress will automatically appear on your phone, computer and tablet.
      </p>
      <div id="syncSetupArea">
        <div id="syncStatus" style="text-align:center;padding:10px;color:var(--brown-light);font-size:13px;">Loading sync status...</div>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HANDS-FREE MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="hf-screen" id="handsFreeScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="stopHandsFree()">‚Äπ</button>
    <div>
      <div style="font-size:17px;font-weight:900;">üîä Hands-Free Mode</div>
      <div style="font-size:11px;color:var(--brown-light);" id="hfProgress">Line 1 of 0</div>
    </div>
    <button onclick="toggleHFPause()" id="hfPauseBtn" style="margin-left:auto;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">‚è∏ Pause</button>
  </div>
  <div class="hf-body">
    <div class="hf-cue-card">
      <div class="hf-cue-label">üé§ Cue ‚Äî listen and respond:</div>
      <div class="hf-cue-text" id="hfCueText">Ready to begin...</div>
    </div>
    <div class="hf-status" id="hfStatus">Tap the mic to start</div>
    <button class="hf-big-btn idle" id="hfMicBtn" onclick="hfMicTap()">üéô</button>
    <div class="hf-result" id="hfResult" style="display:none;"></div>
    <div style="display:flex;gap:10px;width:100%;max-width:500px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="hfNext('wrong')">‚úó Wrong</button>
      <button class="btn btn-sage" style="flex:2;" onclick="hfNext('correct')">‚úì Got it ‚Äî Next</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCENE PARTNER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="hf-screen" id="scenePartnerScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="stopScenePartner()">‚Äπ</button>
    <div>
      <div style="font-size:17px;font-weight:900;">üé≠ Scene Partner</div>
      <div style="font-size:11px;color:var(--brown-light);" id="spProgress">Line 1 of 0</div>
    </div>
    <button onclick="toggleSPPause()" id="spPauseBtn" style="margin-left:auto;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">‚è∏ Pause</button>
  </div>
  <div class="hf-body">
    <div id="spOtherCard" class="sp-other-line" style="display:none;">
      <div class="sp-char-name" id="spOtherChar">OTHER CHARACTER</div>
      <div id="spOtherText">...</div>
    </div>
    <div class="hf-cue-card" id="spMyCard" style="display:none;">
      <div class="hf-cue-label" id="spMyChar">YOUR LINE</div>
      <div class="hf-cue-text" id="spMyText">...</div>
    </div>
    <div class="hf-status" id="spStatus">App will read all other lines aloud. You speak yours.</div>
    <button class="hf-big-btn idle" id="spMicBtn" onclick="spMicTap()" style="display:none;">üéô</button>
    <div class="hf-result" id="spResult" style="display:none;"></div>
    <div style="display:flex;gap:10px;width:100%;max-width:500px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="spNext()">Next ‚Üí</button>
    </div>
    <button class="btn btn-terra" id="spStartBtn" onclick="spStart()" style="width:100%;max-width:500px;margin-top:8px;">‚ñ∂ Start Scene</button>
    <button onclick="stopScenePartner()" style="background:none;border:2px solid var(--sand-dark);border-radius:99px;padding:8px 20px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;color:var(--brown-light);margin-top:8px;width:100%;max-width:500px;">‚úï Quit</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPEED DRILL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="hf-screen" id="speedDrillScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="stopSpeedDrill()">‚Äπ</button>
    <div>
      <div style="font-size:17px;font-weight:900;">‚ö° Speed Drill</div>
      <div style="font-size:11px;color:var(--brown-light);" id="sdProgress">Line 1 of 0</div>
    </div>
  </div>
  <div class="hf-body">
    <div class="sd-timer" id="sdTimer">0.0s</div>
    <div class="sd-best" id="sdBest">Best time: --</div>
    <div class="sd-line-card">
      <div class="sd-scene-tag" id="sdSceneTag">Scene 1</div>
      <div class="hf-cue-label">Cue:</div>
      <div style="font-size:14px;color:var(--brown-light);font-style:italic;margin-bottom:10px;" id="sdCueText">...</div>
      <div class="hf-cue-label" style="color:var(--terra);">Your line:</div>
      <div style="font-size:16px;font-weight:700;line-height:1.6;" id="sdLineText">...</div>
    </div>
    <div style="display:flex;gap:10px;width:100%;max-width:500px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="sdMark('wrong')">‚úó Stumbled</button>
      <button class="btn btn-terra" style="flex:2;" onclick="sdMark('correct')">‚úì Got it!</button>
    </div>
    <button onclick="stopSpeedDrill()" style="background:none;border:2px solid var(--sand-dark);border-radius:99px;padding:8px 20px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;color:var(--brown-light);margin-top:8px;width:100%;max-width:500px;">‚úï Quit</button>
    <div id="sdFinished" style="display:none;width:100%;max-width:500px;text-align:center;margin-top:16px;">
      <div style="font-size:18px;font-weight:900;margin-bottom:8px;">Run complete! üéâ</div>
      <div style="font-size:14px;color:var(--brown-light);margin-bottom:16px;" id="sdFinishStats"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="btn btn-terra" style="flex:1;" onclick="startSpeedDrill()">Run Again ‚ö°</button>
        <button class="btn btn-ghost" style="flex:1;" onclick="exitToGameChooser()">Done ‚úì</button>
      </div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BLACKOUT MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- From Rehearsal Pro: your lines are hidden, tap to peek -->
<div class="hf-screen" id="blackoutScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="stopBlackout()">‚Äπ</button>
    <div>
      <div style="font-size:17px;font-weight:900;">‚¨õ Blackout Mode</div>
      <div style="font-size:11px;color:var(--brown-light);" id="boProgress">Line 1 of 0</div>
    </div>
    <button onclick="toggleBoLoop()" id="boLoopBtn" style="margin-left:auto;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:11px;cursor:pointer;">üîÅ Loop: Off</button>
  </div>
  <div class="hf-body" style="gap:12px;">
    <!-- Progress bar -->
    <div class="prog-wrap" style="width:100%;max-width:500px;"><div class="prog-fill" id="boProgBar" style="width:0%"></div></div>

    <!-- Other character's line (always visible) -->
    <div id="boOtherCard" class="sp-other-line" style="width:100%;max-width:500px;">
      <div class="sp-char-name" id="boOtherChar">OTHER CHARACTER</div>
      <div id="boOtherText" style="font-size:15px;line-height:1.7;">...</div>
      <button onclick="speakBoOther()" style="margin-top:6px;background:rgba(255,255,255,0.25);border:none;color:white;border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);">üîä Hear cue</button>
    </div>

    <!-- MY LINE ‚Äî blacked out until tapped -->
    <div id="boMyCard" onclick="boReveal()" style="width:100%;max-width:500px;background:var(--terra);border-radius:var(--r);padding:16px;cursor:pointer;min-height:90px;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all 0.3s;">
      <div style="font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.7);margin-bottom:6px;" id="boMyChar">YOUR LINE üé≠</div>
      <div id="boBlackBar" style="width:90%;height:36px;background:rgba(0,0,0,0.4);border-radius:8px;display:flex;align-items:center;justify-content:center;">
        <span style="color:rgba(255,255,255,0.5);font-size:13px;font-weight:900;">üëÜ Tap to peek</span>
      </div>
      <div id="boMyText" style="display:none;font-size:15px;font-weight:700;color:white;line-height:1.7;width:100%;text-align:left;"></div>
    </div>

    <div style="font-size:12px;color:var(--brown-light);text-align:center;" id="boHint">Tap the red card to reveal your line</div>

    <!-- Beat marks area -->
    <div id="boBeatMarks" style="width:100%;max-width:500px;min-height:32px;"></div>

    <!-- Action buttons -->
    <div style="display:flex;gap:10px;width:100%;max-width:500px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="boMark('wrong')">‚úó Missed</button>
      <button class="btn btn-sage" style="flex:1;" onclick="boMark('close')">~ Nearly</button>
      <button class="btn btn-terra" style="flex:2;" onclick="boMark('correct')">‚úì Nailed it!</button>
    </div>
    <button onclick="stopBlackout()" style="background:none;border:2px solid var(--sand-dark);border-radius:99px;padding:8px 20px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;color:var(--brown-light);margin-top:4px;width:100%;max-width:500px;">‚úï Quit</button>

    <!-- Finish panel -->
    <div id="boFinished" style="display:none;width:100%;max-width:500px;text-align:center;margin-top:8px;">
      <div style="font-size:22px;font-weight:900;margin-bottom:8px;">Scene done! üéâ</div>
      <div style="font-size:14px;color:var(--brown-light);margin-bottom:16px;" id="boFinishStats"></div>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-terra" style="flex:1;" onclick="startBlackout()">Again ‚¨õ</button>
        <button class="btn btn-ghost" style="flex:1;" onclick="stopBlackout()">Done ‚úì</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TELEPROMPTER MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- From Rehearsal Pro: auto-scrolling script, your lines highlighted -->
<div class="hf-screen" id="teleprompterScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="stopTeleprompter()">‚Äπ</button>
    <div>
      <div style="font-size:17px;font-weight:900;">üìú Teleprompter</div>
      <div style="font-size:11px;color:var(--brown-light);" id="tpStatus">Auto-scrolling...</div>
    </div>
    <button onclick="toggleTpPause()" id="tpPauseBtn" style="margin-left:auto;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">‚è∏ Pause</button>
  </div>
  <!-- Speed controls -->
  <div style="display:flex;align-items:center;gap:10px;background:var(--sand);padding:8px 16px;border-bottom:1px solid var(--sand-dark);">
    <span style="font-size:11px;font-weight:900;color:var(--brown-light);">Speed:</span>
    <button onclick="tpSlower()" style="background:var(--sand-dark);border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;font-family:var(--font);">‚àí</button>
    <span id="tpSpeedLabel" style="font-size:12px;font-weight:900;min-width:30px;text-align:center;">2</span>
    <button onclick="tpFaster()" style="background:var(--sand-dark);border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;font-family:var(--font);">+</button>
    <div style="flex:1;"></div>
    <label style="font-size:11px;font-weight:900;color:var(--brown-light);display:flex;align-items:center;gap:6px;">
      <input type="checkbox" id="tpHideMyLines" onchange="tpToggleHide(this.checked)" style="width:16px;height:16px;">
      Hide my lines
    </label>
    <button onclick="tpLoop()" id="tpLoopBtn" style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);">üîÅ Off</button>
  </div>
  <!-- Script content -->
  <div id="tpScroll" style="overflow-y:auto;flex:1;padding:20px 16px;font-size:var(--tp-fs,17px);line-height:2.2;" onclick="toggleTpPause()">
    <div id="tpContent"></div>
    <div style="height:60vh;"></div><!-- bottom padding so last line can scroll to top -->
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIO GAP PRACTICE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- From Line Learner: TTS plays scene with silence gap for your lines -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIO RUN-THROUGH (Line Learner full feature set) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="hf-screen" id="audioGapScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="stopAudioGap()">‚Äπ</button>
    <div>
      <div style="font-size:17px;font-weight:900;">üéß Audio Run-Through</div>
      <div style="font-size:11px;color:var(--brown-light);" id="agProgress">Ready</div>
    </div>
    <button onclick="agOpenSettings()" style="margin-left:auto;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">‚öô Options</button>
  </div>

  <!-- ‚îÄ‚îÄ SETTINGS PANEL (collapsed by default) ‚îÄ‚îÄ -->
  <div id="agSettingsPanel" style="display:none;background:var(--cream);border-bottom:2px solid var(--sand-dark);padding:14px 16px;">
    <div style="font-size:13px;font-weight:900;color:var(--brown);margin-bottom:12px;">‚öô Run-Through Options</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">

      <!-- Play mode -->
      <div style="background:var(--sand);border-radius:var(--rs);padding:10px;">
        <div style="font-size:11px;font-weight:900;color:var(--brown);margin-bottom:6px;">Play mode:</div>
        <select id="agPlayMode" style="width:100%;padding:5px;border:1px solid var(--sand-dark);border-radius:var(--rs);font-family:var(--font);font-size:11px;background:white;">
          <option value="gap-line">Gap ‚Üí then hear line</option>
          <option value="line-gap" selected>Hear line ‚Üí then gap</option>
          <option value="gap-only">Gap only (silent recall)</option>
        </select>
        <div style="font-size:9px;color:var(--brown-light);margin-top:4px;">Gap-line: try first, then check. Line-gap: hear it, repeat it.</div>
      </div>

      <!-- Gap size -->
      <div style="background:var(--sand);border-radius:var(--rs);padding:10px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
          <span style="font-size:11px;font-weight:900;color:var(--brown);">Gap size:</span>
          <span id="agGapLabel" style="font-size:12px;font-weight:900;color:var(--terra);">8s</span>
        </div>
        <input type="range" id="agGapSlider" min="3" max="30" step="1" value="8" style="width:100%;" oninput="agUpdateGap(this.value)">
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--brown-light);"><span>3s tight</span><span>30s easy</span></div>
      </div>

      <!-- Pitch shift per character -->
      <div style="background:var(--sand);border-radius:var(--rs);padding:10px;">
        <div style="font-size:11px;font-weight:900;color:var(--brown);margin-bottom:6px;">üéµ Other chars pitch:</div>
        <div style="display:flex;align-items:center;gap:6px;">
          <button onclick="agChangePitch(-0.1)" style="background:var(--sand-dark);border:none;border-radius:50%;width:26px;height:26px;font-size:14px;cursor:pointer;font-family:var(--font);">‚àí</button>
          <span id="agPitchLabel" style="font-size:12px;font-weight:900;min-width:40px;text-align:center;">1.0√ó</span>
          <button onclick="agChangePitch(0.1)" style="background:var(--sand-dark);border:none;border-radius:50%;width:26px;height:26px;font-size:14px;cursor:pointer;font-family:var(--font);">+</button>
        </div>
        <div style="font-size:9px;color:var(--brown-light);margin-top:4px;">Shift cue voices so yours stands out</div>
      </div>

      <!-- Speed for other lines -->
      <div style="background:var(--sand);border-radius:var(--rs);padding:10px;">
        <div style="font-size:11px;font-weight:900;color:var(--brown);margin-bottom:6px;">‚ö° Cue line speed:</div>
        <div style="display:flex;align-items:center;gap:6px;">
          <button onclick="agChangeSpeed(-0.1)" style="background:var(--sand-dark);border:none;border-radius:50%;width:26px;height:26px;font-size:14px;cursor:pointer;font-family:var(--font);">‚àí</button>
          <span id="agSpeedLabel" style="font-size:12px;font-weight:900;min-width:40px;text-align:center;">1.0√ó</span>
          <button onclick="agChangeSpeed(0.1)" style="background:var(--sand-dark);border:none;border-radius:50%;width:26px;height:26px;font-size:14px;cursor:pointer;font-family:var(--font);">+</button>
        </div>
        <div style="font-size:9px;color:var(--brown-light);margin-top:4px;">Speed up cue lines; gap stays normal</div>
      </div>
    </div>

    <!-- Options row -->
    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:900;color:var(--brown);background:var(--sand);padding:6px 10px;border-radius:99px;">
        <input type="checkbox" id="agPauseAfterGap" style="width:14px;height:14px;">
        Pause after each gap
      </label>
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:900;color:var(--brown);background:var(--sand);padding:6px 10px;border-radius:99px;">
        <input type="checkbox" id="agVoiceAdvance" style="width:14px;height:14px;">
        üéô Voice auto-advance
      </label>
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:900;color:var(--brown);background:var(--sand);padding:6px 10px;border-radius:99px;">
        <input type="checkbox" id="agLoopCheck" style="width:14px;height:14px;">
        üîÅ Loop scene
      </label>
    </div>

    <!-- Sleep timer -->
    <div style="display:flex;align-items:center;gap:10px;background:var(--sand);border-radius:var(--rs);padding:8px 12px;">
      <span style="font-size:11px;font-weight:900;color:var(--brown);">üò¥ Sleep timer:</span>
      <select id="agSleepTimer" style="padding:4px 8px;border:1px solid var(--sand-dark);border-radius:var(--rs);font-family:var(--font);font-size:11px;background:white;">
        <option value="0">Off</option>
        <option value="15">15 min</option>
        <option value="30">30 min</option>
        <option value="45">45 min</option>
        <option value="60">60 min</option>
      </select>
      <span id="agSleepCountdown" style="font-size:11px;color:var(--brown-light);margin-left:auto;"></span>
    </div>

    <button onclick="agCloseSettings()" class="btn btn-terra btn-sm" style="width:100%;margin-top:10px;">Done ‚úì</button>
  </div>

  <!-- ‚îÄ‚îÄ FLAGGED LINES STRIP (A-B loop + marked lines) ‚îÄ‚îÄ -->
  <div id="agABStrip" style="display:none;background:linear-gradient(135deg,#1a1a2e,#16213e);color:white;padding:8px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
    <span style="font-size:11px;font-weight:900;">üîÇ A-B Loop:</span>
    <button onclick="agSetAB('A')" id="agABtn" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);">Set A</button>
    <button onclick="agSetAB('B')" id="agBBtn" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);">Set B</button>
    <span id="agABStatus" style="font-size:10px;color:rgba(255,255,255,0.7);">Tap A then B to loop a section</span>
    <button onclick="agClearAB()" style="background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);border:none;border-radius:99px;padding:4px 10px;font-size:10px;font-weight:900;cursor:pointer;font-family:var(--font);margin-left:auto;">‚úï Clear</button>
  </div>

  <div class="hf-body" style="gap:12px;padding-top:12px;">

    <!-- Progress bar -->
    <div class="prog-wrap" style="width:100%;max-width:500px;"><div class="prog-fill" id="agProgBar" style="width:0%"></div></div>

    <!-- Currently playing card -->
    <div id="agNowPlaying" style="width:100%;max-width:500px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div style="font-size:12px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;" id="agCurrentChar">‚Äî</div>
        <button onclick="agFlagLine()" id="agFlagBtn" style="background:none;border:none;font-size:18px;cursor:pointer;padding:0 4px;" title="Flag this line for review">üö©</button>
      </div>
      <div style="background:var(--cream);border-radius:var(--r);padding:16px;font-size:16px;line-height:1.8;min-height:80px;display:flex;align-items:center;justify-content:center;position:relative;" id="agCurrentText">
        Press Start to begin
      </div>
    </div>

    <!-- YOUR TURN gap card -->
    <div id="agMyTurn" style="display:none;width:100%;max-width:500px;">
      <div style="background:rgba(193,97,79,0.08);border:3px solid var(--terra);border-radius:var(--r);padding:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-size:13px;font-weight:900;color:var(--terra);">üé≠ YOUR LINE</span>
          <!-- Voice recognition indicator -->
          <div id="agVoiceIndicator" style="display:none;background:var(--terra);border-radius:99px;padding:3px 10px;font-size:10px;font-weight:900;color:white;animation:pulse 1s infinite;">üéô Listening...</div>
        </div>
        <div id="agMyLineText" style="font-size:15px;font-weight:700;color:var(--brown);line-height:1.7;margin-bottom:12px;display:none;"></div>
        <div id="agCountdown" style="font-size:48px;font-weight:900;color:var(--terra);margin-bottom:12px;text-align:center;">8</div>
        <!-- A-B mark during gap -->
        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
          <button onclick="agPrompt()" style="background:var(--amber);color:var(--brown);border:none;border-radius:99px;padding:10px 20px;font-family:var(--font);font-size:13px;font-weight:900;cursor:pointer;">üí° Prompt</button>
          <button onclick="agGotIt()" style="background:var(--sage);color:white;border:none;border-radius:99px;padding:10px 20px;font-family:var(--font);font-size:13px;font-weight:900;cursor:pointer;">‚úì Got it</button>
          <button onclick="agFlagLine()" style="background:none;border:2px solid var(--sand-dark);border-radius:99px;padding:10px 14px;font-family:var(--font);font-size:13px;cursor:pointer;" title="Flag for A-B loop">üö©</button>
        </div>
      </div>
    </div>

    <!-- Flagged lines summary -->
    <div id="agFlaggedStrip" style="display:none;width:100%;max-width:500px;background:rgba(193,97,79,0.08);border:1px solid var(--terra);border-radius:var(--rs);padding:8px 12px;">
      <div style="font-size:11px;font-weight:900;color:var(--terra);margin-bottom:4px;">üö© Flagged for review:</div>
      <div id="agFlaggedList" style="font-size:11px;color:var(--brown);line-height:1.8;"></div>
    </div>

    <!-- Controls -->
    <div style="width:100%;max-width:500px;">
      <button id="agStartBtn" onclick="agStart()" class="btn btn-terra" style="width:100%;font-size:16px;padding:16px;">‚ñ∂ Start Run-Through</button>
    </div>
    <div id="agRunning" style="display:none;width:100%;max-width:500px;flex-direction:column;gap:8px;">
      <div style="display:flex;gap:8px;">
        <button onclick="agPause()" id="agPauseBtn" class="btn btn-ghost" style="flex:1;">‚è∏ Pause</button>
        <button onclick="agSkip()" class="btn btn-sage" style="flex:1;">Skip ‚è≠</button>
        <button onclick="agToggleABStrip()" style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:8px 12px;font-family:var(--font);font-size:11px;font-weight:900;cursor:pointer;">üîÇ A-B</button>
      </div>
    </div>

    <button onclick="stopAudioGap()" style="background:none;border:2px solid var(--sand-dark);border-radius:99px;padding:8px 20px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;color:var(--brown-light);width:100%;max-width:500px;">‚úï Quit</button>

    <!-- Finish panel -->
    <div id="agFinished" style="display:none;width:100%;max-width:500px;text-align:center;">
      <div style="font-size:22px;font-weight:900;margin-bottom:8px;">Run complete! üéß</div>
      <div style="font-size:14px;color:var(--brown-light);margin-bottom:4px;" id="agFinishStats"></div>
      <div id="agFlaggedFinish" style="display:none;background:rgba(193,97,79,0.08);border-radius:var(--rs);padding:12px;margin:10px 0;text-align:left;">
        <div style="font-size:12px;font-weight:900;color:var(--terra);margin-bottom:6px;">üö© Lines to revisit:</div>
        <div id="agFlaggedFinishList" style="font-size:12px;color:var(--brown);line-height:1.9;"></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px;">
        <button class="btn btn-terra" style="flex:1;" onclick="agRestart()">Again üîÅ</button>
        <button class="btn btn-ghost" style="flex:1;" onclick="agRunFlaggedOnly()" id="agRunFlaggedBtn" style="display:none;">Run Flagged üö©</button>
        <button class="btn btn-ghost" style="flex:1;" onclick="stopAudioGap()">Done ‚úì</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROGRESS DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="prog-dash" id="progressDashScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="hideProgressDashboard()">‚Äπ</button>
    <div>
      <div style="font-size:17px;font-weight:900;">üìä Progress Dashboard</div>
      <div style="font-size:11px;color:var(--brown-light);" id="dashSubtitle">Your lines at a glance</div>
    </div>
  </div>
  <div class="scroll-content" id="dashContent"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHAKRA SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="chakraScreen">
  <!-- Home view -->
  <div id="chakraHome">
    <div class="app-header">
      <div class="logo">Esco<span>Mind</span></div>
      <div style="font-size:13px;font-weight:800;color:var(--brown-light);">Character Chakras üîÆ</div>
    </div>
    <div class="scroll-content">
      <div class="hero hero-brown" data-emoji="üîÆ">
        <h2>Character Chakras</h2>
        <p>Map your character's energy system to deepen your embodiment</p>
      </div>
      <!-- Saved profiles -->
      <div id="chakraSavedProfiles" style="margin-bottom:16px;"></div>
      <!-- New profile -->
      <div class="card">
        <div style="font-size:14px;font-weight:900;margin-bottom:10px;">+ New Character Profile</div>
        <div id="chakraCharList" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;"></div>
        <div style="font-size:11px;color:var(--brown-light);margin-bottom:8px;">Select from your scripts above, or type a new character name:</div>
        <input class="char-input" id="chakraCharInput" placeholder="Character name..." oninput="chakraCharTyped(this.value)">
        <div id="chakraStartBtns" style="display:none;margin-top:12px;">
          <div style="font-size:13px;font-weight:900;color:var(--brown);margin-bottom:10px;" id="chakraCharTitle"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <button class="btn btn-terra" onclick="startChakraQuiz()">üß† Character Quiz</button>
            <button class="btn btn-sage" onclick="startChakraManual()">üéõ Manual Mode</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz view -->
  <div id="chakraQuizView" style="display:none;">
    <div class="app-header">
      <button class="back-btn" onclick="chakraGoHome()">‚Äπ</button>
      <div>
        <div style="font-size:17px;font-weight:900;">Character Quiz</div>
        <div style="font-size:11px;color:var(--brown-light);" id="chakraQuizProgress">Question 1 of 35</div>
      </div>
    </div>
    <div class="scroll-content">
      <div id="chakraQuizArea"></div>
    </div>
  </div>

  <!-- Results view -->
  <div id="chakraResultView" style="display:none;">
    <div class="app-header">
      <button class="back-btn" onclick="chakraGoHome()">‚Äπ</button>
      <div style="flex:1;">
        <div style="font-size:17px;font-weight:900;" id="chakraResultTitle">Chakra Profile</div>
        <div style="font-size:11px;color:var(--brown-light);">Tap any chakra to change its state</div>
      </div>
      <button onclick="printChakraProfile()" style="background:var(--terra);color:white;border:none;border-radius:99px;padding:6px 14px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);">üñ® Print</button>
    </div>
    <div class="scroll-content">
      <div id="chakraResultArea"></div>
      <div style="height:20px;"></div>
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <button class="nav-btn active" id="nav0" onclick="navTo('homeScreen',0)"><div class="ni">üè†</div>Home</button>
  <button class="nav-btn" id="nav1" onclick="navTo('scriptScreen',1)"><div class="ni">üìÑ</div>Scripts</button>
  <button class="nav-btn" id="nav2" onclick="navTo('practiceScreen',2)"><div class="ni">üìö</div>Practice</button>
  <button class="nav-btn" id="nav3" onclick="navTo('gameScreen',3)"><div class="ni">üéÆ</div>Games</button>
  <button class="nav-btn" id="nav4" onclick="toggleMoreMenu()"><div class="ni">‚ò∞</div>More</button>
</nav>

<!-- More dropdown menu -->
<div id="moreMenu" style="display:none;position:fixed;bottom:68px;left:0;right:0;background:var(--cream);border-top:2px solid var(--sand-dark);z-index:150;box-shadow:0 -4px 20px rgba(74,55,40,0.15);padding:12px 16px;">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
    <button onclick="closeMoreMenu();navTo('chakraScreen',4);" style="background:linear-gradient(135deg,#7B1FA2,#512DA8);color:white;border:none;border-radius:var(--r);padding:16px;font-family:var(--font);font-size:13px;font-weight:900;cursor:pointer;text-align:center;">
      <div style="font-size:28px;margin-bottom:4px;">üîÆ</div>Chakras
    </button>
    <button onclick="closeMoreMenu();navTo('settingsScreen',5);" style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:var(--r);padding:16px;font-family:var(--font);font-size:13px;font-weight:900;cursor:pointer;color:var(--brown);text-align:center;">
      <div style="font-size:28px;margin-bottom:4px;">‚öôÔ∏è</div>Settings
    </button>
  </div>
  <button onclick="closeMoreMenu()" style="width:100%;margin-top:10px;background:none;border:none;font-family:var(--font);font-size:12px;font-weight:900;color:var(--brown-light);padding:8px;cursor:pointer;">‚úï Close</button>
</div>
<div id="moreMenuOverlay" style="display:none;position:fixed;inset:0;z-index:140;" onclick="closeMoreMenu()"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMER MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="timerModal">
  <div class="modal-sheet">
    <div class="modal-title">‚è± Study Timer</div>
    <div class="timer-mode" id="timerModeLabel">20 min focus session</div>
    <div class="timer-big" id="timerDisplay">20:00</div>
    <div style="font-size:12px;font-weight:900;margin-bottom:8px;color:var(--brown-light);">Session length:</div>
    <div class="break-opts" style="margin-bottom:12px;">
      <div class="break-opt active" onclick="setSessionLength(10);document.querySelectorAll('.sess-opt').forEach(b=>b.classList.remove('active'));this.classList.add('active');" class="sess-opt">10 min</div>
      <div class="break-opt" onclick="setSessionLength(20);document.querySelectorAll('.sess-opt').forEach(b=>b.classList.remove('active'));this.classList.add('active');" class="sess-opt">20 min</div>
      <div class="break-opt" onclick="setSessionLength(30);document.querySelectorAll('.sess-opt').forEach(b=>b.classList.remove('active'));this.classList.add('active');" class="sess-opt">30 min</div>
      <div class="break-opt" onclick="setSessionLength(45);document.querySelectorAll('.sess-opt').forEach(b=>b.classList.remove('active'));this.classList.add('active');" class="sess-opt">45 min</div>
      <div class="break-opt" onclick="setSessionLength(60);document.querySelectorAll('.sess-opt').forEach(b=>b.classList.remove('active'));this.classList.add('active');" class="sess-opt">60 min</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <span style="font-size:12px;font-weight:900;color:var(--brown-light);">Custom (min):</span>
      <input type="number" min="1" max="120" value="20" id="customSessionInput" style="width:70px;padding:8px;border-radius:var(--rs);border:2px solid var(--sand-dark);font-family:var(--font);font-size:14px;font-weight:900;">
      <button onclick="setSessionLength(parseInt(document.getElementById('customSessionInput').value)||20)" style="background:var(--terra);color:white;border:none;border-radius:99px;padding:8px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">Set</button>
    </div>
    <div style="font-size:12px;font-weight:900;margin-bottom:8px;color:var(--brown-light);">Break length:</div>
    <div class="break-opts" style="margin-bottom:12px;">
      <div class="break-opt active" id="bo5" onclick="setBreakLength(5);document.getElementById('bo5').classList.add('active');document.getElementById('bo10').classList.remove('active');document.getElementById('bo15').classList.remove('active');">5 min</div>
      <div class="break-opt" id="bo10" onclick="setBreakLength(10);document.getElementById('bo5').classList.remove('active');document.getElementById('bo10').classList.add('active');document.getElementById('bo15').classList.remove('active');">10 min</div>
      <div class="break-opt" id="bo15" onclick="setBreakLength(15);document.getElementById('bo5').classList.remove('active');document.getElementById('bo10').classList.remove('active');document.getElementById('bo15').classList.add('active');">15 min</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
      <span style="font-size:12px;font-weight:900;color:var(--brown-light);">Custom break (min):</span>
      <input type="number" min="1" max="60" value="5" id="customBreakInput" style="width:60px;padding:8px;border-radius:var(--rs);border:2px solid var(--sand-dark);font-family:var(--font);font-size:14px;font-weight:900;">
      <button onclick="setBreakLength(parseInt(document.getElementById('customBreakInput').value)||5)" style="background:var(--sage);color:white;border:none;border-radius:99px;padding:8px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">Set</button>
    </div>
    <div class="timer-ctrl-row">
      <button class="tcbtn tcbtn-go" id="timerToggleBtn" onclick="toggleTimer()">‚ñ∂ Start</button>
      <button class="tcbtn" onclick="resetTimer()" style="background:var(--sand);color:var(--brown);">‚Ü∫ Reset</button>
      <button class="tcbtn tcbtn-stop" onclick="closeTimer()">‚úï Close</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DICTIONARY POPUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="dict-pop" id="dictPop">
  <button class="dict-close" onclick="closeDict()">√ó</button>
  <div class="dict-word" id="dpWord"></div>
  <div class="dict-pron" id="dpPron"></div>
  <div class="dict-def" id="dpDef"></div>
  <button class="dict-speak-btn" onclick="speakDictWord()">üîä Hear it</button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let productions = [];
let activeProduction = null;
let scriptFontSize = 16;
let globalFs = 16;
let cueIndex = 0;
let cuePairs = [];
let lineShown = false;
let voiceActive = false;
let timerSecs = 1200;
let timerRunning = false;
let timerInterval = null;
let breakLen = 5;
let isBreak = false;
let gameScore = 0;
let gameStreak = 0;
let gameTimerSecs = 60;
let gameTimerInt = null;
let gameQIndex = 0;
let gameQuestions = [];
let rawScriptText = '';
let splitterParsed = [];
let splitterDividers = [];
let splitterMyChar = '';
let myLinesOnlyMode = false;

// Real tracking
let totalXP = 0;
let dayStreak = 0;
let earnedBadges = [];
let linesCorrectToday = 0;
let lastPlayDate = null;

const levels = [
  {min:0,    label:'Just Starting üå±',  next:100},
  {min:100,  label:'Line Reader üìñ',     next:300},
  {min:300,  label:'Getting Warmer üîÜ',  next:600},
  {min:600,  label:'Rising Actor üé≠',    next:1000},
  {min:1000, label:'Stage Ready ‚≠ê',     next:1500},
  {min:1500, label:'Scene Stealer üåü',   next:2200},
  {min:2200, label:'Lead Role üèÜ',       next:3000},
  {min:3000, label:'West End Star üé¨',   next:99999},
];

function getCurrentLevel() {
  for(let i=levels.length-1;i>=0;i--) { if(totalXP>=levels[i].min) return {...levels[i],index:i}; }
  return {...levels[0],index:0};
}

function addXP(pts) {
  const before = getCurrentLevel();
  totalXP += pts;
  linesCorrectToday++;
  const after = getCurrentLevel();
  showToast(`+${pts} XP ‚≠ê`);
  if(after.index > before.index) {
    setTimeout(()=>showToast(`üéâ Level up! You're now: ${after.label}`), 800);
  }
  checkBadges();
  updateXPDisplays();
}

function updateXPDisplays() {
  const lvl = getCurrentLevel();
  const pct = lvl.next < 99999 ? Math.min(100,((totalXP-lvl.min)/(lvl.next-lvl.min))*100) : 100;
  const nextLabel = lvl.next < 99999 ? `${lvl.next-totalXP} XP to next level` : 'Max level reached! üèÜ';
  const lvlLabel = `Level ${lvl.index+1} ‚Äî ${lvl.label}`;
  function safe(id, prop, val) { const el = document.getElementById(id); if(el) el[prop] = val; }
  function safeStyle(id, prop, val) { const el = document.getElementById(id); if(el) el.style[prop] = val; }
  safe('heroXP', 'textContent', totalXP);
  safe('heroStreak', 'textContent', dayStreak+'üî•');
  safe('xpLevelLabel', 'textContent', lvlLabel);
  safe('xpTotal', 'textContent', totalXP+' XP');
  safeStyle('xpBar', 'width', pct+'%');
  safe('xpNext', 'textContent', nextLabel);
  safe('gameXpLabel', 'textContent', lvlLabel);
  safe('gameXpTotal', 'textContent', totalXP+' XP');
  safeStyle('gameXpBar', 'width', pct+'%');
  safe('gameXpNext', 'textContent', nextLabel);
  updateBadgeDisplay();
}

function checkBadges() {
  const checks = [
    {id:'first_line', icon:'üé≠', label:'First Line',  cond:()=>linesCorrectToday>=1},
    {id:'ten_lines',  icon:'üìö', label:'10 Lines',    cond:()=>totalXP>=100},
    {id:'streak3',    icon:'üî•', label:'3 Day Streak',cond:()=>dayStreak>=3},
    {id:'gamer',      icon:'üéÆ', label:'Gamer',       cond:()=>gameScore>=100},
    {id:'star',       icon:'‚≠ê', label:'Rising Star', cond:()=>totalXP>=300},
    {id:'champ',      icon:'üèÜ', label:'Champion',    cond:()=>totalXP>=1000},
  ];
  checks.forEach(b => {
    if(!earnedBadges.includes(b.id) && b.cond()) {
      earnedBadges.push(b.id);
      setTimeout(()=>showToast(`üèÖ Badge earned: ${b.icon} ${b.label}!`), 1200);
    }
  });
}

function updateBadgeDisplay() {
  const allBadges = [
    {id:'first_line',icon:'üé≠',label:'First Line'},
    {id:'ten_lines', icon:'üìö',label:'10 Lines'},
    {id:'streak3',   icon:'üî•',label:'3 Streak'},
    {id:'gamer',     icon:'üéÆ',label:'Gamer'},
    {id:'star',      icon:'‚≠ê',label:'Rising Star'},
    {id:'champ',     icon:'üèÜ',label:'Champion'},
  ];
  const earned = allBadges.filter(b=>earnedBadges.includes(b.id));
  const html = earned.length > 0
    ? earned.map(b=>`<div class="badge">${b.icon}<div class="badge-lbl">${b.label}</div></div>`).join('')
    : '<div style="font-size:12px;color:var(--brown-light);padding:8px 0;">Earn badges by practising! üèÖ</div>';
  document.getElementById('homeBadges').innerHTML = html;
  document.getElementById('gameBadges').innerHTML = html;
}

function updateDayStreak() {
  const today = new Date().toDateString();
  if(lastPlayDate === today) return;
  const yesterday = new Date(Date.now()-86400000).toDateString();
  if(lastPlayDate === yesterday) dayStreak++;
  else if(lastPlayDate !== today) dayStreak = 1;
  lastPlayDate = today;
  document.getElementById('heroGreeting').textContent = dayStreak > 1 ? `Day ${dayStreak} ‚Äî keep it up! üé≠` : 'Welcome to EscoMind! üé≠';
  document.getElementById('heroSubtitle').textContent = dayStreak > 1 ? `You're on a ${dayStreak}-day streak ‚Äî amazing!` : productions.length > 0 ? 'Choose a mode and practise your lines.' : 'Upload your first script to get started.';
  updateXPDisplays();
}

// Sample script for when no user script loaded
const sampleScript = `FAIRY
How now, spirit! Whither wander you?

PUCK
Over hill, over dale, thorough bush, thorough brier, over park, over pale, thorough flood, thorough fire.

FAIRY
Either I mistake your shape and making quite, or else you are that shrewd and knavish sprite called Robin Goodfellow.

PUCK
Thou speak'st aright; I am that merry wanderer of the night.

FAIRY
The king doth keep his revels here tonight.

PUCK
I must go seek some dewdrops here and hang a pearl in every cowslip's ear.

FAIRY
Farewell, thou lob of spirits; I'll be gone.

PUCK
Our queen and all our elves come here anon.

FAIRY
How long within this wood intend you stay?

PUCK
Perchance till after Theseus' wedding-day.`;

// Dictionary
const dict = {
  whither:{pron:'/Ààw…™√∞…ôr/',def:'To what place; where are you going? (archaic)'},
  dale:{pron:'/de…™l/',def:'A broad open valley, especially in northern England.'},
  brier:{pron:'/Ààbra…™…ôr/',def:'A prickly shrub such as wild rose or bramble.'},
  knavish:{pron:'/Ààne…™v…™ É/',def:'Dishonest and unscrupulous; rogue-like.'},
  sprite:{pron:'/spra…™t/',def:'A fairy or elf; a nimble supernatural being.'},
  cowslip:{pron:'/Ààka äsl…™p/',def:'A yellow wildflower common in European meadows.'},
  wanderer:{pron:'/Ààw…índ…ôr…ôr/',def:'One who roams freely with no fixed destination.'},
  revels:{pron:'/Ààr…õv…ôlz/',def:'Lively and noisy festivities or celebrations.'},
  mortals:{pron:'/Ààm…îÀêt…ôlz/',def:'Human beings, as distinct from gods or spirits.'},
  perchance:{pron:'/p…ôÀàt É…ëÀêns/',def:'Perhaps; possibly (archaic or poetic).'},
  thorough:{pron:'/ÀàŒ∏ år…ô/',def:'Passing through; by way of (archaic use in verse).'},
  anon:{pron:'/…ôÀàn…ín/',def:'Shortly; soon; before long (archaic).'},
  theseus:{pron:'/ÀàŒ∏iÀês…™…ôs/',def:'A legendary king of Athens in Greek mythology.'},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const screenIds = ['homeScreen','scriptScreen','practiceScreen','gameScreen','settingsScreen','chakraScreen'];

function navTo(id, navIdx) {
  stopReading();
  screenIds.forEach(s => { const el=document.getElementById(s); if(el) el.classList.remove('active'); });
  document.querySelectorAll('.game-screen,.hf-screen,.prog-dash').forEach(s => s.classList.remove('active'));
  const target = document.getElementById(id);
  if(target) target.classList.add('active');
  if(navIdx !== undefined) {
    document.querySelectorAll('.nav-btn').forEach((b,i) => b.classList.toggle('active', i===navIdx));
  }
  window.scrollTo(0,0);
  if(id === 'practiceScreen') refreshPracticeScreen();
  if(id === 'homeScreen') refreshHome();
  if(id === 'chakraScreen') refreshChakraScreen();
  if(id === 'scriptScreen') { showScriptHome(); renderScriptLibrary(); }
  if(id === 'gameScreen') { showGameHome(); refreshGameScreen(); }
}

function goToGameScreen(id) {
  screenIds.forEach(s => { const el=document.getElementById(s); if(el) el.classList.remove('active'); });
  document.querySelectorAll('.game-screen,.hf-screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCRIPT LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentScriptIdx = null;

function showScriptHome() {
  document.getElementById('scriptHome').style.display = 'block';
  document.getElementById('scriptUploadView').style.display = 'none';
  document.getElementById('scriptDetailView').style.display = 'none';
  document.getElementById('scriptEditorView').style.display = 'none';
  renderScriptLibrary();
}

function showScriptUpload() {
  document.getElementById('scriptHome').style.display = 'none';
  document.getElementById('scriptUploadView').style.display = 'block';
  document.getElementById('scriptDetailView').style.display = 'none';
  document.getElementById('scriptEditorView').style.display = 'none';
  // Reset upload state
  document.getElementById('charSetup').style.display = 'none';
  document.getElementById('sceneSplitterSection').style.display = 'none';
  document.getElementById('readerSection').style.display = 'none';
}

function showScriptDetail(idx) {
  currentScriptIdx = idx;
  const prod = productions[idx];
  if(!prod) return;
  activeProduction = prod;
  document.getElementById('scriptHome').style.display = 'none';
  document.getElementById('scriptUploadView').style.display = 'none';
  document.getElementById('scriptDetailView').style.display = 'block';
  document.getElementById('scriptEditorView').style.display = 'none';
  document.getElementById('detailTitle').textContent = prod.name || prod.myChar;
  document.getElementById('detailSub').textContent = `${prod.myChar} ¬∑ ${prod.cuePairs ? (prod.cuePairs||[]).length : 0} lines`;
  // Character badge
  document.getElementById('detailCharBadge').innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;background:var(--sand);border-radius:var(--rs);padding:10px 14px;margin-bottom:4px;">
      <div style="font-size:11px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;">You are playing:</div>
      <div style="font-size:16px;font-weight:900;color:var(--terra);">${prod.myChar}</div>
      <div style="font-size:11px;color:var(--brown-light);margin-left:auto;">${prod.scriptData ? prod.scriptData.filter(l=>l.mine).length : 0} lines</div>
    </div>`;
  renderDetailScript(idx);
  renderCharAssignBar(idx);
}

function renderScriptLibrary() {
  const lib = document.getElementById('scriptLibrary');
  if(!lib) return;
  if(productions.length === 0) {
    lib.innerHTML = `<div class="empty-state"><div class="es-icon">üìÑ</div><p>No scripts yet.<br>Upload your first script!</p><br><button class="btn btn-terra btn-sm" onclick="showScriptUpload()" style="width:auto;padding:10px 24px;">+ Upload Script</button></div>`;
    return;
  }
  const colors = ['var(--terra)','var(--sage)','var(--amber)','#7B1FA2','#1565C0'];
  lib.innerHTML = productions.map((p,i) => {
    const lineCount = p.scriptData ? p.scriptData.filter(l=>l.mine).length : 0;
    const totalLines = p.scriptData ? p.scriptData.length : 0;
    const prog = p.progress || 0;
    return `<div class="prod-card" onclick="showScriptDetail(${i})" style="border-left-color:${colors[i%colors.length]}">
      <div class="prod-icon">üé≠</div>
      <div class="prod-info" style="flex:1;">
        <div class="prod-name">${p.name || p.myChar}</div>
        <div class="prod-sub">${p.myChar} ¬∑ ${lineCount} lines ¬∑ ${totalLines} total</div>
        <div class="prog-wrap" style="margin-top:8px;"><div class="prog-fill" style="width:${prog}%"></div></div>
        <div class="prod-sub">${prog}% learned</div>
      </div>
      <button onclick="event.stopPropagation();deleteProduction(${i})" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--brown-light);padding:4px 8px;">üóë</button>
    </div>`;
  }).join('');
}

function renderDetailScript(idx) {
  const prod = productions[idx];
  if(!prod || !prod.scriptData) return;
  const reader = document.getElementById('detailScriptReader');
  const myChar = prod.myChar;
  let html = '<div style="font-size:11px;color:var(--brown-light);margin-bottom:12px;text-align:center;padding:6px;background:var(--sand);border-radius:var(--rs);">üëÜ Tap any line to reassign it to the right character</div>';
  prod.scriptData.forEach((line, lineIdx) => {
    const isMine = line.char === myChar || line.mine;
    const isDir = line.isDirection;
    const charColor = getCharColor(line.char, prod);
    if(isDir) {
      html += `<div id="sline_${lineIdx}" onclick="selectLineForReassign(${lineIdx},${idx})"
        style="border-left:2px dashed var(--sand-dark);margin-bottom:4px;padding:5px 10px;border-radius:0 var(--rs) var(--rs) 0;background:transparent;cursor:pointer;opacity:0.45;">
        <div style="font-size:9px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;">STAGE DIRECTION</div>
        <div style="font-size:12px;font-style:italic;color:var(--brown-light);">${line.text}</div>
      </div>`;
    } else {
      html += `<div class="script-block ${isMine?'my-line':''}" id="sline_${lineIdx}"
        onclick="selectLineForReassign(${lineIdx},${idx})"
        style="border-left:4px solid ${isMine?'var(--terra)':charColor};margin-bottom:6px;padding:8px 12px;border-radius:0 var(--rs) var(--rs) 0;background:${isMine?'rgba(193,97,79,0.08)':'var(--cream)'};cursor:pointer;transition:transform 0.1s;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
          <div style="font-size:10px;font-weight:900;color:${isMine?'var(--terra)':charColor};text-transform:uppercase;letter-spacing:1px;">${line.char||'UNKNOWN'}${isMine?' üé≠':''}</div>
          <div style="font-size:10px;color:var(--sand-dark);">tap to reassign</div>
        </div>
        <div style="font-size:14px;line-height:1.8;">${escapeHtml(line.text)}</div>
      </div>`;
    }
  });
  reader.innerHTML = html;
}

// Character color map for script display
function getCharColor(charName, prod) {
  if(!prod._charColors) prod._charColors = {};
  const palette = ['#1565C0','#2E7D32','#6A1B9A','#E65100','#00838F','#AD1457','#4527A0','#558B2F'];
  if(!prod._charColors[charName]) {
    const keys = Object.keys(prod._charColors);
    prod._charColors[charName] = palette[keys.length % palette.length];
  }
  return prod._charColors[charName];
}

// Character reassignment
let selectedLines = [];
let reassignMode = false;

function renderCharAssignBar(idx) {
  const prod = productions[idx];
  if(!prod || !prod.scriptData) return;
  const bar = document.getElementById('charAssignPills');
  if(!bar) return;
  const chars = [...new Set(prod.scriptData.map(l => l.char).filter(Boolean))];
  const counts = {};
  prod.scriptData.forEach(l => { if(l.char && !l.isDirection) counts[l.char] = (counts[l.char]||0)+1; });
  const myLines = prod.scriptData.filter(l=>l.mine && !l.isDirection).length;
  const directions = prod.scriptData.filter(l=>l.isDirection).length;
  bar.innerHTML = `
    <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
      ${chars.map(c => {
        const isMine = c === prod.myChar;
        return `<div style="background:${isMine?'var(--terra)':'var(--sand)'};color:${isMine?'white':'var(--brown)'};
          border:2px solid ${isMine?'var(--terra)':'var(--sand-dark)'};
          border-radius:99px;padding:5px 12px;font-size:11px;font-weight:900;display:inline-flex;align-items:center;gap:5px;">
          ${isMine?'üé≠ ':''}${c} <span style="opacity:0.7;">(${counts[c]||0})</span>
        </div>`;
      }).join('')}
      ${directions>0?`<div style="background:var(--sand);color:var(--brown-light);border:1px dashed var(--sand-dark);border-radius:99px;padding:5px 12px;font-size:11px;font-weight:700;">üö´ ${directions} directions hidden</div>`:''}
    </div>
    <div style="font-size:11px;color:var(--brown-light);margin-top:8px;">
      <strong>${myLines} lines</strong> assigned to you ¬∑ Tap any line below to reassign it
    </div>
  `;
}

function selectLineForReassign(lineIdx, prodIdx) {
  const prod = productions[prodIdx];
  if(!prod) return;
  const line = prod.scriptData[lineIdx];
  if(!line) return;
  const chars = [...new Set(prod.scriptData.map(l=>l.char).filter(Boolean))];

  // Remove any existing popup
  const old = document.getElementById('reassignPopup');
  if(old) old.remove();

  // Build popup
  const popup = document.createElement('div');
  popup.id = 'reassignPopup';
  popup.style.cssText = `
    position:fixed;bottom:0;left:0;right:0;z-index:9999;
    background:var(--cream);border-radius:20px 20px 0 0;
    box-shadow:0 -8px 40px rgba(0,0,0,0.22);
    padding:20px 20px 36px;
    animation:slideUp 0.22s cubic-bezier(0.34,1.56,0.64,1);
  `;
  popup.innerHTML = `
    <div style="width:40px;height:4px;background:var(--sand-dark);border-radius:99px;margin:0 auto 16px;"></div>
    <div style="font-size:11px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Reassign this line:</div>
    <div style="font-size:14px;font-weight:700;color:var(--brown);margin-bottom:16px;line-height:1.5;background:var(--sand);border-radius:var(--rs);padding:8px 12px;">"${line.text.substring(0,80)}${line.text.length>80?'‚Ä¶':''}"</div>
    <div style="font-size:11px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Currently: <span style="color:var(--terra)">${line.char}</span> ‚Äî who does this belong to?</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;">
      ${chars.map(c => {
        const isMine = c === prod.myChar;
        const isCurrent = c === line.char;
        return `<button onclick="quickReassign(${lineIdx},${prodIdx},'${c.replace(/'/g,"\'")}',this.closest('#reassignPopup'))"
          style="background:${isCurrent?'var(--amber)':isMine?'var(--terra)':'var(--sand)'};
            color:${isCurrent||isMine?'white':'var(--brown)'};
            border:2px solid ${isCurrent?'var(--amber)':isMine?'var(--terra)':'var(--sand-dark)'};
            border-radius:99px;padding:8px 16px;font-family:var(--font);font-size:13px;font-weight:900;cursor:pointer;">
          ${isCurrent?'‚úì ':''}${isMine?'üé≠ ':''}${c}
        </button>`;
      }).join('')}
    </div>
    <div style="display:flex;gap:8px;">
      <button onclick="markAsDirection(${lineIdx},${prodIdx},this.closest('#reassignPopup'))"
        style="flex:1;background:var(--sand);color:var(--brown-light);border:2px solid var(--sand-dark);border-radius:var(--rs);padding:10px;font-family:var(--font);font-size:12px;font-weight:900;cursor:pointer;">
        üö´ Stage Direction (hide from practice)
      </button>
      <button onclick="this.closest('#reassignPopup').remove()"
        style="background:none;border:none;font-size:24px;cursor:pointer;padding:0 8px;">‚úï</button>
    </div>
  `;
  document.body.appendChild(popup);

  // Close on backdrop tap
  setTimeout(() => {
    const close = (e) => { if(!popup.contains(e.target)) { popup.remove(); document.removeEventListener('touchstart',close); document.removeEventListener('mousedown',close); }};
    document.addEventListener('touchstart', close);
    document.addEventListener('mousedown', close);
  }, 100);
}

function quickReassign(lineIdx, prodIdx, newChar, popup) {
  const prod = productions[prodIdx];
  if(!prod || !prod.scriptData[lineIdx]) return;
  prod.scriptData[lineIdx].char = newChar;
  prod.scriptData[lineIdx].mine = (newChar === prod.myChar);
  rebuildCuePairs(prod);
  autoSave();
  if(popup) popup.remove();
  renderDetailScript(prodIdx);
  renderCharAssignBar(prodIdx);
  showToast(`‚úÖ Assigned to ${newChar}`);
}

function markAsDirection(lineIdx, prodIdx, popup) {
  const prod = productions[prodIdx];
  if(!prod || !prod.scriptData[lineIdx]) return;
  prod.scriptData[lineIdx].isDirection = true;
  prod.scriptData[lineIdx].mine = false;
  rebuildCuePairs(prod);
  autoSave();
  if(popup) popup.remove();
  renderDetailScript(prodIdx);
  showToast('Marked as stage direction ‚Äî hidden from practice');
}

function assignSelectedLines(charName, prodIdx) {
  const prod = productions[prodIdx];
  if(!prod) return;
  if(selectedLines.length === 0) { showToast('Tap lines in the script first, then assign here'); return; }
  selectedLines.forEach(i => {
    if(prod.scriptData[i]) {
      prod.scriptData[i].char = charName;
      prod.scriptData[i].mine = (charName === prod.myChar);
    }
  });
  // Rebuild cue pairs
  const assignedCount = selectedLines.length;
  rebuildCuePairs(prod);
  selectedLines = [];
  autoSave();
  renderDetailScript(prodIdx);
  renderCharAssignBar(prodIdx);
  showToast(`${assignedCount} line${assignedCount!==1?'s':''} assigned to ${charName} ‚úÖ`);
}

function rebuildCuePairs(prod) {
  const myChar = prod.myChar;
  const pairs = [];
  // Update mine flags first, skip directions
  prod.scriptData.forEach(l => { l.mine = !l.isDirection && (l.char === myChar); });
  // Build cue pairs: cue = last non-direction line before mine
  for(let i = 0; i < prod.scriptData.length; i++) {
    const line = prod.scriptData[i];
    if(line.isDirection) continue;
    if(line.mine) {
      // Find previous non-direction line
      let cue = 'Start of scene';
      for(let j = i-1; j >= 0; j--) {
        if(!prod.scriptData[j].isDirection) { cue = prod.scriptData[j].text; break; }
      }
      pairs.push({ cue, myLine: line.text, scene: line.scene || 'Scene 1' });
    }
  }
  prod.cuePairs = pairs;
}

function practiceCurrentScript() {
  if(currentScriptIdx === null) return;
  activeProduction = productions[currentScriptIdx];
  navTo('practiceScreen', 2);
}

function gameCurrentScript() {
  if(currentScriptIdx === null) return;
  activeProduction = productions[currentScriptIdx];
  navTo('gameScreen', 3);
}

function deleteCurrentScript() {
  if(currentScriptIdx === null) return;
  if(!confirm('Delete this script?')) return;
  productions.splice(currentScriptIdx, 1);
  if(activeProduction === productions[currentScriptIdx]) activeProduction = null;
  currentScriptIdx = null;
  autoSave();
  showScriptHome();
  refreshHome();
  showToast('Script deleted');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCRIPT EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editorNewLines = null;

function editCurrentScript() {
  if(currentScriptIdx === null) return;
  const prod = productions[currentScriptIdx];
  if(!prod) return;
  document.getElementById('scriptDetailView').style.display = 'none';
  document.getElementById('scriptEditorView').style.display = 'block';
  document.getElementById('editorScriptName').value = prod.name || prod.myChar;
  renderEditorLines(currentScriptIdx);
  // Populate char select
  const chars = [...new Set(prod.scriptData.map(l=>l.char).filter(Boolean))];
  document.getElementById('editorNewChar').innerHTML = chars.map(c=>`<option value="${c}">${c}</option>`).join('');
}

function renderEditorLines(idx) {
  const prod = productions[idx];
  if(!prod) return;
  const chars = [...new Set(prod.scriptData.map(l=>l.char).filter(Boolean))];
  document.getElementById('editorLinesList').innerHTML = prod.scriptData.map((line, i) => `
    <div class="card" style="margin-bottom:8px;border-left:4px solid ${line.mine?'var(--terra)':'var(--sand-dark)'};">
      <div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:6px;">
        <select onchange="editorChangeChar(${i},this.value,${idx})" style="background:var(--sand);border:1px solid var(--sand-dark);border-radius:var(--rs);padding:4px 8px;font-family:var(--font);font-size:11px;font-weight:900;">
          ${chars.map(c=>`<option value="${c}" ${c===line.char?'selected':''}>${c}</option>`).join('')}
        </select>
        <button onclick="editorDeleteLine(${i},${idx})" style="background:none;border:none;font-size:14px;cursor:pointer;color:var(--brown-light);margin-left:auto;">‚úï</button>
      </div>
      <textarea onchange="editorChangeLine(${i},this.value,${idx})" style="width:100%;border:1px solid var(--sand-dark);border-radius:var(--rs);padding:8px;font-family:var(--font);font-size:13px;background:var(--cream);min-height:50px;resize:vertical;">${line.text}</textarea>
    </div>
  `).join('');
}

function editorChangeChar(lineIdx, newChar, prodIdx) {
  const prod = productions[prodIdx];
  if(!prod) return;
  prod.scriptData[lineIdx].char = newChar;
  prod.scriptData[lineIdx].mine = (newChar === prod.myChar);
}

function editorChangeLine(lineIdx, newText, prodIdx) {
  const prod = productions[prodIdx];
  if(!prod) return;
  prod.scriptData[lineIdx].text = newText.trim();
}

function editorDeleteLine(lineIdx, prodIdx) {
  const prod = productions[prodIdx];
  if(!prod) return;
  prod.scriptData.splice(lineIdx, 1);
  renderEditorLines(prodIdx);
}

function editorAddLine() {
  if(currentScriptIdx === null) return;
  const prod = productions[currentScriptIdx];
  const char = document.getElementById('editorNewChar').value;
  const text = document.getElementById('editorNewText').value.trim();
  if(!text) { showToast('Please enter line text'); return; }
  prod.scriptData.push({ char, text, mine: char === prod.myChar });
  document.getElementById('editorNewText').value = '';
  renderEditorLines(currentScriptIdx);
  showToast('Line added ‚úÖ');
}

function saveEditorChanges() {
  if(currentScriptIdx === null) return;
  const prod = productions[currentScriptIdx];
  const nameEl = document.getElementById('editorScriptName');
  if(nameEl.value.trim()) prod.name = nameEl.value.trim();
  rebuildCuePairs(prod);
  autoSave();
  showToast('Changes saved ‚úÖ');
  exitEditor();
}

function exitEditor() {
  document.getElementById('scriptEditorView').style.display = 'none';
  document.getElementById('scriptDetailView').style.display = 'block';
}

async function handleEditorPageUpload(input) {
  const file = input.files[0];
  if(!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  showToast('Reading new pages...');
  let text = '';
  if(ext === 'pdf') {
    try {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const ab = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data:ab}).promise;
      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const ct = await page.getTextContent();
        let lastY=null,lb='';
        const pl=[];
        ct.items.forEach(item=>{
          const y=item.transform?Math.round(item.transform[5]):0;
          if(lastY!==null&&Math.abs(y-lastY)>3){if(lb.trim())pl.push(lb.trimEnd());lb=item.str;}
          else lb+=item.str;
          lastY=y;
        });
        if(lb.trim())pl.push(lb.trimEnd());
        text+=pl.reverse().join('\n')+'\n';
      }
    } catch(e){ text=''; }
  } else {
    text = await new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsText(file); });
  }
  if(!text.trim()){ showToast('Could not read file'); return; }
  editorNewLines = parseRawScript(text);
  document.getElementById('editorInsertArea').style.display = 'block';
  const prod = productions[currentScriptIdx];
  const sel = document.getElementById('editorInsertAfter');
  sel.innerHTML = `<option value="-1">At the beginning</option>` +
    (prod.scriptData||[]).map((l,i)=>`<option value="${i}">${i+1}. [${l.char}] ${l.text.substring(0,40)}...</option>`).join('');
  showToast(`Parsed ${editorNewLines.length} lines from new page ‚úÖ`);
}

function confirmEditorInsert() {
  if(!editorNewLines || currentScriptIdx === null) return;
  const prod = productions[currentScriptIdx];
  const insertAfter = parseInt(document.getElementById('editorInsertAfter').value);
  if(insertAfter === -1) {
    prod.scriptData = [...editorNewLines, ...(prod.scriptData||[])];
  } else {
    prod.scriptData.splice(insertAfter+1, 0, ...editorNewLines);
  }
  rebuildCuePairs(prod);
  autoSave();
  editorNewLines = null;
  document.getElementById('editorInsertArea').style.display = 'none';
  renderEditorLines(currentScriptIdx);
  showToast(`${editorNewLines ? editorNewLines.length : 'New'} lines inserted ‚úÖ`);
}

function parseRawScript(text) {
  const lines = text.split('\n');
  const parsed = [];
  let currentChar = null, currentText = [];
  const SKIP = /^(ACT|SCENE|INT\.|EXT\.|SHIFT|LIGHTS|BLACKOUT)/;
  function flush() {
    if(currentChar && currentText.length > 0) {
      const t = currentText.join(' ').replace(/\s+/g,' ').trim();
      if(t) parsed.push({ char: currentChar, text: t, mine: false });
      currentText = [];
    }
  }
  lines.forEach(line => {
    const trimmed = line.trim();
    if(!trimmed) return;
    if(/^[A-Z0-9][A-Z0-9\s\.\'\-\&]*$/.test(trimmed) && /[A-Z]/.test(trimmed) && !SKIP.test(trimmed) && trimmed.length>=2 && trimmed.length<=45 && !['A','I','HE','SHE','WE','OH','NO'].includes(trimmed)) {
      flush(); currentChar = trimmed;
    } else if(currentChar && !/^\(.*\)$/.test(trimmed) && !/^\[.*\]$/.test(trimmed)) {
      currentText.push(trimmed);
    }
  });
  flush();
  return parsed;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORT TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchImportTab(tab, btn) {
  document.querySelectorAll('.itab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('uploadPanel').classList.toggle('active', tab==='upload');
  document.getElementById('pastePanel').classList.toggle('active', tab==='paste');
  document.getElementById('manualPanel').classList.toggle('active', tab==='manual');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TTS ‚Äî READ ALOUD + SPEED CONTROL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ttsRate = 0.85;
let ttsActive = false;

function updateTTSSpeed(val) {
  ttsRate = parseFloat(val);
  const label = ttsRate.toFixed(1) + 'x';
  const el1 = document.getElementById('ttsSpeedLabel');
  const el2 = document.getElementById('ttsSpeedLabel2');
  if(el1) el1.textContent = label;
  if(el2) el2.textContent = label;
  // Sync both sliders
  const s1 = document.getElementById('ttsSpeedSlider');
  const s2 = document.getElementById('ttsSpeedSlider2');
  if(s1) s1.value = ttsRate;
  if(s2) s2.value = ttsRate;
}

function stopReading() {
  if('speechSynthesis' in window) window.speechSynthesis.cancel();
  ttsActive = false;
  const btn1 = document.getElementById('ttsToggle');
  const btn2 = document.getElementById('detailTtsBtn');
  if(btn1) btn1.textContent = 'üîä Read';
  if(btn2) btn2.textContent = 'üîä Read';
}

function readAloud() {
  if(ttsActive) { stopReading(); return; }
  const prod = activeProduction;
  if(!prod) { showToast('Load a script first! üìÑ'); return; }
  const myLines = prod.scriptData.filter(l=>l.mine).map(l=>l.text).join('. ');
  ttsActive = true;
  const btn1 = document.getElementById('ttsToggle');
  const btn2 = document.getElementById('detailTtsBtn');
  if(btn1) btn1.textContent = '‚èπ Stop';
  if(btn2) btn2.textContent = '‚èπ Stop';
  speakText(myLines, ttsRate, () => {
    ttsActive = false;
    if(btn1) btn1.textContent = 'üîä Read';
    if(btn2) btn2.textContent = 'üîä Read';
  });
  showToast('üîä Reading your lines...');
}

function speakCue() {
  const txt = document.getElementById('cueTxt');
  if(txt && txt.textContent) speakText(txt.textContent, ttsRate);
}

function speakText(text, rate, onEnd) {
  if(!('speechSynthesis' in window)) { showToast('Speech not supported in this browser'); return; }
  window.speechSynthesis.cancel();
  setTimeout(function() {
    const u = new SpeechSynthesisUtterance(text);
    u.rate = rate || 0.85;
    u.pitch = 1;
    u.volume = 1;
    const voices = window.speechSynthesis.getVoices();
    const preferred = voices.find(v => v.lang.startsWith('en') && v.localService);
    if(preferred) u.voice = preferred;
    if(onEnd) u.onend = onEnd;
    window.speechSynthesis.speak(u);
  }, 100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HOME + PRACTICE REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshHome() {
  const container = document.getElementById('homeProductions');
  if(!container) return;
  if(productions.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="es-icon">üé≠</div><p>No productions yet.<br>Upload your first script!</p><br><button class="btn btn-terra btn-sm" onclick="navTo('scriptScreen',1)" style="width:auto;padding:10px 24px;">Upload Script</button></div>`;
    document.getElementById('homeLinesLearned').textContent = '0';
    return;
  }
  const colors = ['var(--terra)','var(--sage)','var(--amber)','#7B1FA2','#1565C0'];
  container.innerHTML = productions.map((p,i) => `
    <div class="prod-card" onclick="loadProduction(${i})" style="border-left-color:${colors[i%colors.length]}">
      <div class="prod-icon">${p.type||'üé≠'}</div>
      <div class="prod-info">
        <div class="prod-name">${p.name||p.myChar}</div>
        <div class="prod-sub">${p.myChar} ¬∑ ${p.scriptData?p.scriptData.filter(l=>l.mine).length:0} lines</div>
        <div class="prog-wrap" style="margin-top:8px;"><div class="prog-fill" style="width:${p.progress||0}%"></div></div>
        <div class="prog-label">${p.progress||0}% learned</div>
      </div>
    </div>
  `).join('');
  const total = productions.reduce((a,p)=>a+(p.scriptData?p.scriptData.filter(l=>l.mine).length:0),0);
  document.getElementById('homeLinesLearned').textContent = total;
}

function loadProduction(idx) {
  activeProduction = productions[idx];
  currentScriptIdx = idx;
  navTo('scriptScreen', 1);
  setTimeout(() => showScriptDetail(idx), 50);
}

function deleteProduction(idx) {
  productions.splice(idx, 1);
  if(activeProduction === productions[idx]) activeProduction = null;
  refreshHome();
  renderScriptLibrary();
  refreshPracticeScreen();
  autoSave();
  showToast('Script deleted');
}

function refreshPracticeScreen() {
  // Script picker
  const picker = document.getElementById('practiceScriptPicker');
  if(picker) {
    if(productions.length === 0) {
      picker.innerHTML = '';
    } else {
      picker.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;">` +
        productions.map((p,i) => `<button class="tool-btn ${(activeProduction===p||(!activeProduction&&i===0))?'active':''}" onclick="setPracticeScript(${i},this)">${p.name||p.myChar}</button>`).join('') +
        `</div>`;
    }
  }
  const c = document.getElementById('practiceContent');
  if(!c) return;
  if(productions.length === 0) {
    c.innerHTML = `<div class="empty-state"><div class="es-icon">üìö</div><p>Upload a script first!</p><br><button class="btn btn-terra btn-sm" onclick="navTo('scriptScreen',1)" style="width:auto;padding:10px 24px;">Upload Script</button></div>`;
    return;
  }
  const prod = activeProduction || productions[0];
  if(!activeProduction) activeProduction = productions[0];
  if(!prod) return;
  const cps = prod.cuePairs || [];
  const scenes = prod.scenes && prod.scenes.length > 1 ? prod.scenes : null;
  const sceneSelector = scenes ? `
    <div class="card" style="margin-bottom:14px;">
      <div style="font-size:13px;font-weight:900;margin-bottom:10px;">Practice by scene:</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="tool-btn active" onclick="setSceneFilter('all',this)">All (${cps.length})</button>
        ${scenes.map(s => {
          const count = (prod.cuePairs||[]).filter(p=>(p.scene||'Scene 1')===s).length;
          return `<button class="tool-btn" onclick="setSceneFilter('${s}',this)">${s} (${count})</button>`;
        }).join('')}
      </div>
    </div>` : '';

  c.innerHTML = `
    <div class="card" style="margin-bottom:16px;">
      <div style="font-size:12px;color:var(--brown-light);font-weight:700;margin-bottom:4px;">Currently practising:</div>
      <div style="font-size:16px;font-weight:900;">${prod.myChar}</div>
      <div style="font-size:12px;color:var(--brown-light);" id="practiceLineCount">${prod.cuePairs?(prod.cuePairs||[]).length:0} lines ready</div>
    </div>
    ${sceneSelector}
    <div class="pm-card" onclick="startCueCards()">
      <div class="pm-icon">üÉè</div>
      <div class="pm-info"><div class="pm-name">Cue Cards</div><div class="pm-desc">See the cue, recall your line</div></div>
      <div class="pm-arrow">‚Ä∫</div>
    </div>
    <div class="pm-card" onclick="startHandsFree()">
      <div class="pm-icon">üîä</div>
      <div class="pm-info"><div class="pm-name">Read My Lines</div><div class="pm-desc">Phone reads all your lines aloud ‚Äî with speed control</div></div>
      <div class="pm-arrow">‚Ä∫</div>
    </div>
    <div class="pm-card" onclick="showMyLinesOnly()">
      <div class="pm-icon">üé≠</div>
      <div class="pm-info"><div class="pm-name">My Lines Only</div><div class="pm-desc">See just your lines in order. Tap to show all lines.</div></div>
      <div class="pm-arrow">‚Ä∫</div>
    </div>
    <div class="pm-card" onclick="startScenePartner()">
      <div class="pm-icon">üë•</div>
      <div class="pm-info"><div class="pm-name">Scene Partner</div><div class="pm-desc">App reads all other characters. You speak yours.</div></div>
      <div class="pm-arrow">‚Ä∫</div>
    </div>
    <div class="pm-card" onclick="startSpeedDrill()">
      <div class="pm-icon">‚ö°</div>
      <div class="pm-info"><div class="pm-name">Speed Drill</div><div class="pm-desc">Race through all your lines. Beat your best time!</div></div>
      <div class="pm-arrow">‚Ä∫</div>
    </div>
    <div style="font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:1px;color:var(--brown-light);padding:8px 4px 4px;">‚ú® New methods</div>
    <div class="pm-card" onclick="startBlackout()" style="border-left:3px solid var(--terra);">
      <div class="pm-icon">‚¨õ</div>
      <div class="pm-info"><div class="pm-name">Blackout Mode</div><div class="pm-desc">Lines hidden ‚Äî tap to peek. Rehearsal Pro method.</div></div>
      <div class="pm-arrow">‚Ä∫</div>
    </div>
    <div class="pm-card" onclick="startAudioGap()" style="border-left:3px solid var(--sage);">
      <div class="pm-icon">üéß</div>
      <div class="pm-info"><div class="pm-name">Audio Run-Through</div><div class="pm-desc">Scene plays aloud ‚Äî gap left for your line. Line Learner method.</div></div>
      <div class="pm-arrow">‚Ä∫</div>
    </div>
    <div class="pm-card" onclick="startTeleprompter()" style="border-left:3px solid var(--amber);">
      <div class="pm-icon">üìú</div>
      <div class="pm-info"><div class="pm-name">Teleprompter</div><div class="pm-desc">Full script auto-scrolls. Your lines highlighted or hidden.</div></div>
      <div class="pm-arrow">‚Ä∫</div>
    </div>
    <div class="pm-card" onclick="showProgressDashboard()">
      <div class="pm-icon">üìä</div>
      <div class="pm-info"><div class="pm-name">Progress Dashboard</div><div class="pm-desc">See which scenes you've mastered</div></div>
      <div class="pm-arrow">‚Ä∫</div>
    </div>`;
}

function setPracticeScript(idx, btn) {
  activeProduction = productions[idx];
  document.querySelectorAll('#practiceScriptPicker .tool-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  refreshPracticeScreen();
}

// Show my lines only in practice
function showMyLinesOnly() {
  const prod = activeProduction || productions[0];
  if(!prod) return;
  navTo('scriptScreen', 1);
  setTimeout(() => {
    showScriptDetail(productions.indexOf(prod));
    setTimeout(() => {
      const myLinesBtn = document.getElementById('detailMyLinesOnly');
      if(myLinesBtn && !myLinesBtn.classList.contains('active')) myLinesBtn.click();
    }, 100);
  }, 50);
}

let activeSceneFilter = 'all';

function setSceneFilter(scene, btn) {
  activeSceneFilter = scene;
  document.querySelectorAll('#practiceContent .tool-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const prod = activeProduction || productions[0];
  if(!prod) return;
  const count = scene==='all' ? (prod.cuePairs||[]).length : (prod.cuePairs||[]).filter(p=>(p.scene||'Scene 1')===scene).length;
  const el = document.getElementById('practiceLineCount');
  if(el) el.textContent = count + ' lines' + (scene!=='all'?' in '+scene:' total');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CUE CARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cuePaused = false;

function startCueCards() {
  const prod = activeProduction || productions[0];
  if(!prod || !prod.cuePairs || (prod.cuePairs||[]).length === 0) { showToast('No lines found!'); return; }
  cuePairs = activeSceneFilter !== 'all' ? (prod.cuePairs||[]).filter(p=>(p.scene||'Scene 1')===activeSceneFilter) : [...prod.cuePairs];
  if(cuePairs.length === 0) { showToast('No lines in that section!'); return; }
  cueIndex = 0; lineShown = false; cuePaused = false;
  document.getElementById('cueScreenTitle').textContent = `Cue Cards${activeSceneFilter!=='all'?' ‚Äî '+activeSceneFilter:''}`;
  document.getElementById('cuePauseBtn').textContent = '‚è∏ Pause';
  screenIds.forEach(s => { const el=document.getElementById(s); if(el) el.classList.remove('active'); });
  document.querySelectorAll('.game-screen,.hf-screen').forEach(s => s.classList.remove('active'));
  document.getElementById('cueScreen').classList.add('active');
  loadCue();
  window.scrollTo(0,0);
}

function pauseCueCards() {
  cuePaused = !cuePaused;
  document.getElementById('cuePauseBtn').textContent = cuePaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
  if(cuePaused) stopReading();
}

function exitToGameChooser() {
  stopReading();
  clearInterval(gameTimerInt);
  clearInterval(sdTimerInterval);
  // Go back to the game screen home
  screenIds.forEach(s => { const el=document.getElementById(s); if(el) el.classList.remove('active'); });
  document.querySelectorAll('.game-screen,.hf-screen').forEach(s => s.classList.remove('active'));
  document.getElementById('gameScreen').classList.add('active');
  showGameHome();
  document.querySelectorAll('.nav-btn').forEach((b,i) => b.classList.toggle('active', i===3));
  window.scrollTo(0,0);
}

function loadCue() {
  if(cueIndex >= cuePairs.length) { finishCueCards(); return; }
  const pair = cuePairs[cueIndex];
  const pct = (cueIndex/cuePairs.length)*100;
  document.getElementById('cueProgBar').style.width = pct+'%';
  document.getElementById('cueProgLabel').textContent = `Line ${cueIndex+1} of ${cuePairs.length}`;
  document.getElementById('cueTxt').textContent = pair.cue;
  document.getElementById('revealHint').style.display = 'block';
  document.getElementById('revealTxt').textContent = '';
  document.getElementById('myLineReveal').style.background = '';
  document.getElementById('wordAnalysis').innerHTML = '';
  document.getElementById('cueBanner').className = 'result-banner';
  document.getElementById('cueBanner').textContent = '';
  document.getElementById('feedbackRow').style.display = 'none';
  document.getElementById('nextCueBtn').style.display = 'block';
  lineShown = false;
}

function revealMyLine() {
  if(lineShown) return;
  lineShown = true;
  const pair = cuePairs[cueIndex];
  document.getElementById('revealHint').style.display = 'none';
  document.getElementById('revealTxt').textContent = pair.myLine;
  document.getElementById('feedbackRow').style.display = 'flex';
  document.getElementById('nextCueBtn').style.display = 'none';
}

function nextCue(result) {
  const prod = activeProduction || productions[0];
  if(result === 'correct') { addXP(10); if(prod && prod.cuePairs[cueIndex]) prod.cuePairs[cueIndex].needsWork = false; }
  else if(result === 'wrong') { if(prod && prod.cuePairs[cueIndex]) prod.cuePairs[cueIndex].needsWork = true; }
  cueIndex++;
  if(cueIndex >= cuePairs.length) { finishCueCards(); return; }
  loadCue();
}

function finishCueCards() {
  showToast('üéâ Session complete! Great work!');
  addXP(50);
  checkBadges();
  autoSave();
  setTimeout(() => exitToGameChooser(), 1500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME CENTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showGameHome() {
  const gh = document.getElementById('gameHome');
  const gc = document.getElementById('gameChooser');
  if(gh) gh.style.display = 'block';
  if(gc) gc.style.display = 'none';
}

function refreshGameScreen() {
  // Script picker
  const picker = document.getElementById('gameScriptPicker');
  if(!picker) return;
  if(productions.length === 0) {
    picker.innerHTML = `<div style="font-size:13px;color:var(--brown-light);">No scripts yet ‚Äî <button onclick="navTo('scriptScreen',1)" style="background:none;border:none;color:var(--terra);font-weight:900;cursor:pointer;font-family:var(--font);font-size:13px;">upload one first</button></div>`;
    return;
  }
  picker.innerHTML = productions.map((p,i) => 
    `<button class="tool-btn ${activeProduction===p||(!activeProduction&&i===0)?'active':''}" onclick="setGameScript(${i},this)">${p.name||p.myChar}</button>`
  ).join(' ');
  if(!activeProduction && productions.length > 0) activeProduction = productions[0];
  refreshGameScenePicker();
  updateDailyChallenge();
}

function setGameScript(idx, btn) {
  activeProduction = productions[idx];
  document.querySelectorAll('#gameScriptPicker .tool-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  refreshGameScenePicker();
}

function refreshGameScenePicker() {
  const prod = activeProduction;
  const area = document.getElementById('gameScenePicker');
  const pills = document.getElementById('gameScenePills');
  if(!prod || !prod.scenes || prod.scenes.length <= 1) {
    if(area) area.style.display = 'none';
    activeSceneFilter = 'all';
    return;
  }
  if(area) area.style.display = 'block';
  pills.innerHTML = `<button class="tool-btn active" onclick="setGameScene('all',this)">All Scenes</button>` +
    prod.scenes.map(s => `<button class="tool-btn" onclick="setGameScene('${s}',this)">${s}</button>`).join('');
}

function setGameScene(scene, btn) {
  activeSceneFilter = scene;
  document.querySelectorAll('#gameScenePills .tool-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

function updateDailyChallenge() {
  const games = ['fillblank','cue','speed','partner'];
  const today = new Date().getDay();
  const todayGame = games[today % games.length];
  const labels = { fillblank:'Fill in the Blank', cue:'Cue Cards', speed:'Speed Drill', partner:'Scene Partner' };
  const el = document.getElementById('dailyChalDesc');
  if(el) el.textContent = `Today: ${labels[todayGame]}`;
}

function startGameById(gameId) {
  if(productions.length === 0) { showToast('Upload a script first! üìÑ'); navTo('scriptScreen',1); return; }
  if(!activeProduction) activeProduction = productions[0];
  launchGame(gameId);
}

function launchGame(gameId) {
  if(!activeProduction) { showToast('No script loaded!'); return; }
  if(gameId !== 'teleprompter' && (!activeProduction.cuePairs || activeProduction.cuePairs.length === 0)) {
    showToast('No lines to practice! Upload a script first.');
    return;
  }
  if(gameId === 'cue') startCueCards();
  else if(gameId === 'fillblank') startFillBlank();
  else if(gameId === 'speed') startSpeedDrill();
  else if(gameId === 'partner') startScenePartner();
  else if(gameId === 'blackout') startBlackout();
  else if(gameId === 'teleprompter') startTeleprompter();
  else if(gameId === 'audiogap') startAudioGap();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILL IN THE BLANK GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
gameScore=0; gameStreak=0; gameTimerSecs=60; gameTimerInt=null; gameQIndex=0; gameQuestions=[];

function startFillBlank() {
  const prod = activeProduction;
  if(!prod || !prod.cuePairs || (prod.cuePairs||[]).length === 0) { showToast('No lines to practice!'); return; }
  gameScore=0; gameStreak=0; gameQIndex=0;
  gameTimerSecs = {easy:90,medium:60,hard:30}[document.getElementById('diffSel')?.value||'medium'];
  gameQuestions = buildGameQuestions(prod);
  if(gameQuestions.length === 0) { showToast('Lines too short for this game ‚Äî try longer lines!'); return; }
  goToGameScreen('fillBlankScreen');
  loadGameQ();
  startGameTimer();
}

function buildGameQuestions(prod) {
  const pairs = activeSceneFilter==='all' ? prod.cuePairs : (prod.cuePairs||[]).filter(p=>(p.scene||'Scene 1')===activeSceneFilter);
  const questions = [];
  pairs.forEach(pair => {
    const words = pair.myLine.split(/\s+/).filter(w => w.replace(/[^a-zA-Z]/g,'').length > 3);
    if(words.length < 3) return;
    const blankWord = words[Math.floor(Math.random()*words.length)];
    const blankClean = blankWord.replace(/[^a-zA-Z]/g,'').toLowerCase();
    // Get distractors from other lines
    const allWords = pairs.map(p=>p.myLine.split(/\s+/)).flat().filter(w=>w.replace(/[^a-zA-Z]/g,'').length>3 && w.replace(/[^a-zA-Z]/g,'').toLowerCase()!==blankClean);
    const distractors = [...new Set(allWords.map(w=>w.replace(/[^a-zA-Z]/g,'').toLowerCase()))].filter(w=>w!==blankClean).sort(()=>Math.random()-0.5).slice(0,3);
    const options = [...distractors, blankClean].sort(()=>Math.random()-0.5);
    questions.push({ line: pair.myLine, blankWord, blankClean, options });
  });
  return questions.sort(()=>Math.random()-0.5);
}

function loadGameQ() {
  if(gameQuestions.length === 0) return;
  const q = gameQuestions[gameQIndex % gameQuestions.length];
  const display = q.line.replace(new RegExp('\\b'+q.blankWord.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b'), `<span class="blank" id="theBlank">_______</span>`);
  document.getElementById('gameLineCard').innerHTML = `
    <div style="font-size:11px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Fill in the missing word:</div>
    <div style="font-size:15px;line-height:1.8;">${display}</div>`;
  const pct = (gameQIndex%gameQuestions.length)/gameQuestions.length*100;
  document.getElementById('gameProgBar').style.width = pct+'%';
  const opts = document.getElementById('wordOpts');
  opts.innerHTML = '';
  q.options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'wopt';
    btn.textContent = opt;
    btn.onclick = () => checkGameAnswer(opt, q.blankClean, btn);
    opts.appendChild(btn);
  });
  document.getElementById('gameBanner').className = 'result-banner';
  document.getElementById('gameNextBtn').style.display = 'none';
  updateGameUI();
}

function checkGameAnswer(chosen, correct, btn) {
  document.querySelectorAll('.wopt').forEach(b => b.disabled = true);
  const blank = document.getElementById('theBlank');
  const banner = document.getElementById('gameBanner');
  if(chosen.toLowerCase() === correct.toLowerCase()) {
    if(blank) blank.textContent = chosen;
    gameScore += 50 + (gameStreak*10);
    gameStreak++;
    banner.textContent = `‚úÖ Correct! +${50+((gameStreak-1)*10)} pts${gameStreak>1?' üî• √ó'+gameStreak+' streak!':''}`;
    banner.className = 'result-banner res-good';
    btn.style.cssText = 'background:var(--sage);color:white;border-color:var(--sage);';
    if(gameStreak > 2) triggerStreak();
    addXP(20); checkBadges();
  } else {
    if(blank) blank.textContent = chosen;
    gameStreak = 0;
    banner.textContent = `‚ùå The word was "${correct}" ‚Äî keep going!`;
    banner.className = 'result-banner res-bad';
    btn.style.cssText = 'background:var(--terra);color:white;border-color:var(--terra);';
    document.querySelectorAll('.wopt').forEach(b => { if(b.textContent===correct) b.style.cssText='background:var(--sage);color:white;border-color:var(--sage);'; });
  }
  updateGameUI();
  document.getElementById('gameNextBtn').style.display = 'block';
}

function nextGameQ() { gameQIndex++; loadGameQ(); }
function updateGameUI() {
  document.getElementById('gScore').textContent = gameScore;
  document.getElementById('gStreak').textContent = gameStreak;
}

function setDiff(val) {
  clearInterval(gameTimerInt);
  gameTimerSecs = {easy:90,medium:60,hard:30}[val];
  document.getElementById('gTimer').textContent = gameTimerSecs;
  startGameTimer();
  showToast(`Difficulty: ${val.charAt(0).toUpperCase()+val.slice(1)}`);
}

function startGameTimer() {
  clearInterval(gameTimerInt);
  gameTimerInt = setInterval(() => {
    gameTimerSecs--;
    document.getElementById('gTimer').textContent = gameTimerSecs;
    if(gameTimerSecs <= 0) {
      clearInterval(gameTimerInt);
      showToast(`‚è± Time's up! Score: ${gameScore} pts üéâ`);
      addXP(Math.floor(gameScore/10));
      checkBadges();
      setTimeout(() => exitToGameChooser(), 2000);
    }
  }, 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPEED DRILL (rewritten)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sdPairs=[], sdIndex=0, sdStartTime=0, sdTimerInterval=null, sdWrong=0;

function startSpeedDrill() {
  const prod = activeProduction || productions[0];
  if(!prod || !prod.cuePairs || (prod.cuePairs||[]).length === 0) { showToast('No lines!'); return; }
  sdPairs = activeSceneFilter==='all' ? [...prod.cuePairs] : (prod.cuePairs||[]).filter(p=>(p.scene||'Scene 1')===activeSceneFilter);
  if(sdPairs.length===0) { showToast('No lines in that section!'); return; }
  sdIndex=0; sdWrong=0;
  screenIds.forEach(s => { const el=document.getElementById(s); if(el) el.classList.remove('active'); });
  document.querySelectorAll('.game-screen,.hf-screen').forEach(s => s.classList.remove('active'));
  document.getElementById('speedDrillScreen').classList.add('active');
  document.getElementById('sdFinished').style.display = 'none';
  const bestKey = 'sd-best-'+(prod.myChar||'char');
  const best = localStorage.getItem(bestKey);
  document.getElementById('sdBest').textContent = best ? 'Best: '+best+'s for '+sdPairs.length+' lines' : 'Best: not set yet';
  sdLoadLine();
  sdStartTime = Date.now();
  clearInterval(sdTimerInterval);
  sdTimerInterval = setInterval(() => {
    document.getElementById('sdTimer').textContent = ((Date.now()-sdStartTime)/1000).toFixed(1)+'s';
  }, 100);
  window.scrollTo(0,0);
}

function stopSpeedDrill() {
  clearInterval(sdTimerInterval);
  exitToGameChooser();
}

function sdLoadLine() {
  if(sdIndex >= sdPairs.length) { sdFinish(); return; }
  const pair = sdPairs[sdIndex];
  document.getElementById('sdProgress').textContent = (sdIndex+1)+' of '+sdPairs.length;
  document.getElementById('sdSceneTag').textContent = pair.scene||'Scene 1';
  document.getElementById('sdCueText').textContent = pair.cue;
  document.getElementById('sdLineText').textContent = pair.myLine;
}

function sdMark(result) {
  if(result==='wrong') { sdWrong++; if(sdPairs[sdIndex]) sdPairs[sdIndex].needsWork=true; }
  else if(sdPairs[sdIndex]) sdPairs[sdIndex].needsWork=false;
  sdIndex++;
  sdLoadLine();
}

function sdFinish() {
  clearInterval(sdTimerInterval);
  const total = ((Date.now()-sdStartTime)/1000).toFixed(1);
  document.getElementById('sdTimer').textContent = total+'s';
  document.getElementById('sdFinished').style.display = 'block';
  const correct = sdPairs.length - sdWrong;
  document.getElementById('sdFinishStats').textContent = correct+'/'+sdPairs.length+' lines ¬∑ '+total+'s total';
  const prod = activeProduction||productions[0];
  if(prod) {
    const bestKey='sd-best-'+(prod.myChar||'char');
    const best=parseFloat(localStorage.getItem(bestKey))||9999;
    if(parseFloat(total)<best) { localStorage.setItem(bestKey,total); showToast('New best! '+total+'s üèÜ'); document.getElementById('sdBest').textContent='NEW BEST: '+total+'s!'; }
  }
  addXP(correct*10);
  autoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCENE PARTNER (rewritten)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let spPairs=[], spIndex=0, spPaused=false, spMyTurn=false;

function startScenePartner() {
  const prod = activeProduction || productions[0];
  if(!prod || !prod.cuePairs || (prod.cuePairs||[]).length===0) { showToast('No lines!'); return; }
  spPairs = activeSceneFilter==='all' ? [...prod.cuePairs] : (prod.cuePairs||[]).filter(p=>(p.scene||'Scene 1')===activeSceneFilter);
  spIndex=0; spPaused=false; spMyTurn=false;
  screenIds.forEach(s => { const el=document.getElementById(s); if(el) el.classList.remove('active'); });
  document.querySelectorAll('.game-screen,.hf-screen').forEach(s => s.classList.remove('active'));
  document.getElementById('scenePartnerScreen').classList.add('active');
  document.getElementById('spMyCard').style.display = 'none';
  document.getElementById('spOtherCard').style.display = 'none';
  document.getElementById('spMicBtn').style.display = 'none';
  document.getElementById('spResult').style.display = 'none';
  document.getElementById('spStartBtn').style.display = 'block';
  document.getElementById('spStatus').textContent = 'App reads all other characters. You say yours.';
  document.getElementById('spProgress').textContent = '0 of '+spPairs.length+' lines';
  window.scrollTo(0,0);
}

function stopScenePartner() { window.speechSynthesis&&window.speechSynthesis.cancel(); exitToGameChooser(); }

function toggleSPPause() {
  spPaused = !spPaused;
  document.getElementById('spPauseBtn').textContent = spPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
  if(!spPaused && !spMyTurn) spReadOther();
}

function spStart() { document.getElementById('spStartBtn').style.display='none'; spLoadNext(); }

function spLoadNext() {
  if(spIndex >= spPairs.length) { spFinish(); return; }
  const pair = spPairs[spIndex];
  document.getElementById('spProgress').textContent = (spIndex+1)+' of '+spPairs.length+' lines';
  document.getElementById('spOtherCard').style.display = 'block';
  document.getElementById('spMyCard').style.display = 'none';
  document.getElementById('spMicBtn').style.display = 'none';
  document.getElementById('spResult').style.display = 'none';
  document.getElementById('spOtherChar').textContent = 'OTHER CHARACTER';
  document.getElementById('spOtherText').textContent = pair.cue;
  document.getElementById('spStatus').textContent = 'Reading their line...';
  spMyTurn = false;
  if(!spPaused && window.speechSynthesis) {
    window.speechSynthesis.cancel();
    setTimeout(() => {
      const utt = new SpeechSynthesisUtterance(pair.cue);
      utt.rate = ttsRate; utt.pitch=0.95; utt.volume=1;
      const voices = window.speechSynthesis.getVoices();
      const preferred = voices.find(v=>v.lang.startsWith('en')&&v.localService);
      if(preferred) utt.voice=preferred;
      utt.onend = () => { if(!spPaused) spShowMyTurn(); };
      utt.onerror = () => { if(!spPaused) spShowMyTurn(); };
      window.speechSynthesis.speak(utt);
    }, 150);
  } else { setTimeout(spShowMyTurn, 800); }
}

function spReadOther() { spLoadNext(); }

function spShowMyTurn() {
  if(spIndex >= spPairs.length) return;
  spMyTurn = true;
  document.getElementById('spMyCard').style.display = 'block';
  document.getElementById('spMyChar').textContent = 'üé≠ YOUR LINE';
  document.getElementById('spMyText').textContent = '(tap mic to speak, or tap Next)';
  document.getElementById('spMicBtn').style.display = 'block';
  document.getElementById('spMicBtn').className = 'hf-big-btn idle';
  document.getElementById('spMicBtn').textContent = 'üéô';
  document.getElementById('spStatus').textContent = 'Your turn!';
}

function spMicTap() {
  if(!('SpeechRecognition' in window||'webkitSpeechRecognition' in window)) { showToast('Tap Next to continue'); spNext(); return; }
  const btn = document.getElementById('spMicBtn');
  btn.className='hf-big-btn listening'; btn.textContent='üî¥';
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
  const rec = new SR(); rec.lang='en-GB'; rec.continuous=false; rec.interimResults=false;
  rec.onresult = e => { const spoken=e.results[0][0].transcript; btn.className='hf-big-btn idle'; btn.textContent='üéô'; spCheckLine(spoken); };
  rec.onerror = () => { btn.className='hf-big-btn idle'; btn.textContent='üéô'; };
  rec.start(); setTimeout(()=>{ try{rec.stop();}catch(e){} },9000);
}

function spCheckLine(spoken) {
  if(!spPairs[spIndex]) { spNext(); return; }
  const correct = spPairs[spIndex].myLine;
  const result = compareLines(spoken, correct);
  const resultEl = document.getElementById('spResult');
  resultEl.style.display='block';
  document.getElementById('spMyText').textContent = correct;
  if(result.pct >= 0.75) {
    resultEl.className='hf-result good'; resultEl.textContent='‚úÖ '+Math.round(result.pct*100)+'% ‚Äî nice!';
    addXP(10); setTimeout(()=>{ spIndex++; spLoadNext(); },1200);
  } else {
    resultEl.className='hf-result close'; resultEl.textContent='You said: "'+spoken+'" ‚Äî tap Next when ready';
  }
}

function spNext() { document.getElementById('spMyText').textContent=spPairs[spIndex]?spPairs[spIndex].myLine:''; spIndex++; spLoadNext(); }

function spFinish() {
  showToast('Scene complete! üéâ'); addXP(50); checkBadges(); autoSave();
  setTimeout(()=>exitToGameChooser(), 1500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STUDY TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sessionMins = 20;

function openTimer() { document.getElementById('timerModal').classList.add('show'); }
function closeTimer() {
  document.getElementById('timerModal').classList.remove('show');
  clearInterval(timerInterval);
  timerRunning=false; isBreak=false;
  resetTimerDisplay();
}

function resetTimerDisplay() {
  const mins = sessionMins || 20;
  timerSecs = mins * 60;
  const display = `${String(Math.floor(timerSecs/60)).padStart(2,'0')}:${String(timerSecs%60).padStart(2,'0')}`;
  const el = document.getElementById('timerDisplay');
  if(el) { el.textContent = display; el.style.color = 'var(--terra)'; }
  const btn = document.getElementById('timerToggleBtn');
  if(btn) btn.textContent = '‚ñ∂ Start';
  const lbl = document.getElementById('timerModeLabel');
  if(lbl) lbl.textContent = mins+' min focus session';
}

function setSessionLength(mins) {
  sessionMins = mins;
  clearInterval(timerInterval);
  timerRunning = false;
  resetTimerDisplay();
  showToast('Session: '+mins+' min');
}

function setBreakLength(mins) {
  breakLen = mins;
  showToast('Break: '+mins+' min');
}

function selectBreak(mins) { setBreakLength(mins); }

function toggleTimer() {
  if(!timerRunning) {
    timerRunning = true;
    const btn = document.getElementById('timerToggleBtn');
    if(btn) btn.textContent = '‚è∏ Pause';
    timerInterval = setInterval(() => {
      timerSecs--;
      const display = `${String(Math.floor(timerSecs/60)).padStart(2,'0')}:${String(timerSecs%60).padStart(2,'0')}`;
      const el = document.getElementById('timerDisplay');
      if(el) el.textContent = display;
      if(timerSecs <= 0) {
        clearInterval(timerInterval);
        timerRunning = false;
        if(!isBreak) {
          isBreak = true;
          timerSecs = breakLen * 60;
          showToast('üîî Break time! Rest for '+breakLen+' min');
          const lbl = document.getElementById('timerModeLabel');
          if(lbl) lbl.textContent = breakLen+' min break';
          const el2 = document.getElementById('timerDisplay');
          if(el2) el2.style.color = 'var(--sage)';
        } else {
          isBreak = false;
          timerSecs = (sessionMins||20) * 60;
          showToast('üéØ Break over! Back to work!');
          resetTimerDisplay();
        }
      }
    }, 1000);
  } else {
    timerRunning = false;
    clearInterval(timerInterval);
    const btn = document.getElementById('timerToggleBtn');
    if(btn) btn.textContent = '‚ñ∂ Resume';
  }
}

function resetTimer() {
  clearInterval(timerInterval);
  timerRunning = false;
  isBreak = false;
  resetTimerDisplay();
}


// (timer functions above)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function globalFontSize(d) {
  globalFs = Math.max(12,Math.min(24,globalFs+d));
  document.getElementById('globalFsDisplay').textContent = globalFs;
  document.body.style.fontSize = globalFs+'px';
}

// theme functions above replace setTint

function setBreakLen(mins) {
  breakLen = mins;
  // Update UI if elements exist
  const b5 = document.getElementById('break5Btn');
  const b10 = document.getElementById('break10Btn');
  if(b5) b5.classList.toggle('active', mins===5);
  if(b10) b10.classList.toggle('active', mins===10);
  showToast('Break: ' + mins + ' min');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEMES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const THEMES = {
  sand:     { sand:'#F5ECD7', sandDark:'#E8D9BC', cream:'#FAF4E8', terra:'#C1614F', terraLight:'#D4826F', terraDark:'#A04F3E', sage:'#7A9E7E', sageDark:'#5A7E5E', brown:'#4A3728', brownLight:'#6B5445', amber:'#E8A838', text:'#4A3728' },
  night:    { sand:'#1A1A2E', sandDark:'#16213E', cream:'#0F3460', terra:'#E94560', terraLight:'#FF6B8A', terraDark:'#C43050', sage:'#4A90D9', sageDark:'#2970B9', brown:'#E8E8F0', brownLight:'#A8A8C0', amber:'#F4C430', text:'#E8E8F0' },
  ocean:    { sand:'#E8F4FD', sandDark:'#D0E8F8', cream:'#F5FBFF', terra:'#2980B9', terraLight:'#5DADE2', terraDark:'#1A6A9A', sage:'#1ABC9C', sageDark:'#16A085', brown:'#1A3A4A', brownLight:'#4A7A9A', amber:'#F39C12', text:'#1A3A4A' },
  sunset:   { sand:'#FFF0E6', sandDark:'#FFD9C0', cream:'#FFF8F4', terra:'#E67E22', terraLight:'#F0A040', terraDark:'#C0612A', sage:'#C0392B', sageDark:'#A03020', brown:'#3A1A0A', brownLight:'#8A4A2A', amber:'#F1C40F', text:'#3A1A0A' },
  lavender: { sand:'#F5F0FF', sandDark:'#E5D8FF', cream:'#FAF6FF', terra:'#8E44AD', terraLight:'#BB77D0', terraDark:'#6C2A8A', sage:'#3498DB', sageDark:'#2070B0', brown:'#2C1A3A', brownLight:'#7A5A9A', amber:'#F39C12', text:'#2C1A3A' },
  forest:   { sand:'#EAF5EA', sandDark:'#CCE8CC', cream:'#F4FCF4', terra:'#27AE60', terraLight:'#52C880', terraDark:'#1A8A48', sage:'#F39C12', sageDark:'#D68A00', brown:'#1A3A1A', brownLight:'#4A7A4A', amber:'#E74C3C', text:'#1A3A1A' },
  rose:     { sand:'#FFF0F5', sandDark:'#FFD0E8', cream:'#FFF8FC', terra:'#E91E8C', terraLight:'#FF60B0', terraDark:'#C01070', sage:'#9B59B6', sageDark:'#7A3A9A', brown:'#3A0A2A', brownLight:'#8A4A7A', amber:'#F39C12', text:'#3A0A2A' },
  slate:    { sand:'#ECF0F1', sandDark:'#D0D8DA', cream:'#F8FAFB', terra:'#2C3E50', terraLight:'#546E7A', terraDark:'#1A2A38', sage:'#7F8C8D', sageDark:'#5D6D7E', brown:'#1A1A1A', brownLight:'#555555', amber:'#E74C3C', text:'#1A1A1A' }
};

let currentTheme = localStorage.getItem('escomind-theme') || 'sand';

function applyTheme(name, el) {
  const t = THEMES[name];
  if(!t) return;
  currentTheme = name;
  localStorage.setItem('escomind-theme', name);
  const r = document.documentElement;
  r.style.setProperty('--sand', t.sand);
  r.style.setProperty('--sand-dark', t.sandDark);
  r.style.setProperty('--cream', t.cream);
  r.style.setProperty('--terra', t.terra);
  r.style.setProperty('--terra-light', t.terraLight);
  r.style.setProperty('--terra-dark', t.terraDark);
  r.style.setProperty('--sage', t.sage);
  r.style.setProperty('--sage-dark', t.sageDark);
  r.style.setProperty('--brown', t.brown);
  r.style.setProperty('--brown-light', t.brownLight);
  r.style.setProperty('--amber', t.amber);
  document.body.style.color = t.text;
  document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
  if(el) el.classList.add('active');
  else {
    var grid = document.getElementById('themeGrid');
    if(grid) { var cards = grid.querySelectorAll('.theme-card'); var idx = Object.keys(THEMES).indexOf(name); if(cards[idx]) cards[idx].classList.add('active'); }
  }
  showToast('Theme changed to ' + name.charAt(0).toUpperCase() + name.slice(1) + ' !');
}

function loadSavedTheme() {
  var saved = localStorage.getItem('escomind-theme') || 'sand';
  applyTheme(saved, null);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIDENCE RATINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setConfidence(prodIdx, pairIdx, level) {
  if(productions[prodIdx] && productions[prodIdx].cuePairs[pairIdx]) {
    productions[prodIdx].cuePairs[pairIdx].confidence = level;
    autoSave();
    showProgressDashboard();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROGRESS DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showProgressDashboard() {
  const prod = activeProduction || productions[0];
  if(!prod) { showToast('No script loaded yet!'); return; }
  const screen = document.getElementById('progressDashScreen');
  screen.classList.add('active');
  document.getElementById('dashSubtitle').textContent = prod.myChar + ' ‚Äî ' + (prod.cuePairs||[]).length + ' lines';
  renderDashboard(prod);
}

function hideProgressDashboard() {
  document.getElementById('progressDashScreen').classList.remove('active');
}

function renderDashboard(prod) {
  const pairs = prod.cuePairs;
  const prodIdx = productions.indexOf(prod);
  const total = pairs.length;
  const solid = pairs.filter(p => p.confidence === 'solid').length;
  const getting = pairs.filter(p => p.confidence === 'getting').length;
  const shaky = pairs.filter(p => p.confidence === 'shaky').length;
  const unrated = total - solid - getting - shaky;
  const pct = total > 0 ? Math.round((solid / total) * 100) : 0;

  const scenes = prod.scenes && prod.scenes.length > 0 ? prod.scenes : ['All Lines'];

  let html = '<div class="card" style="margin-bottom:16px;">';
  html += '<div style="font-size:28px;font-weight:900;color:var(--terra);">' + pct + '% solid</div>';
  html += '<div style="font-size:13px;color:var(--brown-light);margin-bottom:12px;">' + solid + ' solid ¬∑ ' + getting + ' getting there ¬∑ ' + shaky + ' shaky ¬∑ ' + unrated + ' unrated</div>';
  html += '<div class="scene-progress-bar"><div class="scene-progress-fill" style="width:' + pct + '%"></div></div>';
  html += '</div>';

  html += '<div class="section-title" style="font-size:14px;margin-bottom:12px;">Rate each line ‚Äî tap to update:</div>';

  scenes.forEach(function(scene) {
    const scenePairs = pairs.filter(function(p, i) {
      return (p.scene || scenes[0]) === scene || scenes.length === 1;
    }).map(function(p, i) { return { p: p, idx: pairs.indexOf(p) }; });

    const scPct = scenePairs.length > 0 ? Math.round((scenePairs.filter(function(x){ return x.p.confidence==='solid'; }).length / scenePairs.length) * 100) : 0;

    html += '<div style="margin-bottom:20px;">';
    html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">';
    html += '<div style="background:var(--sage);color:white;border-radius:99px;padding:4px 14px;font-size:11px;font-weight:900;">' + scene + '</div>';
    html += '<div style="font-size:12px;font-weight:800;color:var(--brown-light);">' + scPct + '% solid</div>';
    html += '</div>';

    scenePairs.forEach(function(item) {
      const p = item.p;
      const i = item.idx;
      const conf = p.confidence || 'unrated';
      html += '<div style="background:var(--cream);border-radius:var(--rs);padding:12px 14px;margin-bottom:8px;box-shadow:var(--shadow);">';
      html += '<div style="font-size:12px;color:var(--brown-light);margin-bottom:4px;font-style:italic;">"' + (p.cue.length > 60 ? p.cue.substring(0,60)+'...' : p.cue) + '"</div>';
      html += '<div style="font-size:14px;font-weight:700;margin-bottom:10px;line-height:1.5;">' + p.myLine + '</div>';
      html += '<div style="display:flex;gap:6px;">';
      html += '<button class="conf-pill conf-shaky' + (conf==='shaky'?' active" style="border:2px solid var(--terra);':'"') + ' onclick="setConfidence(' + prodIdx + ',' + i + ',\'shaky\')">üî¥ Shaky</button>';
      html += '<button class="conf-pill conf-getting' + (conf==='getting'?' active" style="border:2px solid var(--amber);':'"') + ' onclick="setConfidence(' + prodIdx + ',' + i + ',\'getting\')">üü° Getting there</button>';
      html += '<button class="conf-pill conf-solid' + (conf==='solid'?' active" style="border:2px solid var(--sage);':'"') + ' onclick="setConfidence(' + prodIdx + ',' + i + ',\'solid\')">üü¢ Solid</button>';
      html += '</div></div>';
    });
    html += '</div>';
  });

  document.getElementById('dashContent').innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HANDS-FREE MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let hfPairs = [], hfIndex = 0, hfPaused = false, hfSpeaking = false;

function startHandsFree() {
  const prod = activeProduction || productions[0];
  if(!prod || (prod.cuePairs||[]).length === 0) { showToast('No lines to practise!'); return; }
  hfPairs = activeSceneFilter === 'all' ? prod.cuePairs : (prod.cuePairs||[]).filter(function(p){ return (p.scene||'Scene 1') === activeSceneFilter; });
  hfIndex = 0;
  hfPaused = false;
  document.getElementById('handsFreeScreen').classList.add('active');
  document.getElementById('hfResult').style.display = 'none';
  hfLoadLine();
  setTimeout(hfReadCue, 500);
}

function stopHandsFree() {
  window.speechSynthesis && window.speechSynthesis.cancel();
  document.getElementById('handsFreeScreen').classList.remove('active');
}

function toggleHFPause() {
  hfPaused = !hfPaused;
  document.getElementById('hfPauseBtn').textContent = hfPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
  if(!hfPaused) hfReadCue();
}

function hfLoadLine() {
  if(hfIndex >= hfPairs.length) { hfFinish(); return; }
  const pair = hfPairs[hfIndex];
  document.getElementById('hfCueText').textContent = pair.cue;
  document.getElementById('hfProgress').textContent = 'Line ' + (hfIndex+1) + ' of ' + hfPairs.length;
  document.getElementById('hfStatus').textContent = 'Reading cue aloud...';
  document.getElementById('hfResult').style.display = 'none';
  document.getElementById('hfMicBtn').className = 'hf-big-btn idle';
  document.getElementById('hfMicBtn').textContent = 'üéô';
}

function hfReadCue() {
  if(hfPaused || hfIndex >= hfPairs.length) return;
  if(!window.speechSynthesis) { hfMicReady(); return; }
  window.speechSynthesis.cancel();
  const pair = hfPairs[hfIndex];
  document.getElementById('hfMicBtn').className = 'hf-big-btn speaking';
  document.getElementById('hfMicBtn').textContent = 'üîä';
  hfSpeaking = true;
  setTimeout(function() {
    const utt = new SpeechSynthesisUtterance(pair.cue);
    utt.rate = 0.9; utt.pitch = 1.1; utt.volume = 1;
    const voices = window.speechSynthesis.getVoices();
    const preferred = voices.find(function(v){ return v.lang.startsWith('en') && v.localService; });
    if(preferred) utt.voice = preferred;
    utt.onend = function() { if(!hfPaused) hfMicReady(); };
    utt.onerror = function() { if(!hfPaused) hfMicReady(); };
    window.speechSynthesis.speak(utt);
  }, 150);
}

function hfMicReady() {
  hfSpeaking = false;
  document.getElementById('hfMicBtn').className = 'hf-big-btn idle';
  document.getElementById('hfMicBtn').textContent = 'üéô';
  document.getElementById('hfStatus').textContent = 'Your turn ‚Äî tap the mic and say your line';
}

function hfMicTap() {
  if(hfSpeaking) { window.speechSynthesis && window.speechSynthesis.cancel(); hfMicReady(); return; }
  if(!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
    showToast('Voice not supported on this browser'); return;
  }
  const btn = document.getElementById('hfMicBtn');
  btn.className = 'hf-big-btn listening';
  btn.textContent = 'üî¥';
  document.getElementById('hfStatus').textContent = 'Listening...';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SR();
  rec.lang = 'en-GB'; rec.continuous = false; rec.interimResults = false;
  rec.onresult = function(e) {
    const spoken = e.results[0][0].transcript;
    btn.className = 'hf-big-btn idle'; btn.textContent = 'üéô';
    hfCheckLine(spoken);
  };
  rec.onerror = function() {
    btn.className = 'hf-big-btn idle'; btn.textContent = 'üéô';
    document.getElementById('hfStatus').textContent = 'Could not hear you ‚Äî try again or tap Got it';
  };
  rec.start();
  setTimeout(function(){ try{rec.stop();}catch(e){} }, 9000);
}

function hfCheckLine(spoken) {
  const correct = hfPairs[hfIndex].myLine;
  const result = compareLines(spoken, correct);
  const resultEl = document.getElementById('hfResult');
  resultEl.style.display = 'block';
  if(result.pct >= 0.85) {
    resultEl.className = 'hf-result good';
    resultEl.textContent = '‚úÖ Nailed it! ' + Math.round(result.pct*100) + '% match';
    document.getElementById('hfStatus').textContent = 'Great! Moving to next line...';
    setTimeout(function(){ hfNext('correct'); }, 1500);
  } else if(result.pct >= 0.55) {
    resultEl.className = 'hf-result close';
    resultEl.textContent = '~ Close! ' + Math.round(result.pct*100) + '% ‚Äî you said: "' + spoken + '"';
    document.getElementById('hfStatus').textContent = 'Your line: ' + correct;
  } else {
    resultEl.className = 'hf-result wrong';
    resultEl.textContent = '‚úó Not quite. You said: "' + spoken + '"';
    document.getElementById('hfStatus').textContent = 'Your line: ' + correct;
  }
}

function hfNext(result) {
  if(result === 'correct') addXP(10);
  hfIndex++;
  if(hfIndex >= hfPairs.length) { hfFinish(); return; }
  hfLoadLine();
  setTimeout(hfReadCue, 400);
}

function hfFinish() {
  document.getElementById('hfStatus').textContent = 'üéâ All lines done! Amazing work!';
  document.getElementById('hfMicBtn').textContent = 'üéâ';
  document.getElementById('hfMicBtn').className = 'hf-big-btn idle';
  showToast('Hands-Free session complete!');
  addXP(50);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  XP + FEEDBACK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// addXP defined above

function triggerStreak() {
  const el = document.getElementById('streakFx');
  el.classList.add('pop');
  setTimeout(()=>el.classList.remove('pop'), 700);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timeout);
  t._timeout = setTimeout(()=>t.classList.remove('show'), 2600);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLOSE DICT ON OUTSIDE CLICK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('click', e=>{
  if(!e.target.closest('#dictPop') && !e.target.closest('.clickword')) closeDict();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOAD SAMPLE SCRIPT ON FIRST VISIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MANUAL LINE ENTRY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let manualPairs = [];
let manualChar = '';
let manualCurrentScene = 'Scene 1';
let manualScenes = ['Scene 1'];
let manualViewingScene = 'all';

function startManualEntry() {
  const name = document.getElementById('manualCharName').value.trim().toUpperCase();
  if(!name) { showToast('Please enter your character name first'); return; }
  manualChar = name;
  manualPairs = [];
  manualCurrentScene = 'Scene 1';
  manualScenes = ['Scene 1'];
  manualViewingScene = 'all';

  const existing = productions.find(p => p.myChar === manualChar && p.isManual);
  if(existing) {
    manualPairs = existing.cuePairs.map(p => ({...p}));
    manualScenes = [...new Set(manualPairs.map(p => p.scene || 'Scene 1'))];
    manualCurrentScene = manualScenes[manualScenes.length - 1];
    showToast('Continuing ' + manualChar + ' -- ' + manualPairs.length + ' lines already saved');
  }

  document.getElementById('manualCharDisplay').textContent = manualChar;
  document.getElementById('manualStep1').style.display = 'none';
  document.getElementById('manualStep2').style.display = 'block';
  document.getElementById('manualCueInput').value = '';
  document.getElementById('manualLineInput').value = '';
  updateSceneBanner();
  refreshManualList();
}

function newScene() {
  // Auto-save any lines typed so far before switching
  saveManualProduction();

  const num = manualScenes.length + 1;
  const defaultName = 'Scene ' + num;
  const banner = document.getElementById('manualSceneBanner');
  banner.style.background = 'var(--brown)';
  banner.innerHTML =
    '<div style="flex:1;">' +
      '<div style="font-size:11px;font-weight:900;opacity:0.85;text-transform:uppercase;letter-spacing:1px;color:white;margin-bottom:6px;">Name this new scene:</div>' +
      '<input id="newSceneInput" value="' + defaultName + '" ' +
        'onkeydown="if(event.key===\'Enter\')confirmNewScene()" ' +
        'style="width:100%;padding:8px 12px;border-radius:var(--rs);border:none;font-family:var(--font);font-size:14px;font-weight:700;color:var(--brown);background:white;">' +
    '</div>' +
    '<button onclick="confirmNewScene()" style="margin-left:10px;background:rgba(255,255,255,0.25);border:none;color:white;border-radius:99px;padding:8px 16px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;white-space:nowrap;">' +
      '‚úÖ Start' +
    '</button>';
  setTimeout(function() { var el = document.getElementById('newSceneInput'); if(el) { el.select(); el.focus(); } }, 100);
}

function confirmNewScene() {
  var input = document.getElementById('newSceneInput');
  var name = input ? input.value.trim() : '';
  if(!name) { showToast('Please give the scene a name'); return; }
  if(manualScenes.includes(name)) { showToast('A scene with that name already exists'); return; }
  // Save previous scene's lines automatically
  saveManualProduction();
  manualScenes.push(name);
  manualCurrentScene = name;
  manualViewingScene = 'all';
  updateSceneBanner();
  refreshManualList();
  // Clear inputs ready for new scene
  document.getElementById('manualCueInput').value = '';
  document.getElementById('manualLineInput').value = '';
  showToast('Scene saved! Now entering: ' + name);
  document.getElementById('manualCueInput').focus();
}

function updateSceneBanner() {
  var banner = document.getElementById('manualSceneBanner');
  banner.style.background = 'var(--sage)';
  banner.innerHTML =
    '<div>' +
      '<div style="font-size:11px;font-weight:900;opacity:0.85;text-transform:uppercase;letter-spacing:1px;">Currently entering:</div>' +
      '<div style="font-size:15px;font-weight:900;" id="manualSceneBannerName">' + manualCurrentScene + '</div>' +
    '</div>' +
    '<button onclick="newScene()" style="background:rgba(255,255,255,0.25);border:none;color:white;border-radius:99px;padding:8px 16px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">' +
      '+ New Scene' +
    '</button>';
  var el = document.getElementById('manualCurrentSceneName');
  if(el) el.textContent = manualCurrentScene;
}

function switchScene(scene) {
  manualCurrentScene = scene;
  updateSceneBanner();
  showToast('Switched to: ' + scene);
}

function addManualLine() {
  var cue = document.getElementById('manualCueInput').value.trim();
  var line = document.getElementById('manualLineInput').value.trim();
  if(!line) { showToast('Your line is missing! The cue is what the other person says before you'); return; }
  manualPairs.push({ cue: cue || '(start of scene)', myLine: line, scene: manualCurrentScene, needsWork: false });
  document.getElementById('manualCueInput').value = '';
  document.getElementById('manualLineInput').value = '';
  document.getElementById('manualCueInput').focus();
  document.getElementById('manualLineCount').textContent = manualPairs.length;
  var sceneLines = manualPairs.filter(function(p) { return p.scene === manualCurrentScene; }).length;
  showToast('Line ' + manualPairs.length + ' added to ' + manualCurrentScene + ' (' + sceneLines + ' in this scene)');
  refreshManualList();
  saveManualProduction();
}

function refreshManualList() {
  var list = document.getElementById('manualLinesList');
  var inner = document.getElementById('manualLinesListInner');
  var tabsEl = document.getElementById('manualSceneTabs');
  document.getElementById('manualLineCount').textContent = manualPairs.length;
  if(manualPairs.length === 0) { list.style.display = 'none'; return; }
  list.style.display = 'block';

  var allScenes = [];
  manualPairs.forEach(function(p) {
    var sc = p.scene || 'Scene 1';
    if(!allScenes.includes(sc)) allScenes.push(sc);
  });

  var tabHTML = '<button class="tool-btn ' + (manualViewingScene==='all'?'active':'') + '" onclick="filterManualScene(\'all\')">All (' + manualPairs.length + ')</button>';
  allScenes.forEach(function(s) {
    var count = manualPairs.filter(function(p){ return (p.scene||'Scene 1')===s; }).length;
    tabHTML += '<button class="tool-btn ' + (manualViewingScene===s?'active':'') + '" onclick="filterManualScene(\'' + s + '\')">' + s + ' (' + count + ')</button>';
  });
  tabsEl.innerHTML = tabHTML;

  var toShow = manualViewingScene === 'all' ? manualPairs : manualPairs.filter(function(p){ return (p.scene||'Scene 1') === manualViewingScene; });

  var grouped = {};
  toShow.forEach(function(p) {
    var sc = p.scene || 'Scene 1';
    if(!grouped[sc]) grouped[sc] = [];
    grouped[sc].push({cue:p.cue, myLine:p.myLine, scene:p.scene, globalIdx: manualPairs.indexOf(p)});
  });

  var html = '';
  Object.keys(grouped).forEach(function(scene) {
    var pairs = grouped[scene];
    html += '<div style="margin-bottom:20px;">';
    html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">';
    html += '<div style="background:var(--sage);color:white;border-radius:99px;padding:4px 14px;font-size:11px;font-weight:900;">Scene: ' + scene + '</div>';
    html += '<button onclick="switchScene(\'' + scene + '\')" style="background:none;border:2px solid var(--sage);color:var(--sage);border-radius:99px;padding:4px 12px;font-size:10px;font-weight:900;cursor:pointer;font-family:var(--font);">+ Add lines here</button>';
    html += '</div>';

    pairs.forEach(function(p, i) {
      // Insert before button
      html += '<div style="text-align:center;margin:4px 0;">';
      html += '<button onclick="insertLineAt(' + p.globalIdx + ')" style="background:none;border:1px dashed var(--sand-dark);color:var(--brown-light);border-radius:99px;padding:3px 14px;font-size:10px;font-weight:700;cursor:pointer;font-family:var(--font);">+ insert line here</button>';
      html += '</div>';

      // Line card
      html += '<div style="background:var(--cream);border-radius:var(--rs);padding:14px 16px;margin-bottom:4px;box-shadow:var(--shadow);">';

      // Cue row
      html += '<div style="font-size:10px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Cue:</div>';
      html += '<div style="font-size:12px;color:var(--brown-light);margin-bottom:8px;font-style:italic;line-height:1.5;">"' + escapeHtml(p.cue) + '"</div>';

      // My line row
      html += '<div style="font-size:14px;font-weight:700;border-left:4px solid var(--terra);padding-left:10px;line-height:1.6;margin-bottom:12px;">' + escapeHtml(p.myLine) + '</div>';

      // Action buttons
      html += '<div style="display:flex;gap:8px;">';
      html += '<button onclick="editLineAt(' + p.globalIdx + ')" style="flex:1;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:7px 0;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--brown);">‚úèÔ∏è Edit</button>';
      html += '<button onclick="moveLineUp(' + p.globalIdx + ')" ' + (p.globalIdx===0?'disabled':'') + ' style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:7px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--brown);">‚Üë</button>';
      html += '<button onclick="moveLineDown(' + p.globalIdx + ')" ' + (p.globalIdx===manualPairs.length-1?'disabled':'') + ' style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:7px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--brown);">‚Üì</button>';
      html += '<button onclick="deleteManualLine(' + p.globalIdx + ')" style="background:#F5D0CA;border:none;border-radius:99px;padding:7px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--terra-dark);">üóë Delete</button>';
      html += '</div>';
      html += '</div>';
    });

    // Insert at end of scene
    html += '<div style="text-align:center;margin:4px 0 8px;">';
    html += '<button onclick="switchScene(\'' + scene + '\')" style="background:none;border:1px dashed var(--sand-dark);color:var(--brown-light);border-radius:99px;padding:3px 14px;font-size:10px;font-weight:700;cursor:pointer;font-family:var(--font);">+ insert line at end of ' + scene + '</button>';
    html += '</div>';
    html += '</div>';
  });
  inner.innerHTML = html;
}

function escapeHtml(str) {
  if(!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function filterManualScene(scene) {
  manualViewingScene = scene;
  refreshManualList();
}

function deleteManualLine(idx) {
  if(!confirm('Delete this line? This cannot be undone.')) return;
  manualPairs.splice(idx, 1);
  refreshManualList();
  saveManualProduction();
  showToast('Line deleted');
}

function moveLineUp(idx) {
  if(idx === 0) return;
  var tmp = manualPairs[idx-1];
  manualPairs[idx-1] = manualPairs[idx];
  manualPairs[idx] = tmp;
  refreshManualList();
  saveManualProduction();
}

function moveLineDown(idx) {
  if(idx >= manualPairs.length-1) return;
  var tmp = manualPairs[idx+1];
  manualPairs[idx+1] = manualPairs[idx];
  manualPairs[idx] = tmp;
  refreshManualList();
  saveManualProduction();
}

// Insert a blank line BEFORE the given index
function insertLineAt(idx) {
  // Show the edit modal in insert mode
  openLineModal(null, idx, manualPairs[idx] ? manualPairs[idx].scene : manualCurrentScene);
}

// Edit an existing line
function editLineAt(idx) {
  openLineModal(idx, null, manualPairs[idx].scene);
}

// Single modal for both edit and insert
function openLineModal(editIdx, insertBeforeIdx, scene) {
  var existing = editIdx !== null ? manualPairs[editIdx] : null;
  var modal = document.getElementById('lineEditModal');
  if(!modal) {
    modal = document.createElement('div');
    modal.id = 'lineEditModal';
    modal.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(74,55,40,0.55);z-index:300;align-items:flex-end;justify-content:center;';
    modal.innerHTML =
      '<div style="background:var(--cream);border-radius:var(--r) var(--r) 0 0;padding:28px 22px 44px;width:100%;max-width:580px;animation:slideUp 0.3s ease;">' +
        '<div id="lineModalTitle" style="font-size:18px;font-weight:900;margin-bottom:18px;"></div>' +
        '<div style="font-size:12px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Cue ‚Äî what they say before you:</div>' +
        '<textarea id="lineModalCue" class="paste-area" style="min-height:70px;margin-bottom:14px;"></textarea>' +
        '<div style="font-size:12px;font-weight:900;color:var(--terra);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Your line:</div>' +
        '<textarea id="lineModalLine" class="paste-area" style="min-height:70px;border-color:var(--terra);margin-bottom:18px;"></textarea>' +
        '<div style="display:flex;gap:10px;">' +
          '<button onclick="saveLineModal()" style="flex:2;background:var(--terra);color:white;border:none;border-radius:var(--rs);padding:14px;font-family:var(--font);font-weight:900;font-size:14px;cursor:pointer;">‚úÖ Save</button>' +
          '<button onclick="closeLineModal()" style="flex:1;background:var(--sand);color:var(--brown);border:2px solid var(--sand-dark);border-radius:var(--rs);padding:14px;font-family:var(--font);font-weight:900;font-size:14px;cursor:pointer;">Cancel</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(modal);
  }

  modal._editIdx = editIdx;
  modal._insertBeforeIdx = insertBeforeIdx;
  modal._scene = scene;

  document.getElementById('lineModalTitle').textContent = existing ? 'Edit Line' : 'Insert New Line';
  document.getElementById('lineModalCue').value = existing ? existing.cue : '';
  document.getElementById('lineModalLine').value = existing ? existing.myLine : '';
  modal.style.display = 'flex';
  setTimeout(function(){ document.getElementById('lineModalCue').focus(); }, 100);
}

function closeLineModal() {
  var modal = document.getElementById('lineEditModal');
  if(modal) modal.style.display = 'none';
}

function saveLineModal() {
  var modal = document.getElementById('lineEditModal');
  var cue = document.getElementById('lineModalCue').value.trim();
  var line = document.getElementById('lineModalLine').value.trim();
  if(!line) { showToast('Your line cannot be empty!'); return; }

  var newPair = {
    cue: cue || '(start of scene)',
    myLine: line,
    scene: modal._scene || manualCurrentScene,
    needsWork: false
  };

  if(modal._editIdx !== null) {
    // Edit existing
    manualPairs[modal._editIdx] = newPair;
    showToast('Line updated');
  } else {
    // Insert before index
    manualPairs.splice(modal._insertBeforeIdx, 0, newPair);
    showToast('Line inserted');
  }

  closeLineModal();
  refreshManualList();
  saveManualProduction();
}

function saveManualProduction() {
  if(manualPairs.length === 0) return;
  var scriptData = [];
  manualPairs.forEach(function(p) {
    scriptData.push({ char: 'OTHER', text: p.cue, mine: false, scene: p.scene });
    scriptData.push({ char: manualChar, text: p.myLine, mine: true, scene: p.scene });
  });
  var existingIdx = productions.findIndex(function(p) { return p.myChar === manualChar && p.isManual; });
  var sceneList = [];
  manualPairs.forEach(function(p) { var s = p.scene||'Scene 1'; if(!sceneList.includes(s)) sceneList.push(s); });
  var prod = {
    name: manualChar + ' (Manual)',
    role: manualChar,
    type: 'T',
    scriptData: scriptData,
    cuePairs: manualPairs.map(function(p){ return Object.assign({},p); }),
    scenes: sceneList,
    myChar: manualChar,
    isManual: true,
    id: existingIdx >= 0 ? productions[existingIdx].id : Date.now(),
    progress: existingIdx >= 0 ? productions[existingIdx].progress : 0
  };
  if(existingIdx >= 0) productions[existingIdx] = prod;
  else productions.push(prod);
  activeProduction = prod;
  refreshHome();
  refreshProductionsList();
  refreshPracticeScreen();
  autoSave();
}

function finishManualEntry() {
  if(manualPairs.length === 0) { showToast('Add at least one line first!'); return; }
  saveManualProduction();
  autoSave();
  document.getElementById('manualStep1').style.display = 'block';
  document.getElementById('manualStep2').style.display = 'none';
  document.getElementById('manualCharName').value = '';
  manualPairs = [];
  manualCurrentScene = 'Scene 1';
  manualScenes = ['Scene 1'];
  showToast('All lines saved for ' + manualChar + '!');
  setTimeout(function() { navTo('practiceScreen', 2); }, 800);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYNC ‚Äî Real cross-device sync via JSONBin
//  Works on GitHub Pages, phone, computer, anywhere
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const SYNC_KEY = 'escomind-sync-id';
const SYNC_API  = 'https://api.jsonbin.io/v3/b';

// Keys stored under a stable name that never changes between app versions
let syncBinId  = '6998cb53ae596e708f3b1606';
let syncApiKey = '$2a$10$Dnl4wBnkC0LYovzk5RCXS.ds6PB/Bjq8EZ6w.BWbOZZFUvHAmnrUi';
// Pre-save to localStorage so the app recognises sync as active on first load
localStorage.setItem('escomind-bin-id', syncBinId);
localStorage.setItem('escomind-api-key', syncApiKey);
let isSyncing  = false;

// Always persist keys immediately when set
function persistSyncKeys() {
  if(syncBinId)  { localStorage.setItem('escomind-bin-id', syncBinId);  localStorage.setItem(SYNC_KEY, syncBinId); }
  if(syncApiKey) { localStorage.setItem('escomind-api-key', syncApiKey); }
}

function getDataObject() {
  return {
    productions,
    totalXP,
    dayStreak,
    earnedBadges,
    linesCorrectToday,
    lastPlayDate,
    savedAt: new Date().toISOString()
  };
}

function applyLoadedData(data) {
  if(data.productions && data.productions.length > 0) productions = data.productions;
  if(data.totalXP !== undefined) totalXP = data.totalXP;
  if(data.dayStreak !== undefined) dayStreak = data.dayStreak;
  if(data.earnedBadges) earnedBadges = data.earnedBadges;
  if(data.linesCorrectToday !== undefined) linesCorrectToday = data.linesCorrectToday;
  if(data.lastPlayDate) lastPlayDate = data.lastPlayDate;
  if(productions.length > 0) activeProduction = productions[0];
  refreshHome();
  refreshProductionsList();
  refreshPracticeScreen();
  updateXPDisplays();
}

// Always save to localStorage immediately
function saveLocal() {
  try {
    localStorage.setItem('escomind-local', JSON.stringify(getDataObject()));
  } catch(e) {}
}

function loadLocal() {
  try {
    const d = localStorage.getItem('escomind-local');
    if(d) { applyLoadedData(JSON.parse(d)); return true; }
  } catch(e) {}
  return false;
}

// Cloud sync ‚Äî only runs if user has set up a sync code
async function saveToCloud() {
  saveLocal();
  if(!syncBinId || !syncApiKey) { showSyncStatus('Saved locally', 'var(--sage)'); return; }
  if(isSyncing) return;
  isSyncing = true;
  showSyncStatus('Syncing...', 'var(--brown-light)');
  try {
    const res = await fetch(SYNC_API + '/' + syncBinId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Master-Key': syncApiKey },
      body: JSON.stringify(getDataObject())
    });
    if(res.ok) {
      showSyncStatus('Synced across devices', 'var(--sage)');
    } else {
      showSyncStatus('Sync error ‚Äî saved locally', 'var(--amber)');
    }
  } catch(e) {
    showSyncStatus('Offline ‚Äî saved locally', 'var(--amber)');
  }
  isSyncing = false;
}

async function loadFromCloud() {
  // Always load local first so app works instantly
  loadLocal();
  if(!syncBinId || !syncApiKey) {
    showSyncStatus('No sync set up', 'var(--brown-light)');
    return;
  }
  showSyncStatus('Loading from cloud...', 'var(--brown-light)');
  try {
    const res = await fetch(SYNC_API + '/' + syncBinId + '/latest', {
      headers: { 'X-Master-Key': syncApiKey }
    });
    if(res.ok) {
      const json = await res.json();
      const cloudData = json.record;
      // Use cloud data if it's newer than local
      const local = localStorage.getItem('escomind-local');
      let useCloud = true;
      if(local) {
        const localData = JSON.parse(local);
        const localTime = localData.savedAt ? new Date(localData.savedAt).getTime() : 0;
        const cloudTime = cloudData.savedAt ? new Date(cloudData.savedAt).getTime() : 0;
        useCloud = cloudTime > localTime;
      }
      if(useCloud) {
        applyLoadedData(cloudData);
        saveLocal();
        showSyncStatus('Synced ' + getTimeAgo(new Date(cloudData.savedAt)), 'var(--sage)');
      } else {
        showSyncStatus('Up to date', 'var(--sage)');
      }
    } else {
      showSyncStatus('Cloud unavailable', 'var(--amber)');
    }
  } catch(e) {
    showSyncStatus('Offline ‚Äî using local data', 'var(--amber)');
  }
}

async function createSyncBin() {
  if(!syncApiKey) { showToast('Enter your API key first'); return; }
  showSyncStatus('Creating sync...', 'var(--brown-light)');
  try {
    const res = await fetch(SYNC_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': syncApiKey,
        'X-Bin-Name': 'escomind-data',
        'X-Bin-Private': 'true'
      },
      body: JSON.stringify(getDataObject())
    });
    if(res.ok) {
      const json = await res.json();
      syncBinId = json.metadata.id;
      persistSyncKeys();
      showSyncStatus('Sync created!', 'var(--sage)');
      showToast('Sync set up! Copy your Bin ID: ' + syncBinId);
      refreshSyncUI();
    } else {
      showToast('Could not create sync ‚Äî check your API key');
      showSyncStatus('Setup failed', 'var(--terra)');
    }
  } catch(e) {
    showToast('Network error ‚Äî check your connection');
  }
}

function connectExistingBin(binId) {
  if(!binId || !syncApiKey) { showToast('Enter both your API key and Bin ID'); return; }
  syncBinId = binId.trim();
  persistSyncKeys();
  loadFromCloud().then(function() {
    showToast('Connected! Your data is loading...');
    refreshSyncUI();
  });
}

function disconnectSync() {
  syncBinId = null;
  syncApiKey = null;
  localStorage.removeItem(SYNC_KEY);
  localStorage.removeItem('escomind-api-key');
  showSyncStatus('Sync disconnected', 'var(--brown-light)');
  refreshSyncUI();
  showToast('Sync disconnected ‚Äî data still saved locally');
}

function refreshSyncUI() {
  const el = document.getElementById('syncSetupArea');
  if(!el) return;
  if(syncBinId && syncApiKey) {
    el.innerHTML =
      '<div style="background:rgba(122,158,126,0.15);border-radius:var(--rs);padding:14px 16px;margin-bottom:12px;">' +
        '<div style="font-size:13px;font-weight:900;color:var(--sage-dark);margin-bottom:4px;">Sync active</div>' +
        '<div style="font-size:11px;color:var(--brown-light);margin-bottom:8px;">Bin ID: <code style="background:var(--sand);padding:2px 6px;border-radius:4px;">' + syncBinId + '</code></div>' +
        '<div style="font-size:11px;color:var(--brown-light);">Your data syncs automatically across all your devices.</div>' +
      '</div>' +
      '<button onclick="loadFromCloud()" class="btn btn-sage btn-sm" style="margin-bottom:8px;width:100%;">Force sync now</button>' +
      '<button onclick="disconnectSync()" class="btn btn-ghost btn-sm" style="width:100%;font-size:11px;">Disconnect sync</button>';
  } else {
    el.innerHTML =
      '<div style="font-size:13px;color:var(--brown-light);margin-bottom:12px;line-height:1.6;">' +
        'To sync across devices you need a free JSONBin account.<br>' +
        '<a href="https://jsonbin.io" target="_blank" style="color:var(--terra);font-weight:800;">1. Sign up free at jsonbin.io</a><br>' +
        '2. Copy your Master Key from the dashboard<br>' +
        '3. Paste it below and tap Set Up Sync' +
      '</div>' +
      '<input id="apiKeyInput" class="char-input" placeholder="Paste your JSONBin Master Key here" style="margin-bottom:10px;" value="' + (syncApiKey||'') + '" oninput="syncApiKey=this.value">' +
      '<button onclick="createSyncBin()" class="btn btn-terra" style="margin-bottom:8px;">‚òÅÔ∏è Set Up Sync (first time)</button>' +
      '<div style="font-size:12px;font-weight:800;margin:10px 0 6px;color:var(--brown-light);">Already set up on another device?</div>' +
      '<input id="binIdInput" class="char-input" placeholder="Paste your Bin ID here" style="margin-bottom:10px;">' +
      '<button onclick="connectExistingBin(document.getElementById(\'binIdInput\').value)" class="btn btn-sage">üîó Connect to Existing Sync</button>';
  }
}

function getTimeAgo(date) {
  if(!date) return '';
  const mins = Math.floor((Date.now() - date.getTime()) / 60000);
  if(mins < 1) return 'just now';
  if(mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins/60);
  if(hrs < 24) return hrs + 'h ago';
  return Math.floor(hrs/24) + 'd ago';
}

function showSyncStatus(msg, color) {
  const el = document.getElementById('syncStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.color = color;
  el.style.opacity = '1';
  clearTimeout(el._t);
  el._t = setTimeout(function() { el.style.opacity = '0.4'; }, 3000);
}

function saveData() { saveToCloud(); }

let _saveTimeout = null;
function autoSave() {
  saveLocal(); // save locally immediately
  clearTimeout(_saveTimeout);
  _saveTimeout = setTimeout(saveToCloud, 2000); // cloud after short delay
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EDIT PRODUCTION ‚Äî add lines/scenes to existing script
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function editProduction(idx) {
  const prod = productions[idx];
  if(!prod || !prod.isManual) { showToast('Only manually entered scripts can be edited here'); return; }
  activeProduction = prod;
  // Load into manual entry
  manualChar = prod.myChar;
  manualPairs = (prod.cuePairs||[]).map(function(p) { return Object.assign({}, p); });
  manualScenes = prod.scenes && prod.scenes.length > 0 ? prod.scenes.slice() : ['Scene 1'];
  manualCurrentScene = manualScenes[manualScenes.length - 1];
  manualViewingScene = 'all';
  // Switch to manual tab
  navTo('scriptScreen', 1);
  setTimeout(function() {
    var tabs = document.querySelectorAll('.itab');
    tabs.forEach(function(t) { t.classList.remove('active'); });
    tabs[2].classList.add('active');
    var panels = document.querySelectorAll('.import-panel');
    panels.forEach(function(p) { p.classList.remove('active'); });
    document.getElementById('manualPanel').classList.add('active');
    document.getElementById('manualCharName').value = prod.myChar;
    document.getElementById('manualStep1').style.display = 'none';
    document.getElementById('manualStep2').style.display = 'block';
    document.getElementById('manualCharDisplay').textContent = manualChar;
    document.getElementById('manualCueInput').value = '';
    document.getElementById('manualLineInput').value = '';
    updateSceneBanner();
    refreshManualList();
    showToast('Editing ' + prod.myChar + ' ‚Äî add more lines or scenes');
  }, 200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP STARTUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.addEventListener('load', async function() {
  // Add sync indicator to home header
  var header = document.querySelector('#homeScreen .app-header');
  if(header) {
    var syncEl = document.createElement('div');
    syncEl.id = 'syncStatus';
    syncEl.style.cssText = 'font-size:10px;font-weight:700;color:var(--brown-light);transition:opacity 0.5s;opacity:0.4;max-width:110px;text-align:right;line-height:1.3;';
    syncEl.textContent = 'Loading...';
    header.appendChild(syncEl);
  }

  // Load saved theme
  loadSavedTheme();

  // Load data (localStorage first, cloud on top)
  await loadFromCloud();

  // Update streak
  updateDayStreak();

  // Show sync UI state
  refreshSyncUI();

  // Build sample fallback for games
  rawScriptText = sampleScript;
  var lines = sampleScript.split('\n');
  var parsed = [];
  var curr = null, txt = [];
  function flush2(){ if(curr && txt.length){ parsed.push({char:curr, text:txt.join(' ').trim(), mine:curr==='PUCK'}); txt=[]; } }
  lines.forEach(function(l) {
    var t = l.trim();
    if(!t) return;
    if(/^[A-Z]{2,}$/.test(t)) { flush2(); curr=t; }
    else if(curr) txt.push(t);
  });
  flush2();
  var cps = [];
  for(var i=0; i<parsed.length; i++) {
    if(parsed[i].mine) cps.push({cue: i>0 ? parsed[i-1].text : 'Begin', myLine: parsed[i].text});
  }
  window._sampleProd = {name:'Sample', role:'PUCK', type:'T', scriptData:parsed, cuePairs:cps, myChar:'PUCK', id:0, progress:0};
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MORE MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAKRA SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const CHAKRAS = [
  {
    id: 'root', num: 1, name: 'Root', sanskrit: 'Muladhara', color: '#C62828', emoji: 'üî¥',
    location: 'Base of Spine', element: 'Earth', mantra: 'LAM',
    mudra: 'Thumb and index fingers touch. Arms straight, hands on knees.',
    theme: 'Survival, Grounding, Security',
    balanced: ['Grounded','Secure','Independent','Trusting','Alive','Physically strong'],
    overactive: ['Bossy','Domineering','Greedy','Rigid','Resistant to change','Controlling'],
    blocked: ['Fearful','Anxious','Insecure','Financially stressed','Disconnected from body'],
    actingNote: 'Where does your character carry their body weight? Do they feel rooted or like they might float away? Root energy shows in the hips, legs and feet ‚Äî how they stand, sit and move through space.',
    activation: [
      'Stand barefoot and feel the floor ‚Äî bring this to every entrance your character makes',
      'Stomp the feet gently before entering a scene to awaken root energy',
      'Breathe deeply into the belly and pelvis ‚Äî let the exhale drop weight into the ground',
      'Red visualisation: imagine red light glowing at the base of the spine',
      'Mantra: chant LAM three times before stepping into character'
    ]
  },
  {
    id: 'sacral', num: 2, name: 'Sacral', sanskrit: 'Svadhisthana', color: '#E65100', emoji: 'üü†',
    location: 'Below Navel / Hips', element: 'Water', mantra: 'VAM',
    mudra: 'Palms facing up in lap, right palm resting on top of left.',
    theme: 'Creativity, Emotion, Sensuality, Pleasure',
    balanced: ['Passionate','Creative','Emotionally expressive','Playful','Naturally fluid'],
    overactive: ['Manipulative','Emotionally overwhelming','Craving','Boundary-less','Obsessive'],
    blocked: ['Emotionally shut down','Guilty','Creatively blocked','Rigid in movement','Afraid of intimacy'],
    actingNote: 'The sacral lives in the hips and lower belly. A character with open sacral energy moves fluidly and expressively. A blocked sacral creates physical rigidity, shame about the body, or emotional walls that keep others out.',
    activation: [
      'Roll the hips in slow circles ‚Äî find where your character holds tension or freedom here',
      'Let your character sway or shift weight side to side as they listen',
      'Orange visualisation: warm orange light flowing through the pelvis',
      'Improvise with water ‚Äî how does your character move through a room like water or resist it?',
      'Mantra: chant VAM to open creative flow before emotional scenes'
    ]
  },
  {
    id: 'solar', num: 3, name: 'Solar Plexus', sanskrit: 'Manipura', color: '#F9A825', emoji: 'üü°',
    location: 'Upper Abdomen / Core', element: 'Fire', mantra: 'RAM',
    mudra: 'Hands between heart and stomach, fingers interlaced, thumbtips touching.',
    theme: 'Willpower, Confidence, Purpose, Identity',
    balanced: ['Confident','Purposeful','Self-directed','Decisive','Energetic','Owns their power'],
    overactive: ['Controlling','Judgmental','Aggressive','Needs to be right','Bullying','Arrogant'],
    blocked: ['Powerless','Low self-worth','Procrastinating','Easily dominated','Apathetic','Victim mindset'],
    actingNote: 'The gut and core are the seat of willpower. A character with strong solar energy stands tall and acts with conviction ‚Äî their core is engaged. A blocked solar shows as collapsed posture, hesitation, or an inability to make decisions.',
    activation: [
      'Pull the navel gently toward the spine ‚Äî notice how this changes your character\'s presence',
      'Stand in a power pose for 2 minutes before scenes where your character needs authority',
      'Yellow visualisation: a fire burning in the solar plexus, growing brighter with each breath',
      'Ask: what does this character WANT? Connect every action to a clear want',
      'Mantra: chant RAM to ignite determination and confidence'
    ]
  },
  {
    id: 'heart', num: 4, name: 'Heart', sanskrit: 'Anahata', color: '#2E7D32', emoji: 'üíö',
    location: 'Heart Centre / Chest', element: 'Air', mantra: 'YAM',
    mudra: 'Right hand: index and thumb touching at heart centre. Left hand same, resting on knee.',
    theme: 'Love, Compassion, Connection, Grief',
    balanced: ['Loving','Empathetic','Forgiving','Open','Generous','Genuinely connected'],
    overactive: ['Possessive','Jealous','Smothering','Gives too much','Martyrdom','Codependent'],
    blocked: ['Closed off','Fearful of rejection','Grieving','Isolated','Unable to receive love'],
    actingNote: 'The heart chakra lives in the chest and arms. Open heart energy means the character reaches toward others ‚Äî arms open, chest lifted. Blocked heart energy shows as arms folded, chest collapsed, or a character who cannot be touched or moved.',
    activation: [
      'Open the chest: roll the shoulders back, lift the sternum ‚Äî notice how this changes your character\'s availability',
      'Before scenes of love or loss, place a hand on your own heart and breathe',
      'Green visualisation: warm green light expanding from the chest with each breath',
      'Find what your character loves most ‚Äî and let that love be physically present in every scene',
      'Mantra: chant YAM to open the heart before emotionally vulnerable scenes'
    ]
  },
  {
    id: 'throat', num: 5, name: 'Throat', sanskrit: 'Vishuddha', color: '#1565C0', emoji: 'üîµ',
    location: 'Throat and Neck', element: 'Ether / Space', mantra: 'HAM',
    mudra: 'Hands by stomach, fingers interlaced, thumbtips touching, focus on throat.',
    theme: 'Expression, Truth, Communication, Voice',
    balanced: ['Speaks truth','Articulate','Creative','Heard and understood','Authentic voice'],
    overactive: ['Speaks over others','Lectures','Dominates','Harsh','Interrupts','Gossips'],
    blocked: ['Voiceless','Timid','Swallows words','Afraid to speak truth','Suppressed creativity'],
    actingNote: 'The throat is the bridge between inner world and outer expression. Does your character speak their truth or swallow it? Throat tension, a quiet voice, or speaking over others are all throat chakra signals that inform physical performance.',
    activation: [
      'Hum gently ‚Äî feel the vibration in the throat and chest; bring this resonance to your character\'s voice',
      'Lengthen the back of the neck ‚Äî this opens the throat energetically',
      'Blue visualisation: clear blue light at the throat, expanding with each exhale',
      'Speak your character\'s most important line as a whisper, then as a shout ‚Äî find where the truth lives',
      'Mantra: chant HAM to clear and activate the voice before speaking-heavy scenes'
    ]
  },
  {
    id: 'thirdeye', num: 6, name: 'Third Eye', sanskrit: 'Ajna', color: '#4527A0', emoji: 'üü£',
    location: 'Centre of Forehead', element: 'Light', mantra: 'AUM',
    mudra: 'Hands in front of lower chest, middle fingers pointing up and touching, other fingers bent.',
    theme: 'Intuition, Vision, Wisdom, Clarity',
    balanced: ['Intuitive','Perceptive','Clear purpose','Imaginative','Sees the big picture'],
    overactive: ['Lost in fantasy','Disconnected from reality','Overthinking','Delusional','Spaced out'],
    blocked: ['Confused about purpose','Easily misled','Doubts intuition','Short-sighted','Rigid thinking'],
    actingNote: 'Third eye energy is about how the character sees the world ‚Äî literally and metaphorically. Do they have clarity and vision, or are they lost and confused? This shows in the quality of attention, where the eyes focus, and whether the character seems truly present.',
    activation: [
      'Soften your gaze ‚Äî let the eyes receive rather than search; this is the quality of deep intuitive seeing',
      'Before a scene, close the eyes and ask: what does my character KNOW that they cannot explain?',
      'Indigo visualisation: a deep purple light at the centre of the forehead',
      'Trust your first instinct in every scene ‚Äî the third eye is your character\'s gut wisdom',
      'Mantra: chant AUM (OM) to deepen presence and perceptive clarity'
    ]
  },
  {
    id: 'crown', num: 7, name: 'Crown', sanskrit: 'Sahasrara', color: '#6A1B9A', emoji: 'üëë',
    location: 'Top of Head', element: 'Thought / Consciousness', mantra: 'ANG',
    mudra: 'Hands in front of stomach, fingers interlaced, little fingers pointing upward.',
    theme: 'Spirituality, Connection, Transcendence, Meaning',
    balanced: ['Connected to purpose','Wise','Compassionate','Joyful','Part of something bigger'],
    overactive: ['Spiritually obsessed','Needs to be special','Disconnected from body','Grandiose'],
    blocked: ['Disconnected','No sense of meaning','Spiritually cut off','Lonely','Cynical'],
    actingNote: 'Crown energy is about your character\'s relationship with something bigger than themselves ‚Äî whether that is God, fate, love, community or meaning. Does your character feel part of something or completely alone in the universe? This is the philosophical spine of the role.',
    activation: [
      'Imagine a thread of light from the crown connecting upward ‚Äî let this lift your character\'s entire posture',
      'Ask: what does my character believe in? Even if broken, even if lost ‚Äî what do they reach for?',
      'Violet visualisation: a thousand-petalled lotus blooming at the crown',
      'Find the spiritual or philosophical core of your character\'s worldview ‚Äî let it inform every choice',
      'Mantra: chant ANG to connect with higher purpose and transcendent awareness'
    ]
  }
];

// Scored quiz questions (5 per chakra = 35 total, scored 1-4)
const CHAKRA_QUIZ = [
  // ROOT (0-4)
  { chakra: 'root', q: 'My character feels physically safe and secure in their world', reverse: false },
  { chakra: 'root', q: 'My character is comfortable in their own body', reverse: false },
  { chakra: 'root', q: 'My character has a stable relationship with money, home, and survival', reverse: false },
  { chakra: 'root', q: 'My character is driven by fear, anxiety, or the need to survive', reverse: true },
  { chakra: 'root', q: 'My character feels grounded ‚Äî they have weight and presence', reverse: false },
  // SACRAL (5-9)
  { chakra: 'sacral', q: 'My character expresses their emotions freely and openly', reverse: false },
  { chakra: 'sacral', q: 'My character has a rich creative or sensual inner life', reverse: false },
  { chakra: 'sacral', q: 'My character is emotionally shut down, guilty, or ashamed', reverse: true },
  { chakra: 'sacral', q: 'My character connects easily and warmly with other people', reverse: false },
  { chakra: 'sacral', q: 'My character uses emotion or desire to manipulate others', reverse: true },
  // SOLAR (10-14)
  { chakra: 'solar', q: 'My character knows what they want and pursues it with conviction', reverse: false },
  { chakra: 'solar', q: 'My character has strong self-worth and confidence', reverse: false },
  { chakra: 'solar', q: 'My character feels powerless, dominated, or easily walked over', reverse: true },
  { chakra: 'solar', q: 'My character is controlling, judgmental, or needs to be in charge', reverse: true },
  { chakra: 'solar', q: 'My character has a clear sense of personal identity and purpose', reverse: false },
  // HEART (15-19)
  { chakra: 'heart', q: 'My character gives and receives love openly', reverse: false },
  { chakra: 'heart', q: 'My character is empathetic and genuinely cares about others', reverse: false },
  { chakra: 'heart', q: 'My character is closed off, guarded, or afraid of being hurt', reverse: true },
  { chakra: 'heart', q: 'My character carries grief, loneliness, or a sense of being unloved', reverse: true },
  { chakra: 'heart', q: 'My character is possessive, jealous, or smothering in relationships', reverse: true },
  // THROAT (20-24)
  { chakra: 'throat', q: 'My character speaks their truth clearly and honestly', reverse: false },
  { chakra: 'throat', q: 'My character is creative and expressive', reverse: false },
  { chakra: 'throat', q: 'My character struggles to speak up or swallows their words', reverse: true },
  { chakra: 'throat', q: 'My character dominates conversations or speaks over others', reverse: true },
  { chakra: 'throat', q: 'My character feels heard and understood by the people around them', reverse: false },
  // THIRD EYE (25-29)
  { chakra: 'thirdeye', q: 'My character has strong intuition and trusts their gut', reverse: false },
  { chakra: 'thirdeye', q: 'My character sees the bigger picture of their situation clearly', reverse: false },
  { chakra: 'thirdeye', q: 'My character is confused, easily misled, or lost in life', reverse: true },
  { chakra: 'thirdeye', q: 'My character is lost in fantasy or disconnected from reality', reverse: true },
  { chakra: 'thirdeye', q: 'My character has a clear sense of their own purpose', reverse: false },
  // CROWN (30-34)
  { chakra: 'crown', q: 'My character feels connected to something larger than themselves', reverse: false },
  { chakra: 'crown', q: 'My character has a sense of meaning and purpose in their life', reverse: false },
  { chakra: 'crown', q: 'My character feels spiritually disconnected, cynical, or alone in the universe', reverse: true },
  { chakra: 'crown', q: 'My character is obsessed with being special, chosen, or spiritually superior', reverse: true },
  { chakra: 'crown', q: 'My character is wise and compassionate toward others and themselves', reverse: false },
];

let chakraChar = '';
let chakraProfile = {};
let chakraQuizAnswers = [];
let chakraQuizStep = 0;
let chakraMode = '';

function toggleMoreMenu() {
  const m = document.getElementById('moreMenu');
  const o = document.getElementById('moreMenuOverlay');
  const showing = m.style.display !== 'none';
  m.style.display = showing ? 'none' : 'block';
  o.style.display = showing ? 'none' : 'block';
}
function closeMoreMenu() {
  document.getElementById('moreMenu').style.display = 'none';
  document.getElementById('moreMenuOverlay').style.display = 'none';
}

function chakraGoHome() {
  document.getElementById('chakraHome').style.display = 'block';
  document.getElementById('chakraQuizView').style.display = 'none';
  document.getElementById('chakraResultView').style.display = 'none';
  window.scrollTo(0,0);
  refreshChakraScreen();
}

function refreshChakraScreen() {
  const list = document.getElementById('chakraCharList');
  if(!list) return;
  const chars = [...new Set(productions.map(p => p.myChar).filter(Boolean))];
  list.innerHTML = chars.map(c =>
    `<button onclick="selectChakraChar('${c}')" class="tool-btn ${chakraChar===c?'active':''}">${c}</button>`
  ).join('');
  renderSavedChakraProfiles();
}

function renderSavedChakraProfiles() {
  const area = document.getElementById('chakraSavedProfiles');
  if(!area) return;
  const withProfiles = productions.filter(p => p.chakraProfile && Object.keys(p.chakraProfile).length === 7);
  if(withProfiles.length === 0) { area.innerHTML = ''; return; }
  const stateEmoji = { balanced: '‚úÖ', overactive: 'üî•', blocked: '‚¨áÔ∏è' };
  area.innerHTML = `<div class="section-title">Saved Profiles</div>` +
    withProfiles.map((p,i) => {
      const idx = productions.indexOf(p);
      const states = CHAKRAS.map(ch => stateEmoji[p.chakraProfile[ch.id]] || '‚óØ').join(' ');
      return `<div class="card" style="cursor:pointer;margin-bottom:10px;" onclick="viewSavedProfile(${idx})">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-size:15px;font-weight:900;">${p.myChar}</div>
            <div style="font-size:12px;margin-top:4px;letter-spacing:2px;">${states}</div>
          </div>
          <div style="font-size:12px;color:var(--brown-light);font-weight:700;">View ‚Üí</div>
        </div>
      </div>`;
    }).join('');
}

function viewSavedProfile(prodIdx) {
  const prod = productions[prodIdx];
  if(!prod) return;
  chakraChar = prod.myChar;
  chakraProfile = {...prod.chakraProfile};
  renderChakraResults();
}

function chakraCharTyped(val) {
  chakraChar = val.trim().toUpperCase();
  const show = chakraChar.length > 1;
  document.getElementById('chakraStartBtns').style.display = show ? 'block' : 'none';
  if(show) document.getElementById('chakraCharTitle').textContent = chakraChar;
}

function selectChakraChar(name) {
  chakraChar = name;
  document.getElementById('chakraCharInput').value = name;
  document.getElementById('chakraCharTitle').textContent = name;
  document.getElementById('chakraStartBtns').style.display = 'block';
  const prod = productions.find(p => p.myChar === name);
  if(prod && prod.chakraProfile && Object.keys(prod.chakraProfile).length === 7) {
    chakraProfile = {...prod.chakraProfile};
  } else {
    chakraProfile = {};
  }
  refreshChakraScreen();
}

function startChakraQuiz() {
  if(!chakraChar) { showToast('Choose a character first!'); return; }
  chakraMode = 'quiz';
  chakraQuizStep = 0;
  chakraQuizAnswers = new Array(CHAKRA_QUIZ.length).fill(null);
  document.getElementById('chakraHome').style.display = 'none';
  document.getElementById('chakraQuizView').style.display = 'block';
  document.getElementById('chakraResultView').style.display = 'none';
  renderQuizStep();
  window.scrollTo(0,0);
}

function renderQuizStep() {
  const total = CHAKRA_QUIZ.length;
  const pct = Math.round((chakraQuizStep / total) * 100);
  document.getElementById('chakraQuizProgress').textContent = `Question ${chakraQuizStep+1} of ${total}`;
  
  const q = CHAKRA_QUIZ[chakraQuizStep];
  const ch = CHAKRAS.find(c => c.id === q.chakra);
  const labels = ['Never / Not at all', 'Rarely / A little', 'Sometimes / Somewhat', 'Always / Strongly'];
  const current = chakraQuizAnswers[chakraQuizStep];
  
  document.getElementById('chakraQuizArea').innerHTML = `
    <div style="background:var(--sand);border-radius:var(--rs);height:8px;margin-bottom:20px;">
      <div style="background:${ch.color};height:8px;border-radius:var(--rs);width:${pct}%;transition:width 0.3s;"></div>
    </div>
    <div class="card" style="border-left:5px solid ${ch.color};margin-bottom:16px;">
      <div style="font-size:11px;font-weight:900;color:${ch.color};text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">${ch.emoji} ${ch.name} Chakra</div>
      <div style="font-size:15px;font-weight:700;line-height:1.7;color:var(--brown);">${q.q}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
      ${labels.map((label, i) => `
        <button onclick="selectQuizAnswer(${i+1})" style="background:${current===i+1?ch.color+'22':'var(--cream)'};border:2px solid ${current===i+1?ch.color:'var(--sand-dark)'};border-radius:var(--r);padding:14px 16px;text-align:left;font-family:var(--font);font-size:13px;font-weight:700;color:${current===i+1?ch.color:'var(--brown)'};cursor:pointer;line-height:1.5;">${label}</button>
      `).join('')}
    </div>
    <div style="display:flex;gap:10px;">
      ${chakraQuizStep > 0 ? `<button onclick="quizBack()" class="btn btn-ghost" style="flex:1;">‚Üê Back</button>` : '<div style="flex:1;"></div>'}
      ${current !== null ? `<button onclick="quizNext()" class="btn btn-terra" style="flex:2;">Next ‚Üí</button>` : `<button class="btn" style="flex:2;background:var(--sand-dark);color:var(--brown-light);cursor:default;">Choose an answer</button>`}
    </div>
  `;
}

function selectQuizAnswer(val) {
  chakraQuizAnswers[chakraQuizStep] = val;
  renderQuizStep();
}

function quizBack() {
  if(chakraQuizStep > 0) { chakraQuizStep--; renderQuizStep(); window.scrollTo(0,0); }
}

function quizNext() {
  if(chakraQuizAnswers[chakraQuizStep] === null) return;
  chakraQuizStep++;
  if(chakraQuizStep >= CHAKRA_QUIZ.length) {
    computeChakraScores();
  } else {
    renderQuizStep();
    window.scrollTo(0,0);
  }
}

function computeChakraScores() {
  // Score each chakra: 5 questions, each 1-4, max 20
  const scores = {};
  CHAKRAS.forEach(ch => scores[ch.id] = 0);
  
  CHAKRA_QUIZ.forEach((q, i) => {
    let answer = chakraQuizAnswers[i] || 2;
    if(q.reverse) answer = 5 - answer; // flip: high score on reversed = actually low
    scores[q.chakra] += answer;
  });
  
  // Map scores to states
  // 5-10: blocked, 11-15: balanced, 16-20: overactive
  chakraProfile = {};
  CHAKRAS.forEach(ch => {
    const s = scores[ch.id];
    if(s <= 10) chakraProfile[ch.id] = 'blocked';
    else if(s <= 15) chakraProfile[ch.id] = 'balanced';
    else chakraProfile[ch.id] = 'overactive';
  });
  
  saveChakraProfile();
  renderChakraResults();
}

function startChakraManual() {
  if(!chakraChar) { showToast('Choose a character first!'); return; }
  chakraMode = 'manual';
  CHAKRAS.forEach(ch => { if(!chakraProfile[ch.id]) chakraProfile[ch.id] = 'balanced'; });
  saveChakraProfile();
  renderChakraResults();
}

function setChakraState(id, state) {
  chakraProfile[id] = state;
  saveChakraProfile();
  renderChakraResults();
}

function renderChakraResults() {
  document.getElementById('chakraHome').style.display = 'none';
  document.getElementById('chakraQuizView').style.display = 'none';
  document.getElementById('chakraResultView').style.display = 'block';
  document.getElementById('chakraResultTitle').textContent = chakraChar + ' ‚Äî Chakra Profile';
  window.scrollTo(0,0);
  
  const stateColors = { balanced: '#2E7D32', overactive: '#C62828', blocked: '#546E7A' };
  const stateLabel  = { balanced: 'Balanced ‚úÖ', overactive: 'Overactive üî•', blocked: 'Blocked ‚¨áÔ∏è' };
  const stateDesc   = {
    balanced: 'Healthy energy flow ‚Äî this aspect of the character is integrated.',
    overactive: 'Excessive energy ‚Äî this chakra drives the character too hard or creates imbalance.',
    blocked: 'Restricted flow ‚Äî this is where the character is stuck, wounded, or shut down.'
  };

  let html = '';
  CHAKRAS.forEach(ch => {
    const state = chakraProfile[ch.id] || 'balanced';
    const traits = ch[state] || [];
    html += `
    <div class="card" style="margin-bottom:14px;border-left:5px solid ${ch.color};">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
        <div style="width:44px;height:44px;border-radius:50%;background:${ch.color};flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px;">‚óè</div>
        <div style="flex:1;">
          <div style="font-size:15px;font-weight:900;">${ch.name} Chakra</div>
          <div style="font-size:11px;color:var(--brown-light);">${ch.sanskrit} ¬∑ ${ch.location}</div>
        </div>
        <div style="font-size:12px;font-weight:900;color:${stateColors[state]};text-align:right;">${stateLabel[state]}</div>
      </div>
      
      <div style="font-size:12px;color:var(--brown-light);line-height:1.6;margin-bottom:12px;">${stateDesc[state]}</div>
      
      <!-- State selector -->
      <div style="display:flex;gap:6px;margin-bottom:14px;">
        ${['blocked','balanced','overactive'].map(s => `
          <button onclick="setChakraState('${ch.id}','${s}')" style="flex:1;padding:8px 2px;border-radius:99px;border:2px solid ${s===state?stateColors[s]:'var(--sand-dark)'};background:${s===state?stateColors[s]+'22':'var(--sand)'};font-family:var(--font);font-size:9px;font-weight:900;color:${s===state?stateColors[s]:'var(--brown-light)'};cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;">${s}</button>
        `).join('')}
      </div>
      
      <!-- Traits -->
      <div style="font-size:11px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Character traits:</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">
        ${traits.map(t => `<span style="background:${ch.color}22;color:${ch.color};border-radius:99px;padding:3px 10px;font-size:11px;font-weight:700;">${t}</span>`).join('')}
      </div>
      
      <!-- Acting note -->
      <div style="font-size:12px;color:var(--brown-light);line-height:1.6;font-style:italic;margin-bottom:12px;">${ch.actingNote}</div>
      
      <!-- Activation -->
      <div style="background:var(--sand);border-radius:var(--rs);padding:12px;">
        <div style="font-size:11px;font-weight:900;color:var(--brown);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">‚ö° Activation ‚Äî Access this chakra in your body:</div>
        ${ch.activation.map(a => `<div style="font-size:12px;color:var(--brown-light);line-height:1.6;margin-bottom:6px;padding-left:10px;border-left:2px solid ${ch.color};">‚Ä¢ ${a}</div>`).join('')}
        <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--sand-dark);">
          <div style="font-size:12px;font-weight:900;color:var(--brown);">Mantra: <span style="color:${ch.color};">${ch.mantra}</span> ‚Äî ${ch.mudra}</div>
        </div>
      </div>
    </div>`;
  });

  document.getElementById('chakraResultArea').innerHTML = html;
}

function saveChakraProfile() {
  const prod = productions.find(p => p.myChar === chakraChar);
  if(prod) {
    prod.chakraProfile = {...chakraProfile};
    autoSave();
  }
}

function printChakraProfile() {
  const stateColors = { balanced: '#2E7D32', overactive: '#C62828', blocked: '#546E7A' };
  const stateLabel  = { balanced: 'Balanced ‚úÖ', overactive: 'Overactive üî•', blocked: 'Blocked ‚¨áÔ∏è' };
  const stateDesc   = {
    balanced: 'Healthy energy flow ‚Äî this aspect of the character is integrated.',
    overactive: 'Excessive energy ‚Äî this chakra drives the character too hard.',
    blocked: 'Restricted flow ‚Äî this is where the character is stuck or shut down.'
  };

  let html = `<html><head><title>Chakra Profile ‚Äî ${chakraChar}</title>
  <style>
    body{font-family:Georgia,serif;max-width:720px;margin:40px auto;color:#2c1a0e;padding:20px;}
    h1{font-size:28px;margin-bottom:4px;}
    .sub{color:#888;margin-bottom:32px;font-size:14px;}
    .chakra{border-left:6px solid #ccc;padding:16px 20px;margin-bottom:24px;page-break-inside:avoid;}
    .name{font-size:18px;font-weight:bold;margin-bottom:2px;}
    .state{font-size:14px;font-weight:bold;margin:8px 0;}
    .desc{font-size:13px;color:#555;margin-bottom:10px;line-height:1.6;}
    .traits{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
    .trait{background:#f0f0f0;border-radius:99px;padding:3px 12px;font-size:12px;}
    .note{font-size:12px;color:#555;font-style:italic;margin-bottom:12px;line-height:1.6;}
    .activation{background:#f9f6f0;padding:12px;border-radius:6px;}
    .activation h4{font-size:12px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;color:#333;}
    .act-item{font-size:12px;color:#555;line-height:1.7;margin-bottom:4px;padding-left:12px;border-left:3px solid #ccc;}
    .mantra{font-size:13px;font-weight:bold;margin-top:8px;padding-top:8px;border-top:1px solid #ddd;}
    @media print{body{margin:20px;}}
  </style></head><body>
  <h1>üîÆ Chakra Profile</h1>
  <div class="sub">Character: <strong>${chakraChar}</strong> ¬∑ EscoMind ¬∑ ${new Date().toLocaleDateString()}</div>`;

  CHAKRAS.forEach(ch => {
    const state = chakraProfile[ch.id] || 'balanced';
    const traits = ch[state] || [];
    html += `<div class="chakra" style="border-left-color:${ch.color};">
      <div class="name" style="color:${ch.color};">${ch.emoji} ${ch.name} Chakra ‚Äî ${ch.sanskrit}</div>
      <div style="font-size:12px;color:#888;margin-bottom:6px;">${ch.location} ¬∑ Element: ${ch.element}</div>
      <div class="state" style="color:${stateColors[state]};">${stateLabel[state]}</div>
      <div class="desc">${stateDesc[state]}</div>
      <div class="traits">${traits.map(t=>`<span class="trait">${t}</span>`).join('')}</div>
      <div class="note">${ch.actingNote}</div>
      <div class="activation">
        <h4>‚ö° Activation</h4>
        ${ch.activation.map(a=>`<div class="act-item" style="border-left-color:${ch.color};">‚Ä¢ ${a}</div>`).join('')}
        <div class="mantra">Mantra: <strong>${ch.mantra}</strong> ¬∑ ${ch.mudra}</div>
      </div>
    </div>`;
  });

  html += `</body></html>`;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 500);
}

// chakra refresh is handled inside navTo directly

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RECOVERED CORE FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RAW SCRIPT TEXT (state)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
rawScriptText = rawScriptText || '';
splitterParsed = []; splitterDividers = []; splitterMyChar = '';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILE UPLOAD ‚Äî PDF.js powered
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleFileUpload(input) {
  const file = input.files[0];
  if(!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  showToast(`Loading: ${file.name} üìÇ`);
  if(ext === 'pdf') {
    // For PDFs, offer page tools first, then extract text
    showPdfTools(file);
  } else {
    const reader = new FileReader();
    reader.onload = function(e) {
      rawScriptText = e.target.result;
      processScript('file');
    };
    reader.readAsText(file);
  }
}

async 
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PDF PAGE TOOLS ‚Äî Rotate, Crop, Tint, Collate
//  Mirrors Rehearsal Pro's physical script management tools
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let pdfToolsFile = null;          // Original File object
let pdfToolsArrayBuffer = null;   // Raw bytes
let pdfToolsPageCount = 0;
let pdfPageOrder = [];            // Indices of pages in current order
let pdfPageRotations = {};        // pageIdx ‚Üí rotation delta (0/90/180/270)
let pdfPageCrops = {};            // pageIdx ‚Üí {top,bottom,left,right} in %
let pdfPageTints = {};            // pageIdx ‚Üí {color, opacity} or null
let pdfSelectedPages = new Set();
let pdfActiveTintColor = null;
let pdfActiveTintOpacity = 0.25;
let pdfPdfjsDoc = null;           // PDF.js document for thumbnail rendering

async function showPdfTools(file) {
  pdfToolsFile = file;
  pdfPageRotations = {};
  pdfPageCrops = {};
  pdfPageTints = {};
  pdfSelectedPages = new Set();
  pdfActiveTintColor = null;

  // Show loading
  showToast('Loading PDF pages... ‚è≥');

  try {
    pdfToolsArrayBuffer = await file.arrayBuffer();

    // Load via PDF.js for rendering thumbnails
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    pdfPdfjsDoc = await pdfjsLib.getDocument({ data: pdfToolsArrayBuffer.slice(0) }).promise;
    pdfToolsPageCount = pdfPdfjsDoc.numPages;
    pdfPageOrder = Array.from({length: pdfToolsPageCount}, (_, i) => i); // 0-indexed

    // Show the section
    document.getElementById('pdfToolsSection').style.display = 'block';
    document.getElementById('charSetup').style.display = 'none';

    // Render thumbnails
    await pdfRenderThumbnails();
    showToast(`${pdfToolsPageCount} pages loaded ‚Äî apply tools then import ‚úÖ`);
  } catch(err) {
    console.error('PDF tools error:', err);
    showToast('Could not load PDF pages ‚Äî importing directly üìã');
    extractPDFwithPDFjs(file);
  }
}

function hidePdfTools() {
  document.getElementById('pdfToolsSection').style.display = 'none';
  pdfToolsFile = null;
  pdfPdfjsDoc = null;
}

async function pdfRenderThumbnails() {
  const grid = document.getElementById('pdfPageGrid');
  if(!grid) return;
  grid.innerHTML = '<div style="font-size:12px;color:var(--brown-light);">Rendering pages...</div>';
  const items = [];
  for(let idx = 0; idx < pdfPageOrder.length; idx++) {
    const origIdx = pdfPageOrder[idx];
    const thumb = await pdfRenderThumb(origIdx, idx);
    items.push(thumb);
  }
  grid.innerHTML = '';
  items.forEach(el => grid.appendChild(el));
  pdfUpdateSelCount();
}

async function pdfRenderThumb(origPageIdx, displayPos) {
  const wrapper = document.createElement('div');
  wrapper.style.cssText = `position:relative;cursor:pointer;border-radius:var(--rs);overflow:hidden;border:3px solid transparent;transition:border-color 0.15s;background:var(--sand);`;
  wrapper.dataset.origIdx = origPageIdx;
  wrapper.dataset.displayPos = displayPos;
  wrapper.onclick = () => pdfTogglePage(origPageIdx, wrapper);

  // Page number badge
  const badge = document.createElement('div');
  badge.style.cssText = `position:absolute;top:4px;left:4px;background:rgba(0,0,0,0.6);color:white;font-size:10px;font-weight:900;padding:2px 6px;border-radius:99px;z-index:2;font-family:var(--font);`;
  badge.textContent = `p.${displayPos + 1}`;
  wrapper.appendChild(badge);

  // Rotation indicator
  const rot = pdfPageRotations[origPageIdx] || 0;
  if(rot) {
    const rotBadge = document.createElement('div');
    rotBadge.style.cssText = `position:absolute;top:4px;right:4px;background:var(--sage);color:white;font-size:9px;font-weight:900;padding:2px 5px;border-radius:99px;z-index:2;font-family:var(--font);`;
    rotBadge.textContent = `${rot}¬∞`;
    wrapper.appendChild(rotBadge);
  }

  // Tint indicator
  const tint = pdfPageTints[origPageIdx];
  if(tint) {
    const tintBadge = document.createElement('div');
    tintBadge.style.cssText = `position:absolute;bottom:4px;left:4px;background:${tint.color};border:1px solid rgba(0,0,0,0.2);width:14px;height:14px;border-radius:50%;z-index:2;`;
    wrapper.appendChild(tintBadge);
  }

  // Canvas for page preview
  const canvas = document.createElement('canvas');
  try {
    const page = await pdfPdfjsDoc.getPage(origPageIdx + 1);
    const viewport = page.getViewport({ scale: 0.25, rotation: pdfPageRotations[origPageIdx] || 0 });
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    canvas.style.cssText = `display:block;width:${Math.min(viewport.width, 90)}px;height:auto;`;
    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

    // Apply tint overlay on canvas
    if(tint) {
      const ctx = canvas.getContext('2d');
      ctx.globalAlpha = tint.opacity;
      ctx.fillStyle = tint.color;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.globalAlpha = 1;
    }
  } catch(e) {
    canvas.width = 70; canvas.height = 100;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#f5f5f5';
    ctx.fillRect(0,0,70,100);
    ctx.fillStyle = '#999';
    ctx.font = '10px sans-serif';
    ctx.fillText('p.'+(displayPos+1), 20, 55);
  }
  wrapper.appendChild(canvas);

  // Check if selected
  if(pdfSelectedPages.has(origPageIdx)) {
    wrapper.style.borderColor = 'var(--terra)';
    badge.style.background = 'var(--terra)';
  }
  return wrapper;
}

function pdfTogglePage(origIdx, el) {
  if(pdfSelectedPages.has(origIdx)) {
    pdfSelectedPages.delete(origIdx);
    if(el) { el.style.borderColor = 'transparent'; }
  } else {
    pdfSelectedPages.add(origIdx);
    if(el) { el.style.borderColor = 'var(--terra)'; }
  }
  pdfUpdateSelCount();
}

function pdfSelectAll() {
  pdfPageOrder.forEach(idx => pdfSelectedPages.add(idx));
  pdfRenderThumbnails();
}

function pdfSelectNone() {
  pdfSelectedPages.clear();
  pdfRenderThumbnails();
}

function pdfUpdateSelCount() {
  const el = document.getElementById('pdfSelCount');
  if(el) el.textContent = `${pdfSelectedPages.size} selected`;
}

function pdfGetSelected() {
  const sel = [...pdfSelectedPages];
  if(sel.length === 0) { showToast('Select at least one page first üëÜ'); return null; }
  return sel;
}

// ‚îÄ‚îÄ‚îÄ ROTATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdfRotate(degrees) {
  const sel = pdfGetSelected();
  if(!sel) return;
  sel.forEach(idx => {
    const current = pdfPageRotations[idx] || 0;
    pdfPageRotations[idx] = (current + degrees + 360) % 360;
  });
  pdfRenderThumbnails();
  showToast(`Rotated ${sel.length} page(s) by ${degrees > 0 ? '+' : ''}${degrees}¬∞`);
}

// ‚îÄ‚îÄ‚îÄ CROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdfCrop() {
  const sel = pdfGetSelected();
  if(!sel) return;
  const top    = parseFloat(document.getElementById('cropTop').value)    || 0;
  const bottom = parseFloat(document.getElementById('cropBottom').value) || 0;
  const left   = parseFloat(document.getElementById('cropLeft').value)   || 0;
  const right  = parseFloat(document.getElementById('cropRight').value)  || 0;
  sel.forEach(idx => { pdfPageCrops[idx] = {top, bottom, left, right}; });
  pdfRenderThumbnails();
  showToast(`Crop set on ${sel.length} page(s) ‚Äî will apply on import`);
}

// ‚îÄ‚îÄ‚îÄ TINT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdfTint(color, opacity, btn) {
  pdfActiveTintColor = color;
  pdfActiveTintOpacity = parseFloat(document.getElementById('tintStrength').value) || opacity;
  const sel = pdfGetSelected();
  if(!sel) return;
  sel.forEach(idx => {
    if(!color) delete pdfPageTints[idx];
    else pdfPageTints[idx] = { color, opacity: pdfActiveTintOpacity };
  });
  pdfRenderThumbnails();
  showToast(color ? `Tint applied to ${sel.length} page(s)` : `Tint removed from ${sel.length} page(s)`);
}

// ‚îÄ‚îÄ‚îÄ COLLATE / REORDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdfMoveUp() {
  const sel = pdfGetSelected();
  if(!sel) return;
  // Move each selected page up by 1 in pdfPageOrder
  const selSet = new Set(sel);
  for(let i = 1; i < pdfPageOrder.length; i++) {
    if(selSet.has(pdfPageOrder[i]) && !selSet.has(pdfPageOrder[i-1])) {
      [pdfPageOrder[i-1], pdfPageOrder[i]] = [pdfPageOrder[i], pdfPageOrder[i-1]];
    }
  }
  pdfRenderThumbnails();
  showToast(`Moved ${sel.length} page(s) up`);
}

function pdfMoveDown() {
  const sel = pdfGetSelected();
  if(!sel) return;
  const selSet = new Set(sel);
  for(let i = pdfPageOrder.length - 2; i >= 0; i--) {
    if(selSet.has(pdfPageOrder[i]) && !selSet.has(pdfPageOrder[i+1])) {
      [pdfPageOrder[i+1], pdfPageOrder[i]] = [pdfPageOrder[i], pdfPageOrder[i+1]];
    }
  }
  pdfRenderThumbnails();
  showToast(`Moved ${sel.length} page(s) down`);
}

function pdfDeletePages() {
  const sel = pdfGetSelected();
  if(!sel) return;
  if(!confirm(`Delete ${sel.length} page(s)? This cannot be undone.`)) return;
  const selSet = new Set(sel);
  pdfPageOrder = pdfPageOrder.filter(idx => !selSet.has(idx));
  pdfSelectedPages.clear();
  pdfRenderThumbnails();
  showToast(`Deleted ${sel.length} page(s)`);
}

// ‚îÄ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pdfPreviewSelected() {
  const sel = pdfGetSelected();
  if(!sel) return;
  const origIdx = sel[0];
  try {
    const previewArea = document.getElementById('pdfPreviewArea');
    const canvas = document.getElementById('pdfPreviewCanvas');
    previewArea.style.display = 'block';
    const page = await pdfPdfjsDoc.getPage(origIdx + 1);
    const rot = pdfPageRotations[origIdx] || 0;
    const viewport = page.getViewport({ scale: 1.5, rotation: rot });
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    const ctx = canvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport }).promise;
    // Apply tint
    const tint = pdfPageTints[origIdx];
    if(tint) {
      ctx.globalAlpha = tint.opacity;
      ctx.fillStyle = tint.color;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.globalAlpha = 1;
    }
    canvas.scrollIntoView({ behavior: 'smooth' });
  } catch(e) {
    showToast('Preview failed ‚Äî continuing anyway');
  }
}

// ‚îÄ‚îÄ‚îÄ APPLY & IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pdfDoneEditing() {
  if(!pdfToolsArrayBuffer) { extractPDFwithPDFjs(pdfToolsFile); return; }
  const hasChanges = Object.keys(pdfPageRotations).length > 0 ||
                     Object.keys(pdfPageCrops).length > 0 ||
                     Object.keys(pdfPageTints).length > 0 ||
                     pdfPageOrder.some((v,i) => v !== i) ||
                     pdfPageOrder.length !== pdfToolsPageCount;

  if(!hasChanges) {
    // No changes, just extract text directly
    showToast('No changes ‚Äî importing script... ‚è≥');
    document.getElementById('pdfToolsSection').style.display = 'none';
    extractPDFwithPDFjs(pdfToolsFile);
    return;
  }

  showToast('Applying edits... ‚è≥');
  try {
    // Use PDFLib to apply all transformations
    const { PDFDocument, degrees, rgb } = PDFLib;
    const srcDoc = await PDFDocument.load(pdfToolsArrayBuffer);
    const newDoc = await PDFDocument.create();

    for(let displayPos = 0; displayPos < pdfPageOrder.length; displayPos++) {
      const origIdx = pdfPageOrder[displayPos];
      const [copiedPage] = await newDoc.copyPages(srcDoc, [origIdx]);

      // Apply rotation
      const rotDelta = pdfPageRotations[origIdx] || 0;
      if(rotDelta) {
        const existingRot = copiedPage.getRotation().angle;
        copiedPage.setRotation(degrees((existingRot + rotDelta) % 360));
      }

      // Apply crop box
      const crop = pdfPageCrops[origIdx];
      if(crop) {
        const { width, height } = copiedPage.getSize();
        copiedPage.setCropBox(
          width  * (crop.left   / 100),
          height * (crop.bottom / 100),
          width  * (1 - (crop.left + crop.right)   / 100),
          height * (1 - (crop.top  + crop.bottom)  / 100)
        );
      }

      newDoc.addPage(copiedPage);

      // Apply tint: draw a semi-transparent rectangle on top
      const tint = pdfPageTints[origIdx];
      if(tint) {
        // Parse hex color to RGB
        const hex = tint.color.replace('#','');
        const r = parseInt(hex.substring(0,2),16)/255;
        const g = parseInt(hex.substring(2,4),16)/255;
        const b = parseInt(hex.substring(4,6),16)/255;
        const page = newDoc.getPages()[newDoc.getPageCount()-1];
        const { width, height } = page.getSize();
        page.drawRectangle({
          x: 0, y: 0, width, height,
          color: rgb(r, g, b),
          opacity: tint.opacity,
        });
      }
    }

    const modifiedBytes = await newDoc.save();
    const modifiedBlob = new Blob([modifiedBytes], { type: 'application/pdf' });
    const modifiedFile = new File([modifiedBlob], pdfToolsFile.name, { type: 'application/pdf' });

    document.getElementById('pdfToolsSection').style.display = 'none';
    showToast('Edits applied ‚Äî extracting text... ‚è≥');
    extractPDFwithPDFjs(modifiedFile);
  } catch(err) {
    console.error('PDFLib error:', err);
    showToast('Could not apply edits ‚Äî importing original PDF üìã');
    document.getElementById('pdfToolsSection').style.display = 'none';
    extractPDFwithPDFjs(pdfToolsFile);
  }
}

async function extractPDFwithPDFjs(file) {
  showToast('Reading PDF... ‚è≥');
  try {
    if(window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    } else { throw new Error('PDF.js not loaded'); }
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = '';
    const totalPages = pdf.numPages;
    for(let pageNum = 1; pageNum <= totalPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const content = await page.getTextContent();
      const items = content.items;
      if(items.length === 0) continue;
      let lastY = null, lineBuffer = '';
      const pageLines = [];
      items.forEach(item => {
        const y = item.transform ? Math.round(item.transform[5]) : 0;
        const text = item.str;
        if(lastY !== null && Math.abs(y - lastY) > 3) {
          if(lineBuffer.trim()) pageLines.push(lineBuffer.trimEnd());
          lineBuffer = text;
        } else { lineBuffer += text; }
        lastY = y;
      });
      if(lineBuffer.trim()) pageLines.push(lineBuffer.trimEnd());
      fullText += pageLines.reverse().join('\n') + '\n';
    }
    const cleaned = fullText.trim();
    if(cleaned.length > 100) {
      rawScriptText = cleaned;
      showToast(`PDF loaded ‚Äî ${totalPages} pages ‚úÖ`);
      processScript('file');
    } else {
      showToast('PDF appears image-based ‚Äî please paste the text instead üìã');
      document.querySelectorAll('.itab')[1]?.click();
    }
  } catch(err) {
    console.error('PDF.js error:', err);
    showToast('Could not read PDF ‚Äî please paste the script text üìã');
    document.querySelectorAll('.itab')[1]?.click();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCRIPT FONT + DISPLAY CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFont(btn) {
  const reader = document.getElementById('scriptReader') || document.getElementById('detailScriptReader');
  if(!reader) return;
  const isOD = reader.style.fontFamily.includes('OpenDyslexic') || reader.classList.contains('od-font');
  reader.style.fontFamily = isOD ? "Georgia, serif" : "'OpenDyslexic', serif";
  if(btn) btn.classList.toggle('active', !isOD);
  showToast(isOD ? 'Standard font' : 'OpenDyslexic font');
}

function changeFontSize(delta, btn) {
  scriptFontSize = Math.max(12, Math.min(26, scriptFontSize + delta));
  document.documentElement.style.setProperty('--script-fs', scriptFontSize+'px');
  const reader = document.getElementById('scriptReader') || document.getElementById('detailScriptReader');
  if(reader) reader.style.fontSize = scriptFontSize+'px';
  showToast(`Font: ${scriptFontSize}px`);
}

function toggleMyLinesOnly(btn) {
  const reader = document.getElementById('scriptReader') || document.getElementById('detailScriptReader');
  if(!reader) return;
  const myOnly = btn ? btn.classList.toggle('active') : false;
  reader.querySelectorAll('.script-block').forEach(el => {
    const isMine = el.classList.contains('my-line');
    el.style.display = (myOnly && !isMine) ? 'none' : '';
  });
  if(btn) {
    // Add dropdown for "show all"
    btn.textContent = myOnly ? 'üìã Show All Lines' : 'My Lines Only';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VOICE TOGGLE (cue cards)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// voiceActive already declared above
let voiceRecognizer = null;

function toggleVoice() {
  if(voiceActive) {
    voiceActive = false;
    if(voiceRecognizer) { try{ voiceRecognizer.stop(); }catch(e){} voiceRecognizer = null; }
    document.getElementById('voiceBtn').textContent = 'üéô Speak Your Line';
    document.getElementById('voiceBtn').style.background = '';
    return;
  }
  if(!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
    showToast('Voice input not supported in this browser'); return;
  }
  voiceActive = true;
  document.getElementById('voiceBtn').textContent = 'üî¥ Listening... (tap to stop)';
  document.getElementById('voiceBtn').style.background = 'var(--terra)';
  document.getElementById('voiceBtn').style.color = 'white';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  voiceRecognizer = new SR();
  voiceRecognizer.lang = 'en-GB';
  voiceRecognizer.continuous = false;
  voiceRecognizer.interimResults = false;
  voiceRecognizer.onresult = function(e) {
    const spoken = e.results[0][0].transcript;
    voiceActive = false;
    document.getElementById('voiceBtn').textContent = 'üéô Speak Your Line';
    document.getElementById('voiceBtn').style.background = '';
    document.getElementById('voiceBtn').style.color = '';
    checkSpokenLine(spoken);
  };
  voiceRecognizer.onerror = function() {
    voiceActive = false;
    document.getElementById('voiceBtn').textContent = 'üéô Speak Your Line';
    document.getElementById('voiceBtn').style.background = '';
  };
  voiceRecognizer.start();
  setTimeout(function(){ if(voiceActive) { try{voiceRecognizer.stop();}catch(e){} } }, 10000);
}

function checkSpokenLine(spoken) {
  if(cueIndex >= cuePairs.length) return;
  const correct = cuePairs[cueIndex].myLine;
  const result = compareLines(spoken, correct);
  const pct = Math.round(result.pct * 100);
  const banner = document.getElementById('cueBanner');
  const analysis = document.getElementById('wordAnalysis');
  document.getElementById('revealHint').style.display = 'none';
  document.getElementById('revealTxt').textContent = correct;
  lineShown = true;
  if(result.pct >= 0.85) {
    banner.className = 'result-banner res-good';
    banner.textContent = `‚úÖ ${pct}% ‚Äî great!`;
    addXP(15);
    setTimeout(() => nextCue('correct'), 1200);
  } else if(result.pct >= 0.6) {
    banner.className = 'result-banner res-close';
    banner.textContent = `~ ${pct}% ‚Äî close! "${spoken}"`;
    document.getElementById('feedbackRow').style.display = 'flex';
    document.getElementById('nextCueBtn').style.display = 'none';
  } else {
    banner.className = 'result-banner res-bad';
    banner.textContent = `You said: "${spoken}"`;
    document.getElementById('feedbackRow').style.display = 'flex';
    document.getElementById('nextCueBtn').style.display = 'none';
  }
  if(result.wordResults && result.wordResults.length > 0) {
    analysis.innerHTML = result.wordResults.map(w =>
      `<span style="background:${w.ok?'var(--sage)':'var(--terra)'};color:white;border-radius:4px;padding:2px 6px;font-size:11px;margin:2px;">${w.word}</span>`
    ).join(' ');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMPARE LINES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function compareLines(spoken, correct) {
  const normalize = s => s.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(/\s+/).filter(Boolean);
  const a = normalize(spoken), b = normalize(correct);
  if(b.length === 0) return { pct: 1, wordResults: [] };
  let matches = 0;
  const wordResults = b.map(word => {
    const ok = a.includes(word);
    if(ok) matches++;
    return { word, ok };
  });
  return { pct: matches / b.length, wordResults };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DICT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeDict() { document.getElementById('dictPop').classList.remove('show'); }
function speakDictWord() {
  const w = document.getElementById('dpWord').textContent;
  if('speechSynthesis' in window) {
    const u = new SpeechSynthesisUtterance(w);
    u.rate = 0.7;
    speechSynthesis.speak(u);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER SCRIPT READER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderScriptReader(data, myChar) {
  const reader = document.getElementById('scriptReader');
  if(!reader || !data) return;
  reader.innerHTML = data.map((line, idx) => {
    const isMine = line.char === myChar || line.mine;
    return `<div class="script-block ${isMine?'my-line':''}" style="border-left:4px solid ${isMine?'var(--terra)':'var(--sand-dark)'};margin-bottom:8px;padding:8px 12px;border-radius:0 var(--rs) var(--rs) 0;background:${isMine?'rgba(193,97,79,0.08)':'var(--cream)'};">
      <div style="font-size:10px;font-weight:900;color:${isMine?'var(--terra)':'var(--brown-light)'};text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">${line.char||''}</div>
      <div style="font-size:var(--script-fs,14px);line-height:1.8;">${line.text}</div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHARACTER SETUP (after upload)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function highlightTypedChar(val) {
  const name = val.trim().toUpperCase();
  document.querySelectorAll('.char-pill').forEach(p => {
    p.classList.toggle('selected', p.dataset.name === name);
  });
  document.getElementById('myCharInput').dataset.prodName = name || '';
}

function confirmCharacter() {
  const name = (document.getElementById('myCharInput').value || '').trim().toUpperCase();
  if(!name) { showToast('Please choose or type your character name üé≠'); return; }
  document.getElementById('charSetup').style.display = 'none';
  showSceneSplitter(rawScriptText, name);
}

function showCharacterSetup(chars) {
  const setup = document.getElementById('charSetup');
  const pills = document.getElementById('detectedChars');
  if(!setup || !pills) return;
  pills.innerHTML = chars.map(c =>
    `<div class="char-pill" data-name="${c}" onclick="selectChar('${c}')">${c}</div>`
  ).join('');
  setup.style.display = 'block';
  setup.classList.add('show');
  document.getElementById('readerSection').style.display = 'none';
  document.getElementById('sceneSplitterSection').style.display = 'none';
}

function selectChar(name) {
  document.querySelectorAll('.char-pill').forEach(p => p.classList.remove('selected'));
  document.querySelector(`.char-pill[data-name="${name}"]`)?.classList.add('selected');
  document.getElementById('myCharInput').value = name;
  document.getElementById('myCharInput').dataset.prodName = name;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROCESS SCRIPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCRIPT PARSER v2 ‚Äî line-by-line, handles normal + inverted attribution
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function charNameFromLine(stripped) {
  // Returns cleaned character name if this looks like a char label, else null
  if(!stripped || stripped.length < 2 || stripped.length > 55) return null;
  // Strip parenthetical stage notes: "ELI (on Light)" ‚Üí "ELI"
  const base = stripped.replace(/\s*\([^)]*\)\s*/g,'').trim();
  if(!base || base.length < 2) return null;
  // Skip known stage direction keywords
  if(/^(SHIFT|LIGHTS|BLACKOUT|SCENE|ACT|CURTAIN|INTERMISSION|PAUSE|SILENCE|BEAT|FADE|NEVER|THE END|VOICE OVER|OFFSTAGE|OFF STAGE|INT\.|EXT\.)/.test(base)) return null;
  // Must be ALL-CAPS words only
  if(!/^[A-Z][A-Z0-9\s\.\'\-\&]*$/.test(base)) return null;
  // Must have at least 2 consecutive capital letters
  if(!/[A-Z]{2,}/.test(base)) return null;
  // Skip common words that aren't names
  const exact = base.trim();
  if(['A','I','HE','SHE','IT','WE','TO','GO','NO','OH','MY','UP','HM','AH',
      'OK','SO','OR','IF','BY','DO','BE','AS','AT','OF','IN','ON','IS','AM',
      'AN','US','ALL','AND','BUT','FOR','YET','NOR','NOT','TOO','NOW','YES',
      'THEN','THEM','THEY','THEIR','THERE','HERE','WHEN','WHAT','WHERE','WHY',
      'HOW','WHO','WELL','JUST','LIKE','YEAH','OKAY','THAT','THIS','WITH',
      'HAVE','BEEN','WILL','WOULD','COULD','SHOULD','SHALL','MAY','MIGHT',
      'MUST','DOES','DONE','WERE','SAID','BACK','CAME','COME','WENT','GOING',
      'STILL','EVEN','ONLY','ALSO','BOTH','EACH','MORE','SOME','HOLD ON',
      'ALL CAPS'].includes(exact)) return null;
  // Skip pure numbers or page-number-like strings
  if(/^\d+$/.test(exact)) return null;
  // "CHAR1 & CHAR2" ‚Äî take first character's name
  if(base.includes(' & ')) return base.split(' & ')[0].trim();
  return base;
}

function detectCharacters(text) {
  // Detect all character names for the setup screen
  const lines = text.split('\n');
  const counts = {};
  for(const line of lines) {
    const cn = charNameFromLine(line.trim());
    if(cn) counts[cn] = (counts[cn]||0) + 1;
  }
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  const min = total > 50 ? 2 : 1;
  return Object.entries(counts)
    .filter(([,c])=>c>=min)
    .sort((a,b)=>b[1]-a[1])
    .map(([n])=>n)
    .slice(0,20);
}

function parseScriptV2(text, myChar) {
  /**
   * Smart line-by-line parser.
   * Handles BOTH standard attribution (CHARNAME ‚Üí dialogue)
   * AND inverted attribution (dialogue ‚Üí CHARNAME) as used in Windfall.
   * Each physical text line becomes its own scriptData entry.
   */
  const rawLines = text.split('\n');

  // Step 1: tokenise
  const tokens = [];
  for(const raw of rawLines) {
    const s = raw.trim();
    if(!s) { tokens.push({t:'blank'}); continue; }
    if(/^\d+\s*$/.test(s)) continue;                          // page numbers
    if(/^\(.*\)$/.test(s) || /^\[.*\]$/.test(s)) continue;   // pure stage directions
    const cn = charNameFromLine(s);
    if(cn) tokens.push({t:'char', v:cn});
    else   tokens.push({t:'text', v:s});
  }

  // Step 2: collapse consecutive blanks to one
  const toks = [];
  for(const tk of tokens) {
    if(tk.t==='blank' && toks.length && toks[toks.length-1].t==='blank') continue;
    toks.push(tk);
  }

  // Step 3: assign lines using lookahead for inverted attribution
  const result = [];
  let currentChar = null;
  let i = 0;

  while(i < toks.length) {
    const tk = toks[i];

    if(tk.t === 'char') {
      currentChar = tk.v;
      i++;
      if(i < toks.length && toks[i].t==='blank') i++; // skip blank after char name
      continue;
    }

    if(tk.t === 'blank') { i++; continue; }

    if(tk.t === 'text') {
      // Collect a run of consecutive text lines
      let j = i;
      const textRun = [];
      while(j < toks.length && toks[j].t==='text') { textRun.push(toks[j].v); j++; }

      // Skip blank after text run
      let k = j;
      if(k < toks.length && toks[k].t==='blank') k++;

      // Is there a char name next?
      const nextCharIdx = (k < toks.length && toks[k].t==='char') ? k : -1;

      if(nextCharIdx !== -1) {
        // Look past that char name (skip its blank)
        let m = nextCharIdx + 1;
        if(m < toks.length && toks[m].t==='blank') m++;
        // If after the char name comes ANOTHER char or end-of-tokens ‚Üí inverted attribution
        const afterIsChar = m < toks.length && toks[m].t==='char';
        const afterIsEnd  = m >= toks.length;
        const afterIsBlankThenChar = m < toks.length && toks[m].t==='blank'
                                  && m+1 < toks.length && toks[m+1].t==='char';

        if(afterIsChar || afterIsEnd || afterIsBlankThenChar) {
          // Inverted: these lines belong to the upcoming char name
          const nextChar = toks[nextCharIdx].v;
          for(const line of textRun) {
            result.push({char: nextChar, text: line, mine: nextChar===myChar});
          }
          i = j; // advance past text run; char token processed next iteration
          continue;
        }
      }

      // Normal: belongs to currentChar
      if(currentChar) {
        for(const line of textRun) {
          result.push({char: currentChar, text: line, mine: currentChar===myChar});
        }
      }
      i = j;
      continue;
    }

    i++;
  }

  return result;
}

function parseRawScript(text) {
  // Compatibility wrapper ‚Äî used by editor page upload
  return parseScriptV2(text, '__NONE__');
}

// ‚îÄ‚îÄ‚îÄ processScript ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function processScript(source) {
  let text = '';
  if(source === 'paste') {
    text = (document.getElementById('pasteArea').value||'').trim();
    if(!text) { showToast('Please paste your script text first! üìã'); return; }
  } else {
    text = rawScriptText;
  }
  if(text.length < 20) { showToast('Script seems too short ‚Äî please try again'); return; }
  rawScriptText = text;
  const chars = detectCharacters(text);
  if(chars.length === 0) {
    showToast('No character names found. Make sure names are in ALL CAPS on their own line.');
    showCharacterSetup([]);
    return;
  }
  showCharacterSetup(chars);
  showToast(`Found ${chars.length} characters ‚Äî who are you? üé≠`);
}

// ‚îÄ‚îÄ‚îÄ Scene splitter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function skipSceneSplit() {
  document.getElementById('sceneSplitterSection').style.display = 'none';
  const myChar = splitterMyChar || (document.getElementById('myCharInput').value||'').trim().toUpperCase();
  buildAndFinish(rawScriptText, myChar, []);
}

function saveSplitScenes() {
  buildAndFinish(rawScriptText, splitterMyChar, splitterDividers);
}

function showSceneSplitter(text, myChar) {
  splitterMyChar = myChar;
  splitterDividers = [];
  // Quick parse to see if there's anything to show
  splitterParsed = parseScriptV2(text, myChar);
  if(splitterParsed.length === 0) { buildAndFinish(text, myChar, []); return; }
  document.getElementById('sceneSplitterSection').style.display = 'block';
  renderSplitterScript();
}

function renderSplitterScript() {
  const container = document.getElementById('splitterScript');
  if(!container) return;
  // Show unique chars as colour-coded blocks, grouped (not every line)
  // Group consecutive same-char lines into blocks for readability
  const groups = [];
  let last = null;
  for(const line of splitterParsed) {
    if(last && last.char === line.char) { last.lines.push(line.text); }
    else { last = {char:line.char, mine:line.mine, lines:[line.text], idx:groups.length}; groups.push(last); }
  }
  container.innerHTML = groups.map((g,gi) => {
    const div = splitterDividers.find(d=>d.after===gi);
    const isMine = g.mine;
    return `
      ${div ? `<div style="background:var(--sage);color:white;border-radius:var(--rs);padding:8px 14px;margin:8px 0;font-weight:900;font-size:12px;display:flex;justify-content:space-between;align-items:center;">üìç Scene: ${div.name} <button onclick="removeDivider(${gi})" style="background:rgba(0,0,0,0.2);border:none;color:white;border-radius:99px;padding:2px 8px;cursor:pointer;font-family:var(--font);">‚úï</button></div>` : ''}
      <div onclick="splitterTap(${gi})" style="padding:8px 12px;border-left:4px solid ${isMine?'var(--terra)':'var(--sand-dark)'};margin-bottom:4px;background:${isMine?'rgba(193,97,79,0.08)':'white'};border-radius:0 var(--rs) var(--rs) 0;cursor:pointer;">
        <div style="font-size:10px;font-weight:900;color:${isMine?'var(--terra)':'var(--brown-light)'};text-transform:uppercase;">${g.char}</div>
        <div style="font-size:13px;line-height:1.6;color:var(--brown);">${g.lines[0].substring(0,100)}${g.lines.length>1?' (+'+( g.lines.length-1)+' more)':''}</div>
      </div>`;
  }).join('');
}

function splitterTap(idx) {
  const name = prompt('Name this scene (everything from here onwards):') || ('Scene '+(splitterDividers.length+1));
  const existing = splitterDividers.findIndex(d=>d.after===idx);
  if(existing !== -1) splitterDividers[existing].name = name;
  else splitterDividers.push({after:idx, name});
  splitterDividers.sort((a,b)=>a.after-b.after);
  renderSplitterScript();
}

function removeDivider(afterIdx) {
  splitterDividers = splitterDividers.filter(d=>d.after!==afterIdx);
  renderSplitterScript();
}

// ‚îÄ‚îÄ‚îÄ Build & finish ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildAndFinish(text, myChar, dividers) {
  const allLines = parseScriptV2(text, myChar);
  if(allLines.length === 0) { showToast('Could not parse script ‚Äî check formatting'); return; }

  // Assign scenes based on dividers (applied to display-groups, not raw lines)
  if(dividers && dividers.length > 0) {
    // Build same groups as splitter
    const groups = [];
    let last = null;
    for(const line of allLines) {
      if(last && last.char === line.char) { last.lines.push(line); }
      else { last = {char:line.char, lines:[line], idx:groups.length}; groups.push(last); }
    }
    // Assign scene names to groups
    let sceneIdx = 0;
    let sceneName = 'Scene 1';
    const sortedDiv = [...dividers].sort((a,b)=>a.after-b.after);
    groups.forEach((g,gi) => {
      while(sceneIdx < sortedDiv.length && sortedDiv[sceneIdx].after <= gi) {
        sceneName = sortedDiv[sceneIdx].name;
        sceneIdx++;
      }
      g.lines.forEach(l => l.scene = sceneName);
    });
  } else {
    allLines.forEach(l => l.scene = 'Scene 1');
  }

  const sceneNames = [...new Set(allLines.map(l=>l.scene||'Scene 1'))];

  // Build cue pairs: for each of MY lines, cue = preceding line (any char)
  const cuePairs = [];
  for(let i=0; i<allLines.length; i++) {
    if(allLines[i].mine) {
      const cue = i > 0 ? allLines[i-1].text : 'Start of scene';
      cuePairs.push({cue, myLine:allLines[i].text, scene:allLines[i].scene||'Scene 1'});
    }
  }

  const nameEl = document.getElementById('myCharInput');
  const prod = {
    name: (nameEl && nameEl.dataset.prodName) || myChar,
    role: myChar, type: 'üé≠',
    scriptData: allLines,
    cuePairs, scenes: sceneNames, myChar, id: Date.now()
  };
  finishScriptLoad(prod);
}

// Backwards-compat wrappers
function buildScriptData(text, myChar) { buildAndFinish(text, myChar, []); }
function buildScriptDataWithScenes(parsed, myChar, dividers) {
  // parsed may already have scene assignments from splitter ‚Äî use them
  buildAndFinish(rawScriptText, myChar, dividers);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BLACKOUT MODE ‚Äî Rehearsal Pro style
//  Your lines are hidden behind a black bar; tap to peek; mark right/wrong
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let boPairs = [], boIndex = 0, boLoop = false, boRevealed = false;
let boCorrect = 0, boWrong = 0, boPrompts = 0;

function startBlackout() {
  const prod = activeProduction;
  if(!prod || !prod.cuePairs || prod.cuePairs.length === 0) {
    showToast('No lines to practice ‚Äî upload a script first!'); return;
  }
  boPairs = [...prod.cuePairs];
  boIndex = 0; boCorrect = 0; boWrong = 0; boPrompts = 0; boLoop = false;
  document.getElementById('boLoopBtn').textContent = 'üîÅ Loop: Off';
  document.getElementById('boFinished').style.display = 'none';
  document.getElementById('boProgress').textContent = '';
  document.querySelectorAll('#blackoutScreen .btn').forEach(b=>{b.style.display='';});
  document.getElementById('blackoutScreen').classList.add('active');
  boLoad();
}

function boLoad() {
  if(!boPairs[boIndex]) { boFinish(); return; }
  const pair = boPairs[boIndex];
  boRevealed = false;
  const pct = Math.round((boIndex/boPairs.length)*100);
  (document.getElementById('boProgBar')||{}).style = `width:${pct}%`;
  (document.getElementById('boProgress')||{}).textContent = `Line ${boIndex+1} of ${boPairs.length}`;

  // Other character (cue)
  const otherEl = document.getElementById('boOtherText');
  const otherCharEl = document.getElementById('boOtherChar');
  if(otherEl) otherEl.textContent = pair.cue || 'Start of scene';
  if(otherCharEl) otherCharEl.textContent = boIndex===0 ? 'SCENE START' : 'OTHER CHARACTER';

  // My line ‚Äî hidden
  const myCard = document.getElementById('boMyCard');
  const blackBar = document.getElementById('boBlackBar');
  const myText = document.getElementById('boMyText');
  const myChar = document.getElementById('boMyChar');
  if(myCard) { myCard.style.opacity = '1'; myCard.onclick = boReveal; }
  if(blackBar) blackBar.style.display = 'flex';
  if(myText) { myText.style.display = 'none'; myText.textContent = pair.myLine || ''; }
  if(myChar) myChar.textContent = (activeProduction?.myChar || 'YOU') + ' üé≠';
  (document.getElementById('boHint')||{}).textContent = 'Tap the red card to reveal your line';

  // Auto-speak cue
  if(pair.cue && pair.cue !== 'Start of scene') {
    const u = new SpeechSynthesisUtterance(pair.cue);
    u.rate = ttsRate || 0.9;
    window.speechSynthesis.cancel();
    setTimeout(() => window.speechSynthesis.speak(u), 300);
  }
}

function boReveal() {
  if(boRevealed) return;
  boRevealed = true;
  const blackBar = document.getElementById('boBlackBar');
  const myText = document.getElementById('boMyText');
  if(blackBar) blackBar.style.display = 'none';
  if(myText) myText.style.display = 'block';
  (document.getElementById('boHint')||{}).textContent = 'Read your line, then mark how you did ‚Üì';
  boPrompts++;
}

function speakBoOther() {
  const pair = boPairs[boIndex];
  if(!pair) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(pair.cue);
  u.rate = ttsRate || 0.9;
  window.speechSynthesis.speak(u);
}

function boMark(result) {
  window.speechSynthesis.cancel();
  if(result === 'correct') { boCorrect++; addXP(10); }
  else if(result === 'close') { boCorrect++; addXP(5); }
  else boWrong++;
  boIndex++;
  if(boIndex >= boPairs.length) {
    if(boLoop) { boIndex = 0; boLoad(); } else boFinish();
  } else { boLoad(); }
}

function boFinish() {
  const total = boCorrect + boWrong;
  const pct = total > 0 ? Math.round((boCorrect/total)*100) : 0;
  (document.getElementById('boFinishStats')||{}).textContent =
    `${boCorrect}/${total} lines ¬∑ ${pct}% ¬∑ ${boPrompts} peeks`;
  (document.getElementById('boFinished')||{}).style.display = 'block';
  document.querySelectorAll('#blackoutScreen .btn:not(#boFinished .btn)').forEach(b=>{b.style.display='none';});
  addXP(boCorrect * 5);
  autoSave();
}

function stopBlackout() {
  window.speechSynthesis.cancel();
  document.getElementById('blackoutScreen').classList.remove('active');
}

function toggleBoLoop() {
  boLoop = !boLoop;
  (document.getElementById('boLoopBtn')||{}).textContent = boLoop ? 'üîÅ Loop: On' : 'üîÅ Loop: Off';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TELEPROMPTER MODE ‚Äî Rehearsal Pro style
//  Auto-scrolling script with your lines highlighted; tap to pause/resume
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let tpScrollInterval = null, tpSpeed = 2, tpPaused = false, tpHideLines = false, tpLoopOn = false;

function startTeleprompter() {
  const prod = activeProduction;
  if(!prod || !prod.scriptData || prod.scriptData.length === 0) {
    showToast('No script loaded!'); return;
  }
  tpSpeed = 2; tpPaused = false; tpHideLines = false; tpLoopOn = false;
  (document.getElementById('tpSpeedLabel')||{}).textContent = tpSpeed;
  (document.getElementById('tpHideMyLines')||{}).checked = false;
  (document.getElementById('tpLoopBtn')||{}).textContent = 'üîÅ Off';
  (document.getElementById('tpStatus')||{}).textContent = 'Tap script to pause/resume';
  (document.getElementById('tpPauseBtn')||{}).textContent = '‚è∏ Pause';
  tpRender();
  const scroller = document.getElementById('tpScroll');
  if(scroller) scroller.scrollTop = 0;
  document.getElementById('teleprompterScreen').classList.add('active');
  tpStartScroll();
}

function tpRender() {
  const prod = activeProduction;
  if(!prod) return;
  const myChar = prod.myChar;
  const content = document.getElementById('tpContent');
  if(!content) return;
  content.innerHTML = prod.scriptData
    .filter(l => !l.isDirection)
    .map((line, i) => {
      const isMine = line.char === myChar || line.mine;
      if(isMine && tpHideLines) {
        return `<div style="margin-bottom:10px;padding:6px 14px;border-left:4px solid var(--terra);background:rgba(193,97,79,0.08);">
          <div style="font-size:10px;font-weight:900;color:var(--terra);text-transform:uppercase;">${line.char} üé≠</div>
          <div style="background:var(--terra);color:var(--terra);border-radius:6px;padding:4px 8px;user-select:none;">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</div>
        </div>`;
      }
      return `<div style="margin-bottom:10px;padding:6px 14px;border-left:4px solid ${isMine?'var(--terra)':'var(--sand-dark)'};background:${isMine?'rgba(193,97,79,0.08)':'transparent'};">
        <div style="font-size:10px;font-weight:900;color:${isMine?'var(--terra)':'var(--brown-light)'};text-transform:uppercase;">${line.char}${isMine?' üé≠':''}</div>
        <div style="color:var(--brown);">${escapeHtml(line.text)}</div>
      </div>`;
    }).join('');
}

function tpStartScroll() {
  if(tpScrollInterval) clearInterval(tpScrollInterval);
  tpScrollInterval = setInterval(() => {
    if(tpPaused) return;
    const el = document.getElementById('tpScroll');
    if(!el) return;
    el.scrollTop += tpSpeed;
    // Loop: if scrolled to near bottom, restart
    if(tpLoopOn && el.scrollTop + el.clientHeight >= el.scrollHeight - 100) {
      el.scrollTop = 0;
    }
  }, 50);
}

function toggleTpPause() {
  tpPaused = !tpPaused;
  const btn = document.getElementById('tpPauseBtn');
  if(btn) btn.textContent = tpPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
  (document.getElementById('tpStatus')||{}).textContent = tpPaused ? 'Paused ‚Äî tap to resume' : 'Tap script to pause/resume';
}

function tpFaster() { tpSpeed = Math.min(10, tpSpeed+1); (document.getElementById('tpSpeedLabel')||{}).textContent = tpSpeed; }
function tpSlower() { tpSpeed = Math.max(1, tpSpeed-1); (document.getElementById('tpSpeedLabel')||{}).textContent = tpSpeed; }

function tpToggleHide(val) {
  tpHideLines = val;
  tpRender();
}

function tpLoop() {
  tpLoopOn = !tpLoopOn;
  (document.getElementById('tpLoopBtn')||{}).textContent = tpLoopOn ? 'üîÅ On' : 'üîÅ Off';
}

function stopTeleprompter() {
  if(tpScrollInterval) clearInterval(tpScrollInterval);
  tpScrollInterval = null;
  window.speechSynthesis.cancel();
  document.getElementById('teleprompterScreen').classList.remove('active');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUDIO RUN-THROUGH ‚Äî Full Line Learner feature set
//  ‚Ä¢ Play modes: gap‚Üíline, line‚Üígap, gap-only
//  ‚Ä¢ Pitch shift on cue voices (Web Speech pitchRate)
//  ‚Ä¢ Speed control on cue voices (separate from gap speed)
//  ‚Ä¢ Voice recognition auto-advance
//  ‚Ä¢ A-B loop: mark two points, loop that section
//  ‚Ä¢ Flag lines during playback ‚Üí run flagged-only at end
//  ‚Ä¢ Pause after gap option
//  ‚Ä¢ Sleep timer
//  ‚Ä¢ Loop whole scene
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let agPairs = [], agIndex = 0, agGapSeconds = 8, agLoopOn = false;
let agCountdownInterval = null, agCountdownVal = 0;
let agRunning = false, agIsPaused = false;
let agCorrect = 0, agPrompted = 0;
let agPitchRate = 1.0, agCueSpeed = 1.0;
let agPlayMode = 'line-gap';  // 'line-gap' | 'gap-line' | 'gap-only'
let agPauseAfterGap = false, agVoiceAdvance = false;
let agFlaggedLines = new Set();  // indices of flagged lines
let agFlaggedOnly = false;       // running flagged-only pass
let agAStart = -1, agAEnd = -1;  // A-B loop start/end indices
let agSleepTimerInterval = null, agSleepMinutes = 0;
let agVoiceRecognition = null;
let agSettingsOpen = false;
let agABStripOpen = false;

// ‚îÄ‚îÄ Settings panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agOpenSettings() {
  agSettingsOpen = !agSettingsOpen;
  const panel = document.getElementById('agSettingsPanel');
  if(panel) panel.style.display = agSettingsOpen ? 'block' : 'none';
}
function agCloseSettings() {
  agSettingsOpen = false;
  const panel = document.getElementById('agSettingsPanel');
  if(panel) panel.style.display = 'none';
  // Read all settings
  agPlayMode = (document.getElementById('agPlayMode')||{value:'line-gap'}).value;
  agPauseAfterGap = !!(document.getElementById('agPauseAfterGap')||{}).checked;
  agVoiceAdvance  = !!(document.getElementById('agVoiceAdvance')||{}).checked;
  agLoopOn        = !!(document.getElementById('agLoopCheck')||{}).checked;
  agSleepMinutes  = parseInt((document.getElementById('agSleepTimer')||{value:'0'}).value)||0;
  if(agSleepMinutes > 0 && agRunning) agStartSleepTimer();
}

// ‚îÄ‚îÄ Pitch & speed controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agChangePitch(delta) {
  agPitchRate = Math.round(Math.max(0.3, Math.min(2.0, agPitchRate + delta)) * 10) / 10;
  const el = document.getElementById('agPitchLabel');
  if(el) el.textContent = agPitchRate.toFixed(1) + '√ó';
}
function agChangeSpeed(delta) {
  agCueSpeed = Math.round(Math.max(0.5, Math.min(2.0, agCueSpeed + delta)) * 10) / 10;
  const el = document.getElementById('agSpeedLabel');
  if(el) el.textContent = agCueSpeed.toFixed(1) + '√ó';
}

// ‚îÄ‚îÄ Gap size ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agUpdateGap(val) {
  agGapSeconds = parseInt(val);
  const el = document.getElementById('agGapLabel');
  if(el) el.textContent = val + 's';
  agCountdownVal = agGapSeconds;
}

// ‚îÄ‚îÄ Sleep timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agStartSleepTimer() {
  if(agSleepTimerInterval) clearInterval(agSleepTimerInterval);
  let remaining = agSleepMinutes * 60;
  agSleepTimerInterval = setInterval(() => {
    remaining--;
    const el = document.getElementById('agSleepCountdown');
    const mins = Math.floor(remaining/60), secs = remaining%60;
    if(el) el.textContent = `Sleep in ${mins}:${secs.toString().padStart(2,'0')}`;
    if(remaining <= 0) {
      clearInterval(agSleepTimerInterval);
      agPause();
      showToast('üò¥ Sleep timer ‚Äî run-through paused');
    }
  }, 1000);
}

// ‚îÄ‚îÄ A-B Loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agToggleABStrip() {
  agABStripOpen = !agABStripOpen;
  const strip = document.getElementById('agABStrip');
  if(strip) strip.style.display = agABStripOpen ? 'flex' : 'none';
}
function agSetAB(point) {
  if(point === 'A') {
    agAStart = agIndex;
    const btn = document.getElementById('agABtn');
    if(btn) { btn.style.background = 'var(--terra)'; btn.textContent = `A: line ${agIndex+1}`; }
  } else {
    agAEnd = agIndex;
    const btn = document.getElementById('agBBtn');
    if(btn) { btn.style.background = 'var(--sage)'; btn.textContent = `B: line ${agIndex+1}`; }
  }
  const st = document.getElementById('agABStatus');
  if(agAStart >= 0 && agAEnd > agAStart) {
    if(st) st.textContent = `üîÇ Looping lines ${agAStart+1}‚Äì${agAEnd+1}`;
    showToast(`A-B loop set: lines ${agAStart+1}‚Äì${agAEnd+1}`);
  } else if(st) {
    st.textContent = agAStart >= 0 ? 'A set ‚Äî now set B' : 'Tap A then B to loop a section';
  }
}
function agClearAB() {
  agAStart = -1; agAEnd = -1;
  const aBtn = document.getElementById('agABtn');
  const bBtn = document.getElementById('agBBtn');
  const st   = document.getElementById('agABStatus');
  if(aBtn) { aBtn.style.background = 'rgba(255,255,255,0.15)'; aBtn.textContent = 'Set A'; }
  if(bBtn) { bBtn.style.background = 'rgba(255,255,255,0.15)'; bBtn.textContent = 'Set B'; }
  if(st)   st.textContent = 'Tap A then B to loop a section';
}

// ‚îÄ‚îÄ Flag a line ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agFlagLine() {
  if(agPairs[agIndex]) {
    if(agFlaggedLines.has(agIndex)) {
      agFlaggedLines.delete(agIndex);
      showToast('Flag removed');
    } else {
      agFlaggedLines.add(agIndex);
      showToast(`üö© Line ${agIndex+1} flagged for review`);
    }
    agRefreshFlaggedStrip();
  }
}
function agRefreshFlaggedStrip() {
  const strip = document.getElementById('agFlaggedStrip');
  const list  = document.getElementById('agFlaggedList');
  if(!strip || !list) return;
  if(agFlaggedLines.size === 0) { strip.style.display = 'none'; return; }
  strip.style.display = 'block';
  list.innerHTML = [...agFlaggedLines].sort((a,b)=>a-b)
    .map(i => `<div>Line ${i+1}: <em>${(agPairs[i]?.myLine||'').substring(0,60)}${(agPairs[i]?.myLine||'').length>60?'‚Ä¶':''}</em></div>`)
    .join('');
}

// ‚îÄ‚îÄ Voice recognition auto-advance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agStartVoiceRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) { showToast('Voice recognition not supported in this browser'); return; }
  agVoiceRecognition = new SR();
  agVoiceRecognition.continuous = false;
  agVoiceRecognition.interimResults = false;
  agVoiceRecognition.onresult = (e) => {
    if(e.results.length > 0) {
      // Any speech detected = user has spoken their line ‚Üí auto advance
      agGotIt();
    }
  };
  agVoiceRecognition.onerror = () => {};
  agVoiceRecognition.onend   = () => {};
  const ind = document.getElementById('agVoiceIndicator');
  if(ind) ind.style.display = 'block';
  try { agVoiceRecognition.start(); } catch(e) {}
}
function agStopVoiceRecognition() {
  if(agVoiceRecognition) { try { agVoiceRecognition.stop(); } catch(e){} agVoiceRecognition = null; }
  const ind = document.getElementById('agVoiceIndicator');
  if(ind) ind.style.display = 'none';
}

// ‚îÄ‚îÄ Main entry ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startAudioGap() {
  const prod = activeProduction;
  if(!prod || !prod.cuePairs || prod.cuePairs.length === 0) {
    showToast('No lines found ‚Äî upload a script first!'); return;
  }
  agPairs = [...prod.cuePairs];
  agIndex = 0; agCorrect = 0; agPrompted = 0;
  agRunning = false; agIsPaused = false; agFlaggedOnly = false;
  agFlaggedLines = new Set(); agAStart = -1; agAEnd = -1;
  agLoopOn = false; agSleepMinutes = 0;
  agSettingsOpen = false; agABStripOpen = false;

  // Reset UI
  const ids = ['agSettingsPanel','agABStrip','agFlaggedStrip','agFinished'];
  ids.forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none'; });
  const runDiv = document.getElementById('agRunning');
  if(runDiv) runDiv.style.display = 'none';
  const startBtn = document.getElementById('agStartBtn');
  if(startBtn) startBtn.style.display = '';

  // Reset pitch/speed labels
  agPitchRate = 1.0; agCueSpeed = 1.0;
  const pl = document.getElementById('agPitchLabel'); if(pl) pl.textContent = '1.0√ó';
  const sl = document.getElementById('agSpeedLabel'); if(sl) sl.textContent = '1.0√ó';
  const gl = document.getElementById('agGapLabel');   if(gl) gl.textContent = '8s';
  agGapSeconds = 8;

  document.getElementById('agProgress').textContent = `${agPairs.length} lines`;
  document.getElementById('agCurrentChar').textContent = '‚Äî';
  document.getElementById('agCurrentText').textContent = 'Press Start to begin';
  const myTurn = document.getElementById('agMyTurn'); if(myTurn) myTurn.style.display = 'none';
  document.getElementById('audioGapScreen').classList.add('active');
}

function agStart() {
  // Read settings one last time
  agPlayMode     = (document.getElementById('agPlayMode')||{value:'line-gap'}).value;
  agPauseAfterGap= !!(document.getElementById('agPauseAfterGap')||{}).checked;
  agVoiceAdvance = !!(document.getElementById('agVoiceAdvance')||{}).checked;
  agLoopOn       = !!(document.getElementById('agLoopCheck')||{}).checked;
  agSleepMinutes = parseInt((document.getElementById('agSleepTimer')||{value:'0'}).value)||0;
  agGapSeconds   = parseInt((document.getElementById('agGapSlider')||{value:'8'}).value)||8;

  agRunning = true; agIsPaused = false; agIndex = 0;
  const startBtn = document.getElementById('agStartBtn');
  if(startBtn) startBtn.style.display = 'none';
  const runDiv = document.getElementById('agRunning');
  if(runDiv) { runDiv.style.display = 'flex'; runDiv.style.flexDirection = 'column'; }

  if(agSleepMinutes > 0) agStartSleepTimer();
  agPlayNext();
}

function agPlayNext() {
  if(!agRunning || agIsPaused) return;

  // A-B loop check ‚Äî if we hit B, jump back to A
  if(agAStart >= 0 && agAEnd > agAStart && agIndex > agAEnd) {
    agIndex = agAStart;
  }

  // Flagged-only pass: skip non-flagged lines
  if(agFlaggedOnly && agFlaggedLines.size > 0) {
    while(agIndex < agPairs.length && !agFlaggedLines.has(agIndex)) agIndex++;
  }

  if(agIndex >= agPairs.length) { agFinish(); return; }

  const pair = agPairs[agIndex];
  const pct  = Math.round((agIndex / agPairs.length) * 100);
  const progBar = document.getElementById('agProgBar');
  if(progBar) progBar.style.width = pct + '%';
  document.getElementById('agProgress').textContent = `Line ${agIndex+1} of ${agPairs.length}${agFlaggedLines.size?' ¬∑ üö©'+agFlaggedLines.size:''}`;

  // Hide "your turn" card
  const myTurnEl = document.getElementById('agMyTurn');
  if(myTurnEl) myTurnEl.style.display = 'none';
  agStopVoiceRecognition();

  // Show cue line
  document.getElementById('agCurrentChar').textContent = 'OTHER CHARACTER';
  document.getElementById('agCurrentText').textContent = pair.cue === 'Start of scene' ? '‚ñ∂ Scene begins...' : (pair.cue || '‚Äî');

  // mode: 'line-gap' = speak cue ‚Üí gap   |   'gap-line' = gap ‚Üí speak cue   |  'gap-only' = just gap
  if(agPlayMode === 'gap-line') {
    // User tries first, THEN hears the cue (like a quiz)
    agShowMyTurn(() => {
      if(!agRunning || agIsPaused) return;
      agSpeak(pair.cue, () => {
        agIndex++;
        setTimeout(() => agPlayNext(), 600);
      }, true); // true = is cue voice
    });
  } else if(agPlayMode === 'gap-only') {
    // No cue playback at all ‚Äî pure silent recall
    agShowMyTurn(() => {
      agIndex++;
      setTimeout(() => agPlayNext(), 400);
    });
  } else {
    // 'line-gap' = default: speak cue ‚Üí gap
    agSpeak(pair.cue === 'Start of scene' ? 'Scene begins.' : (pair.cue||''), () => {
      if(!agRunning || agIsPaused) return;
      agShowMyTurn(() => {
        agIndex++;
        setTimeout(() => agPlayNext(), agPauseAfterGap ? 200 : 400);
      });
    }, true); // true = cue voice (apply pitch shift + speed)
  }
}

// Speak text using TTS with optional pitch/speed modification for cue voices
function agSpeak(text, onEnd, isCue) {
  if(!text || !agRunning) { if(onEnd) onEnd(); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate  = isCue ? agCueSpeed  : (ttsRate || 0.9);
  u.pitch = isCue ? agPitchRate : 1.0;
  u.onend = () => { if(agRunning && !agIsPaused && onEnd) onEnd(); };
  u.onerror = () => { if(agRunning && !agIsPaused && onEnd) onEnd(); };
  window.speechSynthesis.speak(u);
}

// Show the "your turn" gap card with countdown
function agShowMyTurn(onExpire) {
  const pair   = agPairs[agIndex];
  const myTurn = document.getElementById('agMyTurn');
  const myLineEl = document.getElementById('agMyLineText');
  if(!myTurn) { if(onExpire) onExpire(); return; }

  // Set up the card
  if(myLineEl) { myLineEl.style.display = 'none'; myLineEl.textContent = pair?.myLine || ''; }
  myTurn.style.display = 'block';
  document.getElementById('agCurrentChar').textContent = (activeProduction?.myChar||'YOU') + ' üé≠';
  document.getElementById('agCurrentText').textContent = '‚Äî your turn ‚Äî';

  agCountdownVal = agGapSeconds;
  const cdEl = document.getElementById('agCountdown');
  if(cdEl) cdEl.textContent = agCountdownVal;

  if(agCountdownInterval) clearInterval(agCountdownInterval);

  // Start voice recognition if enabled
  if(agVoiceAdvance) agStartVoiceRecognition();

  agCountdownInterval = setInterval(() => {
    if(!agRunning || agIsPaused) return;
    agCountdownVal--;
    if(cdEl) cdEl.textContent = agCountdownVal;
    if(agCountdownVal <= 0) {
      clearInterval(agCountdownInterval);
      agStopVoiceRecognition();
      // Auto-prompt when time's up
      agPrompt();
      if(agPauseAfterGap) {
        // Pause here and wait for user to tap resume
        agIsPaused = true;
        const pauseBtn = document.getElementById('agPauseBtn');
        if(pauseBtn) pauseBtn.textContent = '‚ñ∂ Resume';
        // store callback so resume can trigger it
        agPauseCallback = onExpire;
      } else {
        setTimeout(() => { if(agRunning && !agIsPaused && onExpire) onExpire(); }, 1500);
      }
    }
  }, 1000);

  // Store for Got It
  agCurrentGapCallback = onExpire;
}
let agCurrentGapCallback = null;
let agPauseCallback = null;

function agPrompt() {
  clearInterval(agCountdownInterval);
  agStopVoiceRecognition();
  agPrompted++;
  const myLineEl = document.getElementById('agMyLineText');
  const cdEl     = document.getElementById('agCountdown');
  if(myLineEl) {
    myLineEl.style.display = 'block';
    agSpeak(myLineEl.textContent, null, false); // speak at normal rate/pitch
  }
  if(cdEl) cdEl.textContent = 'üí°';
}

function agGotIt() {
  clearInterval(agCountdownInterval);
  window.speechSynthesis.cancel();
  agStopVoiceRecognition();
  agCorrect++;
  addXP(8);
  const myTurn = document.getElementById('agMyTurn');
  if(myTurn) myTurn.style.display = 'none';
  agIndex++;
  const cb = agCurrentGapCallback;
  agCurrentGapCallback = null;
  // In line-gap mode the callback handles moving on, in gap-line and gap-only we just play next
  if(cb && agPlayMode !== 'gap-line') {
    // skip the natural expiry callback
  }
  setTimeout(() => agPlayNext(), 300);
}

function agSkip() {
  clearInterval(agCountdownInterval);
  window.speechSynthesis.cancel();
  agStopVoiceRecognition();
  agIndex++;
  const myTurn = document.getElementById('agMyTurn');
  if(myTurn) myTurn.style.display = 'none';
  agCurrentGapCallback = null;
  agPlayNext();
}

function agPause() {
  agIsPaused = !agIsPaused;
  const btn = document.getElementById('agPauseBtn');
  if(btn) btn.textContent = agIsPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
  if(agIsPaused) {
    window.speechSynthesis.cancel();
    clearInterval(agCountdownInterval);
    agStopVoiceRecognition();
  } else {
    // If we were paused mid-gap, just restart from current index
    const pauseCb = agPauseCallback;
    agPauseCallback = null;
    if(pauseCb) pauseCb();
    else agPlayNext();
  }
}

function toggleAgLoop() {
  agLoopOn = !agLoopOn;
  const btn = document.getElementById('agLoopBtn');
  if(btn) btn.textContent = agLoopOn ? 'üîÅ On' : 'üîÅ Off';
  const chk = document.getElementById('agLoopCheck');
  if(chk) chk.checked = agLoopOn;
}

function agRunFlaggedOnly() {
  if(agFlaggedLines.size === 0) { showToast('No flagged lines!'); return; }
  agFlaggedOnly = true;
  agIndex = 0; agCorrect = 0; agPrompted = 0; agRunning = true; agIsPaused = false;
  const fin = document.getElementById('agFinished');
  if(fin) fin.style.display = 'none';
  const runDiv = document.getElementById('agRunning');
  if(runDiv) { runDiv.style.display = 'flex'; runDiv.style.flexDirection = 'column'; }
  showToast(`Running ${agFlaggedLines.size} flagged line(s) üö©`);
  agPlayNext();
}

function agFinish() {
  agRunning = false;
  window.speechSynthesis.cancel();
  clearInterval(agCountdownInterval);
  if(agSleepTimerInterval) clearInterval(agSleepTimerInterval);
  agStopVoiceRecognition();

  const total = agPairs.length;
  const pct   = total > 0 ? Math.round((agCorrect/total)*100) : 0;
  const statsEl = document.getElementById('agFinishStats');
  if(statsEl) statsEl.textContent = `${agCorrect}/${total} without prompting ¬∑ ${agPrompted} prompts ¬∑ ${pct}%`;

  // Flagged lines summary
  const flagFin  = document.getElementById('agFlaggedFinish');
  const flagList = document.getElementById('agFlaggedFinishList');
  const flagBtn  = document.getElementById('agRunFlaggedBtn');
  if(agFlaggedLines.size > 0 && flagFin && flagList) {
    flagFin.style.display  = 'block';
    if(flagBtn) flagBtn.style.display = '';
    flagList.innerHTML = [...agFlaggedLines].sort((a,b)=>a-b)
      .map(i => `<div>Line ${i+1}: <em>${(agPairs[i]?.myLine||'').substring(0,70)}‚Ä¶</em></div>`)
      .join('');
  } else if(flagFin) { flagFin.style.display = 'none'; }

  const fin = document.getElementById('agFinished');
  if(fin) fin.style.display = 'block';
  const runDiv = document.getElementById('agRunning');
  if(runDiv) runDiv.style.display = 'none';

  addXP(agCorrect * 8);
  autoSave();

  if(agLoopOn && !agFlaggedOnly) {
    agIndex = 0; agRunning = true;
    setTimeout(() => agPlayNext(), 1500);
  }
}

function agRestart() {
  agIndex = 0; agCorrect = 0; agPrompted = 0;
  agRunning = true; agIsPaused = false; agFlaggedOnly = false;
  const fin = document.getElementById('agFinished');
  if(fin) fin.style.display = 'none';
  const runDiv = document.getElementById('agRunning');
  if(runDiv) { runDiv.style.display = 'flex'; runDiv.style.flexDirection = 'column'; }
  agPlayNext();
}

function stopAudioGap() {
  agRunning = false;
  window.speechSynthesis.cancel();
  clearInterval(agCountdownInterval);
  if(agSleepTimerInterval) clearInterval(agSleepTimerInterval);
  agStopVoiceRecognition();
  document.getElementById('audioGapScreen').classList.remove('active');
}


function finishScriptLoad(prod) {
  productions.push(prod);
  activeProduction = prod;
  currentScriptIdx = productions.length - 1;
  autoSave();
  renderScriptReader(prod.scriptData, prod.myChar);
  document.getElementById('sceneSplitterSection').style.display = 'none';
  document.getElementById('charSetup').style.display = 'none';
  document.getElementById('readerSection').style.display = 'block';
  refreshHome();
  renderScriptLibrary();
  showToast(`‚úÖ Script loaded! ${(prod.cuePairs||[]).length} lines for ${prod.myChar}`);
}

// Drag & drop on drop zone
document.addEventListener('DOMContentLoaded', function() {
  const dropZone = document.getElementById('dropZone');
  if(dropZone) {
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault(); dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if(file) handleFileUpload({ files: [file] });
    });
  }
});

</script>
</body>
</html>
