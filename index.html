<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EscoMind â€” Learn Your Lines</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<!-- PWA / App Icon â€” fully embedded, no extra files needed -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="EscoMind">
<meta name="theme-color" content="#C1614F">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAP3UlEQVR4nO3W0ZHjhhVE0Y1BUTj/KBSE09C3XbIlUdod7jSHIBt477yq888CMNP32zd36fvll1/+A9DS/h/o3OWv/UcM8E7t/7nOvfXaf3AAV9D+X+3c09f+IwKYoP2/3LlPr/1HArBB+3+9cwYf4ATaW+CWXPtDB+C+9ka4gdf+qAHItTfDXfzaHzAAz2tvibvQtT9WAI7X3hZ30mt/mAC8T3tz3Amu/REC0NPeIFe49kcHwHm0N8m94dofGQDn1d4o94Jrf1QAXEd7s9xB1/6QALie9na5J6798QBwfe0tcw9c+2MBYJ72trlPrv2BADBXe+PcB9f+KADYo7157o9rfwgA7NPevtXXfvkA0N7Cddd+4QDwp/Ymrrn2iwaA77W3cfS1Xy4AfKa9leOu/UIBINXezDHXfpEA8Kj2dl7+2i8QAL6qvaGXvPZLA4CjtDf1Mtd+UQBwtPa2nv7aLwgAXqW9sae99osBgFdrb+3prv1CAOBd2pt7mmu/CAB4t/b21q/9AgCgpb3BtWs/eABoa2/x26/9wAHgLNqb/LZrP2gAOJv2Nr/82g8YAM6qvdEvvfbDBYCzam/0y679YAHg7Npbffi1HygAXEV7sw+79oMEgKtpb/fT136AAHBV7Q1/6toPDwCuqr3hX772gwOAq2tv+cPXfmAAMEV70+NrPygAmKa97dG1HxIATNPe9k+v/YAAYKr2xt+99oMBgOnaW//htR8KAEzX3vofrv1AAGCL9ub/de0HAQDbtLf/f9d+CACwTXv7jT8AlAgAAFjI+APAUsYfAJYSAACwkPEHgKUEAAAsZPwBYCkBAAALGX8AWEoAAMBCxh8AlhIAALCQAACAhYw/ACwlAABgIeMPAEsJAABYSAAAwELGHwCWEgAAsJDxB4ClBAAALCQAAGAh4w8ASwkAAFhIAADAQgIAABYy/gCwlAAAgIUEAAAsJAAAYCHjDwBLCQAAWEgAAMBCAgAAFjL+ALCUAACAhQQAACwkAABgIQEAAAsJAABYSAAAwELGHwCWEgAAsJAAAICFBAAALCQAAGAhAQAACwkAAFhIAADAQgIAABYSAACwkAAAgIUEAAAsJAAAYCEBAAALGX8AWEgAAMBCAgAAFhIAALCQAACAhQQAACwkAABgIQEAAAsJAABYSAAAwEICAAAWEgAAsJAAAICFBAAALCQAAGAhAQAACwkAAFhIAADAQgIAABYSAACwkAAAgIUEAAAsJACI/fbbb/CU9jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+ur/0NAzcCgFh7PLi+9jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+u7+hv8t//+lf97wKuSgAQa48H1/eV7+73kf+q9t8MnJkAINYeD64v/daeGX0xABkBQKw9HlzfZ9/YK4ZfCMDHBACx9nhwffe+rXcMvxCAfxIAxI76Zw9/1xh/EQACgAcIAI7UHH4hAAKABwgAjtIefBEAAoAHCACO0B56EQD/JwCICQCe1R54EQA3AoCYAOAZ7WEXAfBPAoCYAOCr2oMuAuBHAoCYAOCr2mMuAOBHAoCYAOAr2kMuAuBjAoCYAOBR7QEXAXCfACAmAHhUe7wFANwnAIgJAB7RHm4RAD8nAIgJAB7RHm0BAD8nAIgJAFLtwRYB8DkBQEwAkGqPtQCAzwkAYgKAVHusBQB8TgAQEwAk2kMtAiAjAIgJABLtkRYAkBEAxAQAifZICwDICABiAoBEe6QFAGQEADEBQKI90gIAMgKAmAAg0R5pAQAZAUBMAJBoj7QAgIwAICYA+Ex7oEUA5AQAMQFAoj3Qxh8yAoCYACDRHmkBABkBQEwAkGiPtACAjAAgJgBItEdaAEBGABATACTaIy0AICMAiAkAEu2RFgCQEQDEBACJ9kgLAMgIAGICgFR7qI0/fE4AEBMApNpjLQDgcwKAmAAg1R5rAQCfEwDEBACPaA+28YefEwDEBACPaI+2AICfEwDEBACPag+38Yf7BAAxAcCj2uMtAOA+AUBMAPAV7QE3/vAxAUBMAPBV7SE3/vAjAUBMAPBV7TEXAPAjAUBMAPCM9qAbf/gnAUBMAPCs9rAbf7gRAMQEAEdoD7zxh/8TAMQEAEdpD73xBwHAAwQAR2oPvvFnOwFATADwCoYfOgQAMQHAqxh/eD8BQEwA8GqGH95HABATALyL4YfXEwDEBAANRh9eQwAQEwCcjZGHrxMAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFA7NEA4Nza3xPQJQCItQcLAQAcRwAQaw8WAgA4jgAg1h4sBABwHAFArD1YCADgOAKAWHuwEADAcQQAsfZgIQCA4wgAYu3BQgAAxxEAxNqDhQAAjiMAiLUHCwEAHEcAEGsPFgIAOI4AINYeLAQAcBwBQMzAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiAkAgDkEADEBADCHACAmAADmEADEBADAHAKAmAAAmEMAEBMAAHMIAGICAGAOAUBMAADMIQCICQCAOQQAMQEAMIcAICYAAOYQAMQEAMAcAoCYAACYQwAQEwAAcwgAYgIAYA4BQEwAAMwhAIgJAIA5BAAxAQAwhwAgJgAA5hAAxAQAwBwCgJgAAJhDABATAABzCABiAgBgDgFATAAAzCEAiD0aAPC99jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+ur/0NAzcCgFh7PLi+9jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+ur/0NAzcCgFh7PLi+9jcM3AgAYu3x4Pra3zBwIwCItceD62t/w8CNACDWHg+ur/0NAzcCAAAWEgAAsJAAAICFBAAALCQAAGAhAQAACwkAAFhIAADAQgIAABYSAACwkAAAgIUEALzZr7/+Wv8NfgsgAODFfh+2z/gt3d8CGwkAeKFk5N41dn4L8HcCAF7kkZF79dj5LcD3BAC8wFdG7lVj57cAHxEAcLBnRu7osfNbgHsEABzsTEPntwD3CAA42JmGzm8B7hEAcLAzDZ3fAtwjAOBAR4zcUWPntwA/IwDgYGcaOb8FuOfb79f+ETDJmYbObwHuEQBwsDMNnd8C3CMA4GBnGjq/BbhHAMALnGnk/BbgIwIAXuRMI+e3AN8TAPBCZxo5vwX4OwEAL3amkfNbgD8JAHizMw2b3wJ7CQAAWEgAAMBCAgAAFhIAALCQAACAhQQAACz07c9r/xAA4D2+/f3aPwYAeA8BAAALCQAAWEgAAMBCAgAAFhIAALDQt++v/YMAgNf6YfwFAADMJwAAYCEBAAALfRgAIgAA5ro7/gIAAOYSAACwkAAAgIV+GgAiAADm+XT8BQAAzCMAAGAhAQAAC0UBIAIAYI54/AUAAMwhAABgoYcCQAQAwPU9PP4CAACu70sBIAIA4Lq+PP4CAACuSwAAwEJPBYAIAIDreXr8BQAAXM8hASACAOA6Dht/AQAA1yEAAGChQwNABADA+R0+/gIAAM7vJQEgAgDgvF42/gIAAM7rpQEgAgDgfF4+/gIAAM7nLQEgAgDgPN42/gIAAM7jrQEgAgCg7+3jLwIAoKs2/gIAAHqqASACAOD92tv/v2s/BADYpr39f137QQDAFu3N/+HaDwQApmtv/YfXfigAMF176+9e+8EAwFTtjf/02g8IAKZpb3t07YcEANO0tz2+9oMCgCnam/7wtR8YAFxde8u/fO0HBwBX1d7wp6798ADgqtob/vS1HyAAXE17uw+79oMEgKtob/bh136gAHB27a1+2bUfLACcVXujX3rthwsAZ9Xe6Jdf+wEDwNm0t/lt137QAHAW7U1++7UfOAC0tbe4du0HDwAt7Q2uX/sFAMC7tbf3NNd+EQDwLu3NPd21XwgAvFp7a0977RcDAK/S3tjTX/sFAcDR2tt6mWu/KAA4SntTL3ntlwYAX9Xe0Mtf+wUCwKPa2znm2i8SAFLtzRx37RcKAJ9pb+Xoa79cAPheexvXXPtFA8Cf2pu47tovHADaW7j62i8fgH3a2+f+uPaHAMAe7c1zH1z7owBgrvbGuU+u/YEAME9729wD1/5YALi+9pa5J6798QBwPe3tcgdd+0MC4Dram+VecO2PCoDzam+Ue8O1PzIAzqO9Sa5w7Y8OgJ72BrkTXPsjBOB92pvjTnrtDxOA47W3xV3o2h8rAM9rb4m7+LU/YABy7c1wA6/9UQNwX3sj3JJrf+gAGH13gmv/EQBs0P5f79yn1/4jAZig/b/cuaev/UcEcAXt/9XOvfXaf3AA79T+n+u+ffsvvceaczFgqLsAAAAASUVORK5CYII=">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%23C1614F'/><text y='72' x='50' text-anchor='middle' font-size='62' font-family='serif'>ğŸ­</text></svg>">
<style>
@font-face {
  font-family: 'OpenDyslexic';
  src: url('https://cdn.jsdelivr.net/npm/open-dyslexic@1.0.3/fonts/OpenDyslexic-Regular.otf') format('opentype');
}

:root {
  --sand: #F5ECD7;
  --sand-dark: #E8D9BC;
  --cream: #FAF4E8;
  --terra: #C1614F;
  --terra-light: #D4826F;
  --terra-dark: #A04F3E;
  --sage: #7A9E7E;
  --sage-light: #A3C4A8;
  --sage-dark: #5A7E5E;
  --brown: #4A3728;
  --brown-light: #6B5445;
  --amber: #E8A838;
  --amber-light: #F2C46A;
  --rose: #C4897A;
  --font: 'OpenDyslexic', 'Nunito', sans-serif;
  --display: 'Nunito', sans-serif;
  --r: 18px;
  --rs: 10px;
  --shadow: 0 4px 20px rgba(74,55,40,0.12);
  --shadow-lg: 0 8px 40px rgba(74,55,40,0.2);
}

*{margin:0;padding:0;box-sizing:border-box;}

body {
  font-family: var(--font);
  background: var(--sand);
  color: var(--brown);
  min-height: 100vh;
  overflow-x: hidden;
  font-size: 15px;
}

/* â”€â”€ SCREENS â”€â”€ */
.screen { display:none; min-height:100vh; flex-direction:column; animation: fadeIn 0.25s ease; }
.screen.active { display:flex; }
.game-screen { display:none; min-height:100vh; flex-direction:column; background:var(--sand); }
.game-screen.active { display:flex; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* â”€â”€ SCROLLABLE BODY â”€â”€ */
.scroll-content { flex:1; overflow-y:auto; padding:20px 20px 110px; }

/* â”€â”€ HEADER â”€â”€ */
.app-header {
  background: var(--cream);
  padding: 50px 20px 14px;
  border-bottom: 2px solid var(--sand-dark);
  display: flex; align-items:center; justify-content:space-between;
  position: sticky; top:0; z-index:50;
  box-shadow: 0 2px 12px rgba(74,55,40,0.06);
}
.logo { font-family:var(--display); font-size:26px; font-weight:900; color:var(--terra); letter-spacing:-1px; }
.logo span { color:var(--sage); }

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav {
  position:fixed; bottom:0; left:0; right:0;
  background:var(--cream); border-top:2px solid var(--sand-dark);
  display:flex; justify-content:space-around; align-items:center;
  padding:8px 0 18px; z-index:100;
  box-shadow: 0 -4px 20px rgba(74,55,40,0.08);
}
.nav-btn {
  display:flex; flex-direction:column; align-items:center; gap:2px;
  background:none; border:none; cursor:pointer; padding:4px 6px;
  color:var(--brown-light); font-family:var(--font); font-size:9px; font-weight:700;
  border-radius:var(--rs); transition:all 0.2s;
}
.nav-btn.active { color:var(--terra); }
.nav-btn .ni { font-size:18px; }

/* â”€â”€ CARDS â”€â”€ */
.card {
  background:var(--cream); border-radius:var(--r); padding:20px;
  box-shadow:var(--shadow); margin-bottom:16px;
}
.section-title { font-size:17px; font-weight:900; margin-bottom:14px; }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  border:none; border-radius:var(--rs); padding:14px 20px;
  font-family:var(--font); font-weight:900; font-size:14px;
  cursor:pointer; transition:all 0.2s; width:100%;
}
.btn-terra { background:var(--terra); color:white; }
.btn-terra:hover { background:var(--terra-dark); }
.btn-sage { background:var(--sage); color:white; }
.btn-sage:hover { background:var(--sage-dark); }
.btn-ghost { background:var(--sand); color:var(--brown); border:2px solid var(--sand-dark); }
.btn-ghost:hover { border-color:var(--terra); }
.btn-sm { padding:8px 16px; font-size:12px; width:auto; }

/* â”€â”€ HERO â”€â”€ */
.hero {
  border-radius:var(--r); padding:26px 22px; margin-bottom:20px;
  color:white; position:relative; overflow:hidden;
}
.hero-terra { background: linear-gradient(135deg, var(--terra), var(--rose)); }
.hero-brown { background: linear-gradient(135deg, var(--brown), var(--brown-light)); }
.hero-sage  { background: linear-gradient(135deg, var(--sage-dark), var(--sage)); }
.hero::before { content:attr(data-emoji); font-size:90px; position:absolute; right:-12px; top:-12px; opacity:0.15; pointer-events:none; }
.hero h2 { font-size:22px; font-weight:900; margin-bottom:6px; }
.hero p { font-size:13px; opacity:0.9; line-height:1.6; }
.hero-stats { display:flex; gap:12px; margin-top:16px; flex-wrap:wrap; }
.hstat { background:rgba(255,255,255,0.18); border-radius:var(--rs); padding:10px 14px; text-align:center; }
.hstat .n { font-size:20px; font-weight:900; }
.hstat .l { font-size:10px; opacity:0.85; }

/* â”€â”€ PROGRESS â”€â”€ */
.prog-wrap { background:var(--sand-dark); border-radius:99px; height:8px; }
.prog-fill { height:8px; border-radius:99px; background:linear-gradient(90deg,var(--terra),var(--amber)); transition:width 0.4s; }
.prog-label { font-size:11px; color:var(--brown-light); margin-top:4px; }

/* â”€â”€ PRODUCTION CARDS â”€â”€ */
.prod-card {
  background:var(--cream); border-radius:var(--r); padding:16px 18px;
  box-shadow:var(--shadow); cursor:pointer; transition:transform 0.2s;
  display:flex; align-items:center; gap:14px; margin-bottom:12px;
  border-left:5px solid var(--terra);
}
.prod-card:nth-child(2){border-left-color:var(--sage);}
.prod-card:nth-child(3){border-left-color:var(--amber);}
.prod-card:hover{transform:translateY(-2px);}
.prod-icon{font-size:30px;}
.prod-info{flex:1;}
.prod-name{font-weight:900;font-size:15px;margin-bottom:2px;}
.prod-sub{font-size:11px;color:var(--brown-light);}

/* â”€â”€ QUICK ACTIONS â”€â”€ */
.qa-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px; }
.qa-btn {
  background:var(--cream); border-radius:var(--r); padding:18px 14px;
  box-shadow:var(--shadow); cursor:pointer; text-align:center;
  transition:transform 0.2s; border:none; font-family:var(--font);
}
.qa-btn:hover{transform:translateY(-2px);}
.qa-icon{font-size:28px;margin-bottom:8px;}
.qa-label{font-size:12px;font-weight:800;color:var(--brown);}

/* â”€â”€ TIMER WIDGET â”€â”€ */
.timer-widget {
  background:linear-gradient(135deg,var(--sage),var(--sage-dark));
  border-radius:var(--r); padding:18px 22px; margin-bottom:20px;
  color:white; display:flex; align-items:center; justify-content:space-between; cursor:pointer;
}
.tw-left h3{font-size:15px;font-weight:900;margin-bottom:3px;}
.tw-left p{font-size:12px;opacity:0.85;}
.tw-time{font-size:32px;font-weight:900;font-family:var(--display);letter-spacing:-1px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCRIPT IMPORT â€” THE NEW SECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* drag zone */
.import-zone {
  border:3px dashed var(--sand-dark); border-radius:var(--r);
  padding:36px 20px; text-align:center; cursor:pointer;
  transition:all 0.25s; background:var(--cream); margin-bottom:16px;
  position:relative;
}
.import-zone:hover, .import-zone.drag-over {
  border-color:var(--terra); background:rgba(193,97,79,0.05);
}
.import-zone input[type=file] {
  position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%;
}
.iz-icon{font-size:48px;margin-bottom:10px;}
.iz-title{font-size:17px;font-weight:900;margin-bottom:6px;}
.iz-sub{font-size:13px;color:var(--brown-light);line-height:1.5;}

/* import method tabs */
.import-tabs { display:flex; gap:8px; margin-bottom:16px; }
.itab {
  flex:1; padding:10px; border-radius:var(--rs); border:2px solid var(--sand-dark);
  background:var(--sand); font-family:var(--font); font-size:12px; font-weight:800;
  cursor:pointer; color:var(--brown); text-align:center; transition:all 0.2s;
}
.itab.active{background:var(--terra);color:white;border-color:var(--terra);}

.import-panel { display:none; }
.import-panel.active { display:block; }

/* paste area */
.paste-area {
  width:100%; min-height:180px; padding:16px; border-radius:var(--rs);
  border:2px solid var(--sand-dark); background:var(--sand);
  font-family:var(--font); font-size:14px; color:var(--brown);
  resize:vertical; outline:none; line-height:1.8; transition:border-color 0.2s;
}
.paste-area:focus{border-color:var(--terra);}
.paste-area::placeholder{color:var(--brown-light);}

/* character setup */
.char-setup {
  background:var(--cream); border-radius:var(--r); padding:20px;
  box-shadow:var(--shadow); margin-bottom:16px; display:none;
}
.char-setup.show{display:block; animation:fadeIn 0.3s ease;}
.char-setup h3{font-size:16px;font-weight:900;margin-bottom:12px;}
.char-input {
  width:100%; padding:14px 16px; border-radius:var(--rs);
  border:2px solid var(--sand-dark); background:var(--sand);
  font-family:var(--font); font-size:15px; color:var(--brown);
  outline:none; transition:border-color 0.2s; margin-bottom:12px;
}
.char-input:focus{border-color:var(--terra);}

/* detected characters */
.detected-chars { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:14px; }
.char-pill {
  padding:6px 14px; border-radius:99px; border:2px solid var(--sand-dark);
  background:var(--sand); font-family:var(--font); font-size:13px;
  font-weight:800; cursor:pointer; color:var(--brown); transition:all 0.2s;
}
.char-pill.selected{background:var(--terra);color:white;border-color:var(--terra);}

/* script reader */
.reader-toolbar {
  display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px;
}
.tool-btn {
  padding:7px 14px; border-radius:99px; border:2px solid var(--sand-dark);
  background:var(--sand); font-family:var(--font); font-size:11px;
  font-weight:800; cursor:pointer; color:var(--brown); transition:all 0.2s;
}
.tool-btn.active{background:var(--terra);color:white;border-color:var(--terra);}

.script-reader {
  background:var(--cream); border-radius:var(--r); padding:22px 18px;
  box-shadow:var(--shadow); line-height:2; display:none;
}
.script-reader.show{display:block;}
.script-block{margin-bottom:18px;}
.s-charname{font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1.5px;color:var(--brown-light);margin-bottom:4px;}
.s-myline{background:rgba(193,97,79,0.1);border-left:4px solid var(--terra);padding:10px 14px;border-radius:0 var(--rs) var(--rs) 0;font-size:var(--script-fs,16px);}
.s-otherline{padding:4px 0;color:var(--brown-light);font-size:calc(var(--script-fs,16px) - 1px);}
.clickword{cursor:pointer;border-radius:3px;transition:background 0.15s;display:inline;}
.clickword:hover{background:var(--amber-light);}

/* empty state */
.empty-state{text-align:center;padding:40px 20px;color:var(--brown-light);}
.empty-state .es-icon{font-size:52px;margin-bottom:12px;}
.empty-state p{font-size:14px;line-height:1.6;}

/* â”€â”€ PRACTICE â”€â”€ */
.pm-card {
  background:var(--cream); border-radius:var(--r); padding:16px 18px;
  box-shadow:var(--shadow); cursor:pointer; transition:transform 0.2s;
  display:flex; align-items:center; gap:14px; margin-bottom:12px;
}
.pm-card:hover{transform:translateY(-2px);}
.pm-icon{font-size:32px;}
.pm-info{flex:1;}
.pm-name{font-weight:900;font-size:15px;margin-bottom:2px;}
.pm-desc{font-size:11px;color:var(--brown-light);line-height:1.4;}
.pm-arrow{font-size:20px;color:var(--brown-light);}

/* â”€â”€ CUE CARDS â”€â”€ */
.cue-header{background:var(--cream);padding:50px 20px 14px;border-bottom:2px solid var(--sand-dark);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:50;}
.back-btn{background:none;border:none;font-size:26px;cursor:pointer;color:var(--brown);line-height:1;}
.cue-body{flex:1;padding:20px 20px 110px;display:flex;flex-direction:column;gap:14px;}

.cue-box{background:var(--cream);border-radius:var(--r);padding:22px;box-shadow:var(--shadow);}
.cue-lbl{font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:1.5px;color:var(--brown-light);margin-bottom:8px;}
.cue-txt{font-size:16px;line-height:1.8;}

.myline-reveal {
  background:var(--cream); border-radius:var(--r); padding:22px;
  box-shadow:var(--shadow); border:2px solid var(--sand-dark);
  min-height:90px; cursor:pointer; transition:all 0.2s;
  display:flex; align-items:center; justify-content:center; text-align:center;
}
.myline-reveal.shown{background:rgba(122,158,126,0.08);border-color:var(--sage);}
.reveal-hint{color:var(--brown-light);font-size:14px;}
.reveal-txt{font-size:16px;line-height:1.8;display:none;}

.voice-btn{
  background:var(--terra); color:white; border:none;
  border-radius:var(--rs); padding:15px; font-family:var(--font);
  font-weight:900; font-size:14px; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px;
  width:100%; transition:all 0.2s;
}
.voice-btn.listening{background:var(--sage);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}

.feedback-row{display:flex;gap:10px;}
.fb-btn{
  flex:1; padding:13px; border-radius:var(--rs); border:none;
  font-family:var(--font); font-weight:900; font-size:13px; cursor:pointer;
}
.fb-wrong{background:#F5D0CA;color:var(--terra-dark);}
.fb-close{background:var(--amber-light);color:#7A5500;}
.fb-right{background:rgba(122,158,126,0.25);color:var(--sage-dark);}

.result-banner{border-radius:var(--rs);padding:14px 18px;font-weight:900;font-size:14px;text-align:center;display:none;line-height:1.5;}
.res-good{background:rgba(122,158,126,0.2);color:var(--sage-dark);display:block;}
.res-bad{background:rgba(193,97,79,0.12);color:var(--terra-dark);display:block;}

.next-btn{background:var(--terra);color:white;border:none;border-radius:var(--rs);padding:15px;font-family:var(--font);font-weight:900;font-size:15px;cursor:pointer;width:100%;display:none;transition:background 0.2s;}
.next-btn.show{display:block;}
.next-btn:hover{background:var(--terra-dark);}

/* word analysis */
.word-analysis{background:var(--cream);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);display:none;font-size:13px;line-height:1.8;}
.word-analysis.show{display:block;}
.w-correct{color:var(--sage-dark);font-weight:800;}
.w-wrong{color:var(--terra-dark);font-weight:800;text-decoration:underline wavy var(--terra);}
.w-missing{background:rgba(193,97,79,0.15);border-radius:3px;padding:1px 4px;color:var(--terra-dark);font-weight:800;}

/* â”€â”€ GAME CENTER â”€â”€ */
.gc-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
.gc-card{
  border-radius:var(--r); padding:18px 14px; cursor:pointer;
  transition:transform 0.2s; box-shadow:var(--shadow); position:relative; overflow:hidden;
}
.gc-card:hover{transform:translateY(-3px);}
.gc-1{background:linear-gradient(135deg,#E8C4A0,#D4A070);}
.gc-2{background:linear-gradient(135deg,var(--sage-light),var(--sage));}
.gc-3{background:linear-gradient(135deg,#D4A4B4,#B87090);}
.gc-4{background:linear-gradient(135deg,#A0C4D4,#6090B0);}
.gc-icon{font-size:32px;margin-bottom:8px;}
.gc-name{font-size:13px;font-weight:900;color:var(--brown);margin-bottom:3px;}
.gc-desc{font-size:10px;color:var(--brown-light);line-height:1.4;}
.gc-best{position:absolute;top:10px;right:10px;font-size:9px;font-weight:900;color:var(--brown-light);}

.daily-chal {
  background:linear-gradient(135deg,var(--amber),var(--terra));
  border-radius:var(--r); padding:18px 22px; margin-bottom:20px;
  color:white; display:flex; align-items:center; justify-content:space-between;
  cursor:pointer; transition:transform 0.2s;
}
.daily-chal:hover{transform:translateY(-2px);}
.dc-info h3{font-size:15px;font-weight:900;margin-bottom:3px;}
.dc-info p{font-size:12px;opacity:0.9;}

.xp-card{background:var(--cream);border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow);margin-bottom:20px;}
.xp-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.xp-ttl{font-size:15px;font-weight:900;}
.xp-lvl{background:var(--terra);color:white;border-radius:99px;padding:4px 12px;font-size:11px;font-weight:900;}
.xp-bar{background:var(--sand);border-radius:99px;height:10px;margin-bottom:6px;}
.xp-fill{height:10px;border-radius:99px;background:linear-gradient(90deg,var(--terra),var(--amber));width:65%;}
.badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
.badge{background:var(--sand);border-radius:var(--rs);padding:8px 12px;text-align:center;}
.badge-lbl{font-size:9px;color:var(--brown-light);font-weight:700;margin-top:2px;}

/* source selector */
.src-tabs{display:flex;gap:10px;margin-bottom:16px;}
.src-tab{flex:1;padding:10px;border-radius:var(--rs);border:2px solid var(--sand-dark);background:var(--sand);font-family:var(--font);font-size:12px;font-weight:800;cursor:pointer;color:var(--brown);text-align:center;transition:all 0.2s;}
.src-tab.active{background:var(--terra);color:white;border-color:var(--terra);}

/* â”€â”€ FILL IN BLANK GAME â”€â”€ */
.game-header{background:var(--cream);padding:50px 20px 14px;border-bottom:2px solid var(--sand-dark);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:50;}
.game-body{flex:1;padding:20px 20px 110px;display:flex;flex-direction:column;gap:14px;}
.score-strip{display:flex;gap:8px;flex-wrap:wrap;}
.pill{border-radius:99px;padding:6px 14px;font-size:12px;font-weight:900;}
.pill-terra{background:var(--terra);color:white;}
.pill-amber{background:var(--amber);color:var(--brown);}
.pill-sage{background:var(--sage);color:white;}

.game-line-card{background:var(--cream);border-radius:var(--r);padding:22px;box-shadow:var(--shadow);font-size:18px;line-height:2;}
.blank{display:inline-block;min-width:80px;border-bottom:3px solid var(--terra);margin:0 3px;text-align:center;font-weight:900;color:var(--terra);padding:0 6px;}
.blank.filled-ok{color:var(--sage-dark);border-color:var(--sage);}
.blank.filled-bad{color:var(--terra-dark);animation:shake 0.3s;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

.word-opts{display:flex;flex-wrap:wrap;gap:10px;}
.wopt{
  background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;
  padding:8px 18px;font-family:var(--font);font-size:13px;font-weight:700;
  cursor:pointer;color:var(--brown);transition:all 0.2s;
}
.wopt:hover{background:var(--terra);color:white;border-color:var(--terra);}
.wopt:disabled{opacity:0.45;pointer-events:none;}

/* â”€â”€ SETTINGS â”€â”€ */
.set-sec{background:var(--cream);border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow);margin-bottom:14px;}
.set-sec h3{font-size:15px;font-weight:900;margin-bottom:14px;}
.set-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--sand);}
.set-row:last-child{border-bottom:none;}
.set-name{font-size:13px;font-weight:800;}
.set-desc{font-size:10px;color:var(--brown-light);margin-top:2px;}
.toggle{width:46px;height:24px;border-radius:99px;background:var(--sand-dark);position:relative;cursor:pointer;transition:background 0.2s;border:none;flex-shrink:0;}
.toggle.on{background:var(--sage);}
.toggle::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:white;top:3px;left:3px;transition:left 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.2);}
.toggle.on::after{left:25px;}
.fs-ctrl{display:flex;align-items:center;gap:10px;}
.fs-btn{background:var(--sand);border:2px solid var(--sand-dark);width:32px;height:32px;border-radius:99px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:var(--font);color:var(--brown);font-weight:900;}
.swatches{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.swatch{width:34px;height:34px;border-radius:99px;cursor:pointer;border:3px solid transparent;transition:border-color 0.2s;}
.swatch.active{border-color:var(--brown);}
.theme-card{background:var(--sand);border:3px solid var(--sand-dark);border-radius:var(--rs);padding:12px;cursor:pointer;transition:all 0.2s;}
.theme-card.active{border-color:var(--terra);background:rgba(193,97,79,0.08);}
.theme-card:hover{border-color:var(--terra-light);}

/* â”€â”€ HANDS-FREE / SCENE PARTNER / SPEED DRILL SCREENS â”€â”€ */
.hf-screen{background:var(--sand);min-height:100vh;display:none;flex-direction:column;}
.hf-screen.active{display:flex;}
.hf-header{background:var(--cream);padding:50px 20px 14px;border-bottom:2px solid var(--sand-dark);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:50;}
.hf-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;gap:20px;text-align:center;}
.hf-cue-card{background:var(--cream);border-radius:var(--r);padding:24px;box-shadow:var(--shadow-lg);width:100%;max-width:500px;}
.hf-cue-label{font-size:11px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.hf-cue-text{font-size:18px;font-weight:700;line-height:1.6;color:var(--brown);}
.hf-status{font-size:14px;font-weight:900;color:var(--brown-light);min-height:28px;}
.hf-big-btn{width:88px;height:88px;border-radius:50%;border:none;font-size:32px;cursor:pointer;box-shadow:var(--shadow-lg);transition:transform 0.1s;}
.hf-big-btn:active{transform:scale(0.94);}
.hf-big-btn.listening{background:var(--terra);animation:pulse 1s infinite;}
.hf-big-btn.idle{background:var(--sage);}
.hf-big-btn.speaking{background:var(--amber);}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(193,97,79,0.4)}50%{box-shadow:0 0 0 20px rgba(193,97,79,0)}}
.hf-result{border-radius:var(--rs);padding:12px 16px;font-size:14px;font-weight:800;width:100%;max-width:500px;}
.hf-result.good{background:rgba(39,174,96,0.15);color:#1a7a40;}
.hf-result.close{background:rgba(232,168,56,0.15);color:#a07010;}
.hf-result.wrong{background:rgba(193,97,79,0.12);color:var(--terra-dark);}
.hf-controls{display:flex;gap:12px;width:100%;max-width:500px;}
.sp-other-line{background:var(--sand-dark);border-radius:var(--rs);padding:14px 18px;font-size:15px;font-weight:700;line-height:1.6;color:var(--brown-light);font-style:italic;width:100%;max-width:500px;text-align:left;}
.sp-char-name{font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:1px;color:var(--brown-light);margin-bottom:4px;}

/* â”€â”€ SPEED DRILL â”€â”€ */
.sd-timer{font-size:72px;font-weight:900;color:var(--terra);font-family:monospace;line-height:1;}
.sd-best{font-size:12px;font-weight:800;color:var(--brown-light);}
.sd-line-card{background:var(--cream);border-radius:var(--r);padding:20px 22px;box-shadow:var(--shadow-lg);width:100%;max-width:500px;}
.sd-scene-tag{font-size:10px;font-weight:900;color:var(--sage-dark);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}

/* â”€â”€ PROGRESS DASHBOARD â”€â”€ */
.prog-dash{background:var(--sand);min-height:100vh;display:none;flex-direction:column;}
.prog-dash.active{display:flex;}
.scene-progress-bar{height:10px;background:var(--sand-dark);border-radius:99px;overflow:hidden;margin-top:6px;}
.scene-progress-fill{height:100%;border-radius:99px;background:var(--sage);transition:width 0.6s;}
.conf-pill{display:inline-block;border-radius:99px;padding:3px 10px;font-size:10px;font-weight:900;cursor:pointer;border:none;font-family:var(--font);}
.conf-shaky{background:rgba(193,97,79,0.15);color:var(--terra-dark);}
.conf-getting{background:rgba(232,168,56,0.15);color:#a07010;}
.conf-solid{background:rgba(122,158,126,0.15);color:var(--sage-dark);}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(74,55,40,0.55);z-index:300;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-sheet{background:var(--cream);border-radius:var(--r) var(--r) 0 0;padding:28px 22px 44px;width:100%;max-width:580px;animation:slideUp 0.3s ease;}
@keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-size:20px;font-weight:900;margin-bottom:20px;text-align:center;}
.timer-big{font-size:68px;font-weight:900;font-family:var(--display);text-align:center;color:var(--terra);margin:16px 0;letter-spacing:-2px;}
.timer-mode{text-align:center;font-size:13px;color:var(--brown-light);font-weight:700;margin-bottom:16px;}
.break-opts{display:flex;gap:10px;margin-bottom:18px;}
.break-opt{flex:1;padding:12px;border-radius:var(--rs);border:2px solid var(--sand-dark);background:var(--sand);font-family:var(--font);font-weight:900;font-size:13px;cursor:pointer;color:var(--brown);text-align:center;transition:all 0.2s;}
.break-opt.active{border-color:var(--sage);background:rgba(122,158,126,0.15);color:var(--sage-dark);}
.timer-ctrl-row{display:flex;gap:10px;}
.tcbtn{flex:1;padding:14px;border-radius:var(--rs);border:none;font-family:var(--font);font-weight:900;font-size:14px;cursor:pointer;}
.tcbtn-go{background:var(--terra);color:white;}
.tcbtn-stop{background:var(--sand);color:var(--brown);}

/* â”€â”€ DICT POPUP â”€â”€ */
.dict-pop{display:none;position:fixed;bottom:88px;left:16px;right:16px;background:var(--brown);color:white;border-radius:var(--r);padding:20px 22px;z-index:200;box-shadow:var(--shadow-lg);animation:slideUp 0.25s ease;}
.dict-pop.show{display:block;}
.dict-word{font-size:20px;font-weight:900;margin-bottom:3px;}
.dict-pron{font-size:12px;color:var(--amber-light);margin-bottom:8px;}
.dict-def{font-size:13px;line-height:1.6;}
.dict-close{position:absolute;top:10px;right:14px;background:none;border:none;color:white;font-size:22px;cursor:pointer;line-height:1;}
.dict-speak-btn{background:var(--terra);border:none;color:white;border-radius:99px;padding:6px 16px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;margin-top:10px;}

/* â”€â”€ TOAST & STREAK â”€â”€ */
.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-16px);background:var(--brown);color:white;padding:10px 22px;border-radius:99px;font-weight:900;font-size:13px;z-index:400;opacity:0;transition:all 0.3s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.streak-fx{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:80px;z-index:500;pointer-events:none;opacity:0;transition:all 0.4s;}
.streak-fx.pop{opacity:1;transform:translate(-50%,-65%);}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(min-width:600px){
  body{max-width:480px;margin:0 auto;}
  .bottom-nav,.modal-overlay{max-width:480px;left:50%;right:auto;width:480px;transform:translateX(-50%);}
  .dict-pop{left:calc(50% - 224px);right:auto;width:448px;}
  .toast{max-width:440px;}
}
</style>
</head>
<body>

<div class="toast" id="toast"></div>
<div class="streak-fx" id="streakFx">ğŸ”¥</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="homeScreen">
  <div class="app-header">
    <div class="logo">Esco<span>Mind</span></div>
    <button onclick="openTimer()" style="background:var(--sage);border:none;color:white;border-radius:99px;padding:8px 16px;font-family:var(--font);font-weight:800;font-size:12px;cursor:pointer;">â± Timer</button>
  </div>
  <div class="scroll-content">

    <div class="hero hero-terra" data-emoji="ğŸ­">
      <h2 id="heroGreeting">Welcome to EscoMind! ğŸ­</h2>
      <p id="heroSubtitle">Upload your first script to get started.</p>
      <div class="hero-stats">
        <div class="hstat"><div class="n" id="heroStreak">0ğŸ”¥</div><div class="l">Day Streak</div></div>
        <div class="hstat"><div class="n" id="heroXP">0</div><div class="l">XP Total</div></div>
        <div class="hstat"><div class="n" id="homeLinesLearned">0</div><div class="l">Lines Learned</div></div>
      </div>
    </div>

    <div class="section-title">My Productions</div>
    <div id="homeProductions">
      <div class="empty-state">
        <div class="es-icon">ğŸ­</div>
        <p>No productions yet.<br>Upload your first script to get started!</p>
        <br>
        <button class="btn btn-terra btn-sm" onclick="navTo('scriptScreen',1)" style="width:auto;padding:10px 24px;">Upload Script</button>
      </div>
    </div>

    <div class="section-title">Quick Actions</div>
    <div class="qa-grid">
      <button class="qa-btn" onclick="navTo('practiceScreen',2)"><div class="qa-icon">ğŸ“š</div><div class="qa-label">Practice Lines</div></button>
      <button class="qa-btn" onclick="navTo('gameScreen',3)"><div class="qa-icon">ğŸ®</div><div class="qa-label">Game Center</div></button>
      <button class="qa-btn" onclick="navTo('scriptScreen',1)"><div class="qa-icon">ğŸ“„</div><div class="qa-label">Scripts</div></button>
      <button class="qa-btn" onclick="openTimer()"><div class="qa-icon">â±</div><div class="qa-label">Study Timer</div></button>
    </div>

    <div class="xp-card">
      <div class="xp-hdr"><div class="xp-ttl" id="xpLevelLabel">Level 1 â€” Just Starting ğŸŒ±</div><div class="xp-lvl" id="xpTotal">0 XP</div></div>
      <div class="xp-bar"><div class="xp-fill" id="xpBar" style="width:0%"></div></div>
      <div style="font-size:11px;color:var(--brown-light);" id="xpNext">100 XP to Level 2</div>
      <div class="badges" id="homeBadges">
        <div style="font-size:12px;color:var(--brown-light);padding:8px 0;">Earn badges by practising and playing games! ğŸ…</div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="scriptScreen">
  <div class="app-header">
    <div class="logo">Esco<span>Mind</span></div>
    <div style="font-size:13px;font-weight:800;color:var(--brown-light);">Scripts</div>
  </div>
  <div class="scroll-content">

    <!-- IMPORT TABS -->
    <div class="section-title">Add Your Script</div>
    <div class="import-tabs">
      <button class="itab active" onclick="switchImportTab('upload',this)">ğŸ“‚ Upload</button>
      <button class="itab" onclick="switchImportTab('paste',this)">ğŸ“‹ Paste</button>
      <button class="itab" onclick="switchImportTab('manual',this)">âœï¸ Manual</button>
    </div>

    <!-- UPLOAD PANEL -->
    <div class="import-panel active" id="uploadPanel">
      <div class="import-zone" id="dropZone">
        <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.rtf" onchange="handleFileUpload(this)">
        <div class="iz-icon">ğŸ“‚</div>
        <div class="iz-title">Upload Your Script</div>
        <div class="iz-sub">
          Tap to choose a file â€” or drag and drop here<br>
          <strong>PDF Â· TXT Â· Word Doc Â· RTF</strong><br><br>
          ğŸ“± From your phone:<br>
          Files app Â· Google Drive Â· AirDrop Â· iCloud
        </div>
      </div>
      <div class="card" style="text-align:center;padding:16px;">
        <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--brown-light);">Or open from another app:</div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
          <div style="background:var(--sand);border-radius:var(--rs);padding:10px 16px;font-size:12px;font-weight:800;">ğŸ“± AirDrop</div>
          <div style="background:var(--sand);border-radius:var(--rs);padding:10px 16px;font-size:12px;font-weight:800;">ğŸ“ Files App</div>
          <div style="background:var(--sand);border-radius:var(--rs);padding:10px 16px;font-size:12px;font-weight:800;">ğŸ”µ Google Drive</div>
          <div style="background:var(--sand);border-radius:var(--rs);padding:10px 16px;font-size:12px;font-weight:800;">â˜ï¸ iCloud</div>
        </div>
        <div style="margin-top:12px;font-size:11px;color:var(--brown-light);">On iOS: open your script in any of these apps,<br>tap Share â†’ Open in EscoMind</div>
      </div>
    </div>

    <!-- PASTE PANEL -->
    <div class="import-panel" id="pastePanel">
      <div class="card">
        <div style="font-size:13px;font-weight:800;margin-bottom:10px;">Paste your script below:</div>
        <textarea class="paste-area" id="pasteArea" placeholder="Copy your script from Google Docs, Notes, email, or anywhere else â€” then paste it here.

EscoMind will automatically detect all the characters and find your lines.

Example format:
HAMLET
To be, or not to be â€” that is the question.

HORATIO
Good my lord."></textarea>
        <button class="btn btn-terra" style="margin-top:12px;" onclick="processScript('paste')">ğŸ” Analyse Script</button>
      </div>
    </div>

    <!-- MANUAL ENTRY PANEL -->
    <div class="import-panel" id="manualPanel">

      <div class="card" id="manualStep1">
        <div style="font-size:16px;font-weight:900;margin-bottom:6px;">âœï¸ Enter Lines Manually</div>
        <div style="font-size:13px;color:var(--brown-light);margin-bottom:16px;line-height:1.6;">
          Perfect for watermarked or locked PDFs like Universal scripts. Add one cue and one line at a time â€” do as many or as few as you like right now, and come back to add more later anytime!
        </div>
        <div style="font-size:13px;font-weight:800;margin-bottom:8px;">What's your character name?</div>
        <input class="char-input" id="manualCharName" type="text" placeholder="e.g. MILES">
        <button class="btn btn-terra" style="margin-top:10px;" onclick="startManualEntry()">Let's go â†’</button>
      </div>

      <div id="manualStep2" style="display:none;">

        <!-- Status banner -->
        <div class="card" style="background:linear-gradient(135deg,var(--terra),var(--rose));color:white;margin-bottom:14px;">
          <div style="font-size:14px;font-weight:900;margin-bottom:4px;">Adding lines for: <span id="manualCharDisplay"></span></div>
          <div style="font-size:12px;opacity:0.9;line-height:1.6;">
            <span id="manualLineCount">0</span> lines Â· 
            Scene: <span id="manualCurrentSceneName">Scene 1</span>
          </div>
        </div>

        <!-- Current scene indicator -->
        <div id="manualSceneBanner" style="background:var(--sage);color:white;border-radius:var(--rs);padding:10px 16px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-size:11px;font-weight:900;opacity:0.85;text-transform:uppercase;letter-spacing:1px;">Currently entering:</div>
            <div style="font-size:15px;font-weight:900;" id="manualSceneBannerName">Scene 1</div>
          </div>
          <button onclick="newScene()" style="background:rgba(255,255,255,0.25);border:none;color:white;border-radius:99px;padding:8px 16px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">
            + New Scene
          </button>
        </div>

        <!-- Line entry card -->
        <div class="card" style="margin-bottom:14px;">
          <div style="font-size:13px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">ğŸ“£ Cue â€” line just before yours:</div>
          <textarea class="paste-area" id="manualCueInput" style="min-height:70px;" placeholder="What does the other character say just before you speak?&#10;&#10;e.g. What do you think we should do?"></textarea>

          <div style="font-size:13px;font-weight:900;color:var(--terra);text-transform:uppercase;letter-spacing:1px;margin:14px 0 8px;">ğŸ­ Your line:</div>
          <textarea class="paste-area" id="manualLineInput" style="min-height:70px;border-color:var(--terra);" placeholder="Type your line exactly as it appears in the script.&#10;&#10;e.g. I think we need to talk to Marcus first."></textarea>

          <div style="display:flex;gap:10px;margin-top:12px;">
            <button class="btn btn-terra" style="flex:2;" onclick="addManualLine()">â• Add Line</button>
            <button class="btn btn-ghost" style="flex:1;" onclick="finishManualEntry()">âœ… Done</button>
          </div>
        </div>

        <!-- Lines added so far, grouped by scene -->
        <div id="manualLinesList" style="display:none;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <div class="section-title" style="font-size:14px;margin-bottom:0;">Lines Added ğŸ“‹</div>
            <button class="btn btn-sage btn-sm" onclick="finishManualEntry()">âœ… Save & Practise</button>
          </div>

          <!-- Scene filter tabs -->
          <div id="manualSceneTabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;"></div>

          <div id="manualLinesListInner"></div>
        </div>

      </div>
    </div>

    <!-- CHARACTER SETUP (shown after upload/paste) -->
    <div class="char-setup" id="charSetup">
      <h3>ğŸ­ Who are you playing?</h3>
      <div style="font-size:13px;color:var(--brown-light);margin-bottom:12px;">We found these characters in your script â€” tap yours, or type it below:</div>
      <div class="detected-chars" id="detectedChars"></div>
      <input class="char-input" id="myCharInput" type="text" placeholder="Or type your character name..." oninput="highlightTypedChar(this.value)">
      <button class="btn btn-terra" onclick="confirmCharacter()">âœ… That's me â€” Show My Lines</button>
    </div>

    <!-- SCENE SPLITTER (shown after character confirmed if user wants to split manually) -->
    <div id="sceneSplitterSection" style="display:none;">
      <div class="card" style="margin-bottom:14px;background:linear-gradient(135deg,var(--sage),var(--sage-dark));color:white;">
        <div style="font-size:15px;font-weight:900;margin-bottom:6px;">ğŸ“ Split into Scenes</div>
        <div style="font-size:12px;opacity:0.9;line-height:1.6;">Tap anywhere in your script below to drop a scene divider. Name each scene whatever makes sense to you. When you're done, tap <strong>Save Scenes</strong>.</div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
        <button class="btn btn-sage" style="flex:1;" onclick="saveSplitScenes()">âœ… Save Scenes</button>
        <button class="btn btn-ghost" style="flex:1;" onclick="skipSceneSplit()">Skip â€” No Scenes</button>
      </div>
      <div id="splitterScript" style="background:var(--cream);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);"></div>
    </div>

    <!-- READER TOOLBAR + SCRIPT VIEW -->
    <div id="readerSection" style="display:none;">
      <div class="reader-toolbar">
        <button class="tool-btn active" id="fontToggle" onclick="toggleFont(this)">OpenDyslexic</button>
        <button class="tool-btn" onclick="changeFontSize(1,this)">A+</button>
        <button class="tool-btn" onclick="changeFontSize(-1,this)">Aâˆ’</button>
        <button class="tool-btn" id="ttsToggle" onclick="readAloud()">ğŸ”Š Read</button>
        <button class="tool-btn" id="myLinesOnly" onclick="toggleMyLinesOnly(this)">My Lines Only</button>
      </div>
      <div class="script-reader show" id="scriptReader"></div>
    </div>

    <!-- PRODUCTIONS LIST -->
    <div id="productionsList" style="margin-top:20px;"></div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PRACTICE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="practiceScreen">
  <div class="app-header">
    <div class="logo">Esco<span>Mind</span></div>
    <div style="font-size:13px;font-weight:800;color:var(--brown-light);">Practice</div>
  </div>
  <div class="scroll-content">
    <div class="section-title">Choose Your Mode</div>
    <div id="practiceContent">
      <div class="empty-state">
        <div class="es-icon">ğŸ“š</div>
        <p>Upload a script first to start practising your lines!</p>
        <br>
        <button class="btn btn-terra btn-sm" onclick="navTo('scriptScreen',1)" style="width:auto;padding:10px 24px;">Upload Script</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CUE CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="cueScreen">
  <div class="cue-header">
    <button class="back-btn" onclick="navTo('practiceScreen',2)">â€¹</button>
    <div>
      <div style="font-size:17px;font-weight:900;" id="cueScreenTitle">Cue Cards</div>
      <div style="font-size:11px;color:var(--brown-light);" id="cueScreenSub">Loading...</div>
    </div>
  </div>
  <div class="cue-body">
    <div class="prog-wrap"><div class="prog-fill" id="cueProgBar" style="width:0%"></div></div>
    <div class="prog-label" id="cueProgLabel">Line 1 of 0</div>

    <div class="cue-box">
      <div class="cue-lbl">ğŸ¤ Cue line:
        <button onclick="speakCue()" style="float:right;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:3px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--brown);">ğŸ”Š Hear it</button>
      </div>
      <div class="cue-txt" id="cueTxt">Loading...</div>
    </div>

    <div class="myline-reveal" id="myLineReveal" onclick="revealMyLine()">
      <div class="reveal-hint" id="revealHint">ğŸ‘† Tap to reveal your line â€” or speak it below</div>
      <div class="reveal-txt" id="revealTxt"></div>
    </div>

    <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">ğŸ™ Speak Your Line</button>

    <div class="word-analysis" id="wordAnalysis"></div>
    <div class="result-banner" id="cueBanner"></div>
    <div class="feedback-row" id="feedbackRow" style="display:none;">
      <button class="fb-btn fb-wrong" onclick="nextCue('wrong')">âœ— Wrong</button>
      <button class="fb-btn fb-close" onclick="nextCue('close')">~ Close</button>
      <button class="fb-btn fb-right" onclick="nextCue('correct')">âœ“ Got it!</button>
    </div>
    <button class="next-btn" id="nextCueBtn" onclick="nextCue('correct')">Next Line â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAMES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="gameScreen">
  <div class="app-header">
    <div class="logo">Esco<span>Mind</span></div>
    <div style="font-size:13px;font-weight:800;color:var(--brown-light);">Game Center</div>
  </div>
  <div class="scroll-content">
    <div class="hero hero-brown" data-emoji="ğŸ®">
      <h2>Game Center ğŸ®</h2>
      <p>Learn your lines through play. Pick a game!</p>
    </div>

    <div class="daily-chal" onclick="startGame('fillblank')">
      <div class="dc-info"><h3>âš¡ Daily Challenge</h3><p>Today: Fill in the Blank Â· Your script</p></div>
      <div style="font-size:40px;">ğŸ†</div>
    </div>

    <div class="src-tabs">
      <button class="src-tab active" onclick="switchSrc('mine',this)">My Scripts</button>
      <button class="src-tab" onclick="switchSrc('sample',this)">Sample Scripts</button>
    </div>

    <div class="gc-grid">
      <div class="gc-card gc-1" onclick="startGame('fillblank')">
        <div class="gc-best">Best: 420</div>
        <div class="gc-icon">ğŸ“</div>
        <div class="gc-name">Fill in the Blank</div>
        <div class="gc-desc">Complete the missing word in your line</div>
      </div>
      <div class="gc-card gc-2" onclick="startGame('scramble')">
        <div class="gc-best">Best: 380</div>
        <div class="gc-icon">ğŸ”€</div>
        <div class="gc-name">Word Scramble</div>
        <div class="gc-desc">Put your jumbled line back in order</div>
      </div>
      <div class="gc-card gc-3" onclick="startGame('match')">
        <div class="gc-best">Best: 290</div>
        <div class="gc-icon">ğŸ§©</div>
        <div class="gc-name">Memory Match</div>
        <div class="gc-desc">Match the cue to the right line</div>
      </div>
      <div class="gc-card gc-4" onclick="startGame('clock')">
        <div class="gc-best">Best: 510</div>
        <div class="gc-icon">âš¡</div>
        <div class="gc-name">Beat the Clock</div>
        <div class="gc-desc">Race against the timer for big points</div>
      </div>
    </div>

    <div class="xp-card">
      <div class="xp-hdr"><div class="xp-ttl" id="gameXpLabel">Level 1 â€” Just Starting ğŸŒ±</div><div class="xp-lvl" id="gameXpTotal">0 XP</div></div>
      <div class="xp-bar"><div class="xp-fill" id="gameXpBar" style="width:0%"></div></div>
      <div style="font-size:11px;color:var(--brown-light);" id="gameXpNext">100 XP to Level 2</div>
      <div class="badges" id="gameBadges">
        <div style="font-size:12px;color:var(--brown-light);padding:8px 0;">Play games to earn badges! ğŸ…</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FILL IN BLANK GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="game-screen" id="fillBlankScreen">
  <div class="game-header">
    <button class="back-btn" onclick="navTo('gameScreen',3)">â€¹</button>
    <div style="flex:1;font-size:17px;font-weight:900;">Fill in the Blank ğŸ“</div>
    <select id="diffSel" onchange="setDiff(this.value)" style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 12px;font-family:var(--font);font-weight:700;color:var(--brown);font-size:11px;cursor:pointer;">
      <option value="easy">Easy</option>
      <option value="medium" selected>Medium</option>
      <option value="hard">Hard</option>
    </select>
  </div>
  <div class="game-body">
    <div class="score-strip">
      <div class="pill pill-terra">â­ <span id="gScore">0</span> pts</div>
      <div class="pill pill-amber">ğŸ”¥ <span id="gStreak">0</span></div>
      <div class="pill pill-sage">â± <span id="gTimer">60</span>s</div>
    </div>
    <div class="prog-wrap"><div class="prog-fill" id="gameProgBar" style="width:0%"></div></div>
    <div class="game-line-card" id="gameLineCard"></div>
    <div>
      <div style="font-size:12px;font-weight:900;color:var(--brown-light);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;">Choose the missing word:</div>
      <div class="word-opts" id="wordOpts"></div>
    </div>
    <div class="result-banner" id="gameBanner"></div>
    <button class="next-btn" id="gameNextBtn" onclick="nextGameQ()" style="display:none;">Next Line â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="settingsScreen">
  <div class="app-header">
    <div class="logo">Esco<span>Mind</span></div>
    <div style="font-size:13px;font-weight:800;color:var(--brown-light);">Settings</div>
  </div>
  <div class="scroll-content">
    <div class="set-sec">
      <h3>ğŸ”¤ Text & Display</h3>
      <div class="set-row">
        <div><div class="set-name">OpenDyslexic Font</div><div class="set-desc">Dyslexia-friendly font everywhere</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="set-row">
        <div class="set-name">Font Size</div>
        <div class="fs-ctrl">
          <button class="fs-btn" onclick="globalFontSize(-1)">âˆ’</button>
          <div style="font-weight:900;min-width:28px;text-align:center;" id="globalFsDisplay">16</div>
          <button class="fs-btn" onclick="globalFontSize(1)">+</button>
        </div>
      </div>
      <div class="set-row">
        <div><div class="set-name">Extra Line Spacing</div><div class="set-desc">More breathing room between lines</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="set-row">
        <div><div class="set-name">Text-to-Speech</div><div class="set-desc">Read lines aloud as you study</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
    </div>

    <div class="set-sec">
      <h3>ğŸ¨ Creative Themes</h3>
      <div style="font-size:12px;color:var(--brown-light);margin-bottom:12px;">Pick a full theme â€” changes background, buttons and accent colours:</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;" id="themeGrid">
        <div class="theme-card active" onclick="applyTheme('sand',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#F5ECD7;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#C1614F;"></div><div style="width:18px;height:18px;border-radius:50%;background:#7A9E7E;"></div></div>
          <div style="font-size:12px;font-weight:900;">Warm Sand</div><div style="font-size:10px;color:var(--brown-light);">Original â€” easy on the eyes</div>
        </div>
        <div class="theme-card" onclick="applyTheme('night',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#1A1A2E;border:2px solid #444;"></div><div style="width:18px;height:18px;border-radius:50%;background:#E94560;"></div><div style="width:18px;height:18px;border-radius:50%;background:#0F3460;"></div></div>
          <div style="font-size:12px;font-weight:900;">Night Mode ğŸŒ™</div><div style="font-size:10px;color:var(--brown-light);">Dark â€” late night rehearsals</div>
        </div>
        <div class="theme-card" onclick="applyTheme('ocean',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#E8F4FD;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#2980B9;"></div><div style="width:18px;height:18px;border-radius:50%;background:#1ABC9C;"></div></div>
          <div style="font-size:12px;font-weight:900;">Ocean ğŸŒŠ</div><div style="font-size:10px;color:var(--brown-light);">Cool blue and teal</div>
        </div>
        <div class="theme-card" onclick="applyTheme('sunset',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#FFF0E6;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#E67E22;"></div><div style="width:18px;height:18px;border-radius:50%;background:#C0392B;"></div></div>
          <div style="font-size:12px;font-weight:900;">Sunset ğŸŒ…</div><div style="font-size:10px;color:var(--brown-light);">Warm orange and red</div>
        </div>
        <div class="theme-card" onclick="applyTheme('lavender',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#F5F0FF;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#8E44AD;"></div><div style="width:18px;height:18px;border-radius:50%;background:#3498DB;"></div></div>
          <div style="font-size:12px;font-weight:900;">Lavender ğŸ’œ</div><div style="font-size:10px;color:var(--brown-light);">Purple and blue calm</div>
        </div>
        <div class="theme-card" onclick="applyTheme('forest',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#EAF5EA;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#27AE60;"></div><div style="width:18px;height:18px;border-radius:50%;background:#F39C12;"></div></div>
          <div style="font-size:12px;font-weight:900;">Forest ğŸŒ¿</div><div style="font-size:10px;color:var(--brown-light);">Green and gold nature</div>
        </div>
        <div class="theme-card" onclick="applyTheme('rose',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#FFF0F5;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#E91E8C;"></div><div style="width:18px;height:18px;border-radius:50%;background:#9B59B6;"></div></div>
          <div style="font-size:12px;font-weight:900;">Rose Gold ğŸŒ¸</div><div style="font-size:10px;color:var(--brown-light);">Pink and purple glam</div>
        </div>
        <div class="theme-card" onclick="applyTheme('slate',this)">
          <div style="display:flex;gap:6px;margin-bottom:6px;"><div style="width:18px;height:18px;border-radius:50%;background:#ECF0F1;border:2px solid #ccc;"></div><div style="width:18px;height:18px;border-radius:50%;background:#2C3E50;"></div><div style="width:18px;height:18px;border-radius:50%;background:#E74C3C;"></div></div>
          <div style="font-size:12px;font-weight:900;">Slate âš¡</div><div style="font-size:10px;color:var(--brown-light);">Clean monochrome</div>
        </div>
      </div>
    </div>

    <div class="set-sec">
      <h3>â± Study Timer</h3>
      <div class="set-row">
        <div class="set-name">Session Length</div>
        <div style="font-weight:900;color:var(--terra);">20 min</div>
      </div>
      <div class="set-row">
        <div class="set-name">Break Length</div>
        <div style="display:flex;gap:8px;">
          <button class="tool-btn active" id="break5Btn" onclick="setBreakLen(5)">5 min</button>
          <button class="tool-btn" id="break10Btn" onclick="setBreakLen(10)">10 min</button>
        </div>
      </div>
    </div>

    <div class="set-sec">
      <h3>ğŸ™ Line Checking</h3>
      <div class="set-row">
        <div><div class="set-name">Word-Perfect Mode</div><div class="set-desc">Every word must match exactly</div></div>
        <button class="toggle on" id="wordPerfectToggle" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="set-row">
        <div><div class="set-name">Voice Input</div><div class="set-desc">Speak your lines for checking</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
    </div>

    <div class="set-sec">
      <h3>ğŸ”” Notifications</h3>
      <div class="set-row">
        <div><div class="set-name">Daily Reminder</div><div class="set-desc">Remind me to practise each day</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
      <div class="set-row">
        <div><div class="set-name">Streak Alerts</div><div class="set-desc">Don't let me break my streak!</div></div>
        <button class="toggle on" onclick="this.classList.toggle('on')"></button>
      </div>
    </div>

    <div class="set-sec">
      <h3>â˜ï¸ Sync Across Devices</h3>
      <p style="font-size:12px;color:var(--brown-light);margin-bottom:14px;line-height:1.6;">
        Set this up once and your lines, scenes and progress will automatically appear on your phone, computer and tablet.
      </p>
      <div id="syncSetupArea">
        <div style="text-align:center;padding:10px;color:var(--brown-light);font-size:13px;">Loading sync status...</div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HANDS-FREE MODE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="hf-screen" id="handsFreeScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="stopHandsFree()">â€¹</button>
    <div>
      <div style="font-size:17px;font-weight:900;">ğŸ”Š Hands-Free Mode</div>
      <div style="font-size:11px;color:var(--brown-light);" id="hfProgress">Line 1 of 0</div>
    </div>
    <button onclick="toggleHFPause()" id="hfPauseBtn" style="margin-left:auto;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">â¸ Pause</button>
  </div>
  <div class="hf-body">
    <div class="hf-cue-card">
      <div class="hf-cue-label">ğŸ¤ Cue â€” listen and respond:</div>
      <div class="hf-cue-text" id="hfCueText">Ready to begin...</div>
    </div>
    <div class="hf-status" id="hfStatus">Tap the mic to start</div>
    <button class="hf-big-btn idle" id="hfMicBtn" onclick="hfMicTap()">ğŸ™</button>
    <div class="hf-result" id="hfResult" style="display:none;"></div>
    <div style="display:flex;gap:10px;width:100%;max-width:500px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="hfNext('wrong')">âœ— Wrong</button>
      <button class="btn btn-sage" style="flex:2;" onclick="hfNext('correct')">âœ“ Got it â€” Next</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCENE PARTNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="hf-screen" id="scenePartnerScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="stopScenePartner()">â€¹</button>
    <div>
      <div style="font-size:17px;font-weight:900;">ğŸ­ Scene Partner</div>
      <div style="font-size:11px;color:var(--brown-light);" id="spProgress">Line 1 of 0</div>
    </div>
    <button onclick="toggleSPPause()" id="spPauseBtn" style="margin-left:auto;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:6px 14px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">â¸ Pause</button>
  </div>
  <div class="hf-body">
    <div id="spOtherCard" class="sp-other-line" style="display:none;">
      <div class="sp-char-name" id="spOtherChar">OTHER CHARACTER</div>
      <div id="spOtherText">...</div>
    </div>
    <div class="hf-cue-card" id="spMyCard" style="display:none;">
      <div class="hf-cue-label" id="spMyChar">YOUR LINE</div>
      <div class="hf-cue-text" id="spMyText">...</div>
    </div>
    <div class="hf-status" id="spStatus">App will read all other lines aloud. You speak yours.</div>
    <button class="hf-big-btn idle" id="spMicBtn" onclick="spMicTap()" style="display:none;">ğŸ™</button>
    <div class="hf-result" id="spResult" style="display:none;"></div>
    <button class="btn btn-terra" id="spStartBtn" onclick="spStart()" style="width:100%;max-width:500px;">â–¶ Start Scene</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SPEED DRILL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="hf-screen" id="speedDrillScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="stopSpeedDrill()">â€¹</button>
    <div>
      <div style="font-size:17px;font-weight:900;">âš¡ Speed Drill</div>
      <div style="font-size:11px;color:var(--brown-light);" id="sdProgress">Line 1 of 0</div>
    </div>
  </div>
  <div class="hf-body">
    <div class="sd-timer" id="sdTimer">0.0s</div>
    <div class="sd-best" id="sdBest">Best time: --</div>
    <div class="sd-line-card">
      <div class="sd-scene-tag" id="sdSceneTag">Scene 1</div>
      <div class="hf-cue-label">Cue:</div>
      <div style="font-size:14px;color:var(--brown-light);font-style:italic;margin-bottom:10px;" id="sdCueText">...</div>
      <div class="hf-cue-label" style="color:var(--terra);">Your line:</div>
      <div style="font-size:16px;font-weight:700;line-height:1.6;" id="sdLineText">...</div>
    </div>
    <div style="display:flex;gap:10px;width:100%;max-width:500px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="sdMark('wrong')">âœ— Stumbled</button>
      <button class="btn btn-terra" style="flex:2;" onclick="sdMark('correct')">âœ“ Got it!</button>
    </div>
    <div id="sdFinished" style="display:none;width:100%;max-width:500px;text-align:center;">
      <div style="font-size:18px;font-weight:900;margin-bottom:8px;">Run complete! ğŸ‰</div>
      <div style="font-size:14px;color:var(--brown-light);margin-bottom:16px;" id="sdFinishStats"></div>
      <button class="btn btn-terra" onclick="startSpeedDrill()">Run Again âš¡</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROGRESS DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="prog-dash" id="progressDashScreen">
  <div class="hf-header">
    <button class="back-btn" onclick="hideProgressDashboard()">â€¹</button>
    <div>
      <div style="font-size:17px;font-weight:900;">ğŸ“Š Progress Dashboard</div>
      <div style="font-size:11px;color:var(--brown-light);" id="dashSubtitle">Your lines at a glance</div>
    </div>
  </div>
  <div class="scroll-content" id="dashContent"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAKRA SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="chakraScreen">
  <!-- Home view -->
  <div id="chakraHome">
    <div class="app-header">
      <div class="logo">Esco<span>Mind</span></div>
      <div style="font-size:13px;font-weight:800;color:var(--brown-light);">Character Chakras ğŸ”®</div>
    </div>
    <div class="scroll-content">
      <div class="hero hero-brown" data-emoji="ğŸ”®">
        <h2>Character Chakras</h2>
        <p>Map your character's energy system to deepen your embodiment</p>
      </div>
      <!-- Saved profiles -->
      <div id="chakraSavedProfiles" style="margin-bottom:16px;"></div>
      <!-- New profile -->
      <div class="card">
        <div style="font-size:14px;font-weight:900;margin-bottom:10px;">+ New Character Profile</div>
        <div id="chakraCharList" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;"></div>
        <div style="font-size:11px;color:var(--brown-light);margin-bottom:8px;">Select from your scripts above, or type a new character name:</div>
        <input class="char-input" id="chakraCharInput" placeholder="Character name..." oninput="chakraCharTyped(this.value)">
        <div id="chakraStartBtns" style="display:none;margin-top:12px;">
          <div style="font-size:13px;font-weight:900;color:var(--brown);margin-bottom:10px;" id="chakraCharTitle"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <button class="btn btn-terra" onclick="startChakraQuiz()">ğŸ§  Character Quiz</button>
            <button class="btn btn-sage" onclick="startChakraManual()">ğŸ› Manual Mode</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz view -->
  <div id="chakraQuizView" style="display:none;">
    <div class="app-header">
      <button class="back-btn" onclick="chakraGoHome()">â€¹</button>
      <div>
        <div style="font-size:17px;font-weight:900;">Character Quiz</div>
        <div style="font-size:11px;color:var(--brown-light);" id="chakraQuizProgress">Question 1 of 35</div>
      </div>
    </div>
    <div class="scroll-content">
      <div id="chakraQuizArea"></div>
    </div>
  </div>

  <!-- Results view -->
  <div id="chakraResultView" style="display:none;">
    <div class="app-header">
      <button class="back-btn" onclick="chakraGoHome()">â€¹</button>
      <div style="flex:1;">
        <div style="font-size:17px;font-weight:900;" id="chakraResultTitle">Chakra Profile</div>
        <div style="font-size:11px;color:var(--brown-light);">Tap any chakra to change its state</div>
      </div>
      <button onclick="printChakraProfile()" style="background:var(--terra);color:white;border:none;border-radius:99px;padding:6px 14px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);">ğŸ–¨ Print</button>
    </div>
    <div class="scroll-content">
      <div id="chakraResultArea"></div>
      <div style="height:20px;"></div>
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <button class="nav-btn active" id="nav0" onclick="navTo('homeScreen',0)"><div class="ni">ğŸ </div>Home</button>
  <button class="nav-btn" id="nav1" onclick="navTo('scriptScreen',1)"><div class="ni">ğŸ“„</div>Scripts</button>
  <button class="nav-btn" id="nav2" onclick="navTo('practiceScreen',2)"><div class="ni">ğŸ“š</div>Practice</button>
  <button class="nav-btn" id="nav3" onclick="navTo('gameScreen',3)"><div class="ni">ğŸ®</div>Games</button>
  <button class="nav-btn" id="nav4" onclick="toggleMoreMenu()"><div class="ni">â˜°</div>More</button>
</nav>

<!-- More dropdown menu -->
<div id="moreMenu" style="display:none;position:fixed;bottom:68px;left:0;right:0;background:var(--cream);border-top:2px solid var(--sand-dark);z-index:150;box-shadow:0 -4px 20px rgba(74,55,40,0.15);padding:12px 16px;">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
    <button onclick="closeMoreMenu();navTo('chakraScreen',4);" style="background:linear-gradient(135deg,#7B1FA2,#512DA8);color:white;border:none;border-radius:var(--r);padding:16px;font-family:var(--font);font-size:13px;font-weight:900;cursor:pointer;text-align:center;">
      <div style="font-size:28px;margin-bottom:4px;">ğŸ”®</div>Chakras
    </button>
    <button onclick="closeMoreMenu();navTo('settingsScreen',5);" style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:var(--r);padding:16px;font-family:var(--font);font-size:13px;font-weight:900;cursor:pointer;color:var(--brown);text-align:center;">
      <div style="font-size:28px;margin-bottom:4px;">âš™ï¸</div>Settings
    </button>
  </div>
  <button onclick="closeMoreMenu()" style="width:100%;margin-top:10px;background:none;border:none;font-family:var(--font);font-size:12px;font-weight:900;color:var(--brown-light);padding:8px;cursor:pointer;">âœ• Close</button>
</div>
<div id="moreMenuOverlay" style="display:none;position:fixed;inset:0;z-index:140;" onclick="closeMoreMenu()"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TIMER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="timerModal">
  <div class="modal-sheet">
    <div class="modal-title">â± Study Timer</div>
    <div class="timer-mode" id="timerModeLabel">20 min focus session</div>
    <div class="timer-big" id="timerDisplay">20:00</div>
    <div style="font-size:12px;font-weight:900;margin-bottom:8px;color:var(--brown-light);">Break length:</div>
    <div class="break-opts">
      <div class="break-opt active" id="bo5" onclick="selectBreak(5)">5 minutes</div>
      <div class="break-opt" id="bo10" onclick="selectBreak(10)">10 minutes</div>
    </div>
    <div class="timer-ctrl-row">
      <button class="tcbtn tcbtn-go" id="timerToggleBtn" onclick="toggleTimer()">â–¶ Start</button>
      <button class="tcbtn tcbtn-stop" onclick="closeTimer()">Close</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DICTIONARY POPUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="dict-pop" id="dictPop">
  <button class="dict-close" onclick="closeDict()">Ã—</button>
  <div class="dict-word" id="dpWord"></div>
  <div class="dict-pron" id="dpPron"></div>
  <div class="dict-def" id="dpDef"></div>
  <button class="dict-speak-btn" onclick="speakDictWord()">ğŸ”Š Hear it</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let productions = [];
let activeProduction = null;
let scriptFontSize = 16;
let globalFs = 16;
let cueIndex = 0;
let cuePairs = [];
let lineShown = false;
let voiceActive = false;
let timerSecs = 1200;
let timerRunning = false;
let timerInterval = null;
let breakLen = 5;
let isBreak = false;
let gameScore = 0;
let gameStreak = 0;
let gameTimerSecs = 60;
let gameTimerInt = null;
let gameQIndex = 0;
let gameQuestions = [];
let rawScriptText = '';
let myLinesOnlyMode = false;

// Real tracking
let totalXP = 0;
let dayStreak = 0;
let earnedBadges = [];
let linesCorrectToday = 0;
let lastPlayDate = null;

const levels = [
  {min:0,    label:'Just Starting ğŸŒ±',  next:100},
  {min:100,  label:'Line Reader ğŸ“–',     next:300},
  {min:300,  label:'Getting Warmer ğŸ”†',  next:600},
  {min:600,  label:'Rising Actor ğŸ­',    next:1000},
  {min:1000, label:'Stage Ready â­',     next:1500},
  {min:1500, label:'Scene Stealer ğŸŒŸ',   next:2200},
  {min:2200, label:'Lead Role ğŸ†',       next:3000},
  {min:3000, label:'West End Star ğŸ¬',   next:99999},
];

function getCurrentLevel() {
  for(let i=levels.length-1;i>=0;i--) { if(totalXP>=levels[i].min) return {...levels[i],index:i}; }
  return {...levels[0],index:0};
}

function addXP(pts) {
  const before = getCurrentLevel();
  totalXP += pts;
  linesCorrectToday++;
  const after = getCurrentLevel();
  showToast(`+${pts} XP â­`);
  if(after.index > before.index) {
    setTimeout(()=>showToast(`ğŸ‰ Level up! You're now: ${after.label}`), 800);
  }
  checkBadges();
  updateXPDisplays();
}

function updateXPDisplays() {
  const lvl = getCurrentLevel();
  const pct = lvl.next < 99999 ? Math.min(100,((totalXP-lvl.min)/(lvl.next-lvl.min))*100) : 100;
  document.getElementById('heroXP').textContent = totalXP;
  document.getElementById('heroStreak').textContent = dayStreak+'ğŸ”¥';
  document.getElementById('xpLevelLabel').textContent = `Level ${lvl.index+1} â€” ${lvl.label}`;
  document.getElementById('xpTotal').textContent = totalXP+' XP';
  document.getElementById('xpBar').style.width = pct+'%';
  document.getElementById('xpNext').textContent = lvl.next < 99999 ? `${lvl.next-totalXP} XP to next level` : 'Max level reached! ğŸ†';
  document.getElementById('gameXpLabel').textContent = `Level ${lvl.index+1} â€” ${lvl.label}`;
  document.getElementById('gameXpTotal').textContent = totalXP+' XP';
  document.getElementById('gameXpBar').style.width = pct+'%';
  document.getElementById('gameXpNext').textContent = lvl.next < 99999 ? `${lvl.next-totalXP} XP to next level` : 'Max level reached! ğŸ†';
  updateBadgeDisplay();
}

function checkBadges() {
  const checks = [
    {id:'first_line', icon:'ğŸ­', label:'First Line',  cond:()=>linesCorrectToday>=1},
    {id:'ten_lines',  icon:'ğŸ“š', label:'10 Lines',    cond:()=>totalXP>=100},
    {id:'streak3',    icon:'ğŸ”¥', label:'3 Day Streak',cond:()=>dayStreak>=3},
    {id:'gamer',      icon:'ğŸ®', label:'Gamer',       cond:()=>gameScore>=100},
    {id:'star',       icon:'â­', label:'Rising Star', cond:()=>totalXP>=300},
    {id:'champ',      icon:'ğŸ†', label:'Champion',    cond:()=>totalXP>=1000},
  ];
  checks.forEach(b => {
    if(!earnedBadges.includes(b.id) && b.cond()) {
      earnedBadges.push(b.id);
      setTimeout(()=>showToast(`ğŸ… Badge earned: ${b.icon} ${b.label}!`), 1200);
    }
  });
}

function updateBadgeDisplay() {
  const allBadges = [
    {id:'first_line',icon:'ğŸ­',label:'First Line'},
    {id:'ten_lines', icon:'ğŸ“š',label:'10 Lines'},
    {id:'streak3',   icon:'ğŸ”¥',label:'3 Streak'},
    {id:'gamer',     icon:'ğŸ®',label:'Gamer'},
    {id:'star',      icon:'â­',label:'Rising Star'},
    {id:'champ',     icon:'ğŸ†',label:'Champion'},
  ];
  const earned = allBadges.filter(b=>earnedBadges.includes(b.id));
  const html = earned.length > 0
    ? earned.map(b=>`<div class="badge">${b.icon}<div class="badge-lbl">${b.label}</div></div>`).join('')
    : '<div style="font-size:12px;color:var(--brown-light);padding:8px 0;">Earn badges by practising! ğŸ…</div>';
  document.getElementById('homeBadges').innerHTML = html;
  document.getElementById('gameBadges').innerHTML = html;
}

function updateDayStreak() {
  const today = new Date().toDateString();
  if(lastPlayDate === today) return;
  const yesterday = new Date(Date.now()-86400000).toDateString();
  if(lastPlayDate === yesterday) dayStreak++;
  else if(lastPlayDate !== today) dayStreak = 1;
  lastPlayDate = today;
  document.getElementById('heroGreeting').textContent = dayStreak > 1 ? `Day ${dayStreak} â€” keep it up! ğŸ­` : 'Welcome to EscoMind! ğŸ­';
  document.getElementById('heroSubtitle').textContent = dayStreak > 1 ? `You're on a ${dayStreak}-day streak â€” amazing!` : productions.length > 0 ? 'Choose a mode and practise your lines.' : 'Upload your first script to get started.';
  updateXPDisplays();
}

// Sample script for when no user script loaded
const sampleScript = `FAIRY
How now, spirit! Whither wander you?

PUCK
Over hill, over dale, thorough bush, thorough brier, over park, over pale, thorough flood, thorough fire.

FAIRY
Either I mistake your shape and making quite, or else you are that shrewd and knavish sprite called Robin Goodfellow.

PUCK
Thou speak'st aright; I am that merry wanderer of the night.

FAIRY
The king doth keep his revels here tonight.

PUCK
I must go seek some dewdrops here and hang a pearl in every cowslip's ear.

FAIRY
Farewell, thou lob of spirits; I'll be gone.

PUCK
Our queen and all our elves come here anon.

FAIRY
How long within this wood intend you stay?

PUCK
Perchance till after Theseus' wedding-day.`;

// Dictionary
const dict = {
  whither:{pron:'/ËˆwÉªÃ°É™r/',def:'To what place; where are you going? (archaic)'},
  dale:{pron:'/deÉªl/',def:'A broad open valley, especially in northern England.'},
  brier:{pron:'/ËˆbraÉªÉ™r/',def:'A prickly shrub such as wild rose or bramble.'},
  knavish:{pron:'/ËˆneÉªvÉªÊƒ/',def:'Dishonest and unscrupulous; rogue-like.'},
  sprite:{pron:'/spraÉªt/',def:'A fairy or elf; a nimble supernatural being.'},
  cowslip:{pron:'/ËˆkaÊŠslÉªp/',def:'A yellow wildflower common in European meadows.'},
  wanderer:{pron:'/ËˆwÉ’ndÉ™rÉ™r/',def:'One who roams freely with no fixed destination.'},
  revels:{pron:'/ËˆrÉ›vÉ™lz/',def:'Lively and noisy festivities or celebrations.'},
  mortals:{pron:'/ËˆmÉ”ËtÉ™lz/',def:'Human beings, as distinct from gods or spirits.'},
  perchance:{pron:'/pÉ™ËˆtÊƒÉ‘Ëns/',def:'Perhaps; possibly (archaic or poetic).'},
  thorough:{pron:'/ËˆÎ¸ÊŒrÉ™/',def:'Passing through; by way of (archaic use in verse).'},
  anon:{pron:'/É™ËˆnÉ’n/',def:'Shortly; soon; before long (archaic).'},
  theseus:{pron:'/ËˆÎ¸iËsÉªÉ™s/',def:'A legendary king of Athens in Greek mythology.'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const screenIds = ['homeScreen','scriptScreen','practiceScreen','gameScreen','settingsScreen','chakraScreen'];

function navTo(id, navIdx) {
  screenIds.forEach(s => {
    const el = document.getElementById(s);
    if(el) el.classList.remove('active');
  });
  document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
  const target = document.getElementById(id);
  if(target) target.classList.add('active');
  if(navIdx !== undefined) {
    document.querySelectorAll('.nav-btn').forEach((b,i) => b.classList.toggle('active', i===navIdx));
  }
  window.scrollTo(0,0);
  if(id === 'practiceScreen') refreshPracticeScreen();
  if(id === 'homeScreen') refreshHome();
  if(id === 'chakraScreen') refreshChakraScreen();
}

function goToGameScreen(id) {
  screenIds.forEach(s => { const el=document.getElementById(s); if(el) el.classList.remove('active'); });
  document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCRIPT IMPORT â€” TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchImportTab(tab, btn) {
  document.querySelectorAll('.itab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('uploadPanel').classList.toggle('active', tab==='upload');
  document.getElementById('pastePanel').classList.toggle('active', tab==='paste');
  document.getElementById('manualPanel').classList.toggle('active', tab==='manual');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleFileUpload(input) {
  const file = input.files[0];
  if(!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  if(ext === 'pdf') {
    showToast('PDF detected â€” extracting text... ğŸ“„');
    // For PDF: read as text (works for text-layer PDFs)
    const reader = new FileReader();
    reader.onload = function(e) {
      // Try to extract readable text from PDF binary
      const binary = e.target.result;
      const text = extractTextFromPDF(binary, file.name);
      if(text.trim().length > 50) {
        rawScriptText = text;
        processScript('file');
      } else {
        showToast('PDF is image-based â€” please copy & paste the text instead ğŸ“‹');
        document.querySelectorAll('.itab')[1].click();
      }
    };
    reader.readAsBinaryString(file);
  } else {
    const reader = new FileReader();
    reader.onload = function(e) {
      rawScriptText = e.target.result;
      processScript('file');
    };
    reader.readAsText(file);
  }
  showToast(`Loading: ${file.name} ğŸ“‚`);
}

function extractTextFromPDF(binary, filename) {
  // Simple text extraction from PDF text layer
  try {
    let text = '';
    const matches = binary.match(/BT[\s\S]*?ET/g) || [];
    matches.forEach(block => {
      const strings = block.match(/\(([^)]+)\)/g) || [];
      strings.forEach(s => {
        text += s.slice(1,-1).replace(/\\n/g,'\n').replace(/\\/g,'') + ' ';
      });
    });
    if(text.trim().length < 30) {
      // Try another method - look for readable text
      const readable = binary.match(/[A-Z][A-Z\s]{2,}\n[\s\S]{10,200}(?=\n[A-Z])/g) || [];
      text = readable.join('\n\n');
    }
    return text.trim();
  } catch(e) { return ''; }
}

// Drag and drop
const dropZone = document.getElementById('dropZone');
if(dropZone) {
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if(file) {
      const fakeInput = { files: [file] };
      handleFileUpload(fakeInput);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCRIPT PROCESSING â€” THE BRAIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processScript(source) {
  let text = '';
  if(source === 'paste') {
    text = document.getElementById('pasteArea').value.trim();
    if(!text) { showToast('Please paste your script text first! ğŸ“‹'); return; }
  } else {
    text = rawScriptText;
  }
  if(text.length < 20) { showToast('Script seems too short â€” please try again'); return; }
  rawScriptText = text;

  // Detect characters
  const chars = detectCharacters(text);
  showCharacterSetup(chars);
  showToast(`Script loaded! Found ${chars.length} characters ğŸ­`);
}

function detectCharacters(text) {
  const lines = text.split('\n');
  const charCounts = {};
  // Patterns: ALL CAPS lines, or "CharName:" pattern
  lines.forEach(line => {
    const trimmed = line.trim();
    // ALL CAPS word(s) on their own line (2-30 chars)
    if(/^[A-Z][A-Z\s\.]{1,28}$/.test(trimmed) && trimmed.length >= 2 && !trimmed.includes('ACT') && !trimmed.includes('SCENE') && !trimmed.includes('INT.') && !trimmed.includes('EXT.')) {
      const name = trimmed.trim();
      charCounts[name] = (charCounts[name]||0) + 1;
    }
    // "NAME:" pattern
    const colonMatch = trimmed.match(/^([A-Z][A-Z\s]{1,20}):/);
    if(colonMatch) {
      const name = colonMatch[1].trim();
      charCounts[name] = (charCounts[name]||0) + 1;
    }
  });
  // Return chars that appear at least once, sorted by frequency
  return Object.entries(charCounts)
    .filter(([,count]) => count >= 1)
    .sort((a,b) => b[1]-a[1])
    .map(([name]) => name)
    .slice(0,12);
}

function showCharacterSetup(chars) {
  const setup = document.getElementById('charSetup');
  const pills = document.getElementById('detectedChars');
  setup.classList.add('show');
  if(chars.length === 0) {
    pills.innerHTML = '<div style="font-size:13px;color:var(--brown-light);">No characters auto-detected â€” type your character name below</div>';
    return;
  }
  pills.innerHTML = chars.map(c =>
    `<div class="char-pill" onclick="selectCharPill(this,'${c}')">${c}</div>`
  ).join('');
}

function selectCharPill(el, name) {
  document.querySelectorAll('.char-pill').forEach(p => p.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('myCharInput').value = name;
}

function highlightTypedChar(val) {
  const upper = val.toUpperCase();
  document.querySelectorAll('.char-pill').forEach(p => {
    p.classList.toggle('selected', p.textContent === upper);
  });
}

function confirmCharacter() {
  const name = (document.getElementById('myCharInput').value || '').trim().toUpperCase();
  if(!name) { showToast('Please choose or type your character name ğŸ­'); return; }
  // Hide character setup
  document.getElementById('charSetup').classList.remove('show');
  document.getElementById('charSetup').style.display = 'none';
  // Show scene splitter
  showSceneSplitter(rawScriptText, name);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCENE SPLITTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let splitterParsed = [];
let splitterMyChar = '';
let splitterDividers = []; // [{afterIdx, name}]

function showSceneSplitter(text, myChar) {
  splitterMyChar = myChar;
  splitterDividers = [];

  // Quick parse to get blocks
  const lines = text.split('\n');
  splitterParsed = [];
  let currentChar = null, currentText = [];
  function flush() {
    if(currentChar && currentText.length > 0) {
      const t = currentText.join(' ').replace(/\s+/g,' ').trim();
      if(t) splitterParsed.push({ char: currentChar, text: t, mine: currentChar === myChar });
      currentText = [];
    }
  }
  lines.forEach(function(line) {
    const trimmed = line.trim();
    if(!trimmed) return;
    const isChar = /^[A-Z][A-Z\s\.]{1,28}$/.test(trimmed) && !trimmed.match(/^(ACT|SCENE|INT\.|EXT\.)/) && trimmed.length >= 2;
    const colonMatch = trimmed.match(/^([A-Z][A-Z\s]{1,20}):\s*(.*)/);
    if(colonMatch) { flush(); currentChar = colonMatch[1].trim(); if(colonMatch[2]) currentText.push(colonMatch[2]); }
    else if(isChar) { flush(); currentChar = trimmed; }
    else if(currentChar && !/^\(.*\)$/.test(trimmed) && !/^\[.*\]$/.test(trimmed)) currentText.push(trimmed);
  });
  flush();

  if(splitterParsed.length === 0) {
    // Nothing parsed â€” go straight to buildScriptData
    buildScriptData(text, myChar);
    return;
  }

  // Render splitter view
  document.getElementById('sceneSplitterSection').style.display = 'block';
  renderSplitterScript();
}

function renderSplitterScript() {
  const container = document.getElementById('splitterScript');
  let html = '<div style="font-size:11px;color:var(--brown-light);margin-bottom:12px;font-weight:700;">Tap between any two lines to add a scene divider:</div>';

  splitterParsed.forEach(function(block, i) {
    // Show any divider that goes BEFORE this block
    const divBefore = splitterDividers.find(function(d){ return d.afterIdx === i - 0.5; });
    if(divBefore) {
      html += renderDivider(i - 0.5, divBefore.name);
    }

    // The script block itself
    html += '<div style="padding:8px 0;border-bottom:1px solid var(--sand-dark);">';
    html += '<div style="font-size:10px;font-weight:900;color:' + (block.mine ? 'var(--terra)' : 'var(--brown-light)') + ';text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;">' + block.char + '</div>';
    html += '<div style="font-size:13px;line-height:1.6;' + (block.mine ? 'font-weight:700;border-left:3px solid var(--terra);padding-left:8px;' : 'color:var(--brown-light);') + '">' + block.text.substring(0, 120) + (block.text.length > 120 ? '...' : '') + '</div>';
    html += '</div>';

    // Insert button AFTER this block
    const hasDivider = splitterDividers.find(function(d){ return d.afterIdx === i + 0.5; });
    if(!hasDivider) {
      html += '<div style="text-align:center;margin:4px 0;">';
      html += '<button onclick="addSceneDivider(' + (i + 0.5) + ')" style="background:none;border:1px dashed var(--sage);color:var(--sage);border-radius:99px;padding:3px 16px;font-size:10px;font-weight:900;cursor:pointer;font-family:var(--font);">+ scene break here</button>';
      html += '</div>';
    } else {
      html += renderDivider(i + 0.5, hasDivider.name);
    }
  });

  container.innerHTML = html;
}

function renderDivider(idx, name) {
  return '<div style="background:var(--sage);color:white;border-radius:var(--rs);padding:8px 14px;margin:6px 0;display:flex;align-items:center;gap:8px;">' +
    '<div style="font-size:12px;">ğŸ“</div>' +
    '<input value="' + name + '" onchange="renameDivider(' + idx + ', this.value)" ' +
      'style="flex:1;background:rgba(255,255,255,0.25);border:none;border-radius:6px;padding:4px 8px;font-family:var(--font);font-weight:900;font-size:12px;color:white;" ' +
      'placeholder="Scene name...">' +
    '<button onclick="removeDivider(' + idx + ')" style="background:rgba(255,255,255,0.2);border:none;color:white;border-radius:99px;padding:3px 10px;font-size:11px;cursor:pointer;font-family:var(--font);">âœ• Remove</button>' +
  '</div>';
}

function addSceneDivider(afterIdx) {
  const sceneNum = splitterDividers.length + 2;
  splitterDividers.push({ afterIdx: afterIdx, name: 'Scene ' + sceneNum });
  splitterDividers.sort(function(a,b){ return a.afterIdx - b.afterIdx; });
  renderSplitterScript();
  showToast('Scene break added â€” tap the name to rename it');
}

function renameDivider(idx, newName) {
  const d = splitterDividers.find(function(d){ return d.afterIdx === idx; });
  if(d) d.name = newName;
}

function removeDivider(idx) {
  splitterDividers = splitterDividers.filter(function(d){ return d.afterIdx !== idx; });
  renderSplitterScript();
}

function skipSceneSplit() {
  document.getElementById('sceneSplitterSection').style.display = 'none';
  buildScriptData(rawScriptText, splitterMyChar);
}

function saveSplitScenes() {
  document.getElementById('sceneSplitterSection').style.display = 'none';
  buildScriptDataWithScenes(splitterParsed, splitterMyChar, splitterDividers);
}

function buildScriptDataWithScenes(parsed, myChar, dividers) {
  // Assign scene names to each block
  var scenes = ['Scene 1'];
  dividers.forEach(function(d){ scenes.push(d.name); });

  function getScene(blockIdx) {
    var sceneName = 'Scene 1';
    for(var i=0; i<dividers.length; i++) {
      if(blockIdx > dividers[i].afterIdx - 0.5) sceneName = dividers[i].name;
    }
    return sceneName;
  }

  var cuePairs = [];
  var sceneList = [];
  for(var i=0; i<parsed.length; i++) {
    var scene = getScene(i);
    if(!sceneList.includes(scene)) sceneList.push(scene);
    if(parsed[i].mine) {
      var cue = i > 0 ? parsed[i-1].text : 'Start of scene';
      cuePairs.push({ cue: cue, myLine: parsed[i].text, scene: scene, needsWork: false });
    }
  }

  var prod = {
    name: 'My Script',
    role: myChar,
    type: 'ğŸ­',
    scriptData: parsed.map(function(b,i){ return Object.assign({},b,{scene:getScene(i)}); }),
    cuePairs: cuePairs,
    scenes: sceneList,
    myChar: myChar,
    id: Date.now(),
    progress: 0
  };
  productions.push(prod);
  activeProduction = prod;

  renderScriptReader(prod.scriptData, myChar);
  document.getElementById('readerSection').style.display = 'block';

  showToast('Found ' + cuePairs.length + ' lines across ' + sceneList.length + ' scenes!');
  refreshHome();
  refreshProductionsList();
  refreshPracticeScreen();
  autoSave();
}

function buildScriptData(text, myChar) {
  const lines = text.split('\n');
  const parsed = [];
  let currentChar = null;
  let currentText = [];

  function flush() {
    if(currentChar && currentText.length > 0) {
      const lineText = currentText.join(' ').replace(/\s+/g,' ').trim();
      if(lineText) parsed.push({ char: currentChar, text: lineText, mine: currentChar === myChar });
      currentText = [];
    }
  }

  lines.forEach(line => {
    const trimmed = line.trim();
    if(!trimmed) return;

    // Check if it's a character name
    const isCharName = /^[A-Z][A-Z\s\.]{1,28}$/.test(trimmed) && !trimmed.includes('ACT') && !trimmed.includes('SCENE') && !trimmed.includes('INT.') && !trimmed.includes('EXT.') && trimmed.length >= 2;
    const colonMatch = trimmed.match(/^([A-Z][A-Z\s]{1,20}):\s*(.*)/);

    if(colonMatch) {
      flush();
      currentChar = colonMatch[1].trim();
      if(colonMatch[2]) currentText.push(colonMatch[2]);
    } else if(isCharName) {
      flush();
      currentChar = trimmed;
    } else if(currentChar) {
      // Skip stage directions (lines in parentheses or starting with [ )
      if(!/^\(.*\)$/.test(trimmed) && !/^\[.*\]$/.test(trimmed)) {
        currentText.push(trimmed);
      }
    }
  });
  flush();

  if(parsed.length === 0) {
    showToast('Could not parse script â€” try the paste option with proper formatting');
    return;
  }

  // Build cue pairs for my lines
  const cuePairs = [];
  for(let i=0; i<parsed.length; i++) {
    if(parsed[i].mine) {
      const cue = i > 0 ? parsed[i-1].text : 'Start of scene';
      cuePairs.push({ cue, myLine: parsed[i].text });
    }
  }

  // Save production
  const prod = {
    name: document.getElementById('myCharInput').dataset.prodName || 'My Script',
    role: myChar,
    type: 'ğŸ­',
    scriptData: parsed,
    cuePairs,
    myChar,
    id: Date.now()
  };
  productions.push(prod);
  activeProduction = prod;

  // Render script
  renderScriptReader(parsed, myChar);
  document.getElementById('readerSection').style.display = 'block';
  document.getElementById('charSetup').classList.remove('show');
  document.getElementById('charSetup').style.display = 'none';

  const myLineCount = parsed.filter(l=>l.mine).length;
  showToast(`âœ… Found ${myLineCount} lines for ${myChar}! ğŸ­`);
  refreshHome();
  refreshProductionsList();
  refreshPracticeScreen();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCRIPT READER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderScriptReader(data, myChar) {
  const reader = document.getElementById('scriptReader');
  reader.innerHTML = data.map(block => `
    <div class="script-block ${myLinesOnlyMode && !block.mine ? 'my-lines-hidden' : ''}" style="${myLinesOnlyMode && !block.mine ? 'display:none;' : ''}">
      <div class="s-charname">${block.char}</div>
      <div class="${block.mine ? 's-myline' : 's-otherline'}">
        ${block.text.split(' ').map(w =>
          `<span class="clickword" onclick="lookupWord('${w.replace(/[^a-zA-Z]/g,'').toLowerCase()}')">${w} </span>`
        ).join('')}
      </div>
    </div>
  `).join('');
}

function toggleMyLinesOnly(btn) {
  myLinesOnlyMode = !myLinesOnlyMode;
  btn.classList.toggle('active', myLinesOnlyMode);
  if(activeProduction) renderScriptReader(activeProduction.scriptData, activeProduction.myChar);
}

function toggleFont(btn) {
  btn.classList.toggle('active');
  document.body.style.fontFamily = btn.classList.contains('active') ? "OpenDyslexic, Nunito, sans-serif" : "Nunito, sans-serif";
}

function changeFontSize(delta, btn) {
  scriptFontSize = Math.max(12, Math.min(26, scriptFontSize + delta));
  document.documentElement.style.setProperty('--script-fs', scriptFontSize+'px');
  showToast(`Font size: ${scriptFontSize}px`);
}

function readAloud() {
  if(!activeProduction) { showToast('Load a script first! ğŸ“„'); return; }
  const myLines = activeProduction.scriptData.filter(l=>l.mine).map(l=>l.text).join('. ');
  speakText(myLines, 0.85);
  showToast('ğŸ”Š Reading your lines aloud...');
}

function speakCue() {
  const txt = document.getElementById('cueTxt');
  if(txt && txt.textContent) speakText(txt.textContent, 0.85);
}

function speakText(text, rate) {
  if(!('speechSynthesis' in window)) { showToast('Speech not supported in this browser'); return; }
  // iOS requires cancel before speak and a tiny delay
  window.speechSynthesis.cancel();
  setTimeout(function() {
    const u = new SpeechSynthesisUtterance(text);
    u.rate = rate || 0.85;
    u.pitch = 1;
    u.volume = 1;
    // Pick a good voice if available
    const voices = window.speechSynthesis.getVoices();
    const preferred = voices.find(v => v.lang.startsWith('en') && v.localService);
    if(preferred) u.voice = preferred;
    window.speechSynthesis.speak(u);
  }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DICTIONARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lookupWord(word) {
  const clean = word.toLowerCase().replace(/[^a-z]/g,'');
  if(!clean) return;
  const entry = dict[clean];
  document.getElementById('dpWord').textContent = clean;
  document.getElementById('dpPron').textContent = entry ? entry.pron : '/ËˆwÉœËrd/';
  document.getElementById('dpDef').textContent = entry ? entry.def : 'Definition not in local dictionary. Tap "Hear it" to hear pronunciation.';
  document.getElementById('dictPop').classList.add('show');
}
function closeDict() { document.getElementById('dictPop').classList.remove('show'); }
function speakDictWord() {
  const w = document.getElementById('dpWord').textContent;
  if('speechSynthesis' in window) {
    const u = new SpeechSynthesisUtterance(w);
    u.rate = 0.7;
    speechSynthesis.speak(u);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOME & PRACTICE REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshHome() {
  const container = document.getElementById('homeProductions');
  if(productions.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="es-icon">ğŸ­</div><p>No productions yet.<br>Upload your first script to get started!</p><br><button class="btn btn-terra btn-sm" onclick="navTo('scriptScreen',1)" style="width:auto;padding:10px 24px;">Upload Script</button></div>`;
    document.getElementById('homeLinesLearned').textContent = '0';
    return;
  }
  container.innerHTML = productions.map((p,i) => `
    <div class="prod-card" onclick="loadProduction(${i})" style="border-left-color:${i===0?'var(--terra)':i===1?'var(--sage)':'var(--amber)'}">
      <div class="prod-icon">${p.type}</div>
      <div class="prod-info">
        <div class="prod-name">${p.myChar}</div>
        <div class="prod-sub">${p.scriptData.filter(l=>l.mine).length} lines Â· ${p.scriptData.length} total blocks</div>
        <div class="prog-wrap" style="margin-top:8px;"><div class="prog-fill" style="width:${p.progress||0}%"></div></div>
        <div class="prog-label">${p.progress||0}% learned</div>
      </div>
    </div>
  `).join('');
  const total = productions.reduce((a,p)=>a+p.scriptData.filter(l=>l.mine).length,0);
  document.getElementById('homeLinesLearned').textContent = total;
}

function loadProduction(idx) {
  activeProduction = productions[idx];
  renderScriptReader(activeProduction.scriptData, activeProduction.myChar);
  document.getElementById('readerSection').style.display = 'block';
  navTo('scriptScreen', 1);
}

function refreshProductionsList() {
  const list = document.getElementById('productionsList');
  if(productions.length === 0) { list.innerHTML = ''; return; }
  list.innerHTML = `<div class="section-title">All Productions</div>` +
    productions.map((p,i) => `
      <div class="prod-card" onclick="loadProduction(${i})">
        <div class="prod-icon">ğŸ­</div>
        <div class="prod-info">
          <div class="prod-name">${p.myChar}</div>
          <div class="prod-sub">${p.cuePairs ? p.cuePairs.length : 0} lines Â· ${p.scenes ? p.scenes.length + ' scenes' : 'no scenes'}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          ${p.isManual ? `<button onclick="event.stopPropagation();editProduction(${i})" style="background:var(--sage);color:white;border:none;border-radius:99px;padding:6px 14px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);">âœï¸ Edit</button>` : ''}
          <button onclick="event.stopPropagation();deleteProduction(${i})" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--brown-light);">ğŸ—‘</button>
        </div>
      </div>
    `).join('');
}

function deleteProduction(idx) {
  productions.splice(idx, 1);
  if(activeProduction === productions[idx]) activeProduction = null;
  refreshHome();
  refreshProductionsList();
  refreshPracticeScreen();
  showToast('Production removed');
}

function refreshPracticeScreen() {
  const c = document.getElementById('practiceContent');
  if(productions.length === 0) {
    c.innerHTML = `<div class="empty-state"><div class="es-icon">ğŸ“š</div><p>Upload a script first to start practising!</p><br><button class="btn btn-terra btn-sm" onclick="navTo('scriptScreen',1)" style="width:auto;padding:10px 24px;">Upload Script</button></div>`;
    return;
  }
  const prod = activeProduction || productions[0];
  const scenes = prod.scenes && prod.scenes.length > 1 ? prod.scenes : null;

  const sceneSelector = scenes ? `
    <div class="card" style="margin-bottom:14px;">
      <div style="font-size:13px;font-weight:900;margin-bottom:10px;">Practice by scene:</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="tool-btn active" id="sceneAll" onclick="setSceneFilter('all',this)">All Scenes (${prod.cuePairs.length})</button>
        ${scenes.map(s => {
          const count = prod.cuePairs.filter(p=>(p.scene||'Scene 1')===s).length;
          return `<button class="tool-btn" id="scene_${s.replace(/\s/g,'_')}" onclick="setSceneFilter('${s}',this)">${s} (${count})</button>`;
        }).join('')}
      </div>
    </div>
  ` : '';

  c.innerHTML = `
    <div class="card" style="margin-bottom:16px;">
      <div style="font-size:12px;color:var(--brown-light);font-weight:700;margin-bottom:4px;">Currently practising:</div>
      <div style="font-size:16px;font-weight:900;">${prod.myChar}</div>
      <div style="font-size:12px;color:var(--brown-light);" id="practiceLineCount">${prod.cuePairs.length} lines ready</div>
    </div>
    ${sceneSelector}
    <div class="pm-card" onclick="startCueCards()">
      <div class="pm-icon">ğŸƒ</div>
      <div class="pm-info"><div class="pm-name">Cue Cards</div><div class="pm-desc">See the cue, recall your line. Word-perfect checking.</div></div>
      <div class="pm-arrow">â€º</div>
    </div>
    <div class="pm-card" onclick="startHandsFree()">
      <div class="pm-icon">ğŸ”Š</div>
      <div class="pm-info"><div class="pm-name">Hands-Free Mode</div><div class="pm-desc">Phone reads the cue aloud â€” you speak your line back.</div></div>
      <div class="pm-arrow">â€º</div>
    </div>
    <div class="pm-card" onclick="startScenePartner()">
      <div class="pm-icon">ğŸ­</div>
      <div class="pm-info"><div class="pm-name">Scene Partner</div><div class="pm-desc">App voices ALL other characters. Just you and your phone.</div></div>
      <div class="pm-arrow">â€º</div>
    </div>
    <div class="pm-card" onclick="startSpeedDrill()">
      <div class="pm-icon">âš¡</div>
      <div class="pm-info"><div class="pm-name">Speed Drill</div><div class="pm-desc">Race through all your lines. Beat your personal best!</div></div>
      <div class="pm-arrow">â€º</div>
    </div>
    <div class="pm-card" onclick="startNeedsWork()">
      <div class="pm-icon">ğŸ”</div>
      <div class="pm-info"><div class="pm-name">Needs Work</div><div class="pm-desc">Practise only the lines you've flagged as wrong.</div></div>
      <div class="pm-arrow">â€º</div>
    </div>
    <div class="pm-card" onclick="showProgressDashboard()">
      <div class="pm-icon">ğŸ“Š</div>
      <div class="pm-info"><div class="pm-name">Progress Dashboard</div><div class="pm-desc">See which scenes you've mastered and what needs work.</div></div>
      <div class="pm-arrow">â€º</div>
    </div>
    ${prod.cuePairs.some(p=>p.needsWork) ? `
    <div class="card">
      <div class="section-title" style="font-size:14px;">Flagged for Review ğŸ”</div>
      ${prod.cuePairs.filter(p=>p.needsWork).map(p => `
        <div style="font-size:13px;line-height:1.8;border-left:4px solid var(--terra);padding:8px 12px;margin-bottom:10px;background:rgba(193,97,79,0.06);border-radius:0 var(--rs) var(--rs) 0;font-style:italic;">"${p.myLine.substring(0,80)}${p.myLine.length>80?'...':''}"</div>
      `).join('')}
    </div>` : ''}
  `;
}

let activeSceneFilter = 'all';

function setSceneFilter(scene, btn) {
  activeSceneFilter = scene;
  document.querySelectorAll('#practiceContent .tool-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const prod = activeProduction || productions[0];
  if(!prod) return;
  const count = scene === 'all' ? prod.cuePairs.length : prod.cuePairs.filter(p=>(p.scene||'Scene 1')===scene).length;
  const el = document.getElementById('practiceLineCount');
  if(el) el.textContent = count + ' lines' + (scene !== 'all' ? ' in ' + scene : ' total');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUE CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startCueCards() {
  const prod = activeProduction || productions[0];
  if(!prod || prod.cuePairs.length === 0) { showToast('No lines found to practise!'); return; }

  // Apply scene filter
  if(activeSceneFilter !== 'all') {
    cuePairs = prod.cuePairs.filter(p => (p.scene||'Scene 1') === activeSceneFilter);
    if(cuePairs.length === 0) { showToast('No lines in that scene yet!'); return; }
    document.getElementById('cueScreenTitle').textContent = `Cue Cards â€” ${activeSceneFilter}`;
    document.getElementById('cueScreenSub').textContent = `${prod.myChar} Â· ${cuePairs.length} lines`;
  } else {
    cuePairs = prod.cuePairs;
    document.getElementById('cueScreenTitle').textContent = `Cue Cards â€” ${prod.myChar}`;
    document.getElementById('cueScreenSub').textContent = `${cuePairs.length} lines`;
  }

  cueIndex = 0;
  loadCue();
  navTo('cueScreen', 2);
}

function startNeedsWork() {
  const prod = activeProduction || productions[0];
  if(!prod) return;
  const flagged = prod.cuePairs.filter(p=>p.needsWork);
  if(flagged.length === 0) { showToast('No lines flagged yet! Great work!'); return; }
  cuePairs = flagged;
  cueIndex = 0;
  document.getElementById('cueScreenTitle').textContent = 'Needs Work';
  document.getElementById('cueScreenSub').textContent = flagged.length + ' lines to review';
  loadCue();
  navTo('cueScreen', 2);
}

function loadCue() {
  const pair = cuePairs[cueIndex];
  const pct = (cueIndex / cuePairs.length) * 100;
  document.getElementById('cueProgBar').style.width = pct + '%';
  document.getElementById('cueProgLabel').textContent = `Line ${cueIndex+1} of ${cuePairs.length}`;
  document.getElementById('cueScreenSub').textContent = `Line ${cueIndex+1} of ${cuePairs.length}`;
  document.getElementById('cueTxt').textContent = pair.cue;
  document.getElementById('revealTxt').textContent = pair.myLine;
  document.getElementById('revealTxt').style.display = 'none';
  document.getElementById('revealHint').style.display = 'block';
  document.getElementById('myLineReveal').classList.remove('shown');
  document.getElementById('feedbackRow').style.display = 'none';
  document.getElementById('nextCueBtn').classList.remove('show');
  document.getElementById('cueBanner').className = 'result-banner';
  document.getElementById('wordAnalysis').className = 'word-analysis';
  document.getElementById('voiceBtn').className = 'voice-btn';
  document.getElementById('voiceBtn').textContent = 'ğŸ™ Speak Your Line';
  lineShown = false;
}

function revealMyLine() {
  if(!lineShown) {
    lineShown = true;
    document.getElementById('revealHint').style.display = 'none';
    document.getElementById('revealTxt').style.display = 'block';
    document.getElementById('myLineReveal').classList.add('shown');
    document.getElementById('feedbackRow').style.display = 'flex';
  }
}

function toggleVoice() {
  if(!voiceActive) {
    voiceActive = true;
    const btn = document.getElementById('voiceBtn');
    btn.classList.add('listening');
    btn.textContent = 'ğŸ”´ Listening... tap to stop';

    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SR();
      recognition.lang = 'en-GB';
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onresult = function(e) {
        const spoken = e.results[0][0].transcript;
        voiceActive = false;
        btn.classList.remove('listening');
        btn.textContent = 'ğŸ™ Speak Your Line';
        checkSpokenLine(spoken);
      };
      recognition.onerror = function() {
        voiceActive = false;
        btn.classList.remove('listening');
        btn.textContent = 'ğŸ™ Speak Your Line';
        simulateVoiceCheck();
      };
      recognition.start();
      setTimeout(() => { if(voiceActive) recognition.stop(); }, 8000);
    } else {
      setTimeout(() => {
        voiceActive = false;
        btn.classList.remove('listening');
        btn.textContent = 'ğŸ™ Speak Your Line';
        simulateVoiceCheck();
      }, 2500);
    }
  } else {
    voiceActive = false;
    document.getElementById('voiceBtn').classList.remove('listening');
    document.getElementById('voiceBtn').textContent = 'ğŸ™ Speak Your Line';
  }
}

function checkSpokenLine(spoken) {
  const correct = cuePairs[cueIndex].myLine;
  const result = compareLines(spoken, correct);
  revealMyLine();
  showWordAnalysis(spoken, correct, result);
}

function compareLines(spoken, correct) {
  const sp = spoken.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/);
  const co = correct.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/);
  let matches = 0;
  sp.forEach(w => { if(co.includes(w)) matches++; });
  const pct = co.length > 0 ? matches/co.length : 0;
  return { spoken:sp, correct:co, pct, matches, total:co.length };
}

function showWordAnalysis(spoken, correct, result) {
  const banner = document.getElementById('cueBanner');
  const analysis = document.getElementById('wordAnalysis');
  const spWords = spoken.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/);
  const coWords = correct.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/);

  let analysisHTML = '';
  coWords.forEach(w => {
    if(spWords.includes(w)) analysisHTML += `<span class="w-correct">${w} </span>`;
    else analysisHTML += `<span class="w-missing">${w} </span>`;
  });

  analysis.innerHTML = `<div style="font-size:11px;font-weight:900;color:var(--brown-light);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">Word by word check:</div>${analysisHTML}`;
  analysis.classList.add('show');

  if(result.pct >= 0.9) {
    banner.textContent = `âœ… Word perfect! ${result.matches}/${result.total} words correct!`;
    banner.className = 'result-banner res-good';
    document.getElementById('nextCueBtn').classList.add('show');
  } else if(result.pct >= 0.6) {
    banner.textContent = `ğŸŸ¡ Getting there! ${result.matches}/${result.total} words â€” red words need work`;
    banner.className = 'result-banner res-bad';
    document.getElementById('feedbackRow').style.display = 'flex';
  } else {
    banner.textContent = `âŒ Keep practising! ${result.matches}/${result.total} words correct â€” you've got this!`;
    banner.className = 'result-banner res-bad';
    document.getElementById('feedbackRow').style.display = 'flex';
  }
}

function simulateVoiceCheck() {
  const correct = cuePairs[cueIndex].myLine;
  const words = correct.split(' ');
  // Drop 1-2 random words
  const dropped = Math.floor(Math.random()*2)+1;
  const spoken = words.filter((_,i) => i % Math.ceil(words.length/dropped) !== 0).join(' ');
  checkSpokenLine(spoken.length > 5 ? spoken : correct);
}

function nextCue(result) {
  if(result === 'wrong' && activeProduction) {
    const idx = (activeProduction.cuePairs || []).findIndex(p=>p.myLine === cuePairs[cueIndex].myLine);
    if(idx>=0) activeProduction.cuePairs[idx].needsWork = true;
  }
  if(result === 'correct') { addXP(10); }
  autoSave();
  cueIndex++;
  if(cueIndex >= cuePairs.length) {
    showToast('ğŸ‰ Scene complete! Amazing work!');
    if(activeProduction) activeProduction.progress = Math.min(100, (activeProduction.progress||0)+10);
    setTimeout(() => navTo('practiceScreen',2), 1200);
  } else {
    loadCue();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME CENTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildGameQuestions() {
  const prod = activeProduction || productions[0];
  if(prod && prod.cuePairs.length > 0) {
    return prod.cuePairs.map(pair => {
      const words = pair.myLine.split(' ').filter(w=>w.length>3);
      if(words.length === 0) return null;
      const blankIdx = Math.floor(Math.random()*words.length);
      const blank = words[blankIdx].replace(/[^a-zA-Z']/g,'');
      const opts = generateOptions(blank, prod.scriptData);
      return { line: pair.myLine, blank, blankClean: blank, options: opts };
    }).filter(Boolean);
  }
  // Sample fallback
  return [
    {line:"I am that merry wanderer of the night.",blank:"merry",blankClean:"merry",options:["merry","noble","sleepy","dark"]},
    {line:"Lord, what fools these mortals be!",blank:"fools",blankClean:"fools",options:["fools","knaves","souls","men"]},
    {line:"The course of true love never did run smooth.",blank:"smooth",blankClean:"smooth",options:["smooth","clear","fast","true"]},
    {line:"I must go seek some dewdrops here.",blank:"dewdrops",blankClean:"dewdrops",options:["dewdrops","moonbeams","starlight","raindrops"]},
  ];
}

function generateOptions(correct, scriptData) {
  // Get other words from the script as distractors
  const allWords = scriptData ? scriptData.flatMap(l=>l.text.split(' ').map(w=>w.replace(/[^a-zA-Z']/g,'').toLowerCase())).filter(w=>w.length>3 && w!==correct.toLowerCase()) : ['noble','sleepy','dark','bright'];
  const distractors = [...new Set(allWords)].sort(()=>Math.random()-0.5).slice(0,3);
  while(distractors.length < 3) distractors.push(['quickly','gently','softly','boldly'][distractors.length]);
  const opts = [correct, ...distractors].sort(()=>Math.random()-0.5);
  return opts;
}

function startGame(type) {
  if(type !== 'fillblank') {
    showToast(`${type==='scramble'?'Word Scramble ğŸ”€':type==='match'?'Memory Match ğŸ§©':'Beat the Clock âš¡'} â€” coming very soon!`);
    return;
  }
  gameScore = 0; gameStreak = 0; gameTimerSecs = 60; gameQIndex = 0;
  gameQuestions = buildGameQuestions();
  if(gameQuestions.length === 0) { showToast('Need a script loaded to play! ğŸ“„'); return; }
  goToGameScreen('fillBlankScreen');
  loadGameQ();
  startGameTimer();
}

function loadGameQ() {
  const q = gameQuestions[gameQIndex % gameQuestions.length];
  const display = q.line.replace(new RegExp('\\b'+q.blankClean+'\\b','i'), `<span class="blank" id="theBlank">_______</span>`);
  document.getElementById('gameLineCard').innerHTML = `
    <div style="font-size:11px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Fill in the missing word:</div>
    ${display}
  `;
  const pct = (gameQIndex % gameQuestions.length) / gameQuestions.length * 100;
  document.getElementById('gameProgBar').style.width = pct+'%';
  const opts = document.getElementById('wordOpts');
  opts.innerHTML = '';
  q.options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'wopt';
    btn.textContent = opt;
    btn.onclick = () => checkGameAnswer(opt, q.blankClean, btn, q.options);
    opts.appendChild(btn);
  });
  document.getElementById('gameBanner').className = 'result-banner';
  document.getElementById('gameNextBtn').style.display = 'none';
  updateGameUI();
}

function checkGameAnswer(chosen, correct, btn, allOpts) {
  document.querySelectorAll('.wopt').forEach(b => b.disabled = true);
  const blank = document.getElementById('theBlank');
  const banner = document.getElementById('gameBanner');
  if(chosen.toLowerCase() === correct.toLowerCase()) {
    blank.textContent = chosen;
    blank.classList.add('filled-ok');
    gameScore += 50 + (gameStreak * 10);
    gameStreak++;
    banner.textContent = `âœ… Correct! +${50 + ((gameStreak-1)*10)} pts${gameStreak>1?' ğŸ”¥ x'+gameStreak+' streak!':''}`;
    banner.className = 'result-banner res-good';
    if(gameStreak > 2) triggerStreak();
    btn.style.cssText = 'background:var(--sage);color:white;border-color:var(--sage);';
    addXP(20);
    checkBadges();
  } else {
    blank.textContent = chosen;
    blank.classList.add('filled-bad');
    gameStreak = 0;
    banner.textContent = `âŒ The word was "${correct}" â€” keep going, you've got this!`;
    banner.className = 'result-banner res-bad';
    btn.style.cssText = 'background:var(--terra);color:white;border-color:var(--terra);';
    // Show correct answer
    document.querySelectorAll('.wopt').forEach(b => {
      if(b.textContent.toLowerCase()===correct.toLowerCase()) b.style.cssText='background:var(--sage);color:white;border-color:var(--sage);';
    });
  }
  updateGameUI();
  document.getElementById('gameNextBtn').style.display = 'block';
}

function nextGameQ() {
  gameQIndex++;
  loadGameQ();
}

function updateGameUI() {
  document.getElementById('gScore').textContent = gameScore;
  document.getElementById('gStreak').textContent = gameStreak;
}

function setDiff(val) {
  const times = {easy:90, medium:60, hard:30};
  clearInterval(gameTimerInt);
  gameTimerSecs = times[val];
  document.getElementById('gTimer').textContent = gameTimerSecs;
  startGameTimer();
  showToast(`Difficulty: ${val.charAt(0).toUpperCase()+val.slice(1)} â€” ${times[val]}s`);
}

function startGameTimer() {
  clearInterval(gameTimerInt);
  gameTimerInt = setInterval(()=>{
    gameTimerSecs--;
    document.getElementById('gTimer').textContent = gameTimerSecs;
    if(gameTimerSecs <= 0) {
      clearInterval(gameTimerInt);
      showToast(`â± Time's up! Final score: ${gameScore} pts ğŸ‰`);
      setTimeout(()=>navTo('gameScreen',3), 1500);
    }
  },1000);
}

function switchSrc(type, btn) {
  document.querySelectorAll('.src-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  showToast(type==='mine' ? 'ğŸ“š Using your scripts' : 'ğŸ“– Using sample scripts');
  if(type==='sample') activeProduction = null;
  else if(productions.length>0) activeProduction = productions[0];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STUDY TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTimer() { document.getElementById('timerModal').classList.add('show'); }
function closeTimer() {
  document.getElementById('timerModal').classList.remove('show');
  clearInterval(timerInterval);
  timerRunning = false; timerSecs = 1200; isBreak = false;
  document.getElementById('timerDisplay').textContent = '20:00';
  document.getElementById('timerDisplay').style.color = 'var(--terra)';
  document.getElementById('timerToggleBtn').textContent = 'â–¶ Start';
  document.getElementById('timerModeLabel').textContent = '20 min focus session';
}

function selectBreak(mins) {
  breakLen = mins;
  document.getElementById('bo5').classList.toggle('active', mins===5);
  document.getElementById('bo10').classList.toggle('active', mins===10);
}

function toggleTimer() {
  if(!timerRunning) {
    timerRunning = true;
    document.getElementById('timerToggleBtn').textContent = 'â¸ Pause';
    timerInterval = setInterval(tickTimer, 1000);
  } else {
    timerRunning = false;
    clearInterval(timerInterval);
    document.getElementById('timerToggleBtn').textContent = 'â–¶ Resume';
  }
}

function tickTimer() {
  timerSecs--;
  if(timerSecs < 0) {
    if(!isBreak) {
      isBreak = true;
      timerSecs = breakLen * 60;
      document.getElementById('timerModeLabel').textContent = `${breakLen} min break ğŸŒ¿`;
      document.getElementById('timerDisplay').style.color = 'var(--sage)';
      showToast('ğŸŒ¿ Break time! Well done â€” breathe!');
    } else {
      isBreak = false;
      timerSecs = 1200;
      document.getElementById('timerModeLabel').textContent = '20 min focus session';
      document.getElementById('timerDisplay').style.color = 'var(--terra)';
      showToast('â± Back to studying â€” you\'ve got this!');
    }
  }
  const m = Math.floor(timerSecs/60);
  const s = timerSecs%60;
  document.getElementById('timerDisplay').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function globalFontSize(d) {
  globalFs = Math.max(12,Math.min(24,globalFs+d));
  document.getElementById('globalFsDisplay').textContent = globalFs;
  document.body.style.fontSize = globalFs+'px';
}

// theme functions above replace setTint

function setBreakLen(mins) {
  breakLen = mins;
  document.getElementById('break5Btn').classList.toggle('active', mins===5);
  document.getElementById('break10Btn').classList.toggle('active', mins===10);
  showToast('Break length: ' + mins + ' minutes');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEMES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEMES = {
  sand:     { sand:'#F5ECD7', sandDark:'#E8D9BC', cream:'#FAF4E8', terra:'#C1614F', terraLight:'#D4826F', terraDark:'#A04F3E', sage:'#7A9E7E', sageDark:'#5A7E5E', brown:'#4A3728', brownLight:'#6B5445', amber:'#E8A838', text:'#4A3728' },
  night:    { sand:'#1A1A2E', sandDark:'#16213E', cream:'#0F3460', terra:'#E94560', terraLight:'#FF6B8A', terraDark:'#C43050', sage:'#4A90D9', sageDark:'#2970B9', brown:'#E8E8F0', brownLight:'#A8A8C0', amber:'#F4C430', text:'#E8E8F0' },
  ocean:    { sand:'#E8F4FD', sandDark:'#D0E8F8', cream:'#F5FBFF', terra:'#2980B9', terraLight:'#5DADE2', terraDark:'#1A6A9A', sage:'#1ABC9C', sageDark:'#16A085', brown:'#1A3A4A', brownLight:'#4A7A9A', amber:'#F39C12', text:'#1A3A4A' },
  sunset:   { sand:'#FFF0E6', sandDark:'#FFD9C0', cream:'#FFF8F4', terra:'#E67E22', terraLight:'#F0A040', terraDark:'#C0612A', sage:'#C0392B', sageDark:'#A03020', brown:'#3A1A0A', brownLight:'#8A4A2A', amber:'#F1C40F', text:'#3A1A0A' },
  lavender: { sand:'#F5F0FF', sandDark:'#E5D8FF', cream:'#FAF6FF', terra:'#8E44AD', terraLight:'#BB77D0', terraDark:'#6C2A8A', sage:'#3498DB', sageDark:'#2070B0', brown:'#2C1A3A', brownLight:'#7A5A9A', amber:'#F39C12', text:'#2C1A3A' },
  forest:   { sand:'#EAF5EA', sandDark:'#CCE8CC', cream:'#F4FCF4', terra:'#27AE60', terraLight:'#52C880', terraDark:'#1A8A48', sage:'#F39C12', sageDark:'#D68A00', brown:'#1A3A1A', brownLight:'#4A7A4A', amber:'#E74C3C', text:'#1A3A1A' },
  rose:     { sand:'#FFF0F5', sandDark:'#FFD0E8', cream:'#FFF8FC', terra:'#E91E8C', terraLight:'#FF60B0', terraDark:'#C01070', sage:'#9B59B6', sageDark:'#7A3A9A', brown:'#3A0A2A', brownLight:'#8A4A7A', amber:'#F39C12', text:'#3A0A2A' },
  slate:    { sand:'#ECF0F1', sandDark:'#D0D8DA', cream:'#F8FAFB', terra:'#2C3E50', terraLight:'#546E7A', terraDark:'#1A2A38', sage:'#7F8C8D', sageDark:'#5D6D7E', brown:'#1A1A1A', brownLight:'#555555', amber:'#E74C3C', text:'#1A1A1A' }
};

let currentTheme = localStorage.getItem('escomind-theme') || 'sand';

function applyTheme(name, el) {
  const t = THEMES[name];
  if(!t) return;
  currentTheme = name;
  localStorage.setItem('escomind-theme', name);
  const r = document.documentElement;
  r.style.setProperty('--sand', t.sand);
  r.style.setProperty('--sand-dark', t.sandDark);
  r.style.setProperty('--cream', t.cream);
  r.style.setProperty('--terra', t.terra);
  r.style.setProperty('--terra-light', t.terraLight);
  r.style.setProperty('--terra-dark', t.terraDark);
  r.style.setProperty('--sage', t.sage);
  r.style.setProperty('--sage-dark', t.sageDark);
  r.style.setProperty('--brown', t.brown);
  r.style.setProperty('--brown-light', t.brownLight);
  r.style.setProperty('--amber', t.amber);
  document.body.style.color = t.text;
  document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
  if(el) el.classList.add('active');
  else {
    var grid = document.getElementById('themeGrid');
    if(grid) { var cards = grid.querySelectorAll('.theme-card'); var idx = Object.keys(THEMES).indexOf(name); if(cards[idx]) cards[idx].classList.add('active'); }
  }
  showToast('Theme changed to ' + name.charAt(0).toUpperCase() + name.slice(1) + ' !');
}

function loadSavedTheme() {
  var saved = localStorage.getItem('escomind-theme') || 'sand';
  applyTheme(saved, null);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIDENCE RATINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setConfidence(prodIdx, pairIdx, level) {
  if(productions[prodIdx] && productions[prodIdx].cuePairs[pairIdx]) {
    productions[prodIdx].cuePairs[pairIdx].confidence = level;
    autoSave();
    showProgressDashboard();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROGRESS DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showProgressDashboard() {
  const prod = activeProduction || productions[0];
  if(!prod) { showToast('No script loaded yet!'); return; }
  const screen = document.getElementById('progressDashScreen');
  screen.classList.add('active');
  document.getElementById('dashSubtitle').textContent = prod.myChar + ' â€” ' + prod.cuePairs.length + ' lines';
  renderDashboard(prod);
}

function hideProgressDashboard() {
  document.getElementById('progressDashScreen').classList.remove('active');
}

function renderDashboard(prod) {
  const pairs = prod.cuePairs;
  const prodIdx = productions.indexOf(prod);
  const total = pairs.length;
  const solid = pairs.filter(p => p.confidence === 'solid').length;
  const getting = pairs.filter(p => p.confidence === 'getting').length;
  const shaky = pairs.filter(p => p.confidence === 'shaky').length;
  const unrated = total - solid - getting - shaky;
  const pct = total > 0 ? Math.round((solid / total) * 100) : 0;

  const scenes = prod.scenes && prod.scenes.length > 0 ? prod.scenes : ['All Lines'];

  let html = '<div class="card" style="margin-bottom:16px;">';
  html += '<div style="font-size:28px;font-weight:900;color:var(--terra);">' + pct + '% solid</div>';
  html += '<div style="font-size:13px;color:var(--brown-light);margin-bottom:12px;">' + solid + ' solid Â· ' + getting + ' getting there Â· ' + shaky + ' shaky Â· ' + unrated + ' unrated</div>';
  html += '<div class="scene-progress-bar"><div class="scene-progress-fill" style="width:' + pct + '%"></div></div>';
  html += '</div>';

  html += '<div class="section-title" style="font-size:14px;margin-bottom:12px;">Rate each line â€” tap to update:</div>';

  scenes.forEach(function(scene) {
    const scenePairs = pairs.filter(function(p, i) {
      return (p.scene || scenes[0]) === scene || scenes.length === 1;
    }).map(function(p, i) { return { p: p, idx: pairs.indexOf(p) }; });

    const scPct = scenePairs.length > 0 ? Math.round((scenePairs.filter(function(x){ return x.p.confidence==='solid'; }).length / scenePairs.length) * 100) : 0;

    html += '<div style="margin-bottom:20px;">';
    html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">';
    html += '<div style="background:var(--sage);color:white;border-radius:99px;padding:4px 14px;font-size:11px;font-weight:900;">' + scene + '</div>';
    html += '<div style="font-size:12px;font-weight:800;color:var(--brown-light);">' + scPct + '% solid</div>';
    html += '</div>';

    scenePairs.forEach(function(item) {
      const p = item.p;
      const i = item.idx;
      const conf = p.confidence || 'unrated';
      html += '<div style="background:var(--cream);border-radius:var(--rs);padding:12px 14px;margin-bottom:8px;box-shadow:var(--shadow);">';
      html += '<div style="font-size:12px;color:var(--brown-light);margin-bottom:4px;font-style:italic;">"' + (p.cue.length > 60 ? p.cue.substring(0,60)+'...' : p.cue) + '"</div>';
      html += '<div style="font-size:14px;font-weight:700;margin-bottom:10px;line-height:1.5;">' + p.myLine + '</div>';
      html += '<div style="display:flex;gap:6px;">';
      html += '<button class="conf-pill conf-shaky' + (conf==='shaky'?' active" style="border:2px solid var(--terra);':'"') + ' onclick="setConfidence(' + prodIdx + ',' + i + ',\'shaky\')">ğŸ”´ Shaky</button>';
      html += '<button class="conf-pill conf-getting' + (conf==='getting'?' active" style="border:2px solid var(--amber);':'"') + ' onclick="setConfidence(' + prodIdx + ',' + i + ',\'getting\')">ğŸŸ¡ Getting there</button>';
      html += '<button class="conf-pill conf-solid' + (conf==='solid'?' active" style="border:2px solid var(--sage);':'"') + ' onclick="setConfidence(' + prodIdx + ',' + i + ',\'solid\')">ğŸŸ¢ Solid</button>';
      html += '</div></div>';
    });
    html += '</div>';
  });

  document.getElementById('dashContent').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HANDS-FREE MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let hfPairs = [], hfIndex = 0, hfPaused = false, hfSpeaking = false;

function startHandsFree() {
  const prod = activeProduction || productions[0];
  if(!prod || prod.cuePairs.length === 0) { showToast('No lines to practise!'); return; }
  hfPairs = activeSceneFilter === 'all' ? prod.cuePairs : prod.cuePairs.filter(function(p){ return (p.scene||'Scene 1') === activeSceneFilter; });
  hfIndex = 0;
  hfPaused = false;
  document.getElementById('handsFreeScreen').classList.add('active');
  document.getElementById('hfResult').style.display = 'none';
  hfLoadLine();
  setTimeout(hfReadCue, 500);
}

function stopHandsFree() {
  window.speechSynthesis && window.speechSynthesis.cancel();
  document.getElementById('handsFreeScreen').classList.remove('active');
}

function toggleHFPause() {
  hfPaused = !hfPaused;
  document.getElementById('hfPauseBtn').textContent = hfPaused ? 'â–¶ Resume' : 'â¸ Pause';
  if(!hfPaused) hfReadCue();
}

function hfLoadLine() {
  if(hfIndex >= hfPairs.length) { hfFinish(); return; }
  const pair = hfPairs[hfIndex];
  document.getElementById('hfCueText').textContent = pair.cue;
  document.getElementById('hfProgress').textContent = 'Line ' + (hfIndex+1) + ' of ' + hfPairs.length;
  document.getElementById('hfStatus').textContent = 'Reading cue aloud...';
  document.getElementById('hfResult').style.display = 'none';
  document.getElementById('hfMicBtn').className = 'hf-big-btn idle';
  document.getElementById('hfMicBtn').textContent = 'ğŸ™';
}

function hfReadCue() {
  if(hfPaused || hfIndex >= hfPairs.length) return;
  if(!window.speechSynthesis) { hfMicReady(); return; }
  window.speechSynthesis.cancel();
  const pair = hfPairs[hfIndex];
  document.getElementById('hfMicBtn').className = 'hf-big-btn speaking';
  document.getElementById('hfMicBtn').textContent = 'ğŸ”Š';
  hfSpeaking = true;
  setTimeout(function() {
    const utt = new SpeechSynthesisUtterance(pair.cue);
    utt.rate = 0.9; utt.pitch = 1.1; utt.volume = 1;
    const voices = window.speechSynthesis.getVoices();
    const preferred = voices.find(function(v){ return v.lang.startsWith('en') && v.localService; });
    if(preferred) utt.voice = preferred;
    utt.onend = function() { if(!hfPaused) hfMicReady(); };
    utt.onerror = function() { if(!hfPaused) hfMicReady(); };
    window.speechSynthesis.speak(utt);
  }, 150);
}

function hfMicReady() {
  hfSpeaking = false;
  document.getElementById('hfMicBtn').className = 'hf-big-btn idle';
  document.getElementById('hfMicBtn').textContent = 'ğŸ™';
  document.getElementById('hfStatus').textContent = 'Your turn â€” tap the mic and say your line';
}

function hfMicTap() {
  if(hfSpeaking) { window.speechSynthesis && window.speechSynthesis.cancel(); hfMicReady(); return; }
  if(!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
    showToast('Voice not supported on this browser'); return;
  }
  const btn = document.getElementById('hfMicBtn');
  btn.className = 'hf-big-btn listening';
  btn.textContent = 'ğŸ”´';
  document.getElementById('hfStatus').textContent = 'Listening...';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SR();
  rec.lang = 'en-GB'; rec.continuous = false; rec.interimResults = false;
  rec.onresult = function(e) {
    const spoken = e.results[0][0].transcript;
    btn.className = 'hf-big-btn idle'; btn.textContent = 'ğŸ™';
    hfCheckLine(spoken);
  };
  rec.onerror = function() {
    btn.className = 'hf-big-btn idle'; btn.textContent = 'ğŸ™';
    document.getElementById('hfStatus').textContent = 'Could not hear you â€” try again or tap Got it';
  };
  rec.start();
  setTimeout(function(){ try{rec.stop();}catch(e){} }, 9000);
}

function hfCheckLine(spoken) {
  const correct = hfPairs[hfIndex].myLine;
  const result = compareLines(spoken, correct);
  const resultEl = document.getElementById('hfResult');
  resultEl.style.display = 'block';
  if(result.pct >= 0.85) {
    resultEl.className = 'hf-result good';
    resultEl.textContent = 'âœ… Nailed it! ' + Math.round(result.pct*100) + '% match';
    document.getElementById('hfStatus').textContent = 'Great! Moving to next line...';
    setTimeout(function(){ hfNext('correct'); }, 1500);
  } else if(result.pct >= 0.55) {
    resultEl.className = 'hf-result close';
    resultEl.textContent = '~ Close! ' + Math.round(result.pct*100) + '% â€” you said: "' + spoken + '"';
    document.getElementById('hfStatus').textContent = 'Your line: ' + correct;
  } else {
    resultEl.className = 'hf-result wrong';
    resultEl.textContent = 'âœ— Not quite. You said: "' + spoken + '"';
    document.getElementById('hfStatus').textContent = 'Your line: ' + correct;
  }
}

function hfNext(result) {
  if(result === 'correct') addXP(10);
  hfIndex++;
  if(hfIndex >= hfPairs.length) { hfFinish(); return; }
  hfLoadLine();
  setTimeout(hfReadCue, 400);
}

function hfFinish() {
  document.getElementById('hfStatus').textContent = 'ğŸ‰ All lines done! Amazing work!';
  document.getElementById('hfMicBtn').textContent = 'ğŸ‰';
  document.getElementById('hfMicBtn').className = 'hf-big-btn idle';
  showToast('Hands-Free session complete!');
  addXP(50);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCENE PARTNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let spPairs = [], spIndex = 0, spPaused = false, spMyTurn = false;

function startScenePartner() {
  const prod = activeProduction || productions[0];
  if(!prod || prod.cuePairs.length === 0) { showToast('No lines to practise!'); return; }
  spPairs = activeSceneFilter === 'all' ? prod.cuePairs : prod.cuePairs.filter(function(p){ return (p.scene||'Scene 1') === activeSceneFilter; });
  spIndex = 0; spPaused = false; spMyTurn = false;
  document.getElementById('scenePartnerScreen').classList.add('active');
  document.getElementById('spMyCard').style.display = 'none';
  document.getElementById('spOtherCard').style.display = 'none';
  document.getElementById('spMicBtn').style.display = 'none';
  document.getElementById('spStartBtn').style.display = 'block';
  document.getElementById('spResult').style.display = 'none';
  document.getElementById('spStatus').textContent = 'App will read all other characters\' lines. You speak yours.';
  document.getElementById('spProgress').textContent = '0 of ' + spPairs.length + ' lines';
}

function stopScenePartner() {
  window.speechSynthesis && window.speechSynthesis.cancel();
  document.getElementById('scenePartnerScreen').classList.remove('active');
}

function toggleSPPause() {
  spPaused = !spPaused;
  document.getElementById('spPauseBtn').textContent = spPaused ? 'â–¶ Resume' : 'â¸ Pause';
  if(!spPaused && !spMyTurn) spReadOther();
}

function spStart() {
  document.getElementById('spStartBtn').style.display = 'none';
  spLoadNext();
}

function spLoadNext() {
  if(spIndex >= spPairs.length) { spFinish(); return; }
  const pair = spPairs[spIndex];
  document.getElementById('spProgress').textContent = (spIndex+1) + ' of ' + spPairs.length + ' lines';

  // Show cue (other character's line) and read it aloud
  document.getElementById('spOtherCard').style.display = 'block';
  document.getElementById('spMyCard').style.display = 'none';
  document.getElementById('spMicBtn').style.display = 'none';
  document.getElementById('spResult').style.display = 'none';
  document.getElementById('spOtherChar').textContent = 'OTHER CHARACTER';
  document.getElementById('spOtherText').textContent = pair.cue;
  document.getElementById('spStatus').textContent = 'Reading their line...';
  spMyTurn = false;

  if(!spPaused && window.speechSynthesis) {
    window.speechSynthesis.cancel();
    setTimeout(function() {
      const utt = new SpeechSynthesisUtterance(pair.cue);
      utt.rate = 0.88; utt.pitch = 0.95; utt.volume = 1;
      const voices = window.speechSynthesis.getVoices();
      const preferred = voices.find(function(v){ return v.lang.startsWith('en') && v.localService; });
      if(preferred) utt.voice = preferred;
      utt.onend = function() { if(!spPaused) spShowMyTurn(); };
      utt.onerror = function() { if(!spPaused) spShowMyTurn(); };
      window.speechSynthesis.speak(utt);
    }, 150);
  } else {
    setTimeout(spShowMyTurn, 800);
  }
}

function spShowMyTurn() {
  if(spIndex >= spPairs.length) return;
  const pair = spPairs[spIndex];
  spMyTurn = true;
  document.getElementById('spMyCard').style.display = 'block';
  document.getElementById('spMyChar').textContent = 'ğŸ­ YOUR LINE';
  document.getElementById('spMyText').textContent = '(tap mic to speak, or tap Next)';
  document.getElementById('spMicBtn').style.display = 'block';
  document.getElementById('spMicBtn').className = 'hf-big-btn idle';
  document.getElementById('spMicBtn').textContent = 'ğŸ™';
  document.getElementById('spStatus').textContent = 'Your turn â€” say your line!';
}

function spMicTap() {
  if(!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
    showToast('Voice not supported â€” tap Next to continue');
    return;
  }
  const btn = document.getElementById('spMicBtn');
  btn.className = 'hf-big-btn listening'; btn.textContent = 'ğŸ”´';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SR();
  rec.lang = 'en-GB'; rec.continuous = false; rec.interimResults = false;
  rec.onresult = function(e) {
    const spoken = e.results[0][0].transcript;
    btn.className = 'hf-big-btn idle'; btn.textContent = 'ğŸ™';
    spCheckLine(spoken);
  };
  rec.onerror = function() { btn.className = 'hf-big-btn idle'; btn.textContent = 'ğŸ™'; };
  rec.start();
  setTimeout(function(){ try{rec.stop();}catch(e){} }, 9000);
}

function spCheckLine(spoken) {
  const correct = spPairs[spIndex].myLine;
  const result = compareLines(spoken, correct);
  const resultEl = document.getElementById('spResult');
  resultEl.style.display = 'block';
  document.getElementById('spMyText').textContent = correct;
  if(result.pct >= 0.85) {
    resultEl.className = 'hf-result good';
    resultEl.textContent = 'âœ… ' + Math.round(result.pct*100) + '% â€” moving on!';
    addXP(10);
    setTimeout(function(){ spIndex++; spLoadNext(); }, 1200);
  } else {
    resultEl.className = 'hf-result close';
    resultEl.textContent = 'You said: "' + spoken + '" â€” tap Next when ready';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPEED DRILL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sdPairs = [], sdIndex = 0, sdStartTime = 0, sdTimerInterval = null, sdWrong = 0;

function startSpeedDrill() {
  const prod = activeProduction || productions[0];
  if(!prod || prod.cuePairs.length === 0) { showToast('No lines to practise!'); return; }
  sdPairs = activeSceneFilter === 'all' ? prod.cuePairs : prod.cuePairs.filter(function(p){ return (p.scene||'Scene 1') === activeSceneFilter; });
  sdIndex = 0; sdWrong = 0;
  document.getElementById('speedDrillScreen').classList.add('active');
  document.getElementById('sdFinished').style.display = 'none';
  var bestKey = 'sd-best-' + (prod.myChar || 'char');
  var best = localStorage.getItem(bestKey);
  document.getElementById('sdBest').textContent = best ? 'Best: ' + best + 's for ' + sdPairs.length + ' lines' : 'Best time: not set yet';
  sdLoadLine();
  sdStartTime = Date.now();
  clearInterval(sdTimerInterval);
  sdTimerInterval = setInterval(function() {
    var elapsed = ((Date.now() - sdStartTime) / 1000).toFixed(1);
    document.getElementById('sdTimer').textContent = elapsed + 's';
  }, 100);
}

function stopSpeedDrill() {
  clearInterval(sdTimerInterval);
  document.getElementById('speedDrillScreen').classList.remove('active');
}

function sdLoadLine() {
  if(sdIndex >= sdPairs.length) { sdFinish(); return; }
  const pair = sdPairs[sdIndex];
  document.getElementById('sdProgress').textContent = (sdIndex+1) + ' of ' + sdPairs.length;
  document.getElementById('sdSceneTag').textContent = pair.scene || 'Scene 1';
  document.getElementById('sdCueText').textContent = pair.cue;
  document.getElementById('sdLineText').textContent = pair.myLine;
}

function sdMark(result) {
  if(result === 'wrong') { sdWrong++; if(sdPairs[sdIndex]) sdPairs[sdIndex].needsWork = true; }
  sdIndex++;
  sdLoadLine();
}

function sdFinish() {
  clearInterval(sdTimerInterval);
  var total = ((Date.now() - sdStartTime) / 1000).toFixed(1);
  document.getElementById('sdTimer').textContent = total + 's';
  document.getElementById('sdFinished').style.display = 'block';
  var correct = sdPairs.length - sdWrong;
  document.getElementById('sdFinishStats').textContent = correct + '/' + sdPairs.length + ' lines got Â· ' + total + 's total';
  var prod = activeProduction || productions[0];
  if(prod) {
    var bestKey = 'sd-best-' + (prod.myChar || 'char');
    var best = parseFloat(localStorage.getItem(bestKey)) || 9999;
    if(parseFloat(total) < best) {
      localStorage.setItem(bestKey, total);
      showToast('New personal best! ' + total + 's ğŸ†');
      document.getElementById('sdBest').textContent = 'NEW BEST: ' + total + 's!';
    }
  }
  addXP(correct * 10);
  autoSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  XP + FEEDBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// addXP defined above

function triggerStreak() {
  const el = document.getElementById('streakFx');
  el.classList.add('pop');
  setTimeout(()=>el.classList.remove('pop'), 700);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timeout);
  t._timeout = setTimeout(()=>t.classList.remove('show'), 2600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLOSE DICT ON OUTSIDE CLICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('click', e=>{
  if(!e.target.closest('#dictPop') && !e.target.closest('.clickword')) closeDict();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD SAMPLE SCRIPT ON FIRST VISIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANUAL LINE ENTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let manualPairs = [];
let manualChar = '';
let manualCurrentScene = 'Scene 1';
let manualScenes = ['Scene 1'];
let manualViewingScene = 'all';

function startManualEntry() {
  const name = document.getElementById('manualCharName').value.trim().toUpperCase();
  if(!name) { showToast('Please enter your character name first'); return; }
  manualChar = name;
  manualPairs = [];
  manualCurrentScene = 'Scene 1';
  manualScenes = ['Scene 1'];
  manualViewingScene = 'all';

  const existing = productions.find(p => p.myChar === manualChar && p.isManual);
  if(existing) {
    manualPairs = existing.cuePairs.map(p => ({...p}));
    manualScenes = [...new Set(manualPairs.map(p => p.scene || 'Scene 1'))];
    manualCurrentScene = manualScenes[manualScenes.length - 1];
    showToast('Continuing ' + manualChar + ' -- ' + manualPairs.length + ' lines already saved');
  }

  document.getElementById('manualCharDisplay').textContent = manualChar;
  document.getElementById('manualStep1').style.display = 'none';
  document.getElementById('manualStep2').style.display = 'block';
  document.getElementById('manualCueInput').value = '';
  document.getElementById('manualLineInput').value = '';
  updateSceneBanner();
  refreshManualList();
}

function newScene() {
  // Auto-save any lines typed so far before switching
  saveManualProduction();

  const num = manualScenes.length + 1;
  const defaultName = 'Scene ' + num;
  const banner = document.getElementById('manualSceneBanner');
  banner.style.background = 'var(--brown)';
  banner.innerHTML =
    '<div style="flex:1;">' +
      '<div style="font-size:11px;font-weight:900;opacity:0.85;text-transform:uppercase;letter-spacing:1px;color:white;margin-bottom:6px;">Name this new scene:</div>' +
      '<input id="newSceneInput" value="' + defaultName + '" ' +
        'onkeydown="if(event.key===\'Enter\')confirmNewScene()" ' +
        'style="width:100%;padding:8px 12px;border-radius:var(--rs);border:none;font-family:var(--font);font-size:14px;font-weight:700;color:var(--brown);background:white;">' +
    '</div>' +
    '<button onclick="confirmNewScene()" style="margin-left:10px;background:rgba(255,255,255,0.25);border:none;color:white;border-radius:99px;padding:8px 16px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;white-space:nowrap;">' +
      'âœ… Start' +
    '</button>';
  setTimeout(function() { var el = document.getElementById('newSceneInput'); if(el) { el.select(); el.focus(); } }, 100);
}

function confirmNewScene() {
  var input = document.getElementById('newSceneInput');
  var name = input ? input.value.trim() : '';
  if(!name) { showToast('Please give the scene a name'); return; }
  if(manualScenes.includes(name)) { showToast('A scene with that name already exists'); return; }
  // Save previous scene's lines automatically
  saveManualProduction();
  manualScenes.push(name);
  manualCurrentScene = name;
  manualViewingScene = 'all';
  updateSceneBanner();
  refreshManualList();
  // Clear inputs ready for new scene
  document.getElementById('manualCueInput').value = '';
  document.getElementById('manualLineInput').value = '';
  showToast('Scene saved! Now entering: ' + name);
  document.getElementById('manualCueInput').focus();
}

function updateSceneBanner() {
  var banner = document.getElementById('manualSceneBanner');
  banner.style.background = 'var(--sage)';
  banner.innerHTML =
    '<div>' +
      '<div style="font-size:11px;font-weight:900;opacity:0.85;text-transform:uppercase;letter-spacing:1px;">Currently entering:</div>' +
      '<div style="font-size:15px;font-weight:900;" id="manualSceneBannerName">' + manualCurrentScene + '</div>' +
    '</div>' +
    '<button onclick="newScene()" style="background:rgba(255,255,255,0.25);border:none;color:white;border-radius:99px;padding:8px 16px;font-family:var(--font);font-weight:900;font-size:12px;cursor:pointer;">' +
      '+ New Scene' +
    '</button>';
  var el = document.getElementById('manualCurrentSceneName');
  if(el) el.textContent = manualCurrentScene;
}

function switchScene(scene) {
  manualCurrentScene = scene;
  updateSceneBanner();
  showToast('Switched to: ' + scene);
}

function addManualLine() {
  var cue = document.getElementById('manualCueInput').value.trim();
  var line = document.getElementById('manualLineInput').value.trim();
  if(!line) { showToast('Your line is missing! The cue is what the other person says before you'); return; }
  manualPairs.push({ cue: cue || '(start of scene)', myLine: line, scene: manualCurrentScene, needsWork: false });
  document.getElementById('manualCueInput').value = '';
  document.getElementById('manualLineInput').value = '';
  document.getElementById('manualCueInput').focus();
  document.getElementById('manualLineCount').textContent = manualPairs.length;
  var sceneLines = manualPairs.filter(function(p) { return p.scene === manualCurrentScene; }).length;
  showToast('Line ' + manualPairs.length + ' added to ' + manualCurrentScene + ' (' + sceneLines + ' in this scene)');
  refreshManualList();
  saveManualProduction();
}

function refreshManualList() {
  var list = document.getElementById('manualLinesList');
  var inner = document.getElementById('manualLinesListInner');
  var tabsEl = document.getElementById('manualSceneTabs');
  document.getElementById('manualLineCount').textContent = manualPairs.length;
  if(manualPairs.length === 0) { list.style.display = 'none'; return; }
  list.style.display = 'block';

  var allScenes = [];
  manualPairs.forEach(function(p) {
    var sc = p.scene || 'Scene 1';
    if(!allScenes.includes(sc)) allScenes.push(sc);
  });

  var tabHTML = '<button class="tool-btn ' + (manualViewingScene==='all'?'active':'') + '" onclick="filterManualScene(\'all\')">All (' + manualPairs.length + ')</button>';
  allScenes.forEach(function(s) {
    var count = manualPairs.filter(function(p){ return (p.scene||'Scene 1')===s; }).length;
    tabHTML += '<button class="tool-btn ' + (manualViewingScene===s?'active':'') + '" onclick="filterManualScene(\'' + s + '\')">' + s + ' (' + count + ')</button>';
  });
  tabsEl.innerHTML = tabHTML;

  var toShow = manualViewingScene === 'all' ? manualPairs : manualPairs.filter(function(p){ return (p.scene||'Scene 1') === manualViewingScene; });

  var grouped = {};
  toShow.forEach(function(p) {
    var sc = p.scene || 'Scene 1';
    if(!grouped[sc]) grouped[sc] = [];
    grouped[sc].push({cue:p.cue, myLine:p.myLine, scene:p.scene, globalIdx: manualPairs.indexOf(p)});
  });

  var html = '';
  Object.keys(grouped).forEach(function(scene) {
    var pairs = grouped[scene];
    html += '<div style="margin-bottom:20px;">';
    html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">';
    html += '<div style="background:var(--sage);color:white;border-radius:99px;padding:4px 14px;font-size:11px;font-weight:900;">Scene: ' + scene + '</div>';
    html += '<button onclick="switchScene(\'' + scene + '\')" style="background:none;border:2px solid var(--sage);color:var(--sage);border-radius:99px;padding:4px 12px;font-size:10px;font-weight:900;cursor:pointer;font-family:var(--font);">+ Add lines here</button>';
    html += '</div>';

    pairs.forEach(function(p, i) {
      // Insert before button
      html += '<div style="text-align:center;margin:4px 0;">';
      html += '<button onclick="insertLineAt(' + p.globalIdx + ')" style="background:none;border:1px dashed var(--sand-dark);color:var(--brown-light);border-radius:99px;padding:3px 14px;font-size:10px;font-weight:700;cursor:pointer;font-family:var(--font);">+ insert line here</button>';
      html += '</div>';

      // Line card
      html += '<div style="background:var(--cream);border-radius:var(--rs);padding:14px 16px;margin-bottom:4px;box-shadow:var(--shadow);">';

      // Cue row
      html += '<div style="font-size:10px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Cue:</div>';
      html += '<div style="font-size:12px;color:var(--brown-light);margin-bottom:8px;font-style:italic;line-height:1.5;">"' + escapeHtml(p.cue) + '"</div>';

      // My line row
      html += '<div style="font-size:14px;font-weight:700;border-left:4px solid var(--terra);padding-left:10px;line-height:1.6;margin-bottom:12px;">' + escapeHtml(p.myLine) + '</div>';

      // Action buttons
      html += '<div style="display:flex;gap:8px;">';
      html += '<button onclick="editLineAt(' + p.globalIdx + ')" style="flex:1;background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:7px 0;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--brown);">âœï¸ Edit</button>';
      html += '<button onclick="moveLineUp(' + p.globalIdx + ')" ' + (p.globalIdx===0?'disabled':'') + ' style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:7px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--brown);">â†‘</button>';
      html += '<button onclick="moveLineDown(' + p.globalIdx + ')" ' + (p.globalIdx===manualPairs.length-1?'disabled':'') + ' style="background:var(--sand);border:2px solid var(--sand-dark);border-radius:99px;padding:7px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--brown);">â†“</button>';
      html += '<button onclick="deleteManualLine(' + p.globalIdx + ')" style="background:#F5D0CA;border:none;border-radius:99px;padding:7px 12px;font-size:11px;font-weight:900;cursor:pointer;font-family:var(--font);color:var(--terra-dark);">ğŸ—‘ Delete</button>';
      html += '</div>';
      html += '</div>';
    });

    // Insert at end of scene
    html += '<div style="text-align:center;margin:4px 0 8px;">';
    html += '<button onclick="switchScene(\'' + scene + '\')" style="background:none;border:1px dashed var(--sand-dark);color:var(--brown-light);border-radius:99px;padding:3px 14px;font-size:10px;font-weight:700;cursor:pointer;font-family:var(--font);">+ insert line at end of ' + scene + '</button>';
    html += '</div>';
    html += '</div>';
  });
  inner.innerHTML = html;
}

function escapeHtml(str) {
  if(!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function filterManualScene(scene) {
  manualViewingScene = scene;
  refreshManualList();
}

function deleteManualLine(idx) {
  if(!confirm('Delete this line? This cannot be undone.')) return;
  manualPairs.splice(idx, 1);
  refreshManualList();
  saveManualProduction();
  showToast('Line deleted');
}

function moveLineUp(idx) {
  if(idx === 0) return;
  var tmp = manualPairs[idx-1];
  manualPairs[idx-1] = manualPairs[idx];
  manualPairs[idx] = tmp;
  refreshManualList();
  saveManualProduction();
}

function moveLineDown(idx) {
  if(idx >= manualPairs.length-1) return;
  var tmp = manualPairs[idx+1];
  manualPairs[idx+1] = manualPairs[idx];
  manualPairs[idx] = tmp;
  refreshManualList();
  saveManualProduction();
}

// Insert a blank line BEFORE the given index
function insertLineAt(idx) {
  // Show the edit modal in insert mode
  openLineModal(null, idx, manualPairs[idx] ? manualPairs[idx].scene : manualCurrentScene);
}

// Edit an existing line
function editLineAt(idx) {
  openLineModal(idx, null, manualPairs[idx].scene);
}

// Single modal for both edit and insert
function openLineModal(editIdx, insertBeforeIdx, scene) {
  var existing = editIdx !== null ? manualPairs[editIdx] : null;
  var modal = document.getElementById('lineEditModal');
  if(!modal) {
    modal = document.createElement('div');
    modal.id = 'lineEditModal';
    modal.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(74,55,40,0.55);z-index:300;align-items:flex-end;justify-content:center;';
    modal.innerHTML =
      '<div style="background:var(--cream);border-radius:var(--r) var(--r) 0 0;padding:28px 22px 44px;width:100%;max-width:580px;animation:slideUp 0.3s ease;">' +
        '<div id="lineModalTitle" style="font-size:18px;font-weight:900;margin-bottom:18px;"></div>' +
        '<div style="font-size:12px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Cue â€” what they say before you:</div>' +
        '<textarea id="lineModalCue" class="paste-area" style="min-height:70px;margin-bottom:14px;"></textarea>' +
        '<div style="font-size:12px;font-weight:900;color:var(--terra);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Your line:</div>' +
        '<textarea id="lineModalLine" class="paste-area" style="min-height:70px;border-color:var(--terra);margin-bottom:18px;"></textarea>' +
        '<div style="display:flex;gap:10px;">' +
          '<button onclick="saveLineModal()" style="flex:2;background:var(--terra);color:white;border:none;border-radius:var(--rs);padding:14px;font-family:var(--font);font-weight:900;font-size:14px;cursor:pointer;">âœ… Save</button>' +
          '<button onclick="closeLineModal()" style="flex:1;background:var(--sand);color:var(--brown);border:2px solid var(--sand-dark);border-radius:var(--rs);padding:14px;font-family:var(--font);font-weight:900;font-size:14px;cursor:pointer;">Cancel</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(modal);
  }

  modal._editIdx = editIdx;
  modal._insertBeforeIdx = insertBeforeIdx;
  modal._scene = scene;

  document.getElementById('lineModalTitle').textContent = existing ? 'Edit Line' : 'Insert New Line';
  document.getElementById('lineModalCue').value = existing ? existing.cue : '';
  document.getElementById('lineModalLine').value = existing ? existing.myLine : '';
  modal.style.display = 'flex';
  setTimeout(function(){ document.getElementById('lineModalCue').focus(); }, 100);
}

function closeLineModal() {
  var modal = document.getElementById('lineEditModal');
  if(modal) modal.style.display = 'none';
}

function saveLineModal() {
  var modal = document.getElementById('lineEditModal');
  var cue = document.getElementById('lineModalCue').value.trim();
  var line = document.getElementById('lineModalLine').value.trim();
  if(!line) { showToast('Your line cannot be empty!'); return; }

  var newPair = {
    cue: cue || '(start of scene)',
    myLine: line,
    scene: modal._scene || manualCurrentScene,
    needsWork: false
  };

  if(modal._editIdx !== null) {
    // Edit existing
    manualPairs[modal._editIdx] = newPair;
    showToast('Line updated');
  } else {
    // Insert before index
    manualPairs.splice(modal._insertBeforeIdx, 0, newPair);
    showToast('Line inserted');
  }

  closeLineModal();
  refreshManualList();
  saveManualProduction();
}

function saveManualProduction() {
  if(manualPairs.length === 0) return;
  var scriptData = [];
  manualPairs.forEach(function(p) {
    scriptData.push({ char: 'OTHER', text: p.cue, mine: false, scene: p.scene });
    scriptData.push({ char: manualChar, text: p.myLine, mine: true, scene: p.scene });
  });
  var existingIdx = productions.findIndex(function(p) { return p.myChar === manualChar && p.isManual; });
  var sceneList = [];
  manualPairs.forEach(function(p) { var s = p.scene||'Scene 1'; if(!sceneList.includes(s)) sceneList.push(s); });
  var prod = {
    name: manualChar + ' (Manual)',
    role: manualChar,
    type: 'T',
    scriptData: scriptData,
    cuePairs: manualPairs.map(function(p){ return Object.assign({},p); }),
    scenes: sceneList,
    myChar: manualChar,
    isManual: true,
    id: existingIdx >= 0 ? productions[existingIdx].id : Date.now(),
    progress: existingIdx >= 0 ? productions[existingIdx].progress : 0
  };
  if(existingIdx >= 0) productions[existingIdx] = prod;
  else productions.push(prod);
  activeProduction = prod;
  refreshHome();
  refreshProductionsList();
  refreshPracticeScreen();
  autoSave();
}

function finishManualEntry() {
  if(manualPairs.length === 0) { showToast('Add at least one line first!'); return; }
  saveManualProduction();
  autoSave();
  document.getElementById('manualStep1').style.display = 'block';
  document.getElementById('manualStep2').style.display = 'none';
  document.getElementById('manualCharName').value = '';
  manualPairs = [];
  manualCurrentScene = 'Scene 1';
  manualScenes = ['Scene 1'];
  showToast('All lines saved for ' + manualChar + '!');
  setTimeout(function() { navTo('practiceScreen', 2); }, 800);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYNC â€” Real cross-device sync via JSONBin
//  Works on GitHub Pages, phone, computer, anywhere
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYNC_KEY = 'escomind-sync-id';
const SYNC_API  = 'https://api.jsonbin.io/v3/b';

// Keys stored under a stable name that never changes between app versions
let syncBinId  = localStorage.getItem('escomind-bin-id') || localStorage.getItem(SYNC_KEY) || null;
let syncApiKey = localStorage.getItem('escomind-api-key') || null;
let isSyncing  = false;

// Always persist keys immediately when set
function persistSyncKeys() {
  if(syncBinId)  { localStorage.setItem('escomind-bin-id', syncBinId);  localStorage.setItem(SYNC_KEY, syncBinId); }
  if(syncApiKey) { localStorage.setItem('escomind-api-key', syncApiKey); }
}

function getDataObject() {
  return {
    productions,
    totalXP,
    dayStreak,
    earnedBadges,
    linesCorrectToday,
    lastPlayDate,
    savedAt: new Date().toISOString()
  };
}

function applyLoadedData(data) {
  if(data.productions && data.productions.length > 0) productions = data.productions;
  if(data.totalXP !== undefined) totalXP = data.totalXP;
  if(data.dayStreak !== undefined) dayStreak = data.dayStreak;
  if(data.earnedBadges) earnedBadges = data.earnedBadges;
  if(data.linesCorrectToday !== undefined) linesCorrectToday = data.linesCorrectToday;
  if(data.lastPlayDate) lastPlayDate = data.lastPlayDate;
  if(productions.length > 0) activeProduction = productions[0];
  refreshHome();
  refreshProductionsList();
  refreshPracticeScreen();
  updateXPDisplays();
}

// Always save to localStorage immediately
function saveLocal() {
  try {
    localStorage.setItem('escomind-local', JSON.stringify(getDataObject()));
  } catch(e) {}
}

function loadLocal() {
  try {
    const d = localStorage.getItem('escomind-local');
    if(d) { applyLoadedData(JSON.parse(d)); return true; }
  } catch(e) {}
  return false;
}

// Cloud sync â€” only runs if user has set up a sync code
async function saveToCloud() {
  saveLocal();
  if(!syncBinId || !syncApiKey) { showSyncStatus('Saved locally', 'var(--sage)'); return; }
  if(isSyncing) return;
  isSyncing = true;
  showSyncStatus('Syncing...', 'var(--brown-light)');
  try {
    const res = await fetch(SYNC_API + '/' + syncBinId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Master-Key': syncApiKey },
      body: JSON.stringify(getDataObject())
    });
    if(res.ok) {
      showSyncStatus('Synced across devices', 'var(--sage)');
    } else {
      showSyncStatus('Sync error â€” saved locally', 'var(--amber)');
    }
  } catch(e) {
    showSyncStatus('Offline â€” saved locally', 'var(--amber)');
  }
  isSyncing = false;
}

async function loadFromCloud() {
  // Always load local first so app works instantly
  loadLocal();
  if(!syncBinId || !syncApiKey) {
    showSyncStatus('No sync set up', 'var(--brown-light)');
    return;
  }
  showSyncStatus('Loading from cloud...', 'var(--brown-light)');
  try {
    const res = await fetch(SYNC_API + '/' + syncBinId + '/latest', {
      headers: { 'X-Master-Key': syncApiKey }
    });
    if(res.ok) {
      const json = await res.json();
      const cloudData = json.record;
      // Use cloud data if it's newer than local
      const local = localStorage.getItem('escomind-local');
      let useCloud = true;
      if(local) {
        const localData = JSON.parse(local);
        const localTime = localData.savedAt ? new Date(localData.savedAt).getTime() : 0;
        const cloudTime = cloudData.savedAt ? new Date(cloudData.savedAt).getTime() : 0;
        useCloud = cloudTime > localTime;
      }
      if(useCloud) {
        applyLoadedData(cloudData);
        saveLocal();
        showSyncStatus('Synced ' + getTimeAgo(new Date(cloudData.savedAt)), 'var(--sage)');
      } else {
        showSyncStatus('Up to date', 'var(--sage)');
      }
    } else {
      showSyncStatus('Cloud unavailable', 'var(--amber)');
    }
  } catch(e) {
    showSyncStatus('Offline â€” using local data', 'var(--amber)');
  }
}

async function createSyncBin() {
  if(!syncApiKey) { showToast('Enter your API key first'); return; }
  showSyncStatus('Creating sync...', 'var(--brown-light)');
  try {
    const res = await fetch(SYNC_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': syncApiKey,
        'X-Bin-Name': 'escomind-data',
        'X-Bin-Private': 'true'
      },
      body: JSON.stringify(getDataObject())
    });
    if(res.ok) {
      const json = await res.json();
      syncBinId = json.metadata.id;
      persistSyncKeys();
      showSyncStatus('Sync created!', 'var(--sage)');
      showToast('Sync set up! Copy your Bin ID: ' + syncBinId);
      refreshSyncUI();
    } else {
      showToast('Could not create sync â€” check your API key');
      showSyncStatus('Setup failed', 'var(--terra)');
    }
  } catch(e) {
    showToast('Network error â€” check your connection');
  }
}

function connectExistingBin(binId) {
  if(!binId || !syncApiKey) { showToast('Enter both your API key and Bin ID'); return; }
  syncBinId = binId.trim();
  persistSyncKeys();
  loadFromCloud().then(function() {
    showToast('Connected! Your data is loading...');
    refreshSyncUI();
  });
}

function disconnectSync() {
  syncBinId = null;
  syncApiKey = null;
  localStorage.removeItem(SYNC_KEY);
  localStorage.removeItem('escomind-api-key');
  showSyncStatus('Sync disconnected', 'var(--brown-light)');
  refreshSyncUI();
  showToast('Sync disconnected â€” data still saved locally');
}

function refreshSyncUI() {
  const el = document.getElementById('syncSetupArea');
  if(!el) return;
  if(syncBinId && syncApiKey) {
    el.innerHTML =
      '<div style="background:rgba(122,158,126,0.15);border-radius:var(--rs);padding:14px 16px;margin-bottom:12px;">' +
        '<div style="font-size:13px;font-weight:900;color:var(--sage-dark);margin-bottom:4px;">Sync active</div>' +
        '<div style="font-size:11px;color:var(--brown-light);margin-bottom:8px;">Bin ID: <code style="background:var(--sand);padding:2px 6px;border-radius:4px;">' + syncBinId + '</code></div>' +
        '<div style="font-size:11px;color:var(--brown-light);">Your data syncs automatically across all your devices.</div>' +
      '</div>' +
      '<button onclick="loadFromCloud()" class="btn btn-sage btn-sm" style="margin-bottom:8px;width:100%;">Force sync now</button>' +
      '<button onclick="disconnectSync()" class="btn btn-ghost btn-sm" style="width:100%;font-size:11px;">Disconnect sync</button>';
  } else {
    el.innerHTML =
      '<div style="font-size:13px;color:var(--brown-light);margin-bottom:12px;line-height:1.6;">' +
        'To sync across devices you need a free JSONBin account.<br>' +
        '<a href="https://jsonbin.io" target="_blank" style="color:var(--terra);font-weight:800;">1. Sign up free at jsonbin.io</a><br>' +
        '2. Copy your Master Key from the dashboard<br>' +
        '3. Paste it below and tap Set Up Sync' +
      '</div>' +
      '<input id="apiKeyInput" class="char-input" placeholder="Paste your JSONBin Master Key here" style="margin-bottom:10px;" value="' + (syncApiKey||'') + '" oninput="syncApiKey=this.value">' +
      '<button onclick="createSyncBin()" class="btn btn-terra" style="margin-bottom:8px;">â˜ï¸ Set Up Sync (first time)</button>' +
      '<div style="font-size:12px;font-weight:800;margin:10px 0 6px;color:var(--brown-light);">Already set up on another device?</div>' +
      '<input id="binIdInput" class="char-input" placeholder="Paste your Bin ID here" style="margin-bottom:10px;">' +
      '<button onclick="connectExistingBin(document.getElementById(\'binIdInput\').value)" class="btn btn-sage">ğŸ”— Connect to Existing Sync</button>';
  }
}

function getTimeAgo(date) {
  if(!date) return '';
  const mins = Math.floor((Date.now() - date.getTime()) / 60000);
  if(mins < 1) return 'just now';
  if(mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins/60);
  if(hrs < 24) return hrs + 'h ago';
  return Math.floor(hrs/24) + 'd ago';
}

function showSyncStatus(msg, color) {
  const el = document.getElementById('syncStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.color = color;
  el.style.opacity = '1';
  clearTimeout(el._t);
  el._t = setTimeout(function() { el.style.opacity = '0.4'; }, 3000);
}

function saveData() { saveToCloud(); }

let _saveTimeout = null;
function autoSave() {
  saveLocal(); // save locally immediately
  clearTimeout(_saveTimeout);
  _saveTimeout = setTimeout(saveToCloud, 2000); // cloud after short delay
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT PRODUCTION â€” add lines/scenes to existing script
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function editProduction(idx) {
  const prod = productions[idx];
  if(!prod || !prod.isManual) { showToast('Only manually entered scripts can be edited here'); return; }
  activeProduction = prod;
  // Load into manual entry
  manualChar = prod.myChar;
  manualPairs = prod.cuePairs.map(function(p) { return Object.assign({}, p); });
  manualScenes = prod.scenes && prod.scenes.length > 0 ? prod.scenes.slice() : ['Scene 1'];
  manualCurrentScene = manualScenes[manualScenes.length - 1];
  manualViewingScene = 'all';
  // Switch to manual tab
  navTo('scriptScreen', 1);
  setTimeout(function() {
    var tabs = document.querySelectorAll('.itab');
    tabs.forEach(function(t) { t.classList.remove('active'); });
    tabs[2].classList.add('active');
    var panels = document.querySelectorAll('.import-panel');
    panels.forEach(function(p) { p.classList.remove('active'); });
    document.getElementById('manualPanel').classList.add('active');
    document.getElementById('manualCharName').value = prod.myChar;
    document.getElementById('manualStep1').style.display = 'none';
    document.getElementById('manualStep2').style.display = 'block';
    document.getElementById('manualCharDisplay').textContent = manualChar;
    document.getElementById('manualCueInput').value = '';
    document.getElementById('manualLineInput').value = '';
    updateSceneBanner();
    refreshManualList();
    showToast('Editing ' + prod.myChar + ' â€” add more lines or scenes');
  }, 200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP STARTUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.addEventListener('load', async function() {
  // Add sync indicator to home header
  var header = document.querySelector('#homeScreen .app-header');
  if(header) {
    var syncEl = document.createElement('div');
    syncEl.id = 'syncStatus';
    syncEl.style.cssText = 'font-size:10px;font-weight:700;color:var(--brown-light);transition:opacity 0.5s;opacity:0.4;max-width:110px;text-align:right;line-height:1.3;';
    syncEl.textContent = 'Loading...';
    header.appendChild(syncEl);
  }

  // Load saved theme
  loadSavedTheme();

  // Load data (localStorage first, cloud on top)
  await loadFromCloud();

  // Update streak
  updateDayStreak();

  // Show sync UI state
  refreshSyncUI();

  // Build sample fallback for games
  rawScriptText = sampleScript;
  var lines = sampleScript.split('\n');
  var parsed = [];
  var curr = null, txt = [];
  function flush2(){ if(curr && txt.length){ parsed.push({char:curr, text:txt.join(' ').trim(), mine:curr==='PUCK'}); txt=[]; } }
  lines.forEach(function(l) {
    var t = l.trim();
    if(!t) return;
    if(/^[A-Z]{2,}$/.test(t)) { flush2(); curr=t; }
    else if(curr) txt.push(t);
  });
  flush2();
  var cps = [];
  for(var i=0; i<parsed.length; i++) {
    if(parsed[i].mine) cps.push({cue: i>0 ? parsed[i-1].text : 'Begin', myLine: parsed[i].text});
  }
  window._sampleProd = {name:'Sample', role:'PUCK', type:'T', scriptData:parsed, cuePairs:cps, myChar:'PUCK', id:0, progress:0};
});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MORE MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAKRA SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CHAKRAS = [
  {
    id: 'root', num: 1, name: 'Root', sanskrit: 'Muladhara', color: '#C62828', emoji: 'ğŸ”´',
    location: 'Base of Spine', element: 'Earth', mantra: 'LAM',
    mudra: 'Thumb and index fingers touch. Arms straight, hands on knees.',
    theme: 'Survival, Grounding, Security',
    balanced: ['Grounded','Secure','Independent','Trusting','Alive','Physically strong'],
    overactive: ['Bossy','Domineering','Greedy','Rigid','Resistant to change','Controlling'],
    blocked: ['Fearful','Anxious','Insecure','Financially stressed','Disconnected from body'],
    actingNote: 'Where does your character carry their body weight? Do they feel rooted or like they might float away? Root energy shows in the hips, legs and feet â€” how they stand, sit and move through space.',
    activation: [
      'Stand barefoot and feel the floor â€” bring this to every entrance your character makes',
      'Stomp the feet gently before entering a scene to awaken root energy',
      'Breathe deeply into the belly and pelvis â€” let the exhale drop weight into the ground',
      'Red visualisation: imagine red light glowing at the base of the spine',
      'Mantra: chant LAM three times before stepping into character'
    ]
  },
  {
    id: 'sacral', num: 2, name: 'Sacral', sanskrit: 'Svadhisthana', color: '#E65100', emoji: 'ğŸŸ ',
    location: 'Below Navel / Hips', element: 'Water', mantra: 'VAM',
    mudra: 'Palms facing up in lap, right palm resting on top of left.',
    theme: 'Creativity, Emotion, Sensuality, Pleasure',
    balanced: ['Passionate','Creative','Emotionally expressive','Playful','Naturally fluid'],
    overactive: ['Manipulative','Emotionally overwhelming','Craving','Boundary-less','Obsessive'],
    blocked: ['Emotionally shut down','Guilty','Creatively blocked','Rigid in movement','Afraid of intimacy'],
    actingNote: 'The sacral lives in the hips and lower belly. A character with open sacral energy moves fluidly and expressively. A blocked sacral creates physical rigidity, shame about the body, or emotional walls that keep others out.',
    activation: [
      'Roll the hips in slow circles â€” find where your character holds tension or freedom here',
      'Let your character sway or shift weight side to side as they listen',
      'Orange visualisation: warm orange light flowing through the pelvis',
      'Improvise with water â€” how does your character move through a room like water or resist it?',
      'Mantra: chant VAM to open creative flow before emotional scenes'
    ]
  },
  {
    id: 'solar', num: 3, name: 'Solar Plexus', sanskrit: 'Manipura', color: '#F9A825', emoji: 'ğŸŸ¡',
    location: 'Upper Abdomen / Core', element: 'Fire', mantra: 'RAM',
    mudra: 'Hands between heart and stomach, fingers interlaced, thumbtips touching.',
    theme: 'Willpower, Confidence, Purpose, Identity',
    balanced: ['Confident','Purposeful','Self-directed','Decisive','Energetic','Owns their power'],
    overactive: ['Controlling','Judgmental','Aggressive','Needs to be right','Bullying','Arrogant'],
    blocked: ['Powerless','Low self-worth','Procrastinating','Easily dominated','Apathetic','Victim mindset'],
    actingNote: 'The gut and core are the seat of willpower. A character with strong solar energy stands tall and acts with conviction â€” their core is engaged. A blocked solar shows as collapsed posture, hesitation, or an inability to make decisions.',
    activation: [
      'Pull the navel gently toward the spine â€” notice how this changes your character\'s presence',
      'Stand in a power pose for 2 minutes before scenes where your character needs authority',
      'Yellow visualisation: a fire burning in the solar plexus, growing brighter with each breath',
      'Ask: what does this character WANT? Connect every action to a clear want',
      'Mantra: chant RAM to ignite determination and confidence'
    ]
  },
  {
    id: 'heart', num: 4, name: 'Heart', sanskrit: 'Anahata', color: '#2E7D32', emoji: 'ğŸ’š',
    location: 'Heart Centre / Chest', element: 'Air', mantra: 'YAM',
    mudra: 'Right hand: index and thumb touching at heart centre. Left hand same, resting on knee.',
    theme: 'Love, Compassion, Connection, Grief',
    balanced: ['Loving','Empathetic','Forgiving','Open','Generous','Genuinely connected'],
    overactive: ['Possessive','Jealous','Smothering','Gives too much','Martyrdom','Codependent'],
    blocked: ['Closed off','Fearful of rejection','Grieving','Isolated','Unable to receive love'],
    actingNote: 'The heart chakra lives in the chest and arms. Open heart energy means the character reaches toward others â€” arms open, chest lifted. Blocked heart energy shows as arms folded, chest collapsed, or a character who cannot be touched or moved.',
    activation: [
      'Open the chest: roll the shoulders back, lift the sternum â€” notice how this changes your character\'s availability',
      'Before scenes of love or loss, place a hand on your own heart and breathe',
      'Green visualisation: warm green light expanding from the chest with each breath',
      'Find what your character loves most â€” and let that love be physically present in every scene',
      'Mantra: chant YAM to open the heart before emotionally vulnerable scenes'
    ]
  },
  {
    id: 'throat', num: 5, name: 'Throat', sanskrit: 'Vishuddha', color: '#1565C0', emoji: 'ğŸ”µ',
    location: 'Throat and Neck', element: 'Ether / Space', mantra: 'HAM',
    mudra: 'Hands by stomach, fingers interlaced, thumbtips touching, focus on throat.',
    theme: 'Expression, Truth, Communication, Voice',
    balanced: ['Speaks truth','Articulate','Creative','Heard and understood','Authentic voice'],
    overactive: ['Speaks over others','Lectures','Dominates','Harsh','Interrupts','Gossips'],
    blocked: ['Voiceless','Timid','Swallows words','Afraid to speak truth','Suppressed creativity'],
    actingNote: 'The throat is the bridge between inner world and outer expression. Does your character speak their truth or swallow it? Throat tension, a quiet voice, or speaking over others are all throat chakra signals that inform physical performance.',
    activation: [
      'Hum gently â€” feel the vibration in the throat and chest; bring this resonance to your character\'s voice',
      'Lengthen the back of the neck â€” this opens the throat energetically',
      'Blue visualisation: clear blue light at the throat, expanding with each exhale',
      'Speak your character\'s most important line as a whisper, then as a shout â€” find where the truth lives',
      'Mantra: chant HAM to clear and activate the voice before speaking-heavy scenes'
    ]
  },
  {
    id: 'thirdeye', num: 6, name: 'Third Eye', sanskrit: 'Ajna', color: '#4527A0', emoji: 'ğŸŸ£',
    location: 'Centre of Forehead', element: 'Light', mantra: 'AUM',
    mudra: 'Hands in front of lower chest, middle fingers pointing up and touching, other fingers bent.',
    theme: 'Intuition, Vision, Wisdom, Clarity',
    balanced: ['Intuitive','Perceptive','Clear purpose','Imaginative','Sees the big picture'],
    overactive: ['Lost in fantasy','Disconnected from reality','Overthinking','Delusional','Spaced out'],
    blocked: ['Confused about purpose','Easily misled','Doubts intuition','Short-sighted','Rigid thinking'],
    actingNote: 'Third eye energy is about how the character sees the world â€” literally and metaphorically. Do they have clarity and vision, or are they lost and confused? This shows in the quality of attention, where the eyes focus, and whether the character seems truly present.',
    activation: [
      'Soften your gaze â€” let the eyes receive rather than search; this is the quality of deep intuitive seeing',
      'Before a scene, close the eyes and ask: what does my character KNOW that they cannot explain?',
      'Indigo visualisation: a deep purple light at the centre of the forehead',
      'Trust your first instinct in every scene â€” the third eye is your character\'s gut wisdom',
      'Mantra: chant AUM (OM) to deepen presence and perceptive clarity'
    ]
  },
  {
    id: 'crown', num: 7, name: 'Crown', sanskrit: 'Sahasrara', color: '#6A1B9A', emoji: 'ğŸ‘‘',
    location: 'Top of Head', element: 'Thought / Consciousness', mantra: 'ANG',
    mudra: 'Hands in front of stomach, fingers interlaced, little fingers pointing upward.',
    theme: 'Spirituality, Connection, Transcendence, Meaning',
    balanced: ['Connected to purpose','Wise','Compassionate','Joyful','Part of something bigger'],
    overactive: ['Spiritually obsessed','Needs to be special','Disconnected from body','Grandiose'],
    blocked: ['Disconnected','No sense of meaning','Spiritually cut off','Lonely','Cynical'],
    actingNote: 'Crown energy is about your character\'s relationship with something bigger than themselves â€” whether that is God, fate, love, community or meaning. Does your character feel part of something or completely alone in the universe? This is the philosophical spine of the role.',
    activation: [
      'Imagine a thread of light from the crown connecting upward â€” let this lift your character\'s entire posture',
      'Ask: what does my character believe in? Even if broken, even if lost â€” what do they reach for?',
      'Violet visualisation: a thousand-petalled lotus blooming at the crown',
      'Find the spiritual or philosophical core of your character\'s worldview â€” let it inform every choice',
      'Mantra: chant ANG to connect with higher purpose and transcendent awareness'
    ]
  }
];

// Scored quiz questions (5 per chakra = 35 total, scored 1-4)
const CHAKRA_QUIZ = [
  // ROOT (0-4)
  { chakra: 'root', q: 'My character feels physically safe and secure in their world', reverse: false },
  { chakra: 'root', q: 'My character is comfortable in their own body', reverse: false },
  { chakra: 'root', q: 'My character has a stable relationship with money, home, and survival', reverse: false },
  { chakra: 'root', q: 'My character is driven by fear, anxiety, or the need to survive', reverse: true },
  { chakra: 'root', q: 'My character feels grounded â€” they have weight and presence', reverse: false },
  // SACRAL (5-9)
  { chakra: 'sacral', q: 'My character expresses their emotions freely and openly', reverse: false },
  { chakra: 'sacral', q: 'My character has a rich creative or sensual inner life', reverse: false },
  { chakra: 'sacral', q: 'My character is emotionally shut down, guilty, or ashamed', reverse: true },
  { chakra: 'sacral', q: 'My character connects easily and warmly with other people', reverse: false },
  { chakra: 'sacral', q: 'My character uses emotion or desire to manipulate others', reverse: true },
  // SOLAR (10-14)
  { chakra: 'solar', q: 'My character knows what they want and pursues it with conviction', reverse: false },
  { chakra: 'solar', q: 'My character has strong self-worth and confidence', reverse: false },
  { chakra: 'solar', q: 'My character feels powerless, dominated, or easily walked over', reverse: true },
  { chakra: 'solar', q: 'My character is controlling, judgmental, or needs to be in charge', reverse: true },
  { chakra: 'solar', q: 'My character has a clear sense of personal identity and purpose', reverse: false },
  // HEART (15-19)
  { chakra: 'heart', q: 'My character gives and receives love openly', reverse: false },
  { chakra: 'heart', q: 'My character is empathetic and genuinely cares about others', reverse: false },
  { chakra: 'heart', q: 'My character is closed off, guarded, or afraid of being hurt', reverse: true },
  { chakra: 'heart', q: 'My character carries grief, loneliness, or a sense of being unloved', reverse: true },
  { chakra: 'heart', q: 'My character is possessive, jealous, or smothering in relationships', reverse: true },
  // THROAT (20-24)
  { chakra: 'throat', q: 'My character speaks their truth clearly and honestly', reverse: false },
  { chakra: 'throat', q: 'My character is creative and expressive', reverse: false },
  { chakra: 'throat', q: 'My character struggles to speak up or swallows their words', reverse: true },
  { chakra: 'throat', q: 'My character dominates conversations or speaks over others', reverse: true },
  { chakra: 'throat', q: 'My character feels heard and understood by the people around them', reverse: false },
  // THIRD EYE (25-29)
  { chakra: 'thirdeye', q: 'My character has strong intuition and trusts their gut', reverse: false },
  { chakra: 'thirdeye', q: 'My character sees the bigger picture of their situation clearly', reverse: false },
  { chakra: 'thirdeye', q: 'My character is confused, easily misled, or lost in life', reverse: true },
  { chakra: 'thirdeye', q: 'My character is lost in fantasy or disconnected from reality', reverse: true },
  { chakra: 'thirdeye', q: 'My character has a clear sense of their own purpose', reverse: false },
  // CROWN (30-34)
  { chakra: 'crown', q: 'My character feels connected to something larger than themselves', reverse: false },
  { chakra: 'crown', q: 'My character has a sense of meaning and purpose in their life', reverse: false },
  { chakra: 'crown', q: 'My character feels spiritually disconnected, cynical, or alone in the universe', reverse: true },
  { chakra: 'crown', q: 'My character is obsessed with being special, chosen, or spiritually superior', reverse: true },
  { chakra: 'crown', q: 'My character is wise and compassionate toward others and themselves', reverse: false },
];

let chakraChar = '';
let chakraProfile = {};
let chakraQuizAnswers = [];
let chakraQuizStep = 0;
let chakraMode = '';

function toggleMoreMenu() {
  const m = document.getElementById('moreMenu');
  const o = document.getElementById('moreMenuOverlay');
  const showing = m.style.display !== 'none';
  m.style.display = showing ? 'none' : 'block';
  o.style.display = showing ? 'none' : 'block';
}
function closeMoreMenu() {
  document.getElementById('moreMenu').style.display = 'none';
  document.getElementById('moreMenuOverlay').style.display = 'none';
}

function chakraGoHome() {
  document.getElementById('chakraHome').style.display = 'block';
  document.getElementById('chakraQuizView').style.display = 'none';
  document.getElementById('chakraResultView').style.display = 'none';
  window.scrollTo(0,0);
  refreshChakraScreen();
}

function refreshChakraScreen() {
  const list = document.getElementById('chakraCharList');
  if(!list) return;
  const chars = [...new Set(productions.map(p => p.myChar).filter(Boolean))];
  list.innerHTML = chars.map(c =>
    `<button onclick="selectChakraChar('${c}')" class="tool-btn ${chakraChar===c?'active':''}">${c}</button>`
  ).join('');
  renderSavedChakraProfiles();
}

function renderSavedChakraProfiles() {
  const area = document.getElementById('chakraSavedProfiles');
  if(!area) return;
  const withProfiles = productions.filter(p => p.chakraProfile && Object.keys(p.chakraProfile).length === 7);
  if(withProfiles.length === 0) { area.innerHTML = ''; return; }
  const stateEmoji = { balanced: 'âœ…', overactive: 'ğŸ”¥', blocked: 'â¬‡ï¸' };
  area.innerHTML = `<div class="section-title">Saved Profiles</div>` +
    withProfiles.map((p,i) => {
      const idx = productions.indexOf(p);
      const states = CHAKRAS.map(ch => stateEmoji[p.chakraProfile[ch.id]] || 'â—¯').join(' ');
      return `<div class="card" style="cursor:pointer;margin-bottom:10px;" onclick="viewSavedProfile(${idx})">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-size:15px;font-weight:900;">${p.myChar}</div>
            <div style="font-size:12px;margin-top:4px;letter-spacing:2px;">${states}</div>
          </div>
          <div style="font-size:12px;color:var(--brown-light);font-weight:700;">View â†’</div>
        </div>
      </div>`;
    }).join('');
}

function viewSavedProfile(prodIdx) {
  const prod = productions[prodIdx];
  if(!prod) return;
  chakraChar = prod.myChar;
  chakraProfile = {...prod.chakraProfile};
  renderChakraResults();
}

function chakraCharTyped(val) {
  chakraChar = val.trim().toUpperCase();
  const show = chakraChar.length > 1;
  document.getElementById('chakraStartBtns').style.display = show ? 'block' : 'none';
  if(show) document.getElementById('chakraCharTitle').textContent = chakraChar;
}

function selectChakraChar(name) {
  chakraChar = name;
  document.getElementById('chakraCharInput').value = name;
  document.getElementById('chakraCharTitle').textContent = name;
  document.getElementById('chakraStartBtns').style.display = 'block';
  const prod = productions.find(p => p.myChar === name);
  if(prod && prod.chakraProfile && Object.keys(prod.chakraProfile).length === 7) {
    chakraProfile = {...prod.chakraProfile};
  } else {
    chakraProfile = {};
  }
  refreshChakraScreen();
}

function startChakraQuiz() {
  if(!chakraChar) { showToast('Choose a character first!'); return; }
  chakraMode = 'quiz';
  chakraQuizStep = 0;
  chakraQuizAnswers = new Array(CHAKRA_QUIZ.length).fill(null);
  document.getElementById('chakraHome').style.display = 'none';
  document.getElementById('chakraQuizView').style.display = 'block';
  document.getElementById('chakraResultView').style.display = 'none';
  renderQuizStep();
  window.scrollTo(0,0);
}

function renderQuizStep() {
  const total = CHAKRA_QUIZ.length;
  const pct = Math.round((chakraQuizStep / total) * 100);
  document.getElementById('chakraQuizProgress').textContent = `Question ${chakraQuizStep+1} of ${total}`;
  
  const q = CHAKRA_QUIZ[chakraQuizStep];
  const ch = CHAKRAS.find(c => c.id === q.chakra);
  const labels = ['Never / Not at all', 'Rarely / A little', 'Sometimes / Somewhat', 'Always / Strongly'];
  const current = chakraQuizAnswers[chakraQuizStep];
  
  document.getElementById('chakraQuizArea').innerHTML = `
    <div style="background:var(--sand);border-radius:var(--rs);height:8px;margin-bottom:20px;">
      <div style="background:${ch.color};height:8px;border-radius:var(--rs);width:${pct}%;transition:width 0.3s;"></div>
    </div>
    <div class="card" style="border-left:5px solid ${ch.color};margin-bottom:16px;">
      <div style="font-size:11px;font-weight:900;color:${ch.color};text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">${ch.emoji} ${ch.name} Chakra</div>
      <div style="font-size:15px;font-weight:700;line-height:1.7;color:var(--brown);">${q.q}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
      ${labels.map((label, i) => `
        <button onclick="selectQuizAnswer(${i+1})" style="background:${current===i+1?ch.color+'22':'var(--cream)'};border:2px solid ${current===i+1?ch.color:'var(--sand-dark)'};border-radius:var(--r);padding:14px 16px;text-align:left;font-family:var(--font);font-size:13px;font-weight:700;color:${current===i+1?ch.color:'var(--brown)'};cursor:pointer;line-height:1.5;">${label}</button>
      `).join('')}
    </div>
    <div style="display:flex;gap:10px;">
      ${chakraQuizStep > 0 ? `<button onclick="quizBack()" class="btn btn-ghost" style="flex:1;">â† Back</button>` : '<div style="flex:1;"></div>'}
      ${current !== null ? `<button onclick="quizNext()" class="btn btn-terra" style="flex:2;">Next â†’</button>` : `<button class="btn" style="flex:2;background:var(--sand-dark);color:var(--brown-light);cursor:default;">Choose an answer</button>`}
    </div>
  `;
}

function selectQuizAnswer(val) {
  chakraQuizAnswers[chakraQuizStep] = val;
  renderQuizStep();
}

function quizBack() {
  if(chakraQuizStep > 0) { chakraQuizStep--; renderQuizStep(); window.scrollTo(0,0); }
}

function quizNext() {
  if(chakraQuizAnswers[chakraQuizStep] === null) return;
  chakraQuizStep++;
  if(chakraQuizStep >= CHAKRA_QUIZ.length) {
    computeChakraScores();
  } else {
    renderQuizStep();
    window.scrollTo(0,0);
  }
}

function computeChakraScores() {
  // Score each chakra: 5 questions, each 1-4, max 20
  const scores = {};
  CHAKRAS.forEach(ch => scores[ch.id] = 0);
  
  CHAKRA_QUIZ.forEach((q, i) => {
    let answer = chakraQuizAnswers[i] || 2;
    if(q.reverse) answer = 5 - answer; // flip: high score on reversed = actually low
    scores[q.chakra] += answer;
  });
  
  // Map scores to states
  // 5-10: blocked, 11-15: balanced, 16-20: overactive
  chakraProfile = {};
  CHAKRAS.forEach(ch => {
    const s = scores[ch.id];
    if(s <= 10) chakraProfile[ch.id] = 'blocked';
    else if(s <= 15) chakraProfile[ch.id] = 'balanced';
    else chakraProfile[ch.id] = 'overactive';
  });
  
  saveChakraProfile();
  renderChakraResults();
}

function startChakraManual() {
  if(!chakraChar) { showToast('Choose a character first!'); return; }
  chakraMode = 'manual';
  CHAKRAS.forEach(ch => { if(!chakraProfile[ch.id]) chakraProfile[ch.id] = 'balanced'; });
  saveChakraProfile();
  renderChakraResults();
}

function setChakraState(id, state) {
  chakraProfile[id] = state;
  saveChakraProfile();
  renderChakraResults();
}

function renderChakraResults() {
  document.getElementById('chakraHome').style.display = 'none';
  document.getElementById('chakraQuizView').style.display = 'none';
  document.getElementById('chakraResultView').style.display = 'block';
  document.getElementById('chakraResultTitle').textContent = chakraChar + ' â€” Chakra Profile';
  window.scrollTo(0,0);
  
  const stateColors = { balanced: '#2E7D32', overactive: '#C62828', blocked: '#546E7A' };
  const stateLabel  = { balanced: 'Balanced âœ…', overactive: 'Overactive ğŸ”¥', blocked: 'Blocked â¬‡ï¸' };
  const stateDesc   = {
    balanced: 'Healthy energy flow â€” this aspect of the character is integrated.',
    overactive: 'Excessive energy â€” this chakra drives the character too hard or creates imbalance.',
    blocked: 'Restricted flow â€” this is where the character is stuck, wounded, or shut down.'
  };

  let html = '';
  CHAKRAS.forEach(ch => {
    const state = chakraProfile[ch.id] || 'balanced';
    const traits = ch[state] || [];
    html += `
    <div class="card" style="margin-bottom:14px;border-left:5px solid ${ch.color};">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
        <div style="width:44px;height:44px;border-radius:50%;background:${ch.color};flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px;">â—</div>
        <div style="flex:1;">
          <div style="font-size:15px;font-weight:900;">${ch.name} Chakra</div>
          <div style="font-size:11px;color:var(--brown-light);">${ch.sanskrit} Â· ${ch.location}</div>
        </div>
        <div style="font-size:12px;font-weight:900;color:${stateColors[state]};text-align:right;">${stateLabel[state]}</div>
      </div>
      
      <div style="font-size:12px;color:var(--brown-light);line-height:1.6;margin-bottom:12px;">${stateDesc[state]}</div>
      
      <!-- State selector -->
      <div style="display:flex;gap:6px;margin-bottom:14px;">
        ${['blocked','balanced','overactive'].map(s => `
          <button onclick="setChakraState('${ch.id}','${s}')" style="flex:1;padding:8px 2px;border-radius:99px;border:2px solid ${s===state?stateColors[s]:'var(--sand-dark)'};background:${s===state?stateColors[s]+'22':'var(--sand)'};font-family:var(--font);font-size:9px;font-weight:900;color:${s===state?stateColors[s]:'var(--brown-light)'};cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;">${s}</button>
        `).join('')}
      </div>
      
      <!-- Traits -->
      <div style="font-size:11px;font-weight:900;color:var(--brown-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Character traits:</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">
        ${traits.map(t => `<span style="background:${ch.color}22;color:${ch.color};border-radius:99px;padding:3px 10px;font-size:11px;font-weight:700;">${t}</span>`).join('')}
      </div>
      
      <!-- Acting note -->
      <div style="font-size:12px;color:var(--brown-light);line-height:1.6;font-style:italic;margin-bottom:12px;">${ch.actingNote}</div>
      
      <!-- Activation -->
      <div style="background:var(--sand);border-radius:var(--rs);padding:12px;">
        <div style="font-size:11px;font-weight:900;color:var(--brown);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">âš¡ Activation â€” Access this chakra in your body:</div>
        ${ch.activation.map(a => `<div style="font-size:12px;color:var(--brown-light);line-height:1.6;margin-bottom:6px;padding-left:10px;border-left:2px solid ${ch.color};">â€¢ ${a}</div>`).join('')}
        <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--sand-dark);">
          <div style="font-size:12px;font-weight:900;color:var(--brown);">Mantra: <span style="color:${ch.color};">${ch.mantra}</span> â€” ${ch.mudra}</div>
        </div>
      </div>
    </div>`;
  });

  document.getElementById('chakraResultArea').innerHTML = html;
}

function saveChakraProfile() {
  const prod = productions.find(p => p.myChar === chakraChar);
  if(prod) {
    prod.chakraProfile = {...chakraProfile};
    autoSave();
  }
}

function printChakraProfile() {
  const stateColors = { balanced: '#2E7D32', overactive: '#C62828', blocked: '#546E7A' };
  const stateLabel  = { balanced: 'Balanced âœ…', overactive: 'Overactive ğŸ”¥', blocked: 'Blocked â¬‡ï¸' };
  const stateDesc   = {
    balanced: 'Healthy energy flow â€” this aspect of the character is integrated.',
    overactive: 'Excessive energy â€” this chakra drives the character too hard.',
    blocked: 'Restricted flow â€” this is where the character is stuck or shut down.'
  };

  let html = `<html><head><title>Chakra Profile â€” ${chakraChar}</title>
  <style>
    body{font-family:Georgia,serif;max-width:720px;margin:40px auto;color:#2c1a0e;padding:20px;}
    h1{font-size:28px;margin-bottom:4px;}
    .sub{color:#888;margin-bottom:32px;font-size:14px;}
    .chakra{border-left:6px solid #ccc;padding:16px 20px;margin-bottom:24px;page-break-inside:avoid;}
    .name{font-size:18px;font-weight:bold;margin-bottom:2px;}
    .state{font-size:14px;font-weight:bold;margin:8px 0;}
    .desc{font-size:13px;color:#555;margin-bottom:10px;line-height:1.6;}
    .traits{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
    .trait{background:#f0f0f0;border-radius:99px;padding:3px 12px;font-size:12px;}
    .note{font-size:12px;color:#555;font-style:italic;margin-bottom:12px;line-height:1.6;}
    .activation{background:#f9f6f0;padding:12px;border-radius:6px;}
    .activation h4{font-size:12px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;color:#333;}
    .act-item{font-size:12px;color:#555;line-height:1.7;margin-bottom:4px;padding-left:12px;border-left:3px solid #ccc;}
    .mantra{font-size:13px;font-weight:bold;margin-top:8px;padding-top:8px;border-top:1px solid #ddd;}
    @media print{body{margin:20px;}}
  </style></head><body>
  <h1>ğŸ”® Chakra Profile</h1>
  <div class="sub">Character: <strong>${chakraChar}</strong> Â· EscoMind Â· ${new Date().toLocaleDateString()}</div>`;

  CHAKRAS.forEach(ch => {
    const state = chakraProfile[ch.id] || 'balanced';
    const traits = ch[state] || [];
    html += `<div class="chakra" style="border-left-color:${ch.color};">
      <div class="name" style="color:${ch.color};">${ch.emoji} ${ch.name} Chakra â€” ${ch.sanskrit}</div>
      <div style="font-size:12px;color:#888;margin-bottom:6px;">${ch.location} Â· Element: ${ch.element}</div>
      <div class="state" style="color:${stateColors[state]};">${stateLabel[state]}</div>
      <div class="desc">${stateDesc[state]}</div>
      <div class="traits">${traits.map(t=>`<span class="trait">${t}</span>`).join('')}</div>
      <div class="note">${ch.actingNote}</div>
      <div class="activation">
        <h4>âš¡ Activation</h4>
        ${ch.activation.map(a=>`<div class="act-item" style="border-left-color:${ch.color};">â€¢ ${a}</div>`).join('')}
        <div class="mantra">Mantra: <strong>${ch.mantra}</strong> Â· ${ch.mudra}</div>
      </div>
    </div>`;
  });

  html += `</body></html>`;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 500);
}

// chakra refresh is handled inside navTo directly
-e 
</script>
</body>
</html>
